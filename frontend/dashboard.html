<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Gateway 2.0 | Hospital Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Vis.js for Interactive Knowledge Graph -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #059669;
            --success-light: #10b981;
            --warning: #d97706;
            --warning-light: #f59e0b;
            --danger: #dc2626;
            --danger-light: #ef4444;
            --info: #0891b2;
            --info-light: #06b6d4;
            --purple: #7c3aed;
            --pink: #ec4899;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 280px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); }
            50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.8); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            color: var(--gray-900);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            animation: slideInLeft 0.5s ease-out;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse 3s ease-in-out infinite;
        }

        .logo h1 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .logo p {
            font-size: 0.7rem;
            color: var(--gray-400);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 0.35rem;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.25s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            transform: translateX(5px);
        }

        .nav-item:hover::before {
            transform: scaleY(1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            width: calc(100% - var(--sidebar-width));
            max-width: calc(100vw - var(--sidebar-width));
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(to right, white, rgba(249, 250, 251, 0.95));
            border-bottom: 1px solid var(--gray-200);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gray-900), var(--gray-700));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 0.65rem 1.25rem;
            width: 320px;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .search-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            padding-left: 0.5rem;
            font-size: 0.875rem;
        }

        .search-box input:focus {
            outline: none;
        }

        .notification-btn, .profile-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-sm);
        }

        .notification-btn:hover, .profile-btn:hover {
            background: var(--gray-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Page Content */
        .page-content {
            padding: 1.5rem 2rem;
        }

        /* Page sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: none;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35rem;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon.blue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: var(--primary); }
        .stat-icon.green { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: var(--success); }
        .stat-icon.yellow { background: linear-gradient(135deg, #fef3c7, #fde68a); color: var(--warning); }
        .stat-icon.red { background: linear-gradient(135deg, #fee2e2, #fecaca); color: var(--danger); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            border: none;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(249, 250, 251, 0.8), white);
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-body.no-padding {
            padding: 0;
        }

        /* Upload Section */
        .upload-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .upload-zone:hover::before {
            left: 100%;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
            transform: scale(1.01);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .upload-zone.processing {
            pointer-events: none;
            opacity: 0.7;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .upload-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-zone h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        #fileInput {
            display: none;
        }

        .upload-settings {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label i {
            color: var(--primary);
            font-size: 0.8rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:hover {
            border-color: var(--gray-300);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .form-select:hover {
            border-color: var(--gray-300);
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 0.85rem 1.5rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Status */
        .status-box {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }

        .status-box.show {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-box.processing {
            background: #eff6ff;
            color: var(--primary);
            border: 1px solid #bfdbfe;
        }

        .status-box.success {
            background: #ecfdf5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .status-box.error {
            background: #fef2f2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 1.5rem;
        }

        .results-container.show {
            display: block;
        }

        /* Alert Boxes */
        .alert-box {
            padding: 1.25rem;
            border-radius: 14px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            animation: fadeInUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .alert-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .alert-box.warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border: none;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
        }

        .alert-box.warning::before {
            background: linear-gradient(180deg, #f59e0b, #d97706);
        }

        .alert-box.danger {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .alert-box.danger::before {
            background: linear-gradient(180deg, #ef4444, #dc2626);
        }

        .alert-box.info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: none;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .alert-box.info::before {
            background: linear-gradient(180deg, #0ea5e9, #0284c7);
        }

        .alert-box.success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: none;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
        }

        .alert-box.success::before {
            background: linear-gradient(180deg, #22c55e, #16a34a);
        }

        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
        }

        .alert-content h5 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .alert-content p {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }

        /* Allergy & Condition Badges */
        .allergy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0.15rem;
        }
        
        .allergy-badge.critical {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
            border: 2px solid #ef4444;
            animation: pulse 2s infinite;
        }
        
        .allergy-badge.high {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            color: #ea580c;
            border: 1px solid #f97316;
        }
        
        .allergy-badge.standard {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.15rem;
        }
        
        .condition-badge.high-impact {
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            color: #7c3aed;
            border: 1px solid #a78bfa;
        }
        
        .condition-badge.standard {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        
        /* Drug Safety Alert Popup */
        .drug-safety-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .safety-alert-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .safety-alert-card.critical {
            border-left: 5px solid #dc2626;
        }
        
        .safety-alert-card.high {
            border-left: 5px solid #f97316;
        }
        
        .safety-alert-card.moderate {
            border-left: 5px solid #eab308;
        }
        
        .safety-alert-header {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
        }
        
        .safety-alert-header.critical {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
        }
        
        .safety-alert-header.high {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            color: #ea580c;
        }
        
        .safety-alert-header.moderate {
            background: linear-gradient(135deg, #fefce8, #fef9c3);
            color: #ca8a04;
        }
        
        .safety-alert-body {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .safety-alert-action {
            padding: 0.5rem 1rem;
            background: var(--gray-50);
            font-size: 0.8rem;
            color: var(--gray-600);
            border-top: 1px solid var(--gray-100);
        }

        /* Prescription Details */
        .prescription-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-block {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 1rem;
        }

        .info-block h4 {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .info-item label {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: block;
        }

        .info-item span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .info-item span.missing {
            color: var(--gray-400);
            font-style: italic;
        }

        /* Medications Table */
        .med-table {
            width: 100%;
            border-collapse: collapse;
        }

        .med-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .med-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .med-table tr:last-child td {
            border-bottom: none;
        }

        .med-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .med-form {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .med-dosage {
            font-weight: 500;
            color: var(--primary);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .badge-success { 
            background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
            color: #166534;
            box-shadow: 0 2px 4px rgba(22, 101, 52, 0.1);
        }
        .badge-warning { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #92400e;
            box-shadow: 0 2px 4px rgba(146, 64, 14, 0.1);
        }
        .badge-danger { 
            background: linear-gradient(135deg, #fee2e2, #fecaca); 
            color: #991b1b;
            box-shadow: 0 2px 4px rgba(153, 27, 27, 0.1);
        }
        .badge-info { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.1);
        }
        .badge-gray { 
            background: linear-gradient(135deg, var(--gray-200), var(--gray-100)); 
            color: var(--gray-700);
        }
        .badge-purple {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            box-shadow: 0 2px 4px rgba(91, 33, 182, 0.1);
        }

        /* Confidence Meter */
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .confidence-bar {
            flex: 1;
            height: 10px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .confidence-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .confidence-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .confidence-fill.high { 
            background: linear-gradient(90deg, #10b981, #059669); 
        }
        .confidence-fill.medium { 
            background: linear-gradient(90deg, #f59e0b, #d97706); 
        }
        .confidence-fill.low { 
            background: linear-gradient(90deg, #ef4444, #dc2626); 
        }

        .confidence-text {
            font-size: 1rem;
            font-weight: 700;
            min-width: 55px;
            text-align: right;
            
            text-align: right;
        }

        /* Tags */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--gray-100);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--gray-700);
        }

        /* Vitals Grid */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .vital-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .vital-item label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            display: block;
            margin-bottom: 0.25rem;
        }

        .vital-item span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Review Banner */
        .review-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 10px;
            padding: 0.875rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .review-banner.hidden {
            display: none;
        }

        .review-banner i {
            color: var(--warning);
        }

        .review-banner span {
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Raw Text */
        .raw-text-box {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header i {
            transition: transform 0.2s;
        }

        .collapsible-header.active i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .collapsible-content.show {
            max-height: 500px;
        }

        /* Recent Prescriptions Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        /* Patient List */
        .patient-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .patient-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .patient-info {
            display: flex;
            flex-direction: column;
        }

        .patient-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .patient-id {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Empty State */
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-300);
        }

        .empty-state h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        /* Chart placeholder */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
            border-radius: 8px;
            color: var(--gray-400);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Print styles */
        @media print {
            .sidebar, .header {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
            .results-container {
                display: block !important;
            }
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
            margin-bottom: 1.5rem;
            animation: pulse 3s ease-in-out infinite;
        }

        .login-logo h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .login-logo p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 1.5rem;
        }

        .login-card-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .login-card-title i {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-qr-zone {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            color: white;
        }

        .login-qr-zone:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .login-qr-zone i {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .login-qr-zone h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .login-qr-zone p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .login-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .login-divider span {
            padding: 0 1rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            display: none;
        }

        .login-status.error {
            display: block;
            background: rgba(220, 38, 38, 0.2);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fecaca;
        }

        .login-status.success {
            display: block;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #a7f3d0;
        }

        .login-status.loading {
            display: block;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #bfdbfe;
        }

        .login-staff-link {
            text-align: center;
            margin-top: 1.5rem;
        }

        .login-staff-link a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .login-staff-link a:hover {
            color: white;
        }

        /* Dashboard hidden by default until login */
        .dashboard-wrapper {
            display: none;
        }

        .dashboard-wrapper.active {
            display: flex;
            width: 100%;
        }

        /* Logout button in header */
        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* Current patient indicator in header */
        .current-patient-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Page History Tabs */
        .page-history-tab {
            background: #e5e7eb;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .page-history-tab:hover {
            background: #d1d5db;
        }
        
        .page-history-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Page Explainability Tabs */
        .page-explain-tab {
            background: #e5e7eb;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .page-explain-tab:hover {
            background: #d1d5db;
        }
        
        .page-explain-tab.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border-color: #7c3aed;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">ðŸ’Š</div>
                <h1>MedAI Gateway</h1>
                <p>Hospital Prescription Management System</p>
            </div>

            <div class="login-card">
                <div class="login-card-title">
                    <i class="fas fa-qrcode"></i>
                    <span>Scan Patient QR Code</span>
                </div>
                <div class="login-qr-zone" id="loginQrDropZone">
                    <i class="fas fa-qrcode"></i>
                    <h3>Drop QR Image Here</h3>
                    <p>or click to browse files</p>
                    <input type="file" id="loginQrFileInput" accept=".png,.jpg,.jpeg,.bmp,.gif,.webp" style="display: none;">
                </div>
            </div>

            <div class="login-divider">
                <span>OR</span>
            </div>

            <div class="login-card">
                <div class="login-card-title">
                    <i class="fas fa-keyboard"></i>
                    <span>Enter Patient UID</span>
                </div>
                <input type="text" class="login-input" id="loginPatientUid" placeholder="e.g., PT20260130-A1B2">
                <button class="login-btn" id="loginBtn" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt"></i>
                    Access Patient Dashboard
                </button>
                <div class="login-status" id="loginStatus"></div>
            </div>

            <div class="login-staff-link">
                <a href="/staff" target="_blank">
                    <i class="fas fa-user-plus"></i> Register New Patient (Staff Portal)
                </a>
            </div>
        </div>
    </div>

    <!-- Dashboard Wrapper (hidden until login) -->
    <div class="dashboard-wrapper" id="dashboardWrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ðŸ’Š</div>
                <div>
                    <h1 style="font-size: 1.2rem; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MedAI Gateway</h1>
                    <p style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 2px;">Hospital Edition v2.0</p>
                </div>
            </div>

        <nav class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="patients">
                    <i class="fas fa-users"></i>
                    <span>Patients</span>
                </a>
                <a class="nav-item" data-page="history">
                    <i class="fas fa-book-medical"></i>
                    <span>Longitudinal History</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Drug Tools</div>
                <a class="nav-item" data-page="drug-normalize">
                    <i class="fas fa-pills"></i>
                    <span>Drug Normalization</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Temporal</div>
                <a class="nav-item" data-page="timeline">
                    <i class="fas fa-stream"></i>
                    <span>Medication Timeline</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a class="nav-item" data-page="knowledge-graph">
                    <i class="fas fa-project-diagram"></i>
                    <span>Knowledge Graph</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Transparency</div>
                <a class="nav-item" data-page="explainability">
                    <i class="fas fa-search-plus"></i>
                    <span>Explainability</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clinical Intelligence</div>
                <a class="nav-item" data-page="clinical-decision">
                    <i class="fas fa-dna"></i>
                    <span>Pharmacogenomics</span>
                </a>
                <a class="nav-item" data-page="treatment-outcomes">
                    <i class="fas fa-heartbeat"></i>
                    <span>Treatment Outcomes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Advanced</div>
                <a class="nav-item" data-page="ask-ai">
                    <i class="fas fa-robot"></i>
                    <span>Ask AI</span>
                </a>
                <a class="nav-item" data-page="review-queue">
                    <i class="fas fa-tasks"></i>
                    <span>Review Queue</span>
                    <span class="nav-badge" id="reviewBadge">0</span>
                </a>
                <a class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--gray-700);">
            <div class="nav-item">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h2 class="page-title" id="pageTitle">Dashboard</h2>
            </div>
            <div class="header-right">
                <div class="current-patient-badge" id="currentPatientBadge">
                    <i class="fas fa-user"></i>
                    <span id="currentPatientName">No Patient</span>
                </div>
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--gray-400);"></i>
                    <input type="text" placeholder="Search patients, prescriptions...">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-dot"></span>
                </button>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Switch Patient
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Dashboard Page -->
            <section class="page-section active" id="page-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalScans">0</div>
                                <div class="stat-label">Total Scans Today</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 12% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalMeds">0</div>
                                <div class="stat-label">Medications Processed</div>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-pills"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 8% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="alertsFound">0</div>
                                <div class="stat-label">Safety Alerts</div>
                            </div>
                            <div class="stat-icon yellow">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-change down">
                            <i class="fas fa-arrow-down"></i> 5% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="avgConfidence">-</div>
                                <div class="stat-label">Avg Confidence</div>
                            </div>
                            <div class="stat-icon red">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 3% from yesterday
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Prescriptions</span>
                            <button class="btn btn-sm btn-secondary" onclick="navigateTo('history')">View All</button>
                        </div>
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Medications</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recentPrescriptions">
                                    <tr>
                                        <td colspan="5" class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>No prescriptions yet. Upload your first prescription!</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Quick Actions</span>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" style="width: 100%; justify-content: center; margin-bottom: 0.75rem;" onclick="navigateTo('scan')">
                                <i class="fas fa-camera"></i> Scan New Prescription
                            </button>
                            <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="openTextInput()">
                                <i class="fas fa-keyboard"></i> Manual Text Entry
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scan Page -->
            <section class="page-section" id="page-scan">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-camera" style="margin-right: 0.5rem;"></i>Scan Prescription</span>
                    </div>
                    <div class="card-body">
                        <div class="upload-area">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Drop prescription here</h3>
                                <p>or click to browse files</p>
                                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                                    Supports: PDF, PNG, JPG, JPEG, TIFF
                                </p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp,.webp">

                            <div class="upload-settings">
                                <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;">
                                    <i class="fas fa-sliders-h" style="margin-right: 0.5rem;"></i>Processing Settings
                                </h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Patient Name (optional)</label>
                                    <input type="text" class="form-input" id="patientNameInput" placeholder="Enter patient name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Known Allergies</label>
                                    <input type="text" class="form-input" id="allergiesInput" placeholder="e.g., Penicillin, Sulfa, Aspirin">
                                    <small style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; display: block;">
                                        Comma-separated list of known allergies
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Processing Mode</label>
                                    <select class="form-select" id="processingMode">
                                        <option value="auto">Auto (AI + Fallback)</option>
                                        <option value="ai">AI Only (Gemini)</option>
                                        <option value="regex">Pattern Matching Only</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" style="width: 100%; justify-content: center;" id="processBtn" disabled>
                                    <i class="fas fa-magic"></i> Process Prescription
                                </button>
                            </div>
                        </div>

                        <div class="status-box" id="statusBox">
                            <span class="spinner"></span>
                            <span id="statusText">Processing...</span>
                        </div>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer">
                    <!-- Review Banner -->
                    <div class="review-banner hidden" id="reviewBanner">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="reviewReason">Manual review recommended</span>
                    </div>

                    <!-- Safety Alerts -->
                    <div id="alertsContainer"></div>

                    <!-- Prescription Details -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-file-medical" style="margin-right: 0.5rem;"></i>Prescription Details</span>
                            <span class="badge badge-info" id="prescriptionDate">-</span>
                        </div>
                        <div class="card-body">
                            <div class="prescription-grid">
                                <div class="info-block">
                                    <h4><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Patient Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Name</label>
                                            <span id="resultPatientName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Age / Gender</label>
                                            <span id="resultAgeGender" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Patient ID</label>
                                            <span id="resultPatientId" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Phone</label>
                                            <span id="resultPatientPhone" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item" style="grid-column: span 2;">
                                            <label>Address</label>
                                            <span id="resultPatientAddress" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-block">
                                    <h4><i class="fas fa-user-md" style="margin-right: 0.5rem;"></i>Doctor Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Doctor</label>
                                            <span id="resultDoctorName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Qualification</label>
                                            <span id="resultDoctorQual" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Clinic</label>
                                            <span id="resultClinic" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Reg. No</label>
                                            <span id="resultDoctorRegNo" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Diagnosis -->
                            <div style="margin-top: 1rem;" id="diagnosisSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-stethoscope" style="margin-right: 0.5rem;"></i>Diagnosis
                                </label>
                                <div class="tag-list" id="diagnosisList"></div>
                            </div>

                            <!-- Vitals -->
                            <div style="margin-top: 1rem;" id="vitalsSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem;"></i>Vitals
                                </label>
                                <div class="vitals-grid" id="vitalsGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medications</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="badge badge-info" id="medBadge">0 items</span>
                                <div class="confidence-meter" style="width: 150px;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" id="confidenceFill" style="width: 0;"></div>
                                    </div>
                                    <span class="confidence-text" id="confidenceText">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body no-padding">
                            <table class="med-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Medication</th>
                                        <th style="width: 12%;">Dosage</th>
                                        <th style="width: 18%;">Frequency</th>
                                        <th style="width: 12%;">Duration</th>
                                        <th style="width: 18%;">Instructions</th>
                                        <th style="width: 15%;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="medicationsList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Advice & Follow-up -->
                    <div class="card" id="adviceCard">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-clipboard-list" style="margin-right: 0.5rem;"></i>Advice & Follow-up</span>
                        </div>
                        <div class="card-body">
                            <div id="adviceSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Advice</label>
                                <div class="tag-list" id="adviceList"></div>
                            </div>
                            <div id="followUpSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Follow-up</label>
                                <span id="followUpDate" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Raw OCR Text -->
                    <div class="card">
                        <div class="card-header collapsible-header" id="rawOcrHeader">
                            <span class="card-title"><i class="fas fa-code" style="margin-right: 0.5rem;"></i>Raw OCR Text</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="collapsible-content" id="rawOcrContent">
                            <div class="card-body">
                                <pre class="raw-text-box" id="rawText"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-secondary" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy Summary
                            </button>
                            <button class="btn btn-secondary" onclick="exportJSON()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                            <button class="btn btn-success" onclick="savePrescription()">
                                <i class="fas fa-save"></i> Save to Database
                            </button>
                            <button class="btn btn-secondary" style="margin-left: auto;" onclick="resetScan()">
                                <i class="fas fa-redo"></i> New Scan
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patients Page -->
            <section class="page-section" id="page-patients">
                <!-- Patient Selection / Creation -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" onclick="refreshPatientList()" style="cursor: pointer;">
                        <div class="stat-icon blue" style="margin-bottom: 0.5rem;"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="totalPatientsCount">0</div>
                        <div class="stat-label">Total Patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green" style="margin-bottom: 0.5rem;"><i class="fas fa-file-medical"></i></div>
                        <div class="stat-value" id="totalPrescriptionsCount">0</div>
                        <div class="stat-label">Total Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow" style="margin-bottom: 0.5rem;"><i class="fas fa-pills"></i></div>
                        <div class="stat-value" id="activeMedicationsCount">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red" style="margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="activeAlertsCount">0</div>
                        <div class="stat-label">Active Alerts</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 400px 1fr; gap: 1.5rem;">
                    <!-- Left Panel: QR Scan & Patient Lookup -->
                    <div>
                        <!-- Doctor QR Scan Card -->
                        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white;">
                            <div class="card-body" style="padding: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        ðŸ“±
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-weight: 600;">Scan Patient QR</h3>
                                        <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Upload QR code image to view patient</p>
                                    </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px dashed rgba(255,255,255,0.4); transition: all 0.3s;" id="doctorQrDropZone">
                                    <i class="fas fa-qrcode" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 500;">Drop QR Image Here</p>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">or click to browse</p>
                                    <input type="file" id="doctorQrFileInput" accept=".png,.jpg,.jpeg,.bmp,.gif,.webp" style="display: none;">
                                </div>
                            </div>
                        </div>

                        <!-- Manual UID Entry -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-keyboard"></i> Manual Lookup</span>
                            </div>
                            <div class="card-body">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label">Patient UID</label>
                                    <input type="text" class="form-input" id="doctorPatientUidInput" placeholder="e.g., PT20260130-A1B2">
                                </div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="doctorLookupPatient()">
                                    <i class="fas fa-search"></i> Find Patient
                                </button>
                            </div>
                        </div>

                        <!-- Existing Patients List -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-list"></i> Recent Patients</span>
                                <button class="btn btn-sm" onclick="refreshPatientList()"><i class="fas fa-sync"></i></button>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 0;">
                                <div id="existingPatientsList">
                                    <div class="empty-state" style="padding: 2rem;">
                                        <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                                        <p style="margin-top: 0.5rem;">No patients yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Portal Link -->
                        <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                            <div class="card-body" style="text-align: center; padding: 1.25rem;">
                                <i class="fas fa-user-plus" style="font-size: 1.5rem; color: #0284c7; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0 0 0.75rem 0; color: #0369a1; font-weight: 500;">Need to register a new patient?</p>
                                <a href="/staff" target="_blank" class="btn" style="background: #0284c7; color: white; width: 100%;">
                                    <i class="fas fa-external-link-alt"></i> Open Staff Portal
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Patient Details View -->
                    <div>
                        <!-- Patient Not Found / Initial State -->
                        <div id="patientNotFoundState">
                            <div class="card">
                                <div class="card-body" style="text-align: center; padding: 4rem 2rem;">
                                    <i class="fas fa-user-md" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--gray-500); margin-bottom: 0.5rem;">Scan Patient QR Code</h3>
                                    <p style="color: var(--gray-400);">Upload a patient QR code image or enter their UID to view prescription details</p>
                                </div>
                            </div>
                        </div>

                        <!-- Patient Found - Details View -->
                        <div id="patientFoundState" style="display: none;">
                            <!-- Patient Header Card -->
                            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                                <div class="card-body" style="padding: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                                                ðŸ‘¤
                                            </div>
                                            <div>
                                                <h2 id="viewPatientName" style="margin: 0; font-size: 1.5rem;">Patient Name</h2>
                                                <p id="viewPatientUid" style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">
                                                    <span id="viewPatientAge"></span>
                                                    <span id="viewPatientGender"></span>
                                                    <span id="viewPatientBlood"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="clearPatientView()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewTotalPrescriptions">0</div>
                                            <div class="stat-label">Prescriptions</div>
                                        </div>
                                        <div class="stat-icon blue"><i class="fas fa-file-prescription"></i></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewActiveMeds">0</div>
                                            <div class="stat-label">Active Medications</div>
                                        </div>
                                        <div class="stat-icon green"><i class="fas fa-pills"></i></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewLastVisit">-</div>
                                            <div class="stat-label">Last Visit</div>
                                        </div>
                                        <div class="stat-icon purple"><i class="fas fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Allergies & Conditions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="card">
                                    <div class="card-header" style="background: #fef2f2;">
                                        <span class="card-title" style="color: #dc2626;"><i class="fas fa-allergies"></i> Allergies</span>
                                    </div>
                                    <div class="card-body" id="viewAllergies">
                                        <span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header" style="background: #fef3c7;">
                                        <span class="card-title" style="color: #d97706;"><i class="fas fa-notes-medical"></i> Conditions</span>
                                    </div>
                                    <div class="card-body" id="viewConditions">
                                        <span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Allergy-Based Risks -->
                            <div class="card" style="margin-top: 1rem;" id="allergyRisksCard">
                                <div class="card-header" style="background: linear-gradient(135deg, #fef2f2, #fecaca);">
                                    <span class="card-title" style="color: #b91c1c;"><i class="fas fa-exclamation-triangle"></i> Allergy-Based Risks</span>
                                    <span class="badge" id="allergyRiskCount" style="background: #dc2626; color: white;">0</span>
                                </div>
                                <div class="card-body" id="allergyRisksContent">
                                    <p style="color: var(--gray-500);">Analyzing allergies...</p>
                                </div>
                            </div>

                            <!-- Patient Context Risk Assessment -->
                            <div class="card" style="margin-top: 1rem;" id="contextRisksCard">
                                <div class="card-header" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                                    <span class="card-title" style="color: #92400e;"><i class="fas fa-user-shield"></i> Patient Context Risk Assessment</span>
                                    <span class="badge" id="contextRiskLevel" style="background: #f59e0b; color: white;">Analyzing</span>
                                </div>
                                <div class="card-body" id="contextRisksContent">
                                    <p style="color: var(--gray-500);">Analyzing patient context...</p>
                                </div>
                            </div>

                            <!-- Drug Interactions (Ranked by Severity) -->
                            <div class="card" style="margin-top: 1rem;" id="drugInteractionsCard">
                                <div class="card-header" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                                    <span class="card-title" style="color: #5b21b6;"><i class="fas fa-capsules"></i> Drug Interactions (Ranked by Severity)</span>
                                    <span class="badge" id="interactionCount" style="background: #7c3aed; color: white;">0</span>
                                </div>
                                <div class="card-body" id="drugInteractionsContent">
                                    <p style="color: var(--gray-500);">Checking interactions...</p>
                                </div>
                            </div>

                            <!-- Active Medications -->
                            <div class="card" style="margin-top: 1rem;">
                                <div class="card-header">
                                    <span class="card-title"><i class="fas fa-pills"></i> Active Medications</span>
                                </div>
                                <div class="card-body" id="viewActiveMedsList">
                                    <p style="color: var(--gray-500);">No active medications</p>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="loadPatientToAI()">
                                    <i class="fas fa-robot"></i> Ask AI About This Patient
                                </button>
                                <button class="btn btn-secondary" onclick="viewPatientTimeline()">
                                    <i class="fas fa-stream"></i> View Timeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Detail View (New Page) -->
            <section class="page-section" id="page-patient-detail">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <button class="btn" onclick="navigateTo('patients')">
                            <i class="fas fa-arrow-left"></i> Back to Patients
                        </button>
                    </div>
                    <div id="patientDetailHeader">
                        <h2 id="patientDetailName">Patient Name</h2>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="refreshPatientDetail()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Patient Info Cards -->
                <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value" id="detailPrescriptionCount">0</div>
                        <div class="stat-label">Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailActiveMeds">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailDiscontinuedMeds">0</div>
                        <div class="stat-label">Discontinued</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailTimelineEvents">0</div>
                        <div class="stat-label">Timeline Events</div>
                    </div>
                    <div class="stat-card" id="detailRiskCard">
                        <div class="stat-value" id="detailRiskLevel">-</div>
                        <div class="stat-label">Risk Level</div>
                    </div>
                </div>

                <!-- Safety Alerts -->
                <div class="card" id="safetyAlertsCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <span class="card-title" style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Active Safety Alerts</span>
                    </div>
                    <div class="card-body" id="safetyAlertsContainer"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <!-- Current Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills"></i> Current Medications</span>
                        </div>
                        <div class="card-body" id="currentMedicationsContainer">
                            <div class="empty-state">
                                <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                                <p>No active medications</p>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-user"></i> Patient Information</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Patient ID</label>
                                    <p id="detailPatientId" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Age / Gender</label>
                                    <p id="detailAgeGender" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Blood Group</label>
                                    <p id="detailBloodGroup" style="font-weight: 600; color: #dc2626;">-</p>
                                </div>
                            </div>
                            
                            <!-- Critical Allergies Section -->
                            <div id="allergiesSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.75rem; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i> Known Allergies
                                </label>
                                <div id="detailAllergiesContainer">
                                    <span style="color: var(--gray-400); font-size: 0.875rem;">None recorded</span>
                                </div>
                            </div>
                            
                            <!-- Chronic Conditions Section -->
                            <div id="conditionsSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.75rem; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-heart" style="color: #7c3aed;"></i> Chronic Conditions
                                </label>
                                <div id="detailConditionsContainer">
                                    <span style="color: var(--gray-400); font-size: 0.875rem;">None recorded</span>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.75rem; color: var(--gray-500);">Treating Doctors</label>
                                <p id="detailDoctors" style="font-weight: 500;">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Timeline -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream"></i> Complete Medical Timeline</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="timelineFilter" style="width: auto;" onchange="filterTimeline()">
                                <option value="">All Events</option>
                                <option value="prescription_added">Prescriptions</option>
                                <option value="medication_started">New Medications</option>
                                <option value="medication_stopped">Discontinued</option>
                                <option value="medication_changed">Dose Changes</option>
                                <option value="safety_alert">Safety Alerts</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="timelineContainer">
                        <div class="empty-state">
                            <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No timeline events yet</p>
                        </div>
                    </div>
                </div>

                <!-- Prescriptions List -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-file-medical"></i> All Prescriptions</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Doctor</th>
                                    <th>Diagnosis</th>
                                    <th>Medications</th>
                                    <th>File</th>
                                </tr>
                            </thead>
                            <tbody id="prescriptionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                        No prescriptions yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Longitudinal Patient History Page -->
            <section class="page-section" id="page-history">
                <!-- Header Card -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                        <span class="card-title" style="color: white; font-size: 1.3rem;">
                            <i class="fas fa-book-medical" style="margin-right: 0.75rem;"></i>
                            Longitudinal Patient History
                        </span>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span id="pageHistoryPatientBadge" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; color: white; font-weight: 500;">
                                <i class="fas fa-user"></i> Loading patient...
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pageHistoryMedCount">10</div>
                                <div class="stat-label">Total Medications</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-pills"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pageHistoryVisitCount">5</div>
                                <div class="stat-label">Hospital Visits</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-hospital"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pageHistoryDiagCount">5</div>
                                <div class="stat-label">Diagnoses</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-stethoscope"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pageHistorySymptomCount">8</div>
                                <div class="stat-label">Symptom Records</div>
                            </div>
                            <div class="stat-icon red"><i class="fas fa-heartbeat"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="card">
                    <div class="card-header" style="border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; gap: 0;">
                            <button class="btn page-history-tab active" data-tab="medications" onclick="switchPageHistoryTab('medications')" style="border-radius: 8px 0 0 0; border-right: none;">
                                <i class="fas fa-pills"></i> Medications
                            </button>
                            <button class="btn page-history-tab" data-tab="symptoms" onclick="switchPageHistoryTab('symptoms')" style="border-radius: 0; border-right: none;">
                                <i class="fas fa-heartbeat"></i> Symptoms
                            </button>
                            <button class="btn page-history-tab" data-tab="diagnosis" onclick="switchPageHistoryTab('diagnosis')" style="border-radius: 0; border-right: none;">
                                <i class="fas fa-stethoscope"></i> Diagnosis
                            </button>
                            <button class="btn page-history-tab" data-tab="visits" onclick="switchPageHistoryTab('visits')" style="border-radius: 0 8px 0 0;">
                                <i class="fas fa-calendar-check"></i> Visits
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="pageHistoryContent" style="min-height: 400px;">
                        <!-- Content will be rendered dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h4>Loading patient history...</h4>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Drug Normalization Page -->
            <section class="page-section" id="page-drug-normalize">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugsNormalized">0</div>
                                <div class="stat-label">Drugs Normalized</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-pills"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalBrandNames">50+</div>
                                <div class="stat-label">Brand Names in Database</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-database"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugClasses">15+</div>
                                <div class="stat-label">Drug Classes</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-layer-group"></i></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Single Drug Normalization -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-search" style="margin-right: 0.5rem;"></i>Drug Lookup</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Enter drug name (brand or generic)</label>
                                <input type="text" class="form-input" id="normalizeDrugInput" placeholder="e.g., Tylenol, Advil, Lipitor">
                            </div>
                            <button class="btn btn-primary" onclick="normalizeSingleDrug()">
                                <i class="fas fa-exchange-alt"></i> Normalize
                            </button>
                            <div id="normalizeResult" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Drug Comparison -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-balance-scale" style="margin-right: 0.5rem;"></i>Drug Comparison</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 1</label>
                                <input type="text" class="form-input" id="compareDrug1" placeholder="e.g., Tylenol">
                            </div>
                            <div style="padding-bottom: 0.5rem;">
                                <i class="fas fa-exchange-alt" style="color: var(--gray-400);"></i>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 2</label>
                                <input type="text" class="form-input" id="compareDrug2" placeholder="e.g., Crocin">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="compareDrugs()">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                        <div id="compareResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-cog" style="margin-right: 0.5rem;"></i>Settings</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">API Endpoint</label>
                            <input type="text" class="form-input" value="http://localhost:8000" id="apiEndpoint">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Processing Mode</label>
                            <select class="form-select" id="defaultMode">
                                <option value="auto">Auto (AI + Fallback)</option>
                                <option value="ai">AI Only</option>
                                <option value="regex">Pattern Matching Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="autoSave" checked> Auto-save prescriptions to database
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Pharmacogenomics Page -->
            <section class="page-section" id="page-clinical-decision">
                <!-- Header -->
                <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border: none; color: white; margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                ðŸ§¬
                            </div>
                            <div>
                                <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem;">Pharmacogenomics</h2>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Genetic factors affecting drug response and metabolism</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Selector -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Select Patient</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="cdsPatientUid" placeholder="Enter patient UID (e.g., PT20260130-A1B2)">
                            </div>
                            <button class="btn btn-primary" onclick="loadPharmacogenomics()" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                <i class="fas fa-dna"></i> Analyze
                            </button>
                        </div>
                        <div id="cdsLoadStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Pharmacogenomic Alerts -->
                <div class="card" id="cdsResultsContainer" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #faf5ff, #f3e8ff);">
                        <span class="card-title"><i class="fas fa-dna" style="margin-right: 0.5rem; color: #8b5cf6;"></i>Pharmacogenomic Considerations</span>
                        <span class="badge badge-purple" id="cdsPgxCount">0 alerts</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Genetic factors that may affect drug response. Consider genetic testing for high-risk medications.
                        </p>
                        <div id="cdsPgxAlertsList"></div>
                    </div>
                </div>
            </section>

            <!-- Treatment Outcomes Page -->
            <section class="page-section" id="page-treatment-outcomes">
                <!-- Header Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="stat-value" style="color: white;">Track</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.8);">Treatment Outcomes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value">Vitals</div>
                        <div class="stat-label">Trend Analysis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow"><i class="fas fa-link"></i></div>
                        <div class="stat-value">Link</div>
                        <div class="stat-label">Rx to Outcomes</div>
                    </div>
                </div>

                <!-- Patient Selector -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Patient Outcome Tracking</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="outcomePatientUid" placeholder="Enter patient UID">
                            </div>
                            <button class="btn btn-primary" onclick="loadOutcomeReport()">
                                <i class="fas fa-chart-line"></i> Load Outcomes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Record Outcome Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: #10b981;"></i>Record Treatment Outcome</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medication</label>
                                <input type="text" class="form-input" id="outcomeRecordMed" placeholder="e.g., Amlodipine">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Outcome Type</label>
                                <select class="form-select" id="outcomeRecordType">
                                    <option value="improved">âœ… Improved</option>
                                    <option value="resolved">ðŸŽ‰ Resolved</option>
                                    <option value="stable">âž¡ï¸ Stable</option>
                                    <option value="worsened">âš ï¸ Worsened</option>
                                    <option value="discontinued">ðŸ›‘ Discontinued</option>
                                    <option value="adverse_event">âŒ Adverse Event</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Side Effects (optional)</label>
                                <input type="text" class="form-input" id="outcomeRecordSideEffects" placeholder="e.g., Headache, Dizziness">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Outcome Description</label>
                            <textarea class="form-input" id="outcomeRecordDesc" rows="2" placeholder="e.g., BP improved from 160/100 to 130/85 over 3 months"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="recordOutcome()">
                            <i class="fas fa-save"></i> Record Outcome
                        </button>
                        <div id="outcomeRecordStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Record Vital Reading -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-heartbeat" style="margin-right: 0.5rem; color: #ef4444;"></i>Record Vital Reading</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Vital Type</label>
                                <select class="form-select" id="vitalRecordType">
                                    <option value="bp_systolic">BP Systolic</option>
                                    <option value="bp_diastolic">BP Diastolic</option>
                                    <option value="heart_rate">Heart Rate</option>
                                    <option value="blood_glucose">Blood Glucose</option>
                                    <option value="hba1c">HbA1c</option>
                                    <option value="ldl_cholesterol">LDL Cholesterol</option>
                                    <option value="hdl_cholesterol">HDL Cholesterol</option>
                                    <option value="weight">Weight</option>
                                    <option value="pain_score">Pain Score (0-10)</option>
                                    <option value="egfr">eGFR</option>
                                    <option value="creatinine">Creatinine</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Value</label>
                                <input type="number" class="form-input" id="vitalRecordValue" placeholder="e.g., 130" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit (auto-filled)</label>
                                <input type="text" class="form-input" id="vitalRecordUnit" placeholder="mmHg" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes (optional)</label>
                                <input type="text" class="form-input" id="vitalRecordNotes" placeholder="e.g., Fasting">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="recordVital()">
                            <i class="fas fa-plus"></i> Record Vital
                        </button>
                        <div id="vitalRecordStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Outcome Timeline -->
                <div id="outcomeTimelineContainer" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Treatment Outcome Timeline</span>
                            <span class="badge" id="outcomeHealthTrend">-</span>
                        </div>
                        <div class="card-body">
                            <div id="outcomeTimelineList"></div>
                        </div>
                    </div>

                    <!-- Vital Trends -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-chart-area" style="margin-right: 0.5rem;"></i>Vital Sign Trends</span>
                        </div>
                        <div class="card-body">
                            <div id="vitalTrendsContainer"></div>
                        </div>
                    </div>

                    <!-- Treatment Insights -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-lightbulb" style="margin-right: 0.5rem; color: #f59e0b;"></i>Treatment Insights</span>
                        </div>
                        <div class="card-body">
                            <div id="treatmentInsightsList"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Timeline Page -->
            <section class="page-section" id="page-timeline">
                <!-- Header -->
                <div class="card" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); border: none; color: white; margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                ðŸ“…
                            </div>
                            <div>
                                <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem;">Patient Prescription Timeline</h2>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Track medications, detect overlaps, and compare prescription history</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream" style="margin-right: 0.5rem;"></i>Patient Timeline</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="timelinePatientUid" placeholder="Enter patient UID (e.g., PT20260131-XXXX)" style="font-family: monospace;">
                            </div>
                            <button class="btn btn-primary" onclick="loadTimeline()">
                                <i class="fas fa-search"></i> Load Timeline
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chronological Prescription Timeline -->
                <div class="card" id="chronologicalTimelineCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                        <span class="card-title"><i class="fas fa-calendar-alt" style="margin-right: 0.5rem; color: #1d4ed8;"></i>Chronological Prescription History</span>
                        <span id="prescriptionCount" class="badge badge-info"></span>
                    </div>
                    <div class="card-body" id="chronologicalTimeline"></div>
                </div>
                
                <div class="card" id="timelineResults" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medication Timeline (Gantt View)</span>
                    </div>
                    <div class="card-body">
                        <div id="timelineChart" style="min-height: 300px;"></div>
                    </div>
                </div>

                <!-- Medication Start/Stop Tracking -->
                <div class="card" id="medStartStopCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0);">
                        <span class="card-title"><i class="fas fa-play-circle" style="margin-right: 0.5rem; color: #16a34a;"></i>Medication Start/Stop Tracking</span>
                    </div>
                    <div class="card-body" id="medStartStopContent"></div>
                </div>

                <!-- Overlapping Medications Detection -->
                <div class="card" id="overlapDetectionCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                        <span class="card-title"><i class="fas fa-layer-group" style="margin-right: 0.5rem; color: #d97706;"></i>Overlapping Medications</span>
                        <span id="overlapCount" class="badge badge-warning"></span>
                    </div>
                    <div class="card-body" id="overlapContent"></div>
                </div>

                <!-- Changes Across Visits -->
                <div class="card" id="visitChangesCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff);">
                        <span class="card-title"><i class="fas fa-exchange-alt" style="margin-right: 0.5rem; color: #9333ea;"></i>Changes Across Visits</span>
                    </div>
                    <div class="card-body" id="visitChangesContent"></div>
                </div>

                <!-- Current vs Past Comparison -->
                <div class="card" id="comparisonCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                        <span class="card-title"><i class="fas fa-balance-scale" style="margin-right: 0.5rem; color: #dc2626;"></i>Current vs Past Prescription Comparison</span>
                    </div>
                    <div class="card-body" id="comparisonContent"></div>
                </div>

                <!-- Auto Medication Changes Card -->
                <div class="card" id="timelineMedChangesCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                        <span class="card-title"><i class="fas fa-exchange-alt" style="margin-right: 0.5rem; color: #d97706;"></i>Medication Changes</span>
                        <span id="medChangesCount" class="badge badge-warning"></span>
                    </div>
                    <div class="card-body">
                        <div id="autoMedChangesResult"></div>
                    </div>
                </div>

                <div class="card" id="timelineEventsCard" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-list-ul" style="margin-right: 0.5rem;"></i>Timeline Events</span>
                    </div>
                    <div class="card-body no-padding">
                        <div id="timelineEvents"></div>
                    </div>
                </div>
            </section>

            <!-- Knowledge Graph Page - Clean Visual Layout -->
            <section class="page-section" id="page-knowledge-graph">
                <!-- Header Card -->
                <div class="card" style="background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); border: none; color: white; margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                ðŸ”—
                            </div>
                            <div>
                                <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem;">Patient Knowledge Graph</h2>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Visual relationships: Patient â†” Medications â†” Conditions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Selection -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-search" style="margin-right: 0.5rem;"></i>Load Patient Graph</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="kgPatientUid" placeholder="PT20260131-XXXX" style="font-family: monospace; font-size: 1rem;">
                            </div>
                            <button class="btn btn-primary" onclick="loadPatientKnowledgeGraph()" style="height: 44px;">
                                <i class="fas fa-project-diagram"></i> Build Graph
                            </button>
                            <button class="btn btn-secondary" onclick="loadDemoKnowledgeGraph()" style="height: 44px;">
                                <i class="fas fa-eye"></i> View Demo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Graph Visualization -->
                <div class="card" id="kgGraphCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #f8fafc, #f1f5f9);">
                        <span class="card-title">
                            <i class="fas fa-sitemap" style="margin-right: 0.5rem; color: #7c3aed;"></i>
                            <span id="kgPatientName">Knowledge Graph</span>
                        </span>
                        <span id="kgStats" class="badge badge-info"></span>
                    </div>
                    <div class="card-body" id="kgGraphContent" style="padding: 2rem; background: #f8fafc; min-height: 500px;">
                        <!-- Graph will be rendered here -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="card" id="kgLegendCard" style="display: none;">
                    <div class="card-body" style="padding: 1rem 1.5rem;">
                        <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Patient</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Medication</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Condition</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Allergy</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #ec4899, #be185d); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Drug Interaction</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Explainability & Evidence Tracking Page -->
            <section class="page-section" id="page-explainability">
                <!-- Header Card -->
                <div class="card" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); border: none; color: white; margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                    ðŸ”
                                </div>
                                <div>
                                    <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem;">Explainability & Evidence Tracking</h2>
                                    <p style="opacity: 0.9; font-size: 0.9rem;">Transparent AI: See sources, reasoning, and confidence for every extraction</p>
                                </div>
                            </div>
                            <span id="explainPagePatientBadge" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 500;">
                                <i class="fas fa-user"></i> Loading patient...
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="explainExtractionCount">8</div>
                                <div class="stat-label">Extractions</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-file-alt"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="explainInteractionCount">3</div>
                                <div class="stat-label">Interactions Flagged</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="explainReasoningCount">3</div>
                                <div class="stat-label">Reasoning Chains</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-brain"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="explainAvgConfidence">94%</div>
                                <div class="stat-label">Avg Confidence</div>
                            </div>
                            <div class="stat-icon purple"><i class="fas fa-chart-line"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Explainability Tabs -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #fdf4ff, #fae8ff); border-bottom: 1px solid #e9d5ff;">
                        <div style="display: flex; gap: 0;">
                            <button class="btn page-explain-tab active" data-tab="extractions" onclick="switchPageExplainTab('extractions')" style="border-radius: 8px 0 0 0; border-right: none;">
                                <i class="fas fa-file-alt"></i> Extractions
                            </button>
                            <button class="btn page-explain-tab" data-tab="interactions" onclick="switchPageExplainTab('interactions')" style="border-radius: 0; border-right: none;">
                                <i class="fas fa-exclamation-triangle"></i> Interactions
                            </button>
                            <button class="btn page-explain-tab" data-tab="reasoning" onclick="switchPageExplainTab('reasoning')" style="border-radius: 0; border-right: none;">
                                <i class="fas fa-brain"></i> Reasoning
                            </button>
                            <button class="btn page-explain-tab" data-tab="confidence" onclick="switchPageExplainTab('confidence')" style="border-radius: 0 8px 0 0;">
                                <i class="fas fa-chart-bar"></i> Confidence
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="min-height: 500px;" id="explainabilityPageContent">
                        <!-- Content will be rendered dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h4>Loading evidence...</h4>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ask AI Page - Medical AI Assistant -->
            <section class="page-section" id="page-ask-ai">
                <!-- AI Assistant Header -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                    <div class="card-body" style="padding: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                                ðŸ¤–
                            </div>
                            <div>
                                <h2 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Medical AI Assistant</h2>
                                <p style="opacity: 0.9; font-size: 1rem;">Your intelligent companion for patient queries, drug analysis, safety checks & more</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Context Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user-circle"></i> Patient Context</span>
                        <button class="btn btn-secondary btn-sm" onclick="togglePatientContext()">
                            <i class="fas fa-chevron-down" id="patientContextToggle"></i>
                        </button>
                    </div>
                    <div class="card-body" id="patientContextBody">
                        <!-- Load from Database Section -->
                        <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <i class="fas fa-database" style="font-size: 1.5rem; color: #0284c7;"></i>
                                <div>
                                    <h4 style="margin: 0; color: #0369a1;">Load Patient from Database</h4>
                                    <p style="margin: 0; font-size: 0.85rem; color: #0284c7;">Enter patient UID to auto-fill context with saved data</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <input type="text" class="form-input" id="aiLoadPatientUid" placeholder="e.g., PT20260130-A1B2" style="flex: 1;">
                                <button class="btn btn-primary" onclick="loadPatientContextFromDB()">
                                    <i class="fas fa-download"></i> Load Context
                                </button>
                            </div>
                            <div id="aiLoadPatientStatus" style="margin-top: 0.75rem; display: none;"></div>
                        </div>

                        <div style="text-align: center; color: var(--gray-400); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            â€” OR enter manually â€”
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-id-card"></i> Patient ID</label>
                                <input type="text" class="form-input" id="aiPatientId" placeholder="e.g., P001">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user"></i> Patient Name</label>
                                <input type="text" class="form-input" id="aiPatientName" placeholder="Patient name">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                                <input type="text" class="form-input" id="aiPatientAge" placeholder="e.g., 45">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-allergies"></i> Allergies (comma-separated)</label>
                                <input type="text" class="form-input" id="aiPatientAllergies" placeholder="e.g., Penicillin, Aspirin, Sulfa">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-notes-medical"></i> Conditions (comma-separated)</label>
                                <input type="text" class="form-input" id="aiPatientConditions" placeholder="e.g., Diabetes, Hypertension">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label"><i class="fas fa-pills"></i> Current Medications (one per line: Name, Dosage, Frequency)</label>
                            <textarea class="form-input" id="aiPatientMedications" rows="3" placeholder="Metformin, 500mg, twice daily
Lisinopril, 10mg, once daily
Aspirin, 81mg, once daily"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="savePatientContext()">
                                <i class="fas fa-save"></i> Save Context
                            </button>
                            <button class="btn btn-secondary" onclick="clearPatientContext()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <span id="contextSaveStatus" style="display: flex; align-items: center; color: var(--success); display: none;">
                                <i class="fas fa-check-circle"></i> Saved!
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-comments"></i> Chat with AI</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="badge badge-success" id="aiStatusBadge">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Online
                            </span>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <!-- Chat Messages Container -->
                        <div id="aiChatContainer" style="height: 400px; overflow-y: auto; padding: 1.5rem; background: linear-gradient(180deg, #f8fafc, #f1f5f9);">
                            <!-- Welcome Message -->
                            <div class="ai-message" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                                    ðŸ¤–
                                </div>
                                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 80%;">
                                    <p style="margin: 0; color: var(--gray-700);">
                                        <strong>Hello, Doctor!</strong> I'm your Medical AI Assistant. I can help you with:
                                    </p>
                                    <ul style="margin: 0.75rem 0 0 1.25rem; color: var(--gray-600); font-size: 0.9rem;">
                                        <li>Patient medication queries</li>
                                        <li>Drug interaction checks</li>
                                        <li>Allergy verification</li>
                                        <li>Drug normalization (brand â†’ generic)</li>
                                        <li>Comprehensive safety analysis</li>
                                        <li>Medication timeline & history</li>
                                    </ul>
                                    <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--gray-500);">
                                        ðŸ’¡ Tip: Set patient context above for more accurate responses!
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); background: white;">
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 1; position: relative;">
                                    <textarea class="form-input" id="aiQueryInput" rows="2" placeholder="Ask me anything... e.g., 'What medications is the patient taking?' or 'Check for drug interactions'" style="padding-right: 50px; resize: none;"></textarea>
                                    <button class="btn btn-primary" onclick="submitAIQuery()" style="position: absolute; right: 8px; bottom: 8px; padding: 0.5rem 1rem; border-radius: 8px;">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                                <span style="font-size: 0.8rem; color: var(--gray-500); margin-right: 0.5rem;">Quick:</span>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); color: #4338ca; border: none; font-size: 0.75rem;" onclick="quickAIQuery('medications')">
                                    ðŸ’Š Medications
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: none; font-size: 0.75rem;" onclick="quickAIQuery('allergies')">
                                    ðŸš¨ Allergies
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border: none; font-size: 0.75rem;" onclick="quickAIQuery('interactions')">
                                    âš ï¸ Interactions
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border: none; font-size: 0.75rem;" onclick="quickAIQuery('safety')">
                                    ðŸ”¬ Safety Analysis
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #5b21b6; border: none; font-size: 0.75rem;" onclick="quickAIQuery('timeline')">
                                    ðŸ“… Timeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions Card -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-lightbulb"></i> Suggested Questions</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;" id="aiSuggestions">
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('What medications is the patient taking?')">
                                <i class="fas fa-pills" style="color: var(--primary);"></i> What medications is the patient taking?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Does the patient have any allergies?')">
                                <i class="fas fa-allergies" style="color: var(--danger);"></i> Does the patient have any allergies?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Check for drug interactions')">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Check for drug interactions
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Run comprehensive safety analysis')">
                                <i class="fas fa-shield-alt" style="color: var(--success);"></i> Run comprehensive safety analysis
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('What is the generic name for Lipitor?')">
                                <i class="fas fa-search" style="color: var(--info);"></i> What is the generic name for Lipitor?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Is Aspirin safe with Warfarin?')">
                                <i class="fas fa-question-circle" style="color: var(--purple);"></i> Is Aspirin safe with Warfarin?
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Review Queue Page -->
            <section class="page-section" id="page-review-queue">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pendingReviewCount">0</div>
                                <div class="stat-label">Pending Review</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-clock"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="correctionsMade">0</div>
                                <div class="stat-label">Corrections Made</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="dismissedAlerts">0</div>
                                <div class="stat-label">Dismissed Alerts</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-times-circle"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>Items Pending Review</span>
                        <button class="btn btn-secondary btn-sm" onclick="refreshReviewQueue()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="reviewQueueList">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <h4>All caught up!</h4>
                                <p>No items pending review</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Recent Corrections</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Original</th>
                                    <th>Corrected</th>
                                    <th>By</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentCorrections">
                                <tr>
                                    <td colspan="6" class="empty-state">No corrections yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
    </div> <!-- End dashboard-wrapper -->

    <!-- Text Input Modal -->
    <div class="modal-overlay" id="textInputModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <h3>Manual Text Entry</h3>
                <button class="modal-close" onclick="closeModal('textInputModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Paste or type prescription text</label>
                    <textarea class="form-input" id="manualText" rows="10" placeholder="Paste prescription text here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Known Allergies (optional)</label>
                    <input type="text" class="form-input" id="manualAllergies" placeholder="e.g., Penicillin, Sulfa">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('textInputModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processManualText()">
                    <i class="fas fa-magic"></i> Process Text
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Use relative URLs for portability
        const API_BASE = '';
        const STAFF_API = '/api/staff';
        let currentResult = null;
        let selectedFile = null;
        let stats = { scans: 0, meds: 0, alerts: 0, totalConfidence: 0 };
        let prescriptionHistory = [];
        let currentPatientData = null;
        let currentViewedPatient = null;

        // ========================================
        // Login Screen Functions
        // ========================================
        
        // Initialize login screen
        document.addEventListener('DOMContentLoaded', () => {
            initLoginScreen();
            initNavigation();
            initUpload();
            loadStats();
        });

        function initLoginScreen() {
            const qrDropZone = document.getElementById('loginQrDropZone');
            const qrFileInput = document.getElementById('loginQrFileInput');
            const uidInput = document.getElementById('loginPatientUid');

            if (qrDropZone && qrFileInput) {
                qrDropZone.addEventListener('click', () => qrFileInput.click());

                qrDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    qrDropZone.style.background = 'rgba(255,255,255,0.2)';
                    qrDropZone.style.borderColor = 'rgba(255,255,255,0.6)';
                });

                qrDropZone.addEventListener('dragleave', () => {
                    qrDropZone.style.background = 'rgba(255,255,255,0.1)';
                    qrDropZone.style.borderColor = 'rgba(255,255,255,0.3)';
                });

                qrDropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    qrDropZone.style.background = 'rgba(255,255,255,0.1)';
                    const file = e.dataTransfer.files[0];
                    if (file) await handleQrLogin(file);
                });

                qrFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) await handleQrLogin(file);
                    e.target.value = '';
                });
            }

            // Enter key support for UID input
            if (uidInput) {
                uidInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
        }

        async function handleQrLogin(file) {
            const statusEl = document.getElementById('loginStatus');
            statusEl.className = 'login-status loading';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning QR code...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${STAFF_API}/doctor/scan-qr`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.patient_found) {
                    statusEl.className = 'login-status success';
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Patient found: ${data.patient?.name || 'Unknown'}`;
                    
                    setTimeout(() => {
                        loginSuccess(data);
                    }, 500);
                } else if (data.decoded_uid && !data.patient_found) {
                    statusEl.className = 'login-status error';
                    statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> QR decoded (${data.decoded_uid}) but patient not found in database.`;
                } else {
                    statusEl.className = 'login-status error';
                    statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Could not read QR code. Please ensure the image is clear.';
                }
            } catch (error) {
                console.error('QR scan error:', error);
                statusEl.className = 'login-status error';
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
            }
        }

        async function handleLogin() {
            const uid = document.getElementById('loginPatientUid').value.trim();
            const statusEl = document.getElementById('loginStatus');
            const btn = document.getElementById('loginBtn');

            if (!uid) {
                statusEl.className = 'login-status error';
                statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a patient UID';
                return;
            }

            statusEl.className = 'login-status loading';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Looking up patient...';
            btn.disabled = true;

            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/full-details`);
                const data = await response.json();

                if (data.success) {
                    statusEl.className = 'login-status success';
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Patient found: ${data.patient?.name || 'Unknown'}`;
                    
                    setTimeout(() => {
                        loginSuccess(data);
                    }, 500);
                } else {
                    statusEl.className = 'login-status error';
                    statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.detail || 'Patient not found'}`;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Login error:', error);
                statusEl.className = 'login-status error';
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> Patient not found: ${error.message}`;
                btn.disabled = false;
            }
        }

        function loginSuccess(data) {
            currentPatientData = data;
            currentViewedPatient = data;
            
            const patientUid = data.patient?.uid || data.decoded_uid;
            const patientName = data.patient?.name || 'Unknown Patient';

            // Update header with patient info
            document.getElementById('currentPatientName').textContent = patientName;

            // Hide login screen, show dashboard
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardWrapper').classList.add('active');

            // Display patient details on dashboard
            displayPatientDetails(data);

            // Pre-fill patient UID across all pages
            prefillPatientUidEverywhere(patientUid);

            // Auto-load all patient data
            loadAllPatientData(patientUid, data);

            // Navigate to dashboard
            navigateTo('dashboard');
        }

        function prefillPatientUidEverywhere(patientUid) {
            // Fill all patient UID inputs across pages
            const uidInputs = [
                'timelinePatientUid',
                'kgPatientUid', 
                'cdsPatientUid',
                'outcomePatientUid',
                'aiPatientId',
                'doctorPatientUidInput',
                'aiLoadPatientUid'
            ];
            
            uidInputs.forEach(inputId => {
                const el = document.getElementById(inputId);
                if (el) el.value = patientUid;
            });
        }

        async function loadAllPatientData(patientUid, patientData) {
            // Load all patient-specific data in parallel
            console.log('Loading all data for patient:', patientUid);
            
            try {
                // Load timeline data
                loadTimelineForPatient(patientUid);
                
                // Load knowledge graph
                loadKnowledgeGraphForPatient(patientUid);
                
                // Load AI context
                loadAIContextForPatient(patientData);
                
                // Load pharmacogenomics if available
                loadPharmacogenomicsForPatient(patientUid);
                
                // Load treatment outcomes
                loadTreatmentOutcomesForPatient(patientUid);
                
            } catch (error) {
                console.error('Error loading patient data:', error);
            }
        }

        async function loadTimelineForPatient(patientUid) {
            try {
                // Load Gantt data
                const ganttResponse = await fetch(`${STAFF_API}/patient/${patientUid}/gantt`);
                const ganttData = await ganttResponse.json();
                
                // Load timeline events
                const eventsResponse = await fetch(`${STAFF_API}/patient/${patientUid}/timeline`);
                const eventsData = await eventsResponse.json();

                if (ganttData.success) {
                    document.getElementById('timelineResults').style.display = 'block';
                    document.getElementById('timelineEventsCard').style.display = 'block';
                    renderGanttChart(ganttData);
                    renderTimelineEvents(eventsData.events || []);
                    autoDetectMedicationChanges(eventsData.events || [], ganttData);
                }
                
                // Also load the prescription timeline with patient data
                loadPatientTimeline();
            } catch (error) {
                console.log('Timeline loading deferred:', error.message);
                // Still try to load prescription timeline
                loadPatientTimeline();
            }
        }

        async function loadKnowledgeGraphForPatient(patientUid) {
            try {
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/knowledge-graph`);
                const data = await response.json();
                
                if (data.success) {
                    kgCurrentData = data;
                    document.getElementById('kgPatientName').textContent = `${data.patient_name} (${patientUid})`;
                    document.getElementById('kgGraphCard').style.display = 'block';
                    document.getElementById('kgLegendCard').style.display = 'block';
                    document.getElementById('kgStats').textContent = `${data.graph.statistics.total_nodes} nodes â€¢ ${data.graph.statistics.total_edges} relationships`;
                    renderCleanKnowledgeGraph(data);
                }
            } catch (error) {
                console.log('Knowledge graph loading deferred:', error.message);
            }
        }

        function loadAIContextForPatient(patientData) {
            try {
                const patient = patientData.patient || {};
                const activeMeds = patientData.active_medications || [];
                
                // Fill AI context fields
                document.getElementById('aiPatientName').value = patient.name || '';
                document.getElementById('aiPatientAge').value = patient.age || '';
                document.getElementById('aiPatientAllergies').value = (patient.allergies || []).join(', ');
                document.getElementById('aiPatientConditions').value = (patient.conditions || []).join(', ');
                
                // Fill medications
                const medsText = activeMeds.map(med => 
                    `${med.name || med.drug_name}, ${med.dosage || ''}, ${med.frequency || ''}`
                ).join('\n');
                document.getElementById('aiPatientMedications').value = medsText;
                
                // Save context
                if (typeof savePatientContext === 'function') {
                    savePatientContext();
                }
            } catch (error) {
                console.log('AI context loading deferred:', error.message);
            }
        }

        async function loadPharmacogenomicsForPatient(patientUid) {
            try {
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/pharmacogenomics`);
                const data = await response.json();
                
                if (data.success && data.pharmacogenomics) {
                    displayPharmacogenomics(data.pharmacogenomics);
                }
            } catch (error) {
                console.log('Pharmacogenomics loading deferred:', error.message);
            }
        }

        async function loadTreatmentOutcomesForPatient(patientUid) {
            try {
                // Load vitals history
                const vitalsResponse = await fetch(`${STAFF_API}/patient/${patientUid}/vitals/history?days=90`);
                const vitalsData = await vitalsResponse.json();
                
                if (vitalsData.success && vitalsData.vitals_history) {
                    displayVitalsTrend(vitalsData.vitals_history);
                }
                
                // Load treatment outcomes
                const outcomesResponse = await fetch(`${STAFF_API}/patient/${patientUid}/outcomes`);
                const outcomesData = await outcomesResponse.json();
                
                if (outcomesData.success && outcomesData.outcomes) {
                    displayOutcomeTimeline(outcomesData.outcomes);
                }
            } catch (error) {
                console.log('Treatment outcomes loading deferred:', error.message);
            }
        }

        function handleLogout() {
            // Clear patient data
            currentPatientData = null;
            currentViewedPatient = null;

            // Reset login form
            document.getElementById('loginPatientUid').value = '';
            document.getElementById('loginStatus').className = 'login-status';
            document.getElementById('loginStatus').innerHTML = '';
            document.getElementById('loginBtn').disabled = false;

            // Show login screen, hide dashboard
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboardWrapper').classList.remove('active');

            // Clear patient view
            clearPatientView();
            
            // Clear all patient UID inputs
            clearAllPatientData();
        }

        function clearAllPatientData() {
            // Clear all patient UID inputs
            const uidInputs = [
                'timelinePatientUid',
                'kgPatientUid', 
                'cdsPatientUid',
                'outcomePatientUid',
                'aiPatientId',
                'doctorPatientUidInput',
                'aiLoadPatientUid',
                'aiPatientName',
                'aiPatientAge',
                'aiPatientAllergies',
                'aiPatientConditions',
                'aiPatientMedications'
            ];
            
            uidInputs.forEach(inputId => {
                const el = document.getElementById(inputId);
                if (el) el.value = '';
            });
            
            // Hide results sections
            const resultsToHide = [
                'timelineResults',
                'timelineEventsCard',
                'timelineMedChangesCard',
                'kgGraphCard',
                'kgLegendCard'
            ];
            
            resultsToHide.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            
            // Clear knowledge graph
            kgCurrentData = null;
            const kgContent = document.getElementById('kgGraphContent');
            if (kgContent) kgContent.innerHTML = '';
            
            // Reset header patient name
            document.getElementById('currentPatientName').textContent = 'No Patient';
        }

        // ========================================
        // Navigation
        // ========================================
        function initNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });
        }

        function navigateTo(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'patient-detail': 'Patient Details',
                'history': 'Longitudinal Patient History',
                'drug-normalize': 'Drug Normalization',
                'settings': 'Settings',
                'timeline': 'Medication Timeline',
                'knowledge-graph': 'Knowledge Graph',
                'explainability': 'Explainability & Evidence',
                'ask-ai': 'Ask AI',
                'review-queue': 'Review Queue'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            // Load page-specific content
            if (page === 'history') {
                loadLongitudinalHistoryPage();
            }
            if (page === 'explainability') {
                loadExplainabilityPageAuto();
            }
        }

        // Upload handling
        function initUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) selectFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) selectFile(file);
            });

            processBtn.addEventListener('click', processFile);

            // Collapsible
            document.getElementById('rawOcrHeader').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('rawOcrContent').classList.toggle('show');
            });
        }

        function selectFile(file) {
            selectedFile = file;
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-icon" style="background: #dcfce7; color: var(--success);">
                    <i class="fas fa-check"></i>
                </div>
                <h3>${file.name}</h3>
                <p>${(file.size / 1024).toFixed(1)} KB</p>
                <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-400);">
                    Click to change file
                </p>
            `;
            document.getElementById('processBtn').disabled = false;
        }

        async function processFile() {
            if (!selectedFile) return;

            const statusBox = document.getElementById('statusBox');
            const processBtn = document.getElementById('processBtn');

            // Show processing status
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing prescription with AI...';
            processBtn.disabled = true;
            document.getElementById('resultsContainer').classList.remove('show');

            const formData = new FormData();
            formData.append('file', selectedFile);

            const allergies = document.getElementById('allergiesInput').value;
            if (allergies) {
                formData.append('allergies', allergies);
            }

            try {
                const response = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = 'âœ“ Prescription processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = 'âœ— ' + error.message;
            } finally {
                processBtn.disabled = false;
            }
        }

        function displayResults(data) {
            document.getElementById('resultsContainer').classList.add('show');

            // Review banner
            const reviewBanner = document.getElementById('reviewBanner');
            if (data.needs_review) {
                reviewBanner.classList.remove('hidden');
                document.getElementById('reviewReason').textContent = 
                    data.review_reasons?.join(', ') || 'Manual review recommended';
            } else {
                reviewBanner.classList.add('hidden');
            }

            // Safety alerts
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';

            if (data.drug_interactions?.length > 0) {
                data.drug_interactions.forEach(int => {
                    const alertClass = int.severity === 'major' || int.severity === 'contraindicated' ? 'danger' : 'warning';
                    alertsContainer.innerHTML += `
                        <div class="alert-box ${alertClass}">
                            <span class="alert-icon">${alertClass === 'danger' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>Drug Interaction: ${int.drug1} + ${int.drug2}</h5>
                                <p><strong>Severity:</strong> ${int.severity.toUpperCase()}</p>
                                <p>${int.description}</p>
                            </div>
                        </div>
                    `;
                });
            }

            if (data.allergy_alerts?.length > 0) {
                data.allergy_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box danger">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>ALLERGY ALERT: ${alert.drug}</h5>
                                <p>Patient is allergic to ${alert.allergen}</p>
                                ${alert.cross_reactivity ? `<p><strong>Cross-reactivity:</strong> ${alert.cross_reactivity}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            if (data.safety_alerts?.length > 0) {
                data.safety_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box warning">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <h5>${alert}</h5>
                            </div>
                        </div>
                    `;
                });
            }

            // Prescription date
            document.getElementById('prescriptionDate').textContent = data.prescription_date || 'Date not found';

            // Patient info
            setField('resultPatientName', data.patient_name);
            setField('resultAgeGender', formatAgeGender(data.patient_age, data.patient_gender));
            setField('resultPatientId', data.patient_id);
            setField('resultPatientPhone', data.patient_phone);
            setField('resultPatientAddress', data.patient_address);

            // Doctor info
            setField('resultDoctorName', data.doctor_name);
            setField('resultDoctorQual', data.doctor_qualification);
            setField('resultClinic', data.clinic_name);
            setField('resultDoctorRegNo', data.doctor_reg_no);

            // Diagnosis
            const diagnosisList = document.getElementById('diagnosisList');
            diagnosisList.innerHTML = '';
            if (data.diagnosis?.length > 0) {
                data.diagnosis.forEach(d => {
                    diagnosisList.innerHTML += `<span class="tag">${d}</span>`;
                });
                document.getElementById('diagnosisSection').style.display = 'block';
            } else {
                document.getElementById('diagnosisSection').style.display = 'none';
            }

            // Vitals
            const vitalsGrid = document.getElementById('vitalsGrid');
            vitalsGrid.innerHTML = '';
            if (data.vitals && Object.keys(data.vitals).length > 0) {
                for (const [key, value] of Object.entries(data.vitals)) {
                    if (value) {
                        vitalsGrid.innerHTML += `
                            <div class="vital-item">
                                <label>${formatVitalName(key)}</label>
                                <span>${value}</span>
                            </div>
                        `;
                    }
                }
                document.getElementById('vitalsSection').style.display = 'block';
            } else {
                document.getElementById('vitalsSection').style.display = 'none';
            }

            // Medications
            const medCount = data.medications?.length || 0;
            const medsList = document.getElementById('medicationsList');
            medsList.innerHTML = '';
            document.getElementById('medBadge').textContent = medCount + ' items';

            // Get interaction drugs for highlighting
            const interactionDrugs = new Set();
            data.drug_interactions?.forEach(i => {
                interactionDrugs.add(i.drug1.toLowerCase());
                interactionDrugs.add(i.drug2.toLowerCase());
            });

            if (medCount > 0) {
                data.medications.forEach((med) => {
                    const hasInteraction = interactionDrugs.has(med.name?.toLowerCase());
                    const statusBadge = hasInteraction 
                        ? '<span class="badge badge-warning">âš ï¸ Interaction</span>'
                        : '<span class="badge badge-success">âœ“ Safe</span>';
                    
                    medsList.innerHTML += `
                        <tr>
                            <td>
                                <div class="med-name">${med.name || 'Unknown'}</div>
                                ${med.form ? `<div class="med-form">${med.form}</div>` : ''}
                            </td>
                            <td class="med-dosage">${med.dosage || '-'}</td>
                            <td>
                                ${med.frequency || '-'}
                                ${med.timing ? `<div style="font-size: 0.75rem; color: var(--gray-500);">${med.timing}</div>` : ''}
                            </td>
                            <td>${med.duration || '-'}</td>
                            <td>${med.instructions || '-'}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            } else {
                medsList.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            No medications found in prescription
                        </td>
                    </tr>
                `;
            }

            // Confidence
            const confidence = Math.round((data.confidence || 0) * 100);
            const confidenceFill = document.getElementById('confidenceFill');
            confidenceFill.style.width = confidence + '%';
            confidenceFill.className = 'confidence-fill ' + (confidence >= 70 ? 'high' : confidence >= 40 ? 'medium' : 'low');
            document.getElementById('confidenceText').textContent = confidence + '%';

            // Advice
            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';
            if (data.advice?.length > 0) {
                data.advice.forEach(a => {
                    adviceList.innerHTML += `<span class="tag">${a}</span>`;
                });
                document.getElementById('adviceSection').style.display = 'block';
            } else {
                document.getElementById('adviceSection').style.display = 'none';
            }

            // Follow-up
            document.getElementById('followUpDate').textContent = data.follow_up || 'Not specified';

            // Raw text
            document.getElementById('rawText').textContent = data.raw_ocr_text || 'No OCR text available';

            // Add to history
            addToHistory(data);
        }

        function setField(id, value) {
            const el = document.getElementById(id);
            if (value) {
                el.textContent = value;
                el.classList.remove('missing');
            } else {
                el.textContent = 'Not found';
                el.classList.add('missing');
            }
        }

        function formatAgeGender(age, gender) {
            const parts = [];
            if (age) parts.push(age);
            if (gender) parts.push(gender);
            return parts.join(' / ') || null;
        }

        function formatVitalName(key) {
            const names = {
                'blood_pressure': 'BP',
                'temperature': 'Temp',
                'pulse': 'Pulse',
                'spo2': 'SpO2',
                'weight': 'Weight'
            };
            return names[key] || key.replace(/_/g, ' ').toUpperCase();
        }

        function updateStats(data) {
            stats.scans++;
            stats.meds += data.medications?.length || 0;
            stats.alerts += (data.drug_interactions?.length || 0) + (data.allergy_alerts?.length || 0);
            stats.totalConfidence += (data.confidence || 0);

            document.getElementById('totalScans').textContent = stats.scans;
            document.getElementById('totalMeds').textContent = stats.meds;
            document.getElementById('alertsFound').textContent = stats.alerts;
            document.getElementById('avgConfidence').textContent = 
                Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
            document.getElementById('alertBadge').textContent = stats.alerts;
        }

        function loadStats() {
            // Load from localStorage or API
            const saved = localStorage.getItem('medicalGatewayStats');
            if (saved) {
                stats = JSON.parse(saved);
                document.getElementById('totalScans').textContent = stats.scans;
                document.getElementById('totalMeds').textContent = stats.meds;
                document.getElementById('alertsFound').textContent = stats.alerts;
                document.getElementById('alertBadge').textContent = stats.alerts;
                if (stats.scans > 0) {
                    document.getElementById('avgConfidence').textContent = 
                        Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
                }
            }
        }

        function addToHistory(data) {
            prescriptionHistory.unshift({
                id: data.document_id || Date.now().toString(),
                patient: data.patient_name || 'Unknown',
                date: data.prescription_date || new Date().toLocaleDateString(),
                medCount: data.medications?.length || 0,
                confidence: Math.round((data.confidence || 0) * 100),
                status: data.needs_review ? 'Review' : 'Complete',
                data: data
            });

            updateHistoryTable();
            updateRecentTable();

            // Save stats
            localStorage.setItem('medicalGatewayStats', JSON.stringify(stats));
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyList');
            if (prescriptionHistory.length === 0) return;

            tbody.innerHTML = prescriptionHistory.map(p => `
                <tr>
                    <td><code style="font-size: 0.75rem;">${p.id.substring(0, 8)}...</code></td>
                    <td>${p.patient}</td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <div class="confidence-meter" style="width: 100px;">
                            <div class="confidence-bar">
                                <div class="confidence-fill ${p.confidence >= 70 ? 'high' : p.confidence >= 40 ? 'medium' : 'low'}" style="width: ${p.confidence}%;"></div>
                            </div>
                            <span style="font-size: 0.75rem;">${p.confidence}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentTable() {
            const tbody = document.getElementById('recentPrescriptions');
            const recent = prescriptionHistory.slice(0, 5);
            
            if (recent.length === 0) return;

            tbody.innerHTML = recent.map(p => `
                <tr>
                    <td>
                        <div class="patient-row">
                            <div class="patient-avatar">${(p.patient[0] || '?').toUpperCase()}</div>
                            <div class="patient-info">
                                <span class="patient-name">${p.patient}</span>
                            </div>
                        </div>
                    </td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewPrescription(id) {
            const prescription = prescriptionHistory.find(p => p.id === id);
            if (prescription) {
                navigateTo('scan');
                displayResults(prescription.data);
            }
        }

        function resetScan() {
            selectedFile = null;
            currentResult = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('allergiesInput').value = '';
            document.getElementById('patientNameInput').value = '';
            document.getElementById('statusBox').classList.remove('show');
            document.getElementById('resultsContainer').classList.remove('show');
            document.getElementById('processBtn').disabled = true;
            
            document.getElementById('uploadZone').innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Drop prescription here</h3>
                <p>or click to browse files</p>
                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                    Supports: PDF, PNG, JPG, JPEG, TIFF
                </p>
            `;
        }

        function copyToClipboard() {
            if (!currentResult) return;

            let text = `PRESCRIPTION SUMMARY\n`;
            text += `==================\n\n`;
            text += `Patient: ${currentResult.patient_name || 'N/A'}\n`;
            text += `Date: ${currentResult.prescription_date || 'N/A'}\n`;
            text += `Doctor: ${currentResult.doctor_name || 'N/A'}\n\n`;
            text += `MEDICATIONS:\n`;

            currentResult.medications?.forEach((med, i) => {
                text += `${i+1}. ${med.name} ${med.dosage || ''}\n`;
                text += `   ${med.frequency || ''} ${med.timing || ''} ${med.duration || ''}\n`;
            });

            if (currentResult.drug_interactions?.length > 0) {
                text += `\nâš ï¸ DRUG INTERACTIONS:\n`;
                currentResult.drug_interactions.forEach(i => {
                    text += `- ${i.drug1} + ${i.drug2}: ${i.description}\n`;
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                alert('Summary copied to clipboard!');
            });
        }

        function exportJSON() {
            if (!currentResult) return;

            const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prescription_${currentResult.document_id || Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function savePrescription() {
            if (!currentResult) return;
            alert('Prescription saved to database!');
        }

        // Modal functions
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function openTextInput() {
            openModal('textInputModal');
        }

        async function processManualText() {
            const text = document.getElementById('manualText').value;
            const allergies = document.getElementById('manualAllergies').value;
            
            if (!text.trim()) {
                alert('Please enter prescription text');
                return;
            }

            closeModal('textInputModal');
            navigateTo('scan');

            const statusBox = document.getElementById('statusBox');
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing text...';

            try {
                const formData = new FormData();
                formData.append('text', text);
                if (allergies) formData.append('allergies', allergies);

                const response = await fetch(`${API_BASE}/api/documents/extract-text`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = 'âœ“ Text processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = 'âœ— ' + error.message;
            }
        }

        async function checkInteractions() {
            const drugs = document.getElementById('interactionDrugs').value;
            if (!drugs.trim()) {
                alert('Please enter medications');
                return;
            }

            const resultsDiv = document.getElementById('interactionResults');
            resultsDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking interactions...</div>';

            try {
                const formData = new FormData();
                formData.append('medications', drugs);

                const response = await fetch(`${API_BASE}/api/documents/check-interactions`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Check failed');
                }

                if (data.drug_interactions?.length > 0) {
                    resultsDiv.innerHTML = data.drug_interactions.map(i => `
                        <div class="alert-box ${i.severity === 'major' || i.severity === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${i.severity === 'major' || i.severity === 'contraindicated' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${i.drug1} + ${i.drug2}</h5>
                                <p><strong>Severity:</strong> ${i.severity.toUpperCase()}</p>
                                <p>${i.description}</p>
                                ${i.management ? `<p><strong>Management:</strong> ${i.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No interactions found</h5>
                                <p>The entered medications (${data.medications_checked.join(', ')}) appear to be safe to use together.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert-box danger">
                        <span class="alert-icon">âŒ</span>
                        <div class="alert-content">
                            <h5>Error</h5>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function saveSettings() {
            localStorage.setItem('apiEndpoint', document.getElementById('apiEndpoint').value);
            localStorage.setItem('defaultMode', document.getElementById('defaultMode').value);
            localStorage.setItem('autoSave', document.getElementById('autoSave').checked);
            alert('Settings saved!');
        }

        // ==================== Patient Prescription Management ====================
        const PATIENT_API = '/api/v2/patient-prescriptions';
        
        let currentPatientId = null;
        let selectedFiles = [];
        let allTimelineEvents = [];

        // Initialize patient upload area
        document.addEventListener('DOMContentLoaded', () => {
            initPatientUpload();
            refreshPatientList();
        });

        function initPatientUpload() {
            const uploadZone = document.getElementById('multiUploadZone');
            const fileInput = document.getElementById('multiFileInput');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--success)';
                uploadZone.style.background = 'rgba(34, 197, 94, 0.05)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
                handleFilesSelected(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFilesSelected(e.target.files);
            });
        }

        function handleFilesSelected(files) {
            selectedFiles = Array.from(files);
            
            if (selectedFiles.length === 0) return;

            const previewArea = document.getElementById('selectedFilesPreview');
            const filesList = document.getElementById('filesListPreview');
            
            previewArea.style.display = 'block';
            
            filesList.innerHTML = selectedFiles.map((f, idx) => `
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                    <i class="fas fa-file-image" style="color: var(--primary);"></i>
                    <span style="flex: 1;">${f.name}</span>
                    <span style="color: var(--gray-500); font-size: 0.75rem;">${(f.size / 1024).toFixed(1)} KB</span>
                    <span class="badge" id="fileStatus${idx}">Pending</span>
                </div>
            `).join('');
        }

        function clearSelectedFiles() {
            selectedFiles = [];
            document.getElementById('multiFileInput').value = '';
            document.getElementById('selectedFilesPreview').style.display = 'none';
            document.getElementById('filesListPreview').innerHTML = '';
        }

        function selectPatient() {
            const patientId = document.getElementById('patientIdInput').value.trim();
            const patientName = document.getElementById('patientNameInput').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }

            currentPatientId = patientId;
            
            // Show upload area
            document.getElementById('noPatientSelectedMsg').style.display = 'none';
            document.getElementById('prescriptionUploadArea').style.display = 'block';
            
            // Update badge
            const badge = document.getElementById('selectedPatientBadge');
            badge.style.display = 'inline-block';
            badge.textContent = `Patient: ${patientId}${patientName ? ` (${patientName})` : ''}`;
            badge.style.background = 'var(--success)';
            badge.style.color = 'white';
            
            // Check if patient exists
            checkExistingPatient(patientId);
        }

        async function checkExistingPatient(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}`);
                if (response.ok) {
                    const patient = await response.json();
                    // Auto-fill fields
                    if (patient.name) document.getElementById('patientNameInput').value = patient.name;
                    if (patient.allergies?.length) document.getElementById('patientAllergiesInput').value = patient.allergies.join(', ');
                    if (patient.chronic_conditions?.length) document.getElementById('patientConditionsInput').value = patient.chronic_conditions.join(', ');
                }
            } catch (e) {
                // Patient doesn't exist yet, that's fine
            }
        }

        async function refreshPatientList() {
            try {
                const response = await fetch(`${PATIENT_API}/patients`);
                const patients = await response.json();
                
                const container = document.getElementById('existingPatientsList');
                document.getElementById('totalPatientsCount').textContent = patients.length;
                
                // Calculate totals
                let totalRx = 0, totalMeds = 0;
                patients.forEach(p => {
                    totalRx += p.prescriptions_count || 0;
                    totalMeds += p.active_medications || 0;
                });
                document.getElementById('totalPrescriptionsCount').textContent = totalRx;
                document.getElementById('activeMedicationsCount').textContent = totalMeds;
                
                if (patients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                            <p style="margin-top: 0.5rem;">No patients yet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = patients.map(p => `
                    <div class="patient-list-item" onclick="loadPatientDetail('${p.patient_id}')" 
                         style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.2s;"
                         onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                        <div>
                            <div style="font-weight: 500;">${p.name}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">ID: ${p.patient_id}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem;">${p.prescriptions_count} Rx</div>
                            <div style="font-size: 0.7rem; color: var(--gray-500);">${p.active_medications} active meds</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load patients:', e);
            }
        }

        async function processAllPrescriptions() {
            if (!currentPatientId) {
                alert('Please select a patient first');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const patientName = document.getElementById('patientNameInput').value.trim();
            const allergies = document.getElementById('patientAllergiesInput').value.trim();
            const conditions = document.getElementById('patientConditionsInput').value.trim();

            // Show processing status
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('processAllBtn').disabled = true;
            
            const progressDiv = document.getElementById('processingProgress');
            const results = [];
            const errors = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                // Update status
                document.getElementById('processingText').textContent = `Processing ${i + 1} of ${selectedFiles.length}: ${file.name}`;
                document.getElementById(`fileStatus${i}`).textContent = 'Processing...';
                document.getElementById(`fileStatus${i}`).style.background = 'var(--warning)';
                document.getElementById(`fileStatus${i}`).style.color = 'white';

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('patient_id', currentPatientId);
                    if (patientName) formData.append('patient_name', patientName);
                    if (allergies) formData.append('allergies', allergies);
                    if (conditions) formData.append('conditions', conditions);

                    const response = await fetch(`${PATIENT_API}/scan`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        results.push({
                            file: file.name,
                            prescription_number: data.analysis.prescription_number,
                            changes: data.analysis.changes_detected,
                            safety: data.analysis.safety_analysis
                        });
                        
                        document.getElementById(`fileStatus${i}`).textContent = 'âœ“ Done';
                        document.getElementById(`fileStatus${i}`).style.background = 'var(--success)';
                        
                        // Show changes in progress
                        const changes = data.analysis.changes_detected;
                        if (changes.new_medications?.length || changes.stopped_medications?.length || changes.dose_changes?.length) {
                            progressDiv.innerHTML += `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; font-size: 0.8rem;">
                                    <strong>Rx #${data.analysis.prescription_number}:</strong>
                                    ${changes.new_medications?.length ? `<span style="color: var(--success);">+${changes.new_medications.length} new</span>` : ''}
                                    ${changes.stopped_medications?.length ? `<span style="color: var(--danger);"> -${changes.stopped_medications.length} stopped</span>` : ''}
                                    ${changes.dose_changes?.length ? `<span style="color: var(--warning);"> ${changes.dose_changes.length} changed</span>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        throw new Error(data.detail || 'Processing failed');
                    }
                } catch (e) {
                    errors.push({ file: file.name, error: e.message });
                    document.getElementById(`fileStatus${i}`).textContent = 'âœ— Error';
                    document.getElementById(`fileStatus${i}`).style.background = 'var(--danger)';
                }
            }

            // Show completion
            document.getElementById('processingText').textContent = `âœ“ Completed: ${results.length} of ${selectedFiles.length} processed`;
            document.getElementById('processAllBtn').disabled = false;

            // Show results card
            document.getElementById('uploadResultsCard').style.display = 'block';
            document.getElementById('uploadResultsSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #059669;">${results.length}</div>
                        <div style="font-size: 0.8rem; color: #065f46;">Successfully Processed</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #d97706;">${results.reduce((sum, r) => sum + (r.changes?.new_medications?.length || 0), 0)}</div>
                        <div style="font-size: 0.8rem; color: #92400e;">New Medications</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: ${errors.length ? '#fee2e2' : '#e0f2fe'}; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: ${errors.length ? '#dc2626' : '#0284c7'};">${errors.length || 'None'}</div>
                        <div style="font-size: 0.8rem; color: ${errors.length ? '#991b1b' : '#075985'};">Errors</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="loadPatientDetail('${currentPatientId}')">
                    <i class="fas fa-user"></i> View Patient Timeline & Details
                </button>
            `;

            // Refresh patient list
            refreshPatientList();
        }

        async function loadPatientDetail(patientId) {
            currentPatientId = patientId;
            
            // Navigate to detail page
            navigateTo('patient-detail');
            
            try {
                // Load patient summary
                const summaryRes = await fetch(`${PATIENT_API}/patients/${patientId}/summary`);
                const summary = await summaryRes.json();
                
                currentPatientData = summary;
                
                // Update header
                document.getElementById('patientDetailName').textContent = summary.patient.name || patientId;
                
                // Update stats
                document.getElementById('detailPrescriptionCount').textContent = summary.statistics.total_prescriptions;
                document.getElementById('detailActiveMeds').textContent = summary.statistics.current_active_medications;
                document.getElementById('detailDiscontinuedMeds').textContent = summary.statistics.discontinued_medications;
                document.getElementById('detailTimelineEvents').textContent = summary.statistics.timeline_events;
                
                // Risk level
                const riskLevel = summary.patient.safety_alerts?.length > 0 ? 'HIGH' : 'LOW';
                document.getElementById('detailRiskLevel').textContent = riskLevel;
                document.getElementById('detailRiskCard').style.background = riskLevel === 'HIGH' ? 
                    'linear-gradient(135deg, #fef2f2, #fee2e2)' : 'linear-gradient(135deg, #f0fdf4, #dcfce7)';
                
                // Patient basic info
                document.getElementById('detailPatientId').textContent = summary.patient.patient_id;
                document.getElementById('detailAgeGender').textContent = 
                    `${summary.patient.age || 'Unknown'} / ${summary.patient.gender || 'Unknown'}`;
                document.getElementById('detailBloodGroup').textContent = summary.patient.blood_group || '-';
                document.getElementById('detailDoctors').textContent = 
                    summary.all_doctors?.length ? summary.all_doctors.join(', ') : '-';
                
                // Render allergies with color-coded badges
                renderAllergyBadges(summary.patient.allergies || []);
                
                // Render conditions with color-coded badges
                renderConditionBadges(summary.patient.chronic_conditions || []);
                
                // Safety alerts
                const alertsCard = document.getElementById('safetyAlertsCard');
                const alertsContainer = document.getElementById('safetyAlertsContainer');
                
                if (summary.patient.safety_alerts?.length > 0) {
                    alertsCard.style.display = 'block';
                    document.getElementById('activeAlertsCount').textContent = summary.patient.safety_alerts.length;
                    alertsContainer.innerHTML = summary.patient.safety_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>${alert.type?.toUpperCase() || 'ALERT'}: ${alert.drugs?.join(' + ') || alert.drug || 'Unknown'}</h5>
                                <p>${alert.description || ''}</p>
                                ${alert.action_required ? `<p style="color: var(--danger);"><strong>Action:</strong> ${alert.action_required}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    alertsCard.style.display = 'none';
                    document.getElementById('activeAlertsCount').textContent = '0';
                }
                
                // Current medications
                const medsContainer = document.getElementById('currentMedicationsContainer');
                if (summary.patient.current_medications?.length > 0) {
                    medsContainer.innerHTML = summary.patient.current_medications.map(med => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: 500;">${med.name}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.generic_name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: var(--primary);">${med.dosage}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.frequency}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    medsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No active medications</p>
                        </div>
                    `;
                }
                
                // Load timeline
                loadPatientTimeline(patientId);
                
                // Load prescriptions table
                loadPrescriptionsTable(summary.patient.prescriptions);
                
                // Auto-set AI context with patient data for AI queries
                autoSetAIPatientContext(patientId, summary);
                
            } catch (e) {
                console.error('Failed to load patient:', e);
                alert('Failed to load patient details: ' + e.message);
            }
        }

        async function loadPatientTimeline(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}/timeline`);
                const data = await response.json();
                
                allTimelineEvents = data.timeline || [];
                renderTimeline(allTimelineEvents);
            } catch (e) {
                console.error('Failed to load timeline:', e);
            }
        }

        function filterTimeline() {
            const filter = document.getElementById('timelineFilter').value;
            const filtered = filter ? 
                allTimelineEvents.filter(e => e.event_type === filter) : 
                allTimelineEvents;
            renderTimeline(filtered);
        }

        function renderTimeline(events) {
            const container = document.getElementById('timelineContainer');
            
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                        <p>No timeline events</p>
                    </div>
                `;
                return;
            }

            const eventIcons = {
                'prescription_added': { icon: 'fa-file-medical', color: '#3b82f6' },
                'medication_started': { icon: 'fa-plus-circle', color: '#22c55e' },
                'medication_stopped': { icon: 'fa-minus-circle', color: '#ef4444' },
                'medication_changed': { icon: 'fa-exchange-alt', color: '#f59e0b' },
                'medication_restarted': { icon: 'fa-redo', color: '#8b5cf6' },
                'diagnosis_recorded': { icon: 'fa-stethoscope', color: '#06b6d4' },
                'safety_alert': { icon: 'fa-exclamation-triangle', color: '#dc2626' }
            };

            container.innerHTML = events.map(event => {
                const config = eventIcons[event.event_type] || { icon: 'fa-circle', color: '#6b7280' };
                return `
                    <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: ${config.color}20; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="font-weight: 500;">${event.description}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${event.event_date}</div>
                            </div>
                            ${event.details ? `
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-600); background: var(--gray-50); padding: 0.5rem; border-radius: 6px;">
                                    ${Object.entries(event.details).filter(([k, v]) => v && k !== 'diagnosis').map(([k, v]) => 
                                        `<span style="margin-right: 1rem;"><strong>${k.replace(/_/g, ' ')}:</strong> ${Array.isArray(v) ? v.join(', ') : v}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadPrescriptionsTable(prescriptions) {
            const tbody = document.getElementById('prescriptionsTableBody');
            
            if (!prescriptions || prescriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            No prescriptions yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = prescriptions.map((rx, idx) => `
                <tr>
                    <td><strong>#${idx + 1}</strong></td>
                    <td>${rx.prescription_date || '-'}</td>
                    <td>
                        <div>${rx.doctor_name || 'Unknown'}</div>
                        <div style="font-size: 0.7rem; color: var(--gray-500);">${rx.clinic_name || ''}</div>
                    </td>
                    <td>${rx.diagnosis?.join(', ') || '-'}</td>
                    <td>
                        ${rx.medications?.map(m => `<span class="tag" style="margin: 0.125rem;">${m.name || m}</span>`).join('') || '-'}
                    </td>
                    <td style="font-size: 0.75rem; color: var(--gray-500);">${rx.file_name || '-'}</td>
                </tr>
            `).join('');
        }

        function refreshPatientDetail() {
            if (currentPatientId) {
                loadPatientDetail(currentPatientId);
            }
        }

        // ==================== Enhanced Features ====================
        const API_V2_BASE = '/api/v2';

        // ==================== Drug Normalization Functions ====================
        
        async function normalizeSingleDrug() {
            const drugName = document.getElementById('normalizeDrugInput').value.trim();
            if (!drugName) {
                alert('Please enter a drug name');
                return;
            }

            const resultDiv = document.getElementById('normalizeResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Looking up drug...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/normalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug_name: drugName })
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="info-block" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${data.generic_name}</h4>
                                <p style="font-size: 0.75rem; color: var(--gray-500);">
                                    ${data.is_brand_name ? `Brand name: ${data.original_name}` : 'Generic name'}
                                </p>
                            </div>
                            <span class="badge" style="background: ${data.confidence > 0.8 ? '#dcfce7' : '#fef3c7'}; color: ${data.confidence > 0.8 ? '#059669' : '#d97706'};">
                                ${Math.round(data.confidence * 100)}% confidence
                            </span>
                        </div>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Drug Class</strong>
                                <p style="font-size: 0.875rem;">${data.drug_class.replace(/_/g, ' ')}</p>
                            </div>
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Common Dosages</strong>
                                <p style="font-size: 0.875rem;">${data.common_dosages?.join(', ') || 'N/A'}</p>
                            </div>
                        </div>
                        ${data.brand_names?.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Known Brand Names</strong>
                                <p style="font-size: 0.875rem;">${data.brand_names.slice(0, 6).join(', ')}${data.brand_names.length > 6 ? '...' : ''}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Update counter
                const counter = document.getElementById('totalDrugsNormalized');
                counter.textContent = parseInt(counter.textContent) + 1;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function compareDrugs() {
            const drug1 = document.getElementById('compareDrug1').value.trim();
            const drug2 = document.getElementById('compareDrug2').value.trim();
            if (!drug1 || !drug2) {
                alert('Please enter both drug names');
                return;
            }

            const resultDiv = document.getElementById('compareResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Comparing drugs...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/compare`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug1, drug2 })
                });
                const data = await response.json();

                const isSame = data.is_same_drug;
                resultDiv.innerHTML = `
                    <div class="alert-box ${isSame ? 'warning' : 'info'}">
                        <span class="alert-icon">${isSame ? 'âš ï¸' : 'âœ…'}</span>
                        <div class="alert-content">
                            <h5>${isSame ? 'Same Medication!' : 'Different Medications'}</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                <div>
                                    <strong>${data.drug1.original}</strong><br>
                                    Generic: ${data.drug1.generic}<br>
                                    Class: ${data.drug1.class.replace(/_/g, ' ')}
                                </div>
                                <div>
                                    <strong>${data.drug2.original}</strong><br>
                                    Generic: ${data.drug2.generic}<br>
                                    Class: ${data.drug2.class.replace(/_/g, ' ')}
                                </div>
                            </div>
                            ${isSame ? `<p style="margin-top: 0.5rem; color: var(--warning);"><strong>Warning:</strong> These are the same medication under different names!</p>` : ''}
                            ${data.same_class && !isSame ? `<p style="margin-top: 0.5rem; color: var(--info);">Note: Same therapeutic class - check for duplicate therapy.</p>` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        // ==================== Timeline Functions (with Auto Medication Changes) ====================

        // Get patient data dynamically from login
        function getTimelinePatientData() {
            const patient = currentPatientData?.patient || {};
            return {
                name: patient.name || 'Unknown Patient',
                uid: patient.uid || currentPatientData?.decoded_uid || 'N/A',
                age: patient.age || patient.demographic?.age || 'N/A',
                gender: patient.gender || patient.demographic?.gender || 'N/A',
                hospital: patient.hospital || patient.facility || 'Hospital',
                prescriptions: [
                {
                    id: 1,
                    date: "2025-03-08",
                    visitDate: "08/03/2025 6:55PM",
                    opNo: "33701",
                    doctor: "Dr. Harshal Chandrashekhar Pilodekar",
                    specialization: "INTERNAL MEDICINE",
                    chiefComplaint: "Cough (2 months), GERD, Allergic Bronchitis",
                    diagnosis: "GERD with Allergic Bronchitis",
                    medications: [
                        { name: "CAP NEXPRO RD 40 MG", generic: "Esomeprazole + Domperidone", dosage: "0-0-1", duration: "10 Days", route: "Oral", instruction: "1/2 hr before food" },
                        { name: "SYP GRILINCTUS-L", generic: "Levocloperastine Fendizoate", dosage: "10ml 1-0-1", duration: "5 Days", route: "Oral", instruction: "" },
                        { name: "TAB LEVOCET M", generic: "Levocetirizine + Montelukast", dosage: "0-0-1", duration: "10 Days", route: "Oral", instruction: "" }
                    ]
                },
                {
                    id: 2,
                    date: "2025-06-06",
                    visitDate: "06/06/2025 6:40PM",
                    opNo: "75970",
                    doctor: "Dr. Harshal Chandrashekhar Pilodekar",
                    specialization: "INTERNAL MEDICINE",
                    chiefComplaint: "Acute Gastroenteritis",
                    diagnosis: "ACUTE GASTROENTERITIS",
                    medications: [
                        { name: "CYRA D 10 TAB", generic: "Rabeprazole Sodium + Domperidone SR", dosage: "0-0-1", duration: "5 Days", route: "Oral", instruction: "Before Meal" },
                        { name: "TAB O2", generic: "Ofloxacin + Ornidazole", dosage: "1-0-1", duration: "5 Days", route: "Oral", instruction: "After Meal" },
                        { name: "TAB CYCLOPAM", generic: "Dicyclomine + Paracetamol", dosage: "When Required", duration: "10 Days", route: "Oral", instruction: "à¤ªà¥‹à¤Ÿà¤¦à¥à¤–à¥€ (Stomach pain)" },
                        { name: "TAB SUMOL 650 MG", generic: "Paracetamol", dosage: "When Required", duration: "10 Days", route: "Oral", instruction: "à¤¤à¤¾à¤ª (Fever)" },
                        { name: "TAB RIDOL", generic: "Loperamide", dosage: "1-0-1", duration: "1 Day", route: "Oral", instruction: "à¤œà¥à¤²à¤¾à¤¬ (Diarrhea)" },
                        { name: "T-ULTRANSR", generic: "Ultranserin", dosage: "1 Tab", duration: "5 Days", route: "Oral", instruction: "Handwritten addition" }
                    ]
                },
                {
                    id: 3,
                    date: "2025-07-19",
                    visitDate: "19/07/2025 3:30PM",
                    opNo: "97395",
                    doctor: "Dr. Jayesh Chandrakant Dhake",
                    specialization: "ORTHOSURGEN",
                    chiefComplaint: "LOW BACK PAIN, H/O LIFTING HEAVY OBJECT",
                    diagnosis: "Lumbar Strain / Back Pain",
                    investigation: "X-RAY LS SPINE - AP/LAT, MRI LS Spine (advised)",
                    medications: [
                        { name: "TAB FLEXURA-D", generic: "Diclofenac + Metaxalone", dosage: "1-0-1", duration: "10 Days", route: "Oral", instruction: "" },
                        { name: "TAB NICOPENTA 40 MG", generic: "Pantoprazole", dosage: "1-0-1", duration: "10 Days", route: "Oral", instruction: "" },
                        { name: "TAB SKELOCAL-CT", generic: "Calcium Citrate + Calcitriol + Vitamin K2-7 + Zinc Sulphate", dosage: "1-0-0", duration: "10 Days", route: "Oral", instruction: "" },
                        { name: "TAB VITENCIAL", generic: "Multivitamin + B12", dosage: "1-0-0", duration: "10 Days", route: "Oral", instruction: "" }
                    ]
                }
            ]
            };
        }

        function loadPatientTimeline() {
            const patientData = getTimelinePatientData();
            
            // Show all cards
            document.getElementById('chronologicalTimelineCard').style.display = 'block';
            document.getElementById('timelineResults').style.display = 'block';
            document.getElementById('medStartStopCard').style.display = 'block';
            document.getElementById('overlapDetectionCard').style.display = 'block';
            document.getElementById('visitChangesCard').style.display = 'block';
            document.getElementById('comparisonCard').style.display = 'block';
            
            // Render all sections
            renderChronologicalTimeline(patientData);
            renderDemoGanttChart(patientData);
            renderMedStartStop(patientData);
            detectOverlappingMedications(patientData);
            renderVisitChanges(patientData);
            renderCurrentVsPastComparison(patientData);
        }

        function renderChronologicalTimeline(patient) {
            const container = document.getElementById('chronologicalTimeline');
            document.getElementById('prescriptionCount').textContent = `${patient.prescriptions.length} Prescriptions`;
            
            container.innerHTML = `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 50px; height: 50px; background: #0284c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; font-weight: 700;">
                            ${patient.name.charAt(0)}
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #0369a1;">${patient.name}</h3>
                            <p style="margin: 0.25rem 0 0 0; color: #0284c7; font-size: 0.9rem;">
                                UHID: ${patient.uid} â€¢ ${patient.age} Yrs/${patient.gender} â€¢ ${patient.hospital}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="position: relative; padding-left: 30px;">
                    <div style="position: absolute; left: 14px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #3b82f6, #8b5cf6, #ec4899);"></div>
                    
                    ${patient.prescriptions.map((presc, idx) => `
                        <div style="position: relative; margin-bottom: 2rem; animation: fadeInUp 0.5s ease-out ${idx * 0.1}s both;">
                            <div style="position: absolute; left: -22px; width: 16px; height: 16px; background: ${idx === patient.prescriptions.length - 1 ? '#10b981' : '#3b82f6'}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                            
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <div style="background: ${idx === patient.prescriptions.length - 1 ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #3b82f6, #2563eb)'}; color: white; padding: 1rem 1.25rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                        <div>
                                            <div style="font-weight: 700; font-size: 1.1rem;">
                                                ${presc.visitDate}
                                                ${idx === patient.prescriptions.length - 1 ? '<span style="background: rgba(255,255,255,0.3); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">LATEST</span>' : ''}
                                            </div>
                                            <div style="font-size: 0.85rem; opacity: 0.9;">OP No: ${presc.opNo}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600;">${presc.doctor}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.9;">${presc.specialization}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding: 1.25rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <span style="background: #fef3c7; color: #92400e; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500;">
                                            <i class="fas fa-stethoscope" style="margin-right: 0.35rem;"></i>${presc.chiefComplaint}
                                        </span>
                                        ${presc.diagnosis ? `<span style="background: #fee2e2; color: #991b1b; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; margin-left: 0.5rem;"><i class="fas fa-diagnoses" style="margin-right: 0.35rem;"></i>${presc.diagnosis}</span>` : ''}
                                    </div>
                                    ${presc.investigation ? `<div style="margin-bottom: 1rem; padding: 0.75rem; background: #faf5ff; border-radius: 8px; font-size: 0.9rem;"><i class="fas fa-x-ray" style="margin-right: 0.5rem; color: #7c3aed;"></i><strong>Investigation:</strong> ${presc.investigation}</div>` : ''}
                                    
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                        <thead>
                                            <tr style="background: #f8fafc;">
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">#</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">Drug Name</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">Generic</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">Dosage</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">Duration</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #e5e7eb; color: #64748b;">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${presc.medications.map((med, medIdx) => `
                                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                                    <td style="padding: 0.75rem; color: #64748b;">${medIdx + 1}</td>
                                                    <td style="padding: 0.75rem; font-weight: 600; color: #1e40af;">${med.name}</td>
                                                    <td style="padding: 0.75rem; color: #64748b; font-size: 0.85rem;">${med.generic}</td>
                                                    <td style="padding: 0.75rem;"><span style="background: #dbeafe; color: #1e40af; padding: 0.2rem 0.5rem; border-radius: 4px; font-family: monospace;">${med.dosage}</span></td>
                                                    <td style="padding: 0.75rem;"><span style="background: #dcfce7; color: #166534; padding: 0.2rem 0.5rem; border-radius: 4px;">${med.duration}</span></td>
                                                    <td style="padding: 0.75rem; font-size: 0.85rem; color: #d97706;">${med.instruction || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderDemoGanttChart(patient) {
            const container = document.getElementById('timelineChart');
            
            // Build medication periods
            const allMeds = [];
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
            
            patient.prescriptions.forEach((presc, prescIdx) => {
                presc.medications.forEach((med, medIdx) => {
                    const startDate = new Date(presc.date);
                    const durationMatch = med.duration.match(/(\d+)/);
                    const days = durationMatch ? parseInt(durationMatch[1]) : 5;
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + days);
                    
                    allMeds.push({
                        name: med.name,
                        generic: med.generic,
                        start: startDate,
                        end: endDate,
                        prescription: prescIdx + 1,
                        color: colors[(prescIdx * 3 + medIdx) % colors.length]
                    });
                });
            });
            
            // Sort by start date
            allMeds.sort((a, b) => a.start - b.start);
            
            // Find date range
            const minDate = new Date(Math.min(...allMeds.map(m => m.start)));
            const maxDate = new Date(Math.max(...allMeds.map(m => m.end)));
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 10;
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <span style="font-size: 0.85rem; color: #64748b;"><strong>Timeline Range:</strong> ${minDate.toLocaleDateString('en-IN')} to ${maxDate.toLocaleDateString('en-IN')}</span>
                    <span style="font-size: 0.85rem; color: #64748b;"><strong>Total Medications:</strong> ${allMeds.length}</span>
                </div>
                <div style="overflow-x: auto;">
                    <div style="min-width: 800px;">
                        ${allMeds.map((med, idx) => {
                            const leftPercent = ((med.start - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            const widthPercent = ((med.end - med.start) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem; gap: 1rem;">
                                    <div style="width: 200px; font-size: 0.8rem; font-weight: 500; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${med.name}">${med.name}</div>
                                    <div style="flex: 1; height: 28px; background: #f1f5f9; border-radius: 4px; position: relative;">
                                        <div style="position: absolute; left: ${leftPercent}%; width: ${Math.max(widthPercent, 2)}%; height: 100%; background: ${med.color}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 0.5rem;" title="${med.start.toLocaleDateString()} - ${med.end.toLocaleDateString()}">
                                            Rx${med.prescription}
                                        </div>
                                    </div>
                                    <div style="width: 80px; font-size: 0.75rem; color: #64748b;">${med.start.toLocaleDateString('en-IN', {day: '2-digit', month: 'short'})}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <span style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.35rem;"><span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></span> Visit 1 (Mar 2025)</span>
                    <span style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.35rem;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span> Visit 2 (Jun 2025)</span>
                    <span style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.35rem;"><span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></span> Visit 3 (Jul 2025)</span>
                </div>
            `;
        }

        function renderMedStartStop(patient) {
            const container = document.getElementById('medStartStopContent');
            
            const allEvents = [];
            patient.prescriptions.forEach(presc => {
                presc.medications.forEach(med => {
                    const startDate = new Date(presc.date);
                    const durationMatch = med.duration.match(/(\d+)/);
                    const days = durationMatch ? parseInt(durationMatch[1]) : 5;
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + days);
                    
                    allEvents.push({ type: 'start', date: startDate, med: med.name, generic: med.generic, doctor: presc.doctor });
                    allEvents.push({ type: 'stop', date: endDate, med: med.name, generic: med.generic, doctor: presc.doctor });
                });
            });
            
            allEvents.sort((a, b) => a.date - b.date);
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                    ${allEvents.map(event => `
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: ${event.type === 'start' ? '#f0fdf4' : '#fef2f2'}; border-left: 4px solid ${event.type === 'start' ? '#10b981' : '#ef4444'}; border-radius: 0 8px 8px 0;">
                            <div style="width: 32px; height: 32px; background: ${event.type === 'start' ? '#10b981' : '#ef4444'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-${event.type === 'start' ? 'play' : 'stop'}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${event.type === 'start' ? '#166534' : '#991b1b'}; font-size: 0.9rem;">${event.med}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${event.date.toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})}</div>
                            </div>
                            <span style="font-size: 0.7rem; background: ${event.type === 'start' ? '#dcfce7' : '#fee2e2'}; color: ${event.type === 'start' ? '#166534' : '#991b1b'}; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600;">${event.type.toUpperCase()}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function detectOverlappingMedications(patient) {
            const container = document.getElementById('overlapContent');
            const countBadge = document.getElementById('overlapCount');
            
            // Build medication periods
            const periods = [];
            patient.prescriptions.forEach(presc => {
                presc.medications.forEach(med => {
                    const startDate = new Date(presc.date);
                    const durationMatch = med.duration.match(/(\d+)/);
                    const days = durationMatch ? parseInt(durationMatch[1]) : 5;
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + days);
                    
                    periods.push({ med: med.name, generic: med.generic, start: startDate, end: endDate, visit: presc.visitDate });
                });
            });
            
            // Find overlaps
            const overlaps = [];
            for (let i = 0; i < periods.length; i++) {
                for (let j = i + 1; j < periods.length; j++) {
                    const a = periods[i];
                    const b = periods[j];
                    
                    // Check if periods overlap
                    if (a.start <= b.end && b.start <= a.end) {
                        const overlapStart = new Date(Math.max(a.start, b.start));
                        const overlapEnd = new Date(Math.min(a.end, b.end));
                        const overlapDays = Math.ceil((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24));
                        
                        if (overlapDays > 0) {
                            overlaps.push({
                                med1: a.med,
                                med2: b.med,
                                generic1: a.generic,
                                generic2: b.generic,
                                overlapStart,
                                overlapEnd,
                                days: overlapDays
                            });
                        }
                    }
                }
            }
            
            countBadge.textContent = `${overlaps.length} Overlaps Found`;
            
            if (overlaps.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #059669;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="font-weight: 600;">No medication overlaps detected!</p>
                        <p style="font-size: 0.9rem; color: #64748b;">All medications were prescribed in non-overlapping periods.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        ${overlaps.map(overlap => `
                            <div style="border: 1px solid #fbbf24; border-radius: 12px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #92400e;"><i class="fas fa-layer-group" style="margin-right: 0.5rem;"></i>Overlap Period</span>
                                    <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${overlap.days} Days</span>
                                </div>
                                <div style="padding: 1rem; display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center;">
                                    <div style="text-align: center; padding: 0.75rem; background: #dbeafe; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #1e40af;">${overlap.med1}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">${overlap.generic1}</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; color: #d97706;">
                                        <i class="fas fa-arrows-alt-h" style="font-size: 1.25rem;"></i>
                                        <span style="font-size: 0.75rem; margin-top: 0.25rem;">${overlap.overlapStart.toLocaleDateString('en-IN', {day: '2-digit', month: 'short'})} - ${overlap.overlapEnd.toLocaleDateString('en-IN', {day: '2-digit', month: 'short'})}</span>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: #dcfce7; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #166534;">${overlap.med2}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">${overlap.generic2}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function renderVisitChanges(patient) {
            const container = document.getElementById('visitChangesContent');
            
            const changes = [];
            for (let i = 1; i < patient.prescriptions.length; i++) {
                const prev = patient.prescriptions[i - 1];
                const curr = patient.prescriptions[i];
                
                const prevMeds = new Set(prev.medications.map(m => m.generic.toLowerCase()));
                const currMeds = new Set(curr.medications.map(m => m.generic.toLowerCase()));
                
                const added = curr.medications.filter(m => !prevMeds.has(m.generic.toLowerCase()));
                const removed = prev.medications.filter(m => !currMeds.has(m.generic.toLowerCase()));
                const continued = curr.medications.filter(m => prevMeds.has(m.generic.toLowerCase()));
                
                changes.push({
                    from: prev,
                    to: curr,
                    added,
                    removed,
                    continued,
                    doctorChanged: prev.doctor !== curr.doctor,
                    specialtyChanged: prev.specialization !== curr.specialization
                });
            }
            
            container.innerHTML = `
                ${changes.map((change, idx) => `
                    <div style="margin-bottom: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="background: #9333ea; color: white; padding: 0.5rem 0.75rem; border-radius: 8px; font-weight: 600;">Visit ${idx + 1}</span>
                                <i class="fas fa-arrow-right" style="color: #9333ea;"></i>
                                <span style="background: #9333ea; color: white; padding: 0.5rem 0.75rem; border-radius: 8px; font-weight: 600;">Visit ${idx + 2}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #7c3aed;">
                                ${change.from.visitDate} â†’ ${change.to.visitDate}
                            </div>
                        </div>
                        
                        ${change.specialtyChanged ? `
                            <div style="background: #fef3c7; padding: 0.75rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user-md" style="color: #d97706;"></i>
                                <strong>Specialty Change:</strong> ${change.from.specialization} â†’ ${change.to.specialization}
                            </div>
                        ` : ''}
                        
                        <div style="padding: 1rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div>
                                <h5 style="color: #16a34a; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-plus-circle"></i> New Medications (${change.added.length})
                                </h5>
                                ${change.added.length > 0 ? change.added.map(med => `
                                    <div style="background: #f0fdf4; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #10b981;">
                                        <div style="font-weight: 600; font-size: 0.85rem; color: #166534;">${med.name}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">${med.generic}</div>
                                    </div>
                                `).join('') : '<p style="color: #64748b; font-size: 0.85rem;">None</p>'}
                            </div>
                            
                            <div>
                                <h5 style="color: #dc2626; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-minus-circle"></i> Discontinued (${change.removed.length})
                                </h5>
                                ${change.removed.length > 0 ? change.removed.map(med => `
                                    <div style="background: #fef2f2; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #ef4444;">
                                        <div style="font-weight: 600; font-size: 0.85rem; color: #991b1b;">${med.name}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">${med.generic}</div>
                                    </div>
                                `).join('') : '<p style="color: #64748b; font-size: 0.85rem;">None</p>'}
                            </div>
                            
                            <div>
                                <h5 style="color: #0284c7; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Continued (${change.continued.length})
                                </h5>
                                ${change.continued.length > 0 ? change.continued.map(med => `
                                    <div style="background: #f0f9ff; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #0284c7;">
                                        <div style="font-weight: 600; font-size: 0.85rem; color: #0369a1;">${med.name}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">${med.generic}</div>
                                    </div>
                                `).join('') : '<p style="color: #64748b; font-size: 0.85rem;">None</p>'}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderCurrentVsPastComparison(patient) {
            const container = document.getElementById('comparisonContent');
            
            const current = patient.prescriptions[patient.prescriptions.length - 1];
            const pastMeds = new Map();
            
            // Collect all past medications
            for (let i = 0; i < patient.prescriptions.length - 1; i++) {
                patient.prescriptions[i].medications.forEach(med => {
                    if (!pastMeds.has(med.generic.toLowerCase())) {
                        pastMeds.set(med.generic.toLowerCase(), { med, visits: [] });
                    }
                    pastMeds.get(med.generic.toLowerCase()).visits.push(patient.prescriptions[i].visitDate);
                });
            }
            
            const currentGenerics = new Set(current.medications.map(m => m.generic.toLowerCase()));
            const newInCurrent = current.medications.filter(m => !pastMeds.has(m.generic.toLowerCase()));
            const fromPast = current.medications.filter(m => pastMeds.has(m.generic.toLowerCase()));
            const neverRepeated = [...pastMeds.entries()].filter(([key]) => !currentGenerics.has(key));
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <h4 style="margin-bottom: 1rem; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-prescription" style="color: #3b82f6;"></i>
                            Current Prescription (${current.visitDate})
                        </h4>
                        <div style="background: #f0f9ff; border-radius: 12px; padding: 1rem;">
                            <p style="font-size: 0.9rem; color: #0369a1; margin-bottom: 0.75rem;"><strong>Chief Complaint:</strong> ${current.chiefComplaint}</p>
                            <p style="font-size: 0.9rem; color: #0369a1; margin-bottom: 1rem;"><strong>Doctor:</strong> ${current.doctor} (${current.specialization})</p>
                            
                            <h5 style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem;">Medications:</h5>
                            ${current.medications.map(med => `
                                <div style="background: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e40af;">${med.name}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">${med.generic}</div>
                                    </div>
                                    <span style="background: ${pastMeds.has(med.generic.toLowerCase()) ? '#fef3c7' : '#dcfce7'}; color: ${pastMeds.has(med.generic.toLowerCase()) ? '#92400e' : '#166534'}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                        ${pastMeds.has(med.generic.toLowerCase()) ? 'REPEAT' : 'NEW'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 1rem; color: #7c3aed; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-history" style="color: #9333ea;"></i>
                            Past Medications (${patient.prescriptions.length - 1} previous visits)
                        </h4>
                        <div style="background: #faf5ff; border-radius: 12px; padding: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <h5 style="font-size: 0.9rem; color: #16a34a; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-redo"></i> Repeated in Current (${fromPast.length})
                                </h5>
                                ${fromPast.map(med => {
                                    const pastInfo = pastMeds.get(med.generic.toLowerCase());
                                    return `
                                        <div style="background: #f0fdf4; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600; font-size: 0.85rem; color: #166534;">${med.name}</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">Previously used: ${pastInfo.visits.join(', ')}</div>
                                        </div>
                                    `;
                                }).join('') || '<p style="color: #64748b; font-size: 0.85rem;">None</p>'}
                            </div>
                            
                            <div>
                                <h5 style="font-size: 0.9rem; color: #dc2626; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-times-circle"></i> Not Repeated (${neverRepeated.length})
                                </h5>
                                ${neverRepeated.slice(0, 5).map(([key, info]) => `
                                    <div style="background: #fef2f2; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 600; font-size: 0.85rem; color: #991b1b;">${info.med.name}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Last used: ${info.visits[info.visits.length - 1]}</div>
                                    </div>
                                `).join('') || '<p style="color: #64748b; font-size: 0.85rem;">None</p>'}
                                ${neverRepeated.length > 5 ? `<p style="color: #64748b; font-size: 0.8rem; text-align: center;">+${neverRepeated.length - 5} more...</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border-radius: 12px;">
                    <h5 style="margin-bottom: 0.75rem; color: #475569;"><i class="fas fa-chart-pie" style="margin-right: 0.5rem;"></i>Summary Statistics</h5>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div style="background: white; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${current.medications.length}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">Current Meds</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${newInCurrent.length}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">New This Visit</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${fromPast.length}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">Repeated</div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${neverRepeated.length}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">Discontinued</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadTimeline() {
            const patientUid = document.getElementById('timelinePatientUid').value.trim();
            if (!patientUid) {
                alert('Please enter a patient UID');
                return;
            }

            try {
                // Load Gantt data from staff API
                const ganttResponse = await fetch(`${STAFF_API}/patient/${patientUid}/gantt`);
                const ganttData = await ganttResponse.json();
                
                if (!ganttData.success) {
                    throw new Error(ganttData.detail || 'Failed to load gantt data');
                }
                
                // Load timeline events from staff API
                const eventsResponse = await fetch(`${STAFF_API}/patient/${patientUid}/timeline`);
                const eventsData = await eventsResponse.json();

                document.getElementById('timelineResults').style.display = 'block';
                document.getElementById('timelineEventsCard').style.display = 'block';

                renderGanttChart(ganttData);
                renderTimelineEvents(eventsData.events || []);
                
                // Auto-detect and display medication changes from timeline events
                autoDetectMedicationChanges(eventsData.events || [], ganttData);
            } catch (error) {
                console.error('Timeline error:', error);
                alert('Error loading timeline: ' + error.message);
            }
        }

        function autoDetectMedicationChanges(events, ganttData) {
            const changesCard = document.getElementById('timelineMedChangesCard');
            const resultDiv = document.getElementById('autoMedChangesResult');
            const countBadge = document.getElementById('medChangesCount');
            
            // Extract medication changes from events
            const started = [];
            const stopped = [];
            const doseChanged = [];
            
            // From timeline events
            events.forEach(event => {
                const eventType = event.event_type || event.type || '';
                if (eventType === 'medication_started') {
                    started.push({
                        name: event.medication || event.description?.replace('Started ', '') || 'Unknown',
                        date: event.event_date || event.date,
                        details: event.description
                    });
                } else if (eventType === 'medication_stopped') {
                    stopped.push({
                        name: event.medication || event.description?.replace('Stopped ', '') || 'Unknown',
                        date: event.event_date || event.date,
                        details: event.description
                    });
                } else if (eventType === 'dosage_changed') {
                    doseChanged.push({
                        name: event.medication || 'Unknown',
                        date: event.event_date || event.date,
                        details: event.description
                    });
                }
            });
            
            // Also detect from gantt data - active vs stopped meds
            if (ganttData.medications) {
                ganttData.medications.forEach(med => {
                    if (!med.active && !stopped.find(s => s.name.toLowerCase() === med.name.toLowerCase())) {
                        stopped.push({
                            name: med.name,
                            date: med.end,
                            details: `${med.dosage || ''} ${med.frequency || ''} - discontinued`
                        });
                    }
                });
            }
            
            const totalChanges = started.length + stopped.length + doseChanged.length;
            
            if (totalChanges === 0) {
                changesCard.style.display = 'none';
                return;
            }
            
            changesCard.style.display = 'block';
            countBadge.textContent = `${totalChanges} change${totalChanges > 1 ? 's' : ''}`;
            
            let html = '';
            
            // Started medications
            if (started.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h5 style="color: #059669; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-plus-circle"></i> Started (${started.length})
                        </h5>
                        ${started.map(s => `
                            <div style="display: flex; align-items: center; padding: 0.5rem; background: #ecfdf5; border-radius: 6px; margin-bottom: 0.25rem;">
                                <span style="width: 8px; height: 8px; background: #059669; border-radius: 50%; margin-right: 0.75rem;"></span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 0.875rem;">${s.name}</strong>
                                    <span style="font-size: 0.75rem; color: var(--gray-500); margin-left: 0.5rem;">${formatDate(s.date)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Dose changes
            if (doseChanged.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h5 style="color: #d97706; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-edit"></i> Dose Changed (${doseChanged.length})
                        </h5>
                        ${doseChanged.map(d => `
                            <div style="display: flex; align-items: center; padding: 0.5rem; background: #fffbeb; border-radius: 6px; margin-bottom: 0.25rem;">
                                <span style="width: 8px; height: 8px; background: #d97706; border-radius: 50%; margin-right: 0.75rem;"></span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 0.875rem;">${d.name}</strong>
                                    <span style="font-size: 0.75rem; color: var(--gray-500); margin-left: 0.5rem;">${d.details || ''}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Stopped medications
            if (stopped.length > 0) {
                html += `
                    <div>
                        <h5 style="color: #dc2626; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-minus-circle"></i> Stopped (${stopped.length})
                        </h5>
                        ${stopped.map(s => `
                            <div style="display: flex; align-items: center; padding: 0.5rem; background: #fef2f2; border-radius: 6px; margin-bottom: 0.25rem;">
                                <span style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%; margin-right: 0.75rem;"></span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 0.875rem;">${s.name}</strong>
                                    <span style="font-size: 0.75rem; color: var(--gray-500); margin-left: 0.5rem;">${formatDate(s.date)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const dt = new Date(dateStr);
                return dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function renderGanttChart(data) {
            const container = document.getElementById('timelineChart');
            if (!data.medications || data.medications.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-pills"></i><p>No medication timeline data</p></div>';
                return;
            }

            // Summary header
            let html = `
                <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${data.active_medications || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Active Medications</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">${data.total_medications || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Total Medications</div>
                    </div>
                </div>
            `;
            
            html += '<div style="overflow-x: auto;">';
            data.medications.forEach(med => {
                const isActive = med.active;
                html += `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="width: 180px;">
                            <div style="font-weight: 600; font-size: 0.9rem;">${med.name}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">${med.dosage || ''} ${med.frequency ? 'â€¢ ' + med.frequency : ''}</div>
                        </div>
                        <div style="flex: 1; background: var(--gray-100); height: 28px; border-radius: 6px; position: relative; margin: 0 1rem; display: flex; align-items: center; padding: 0 10px;">
                            <div style="position: absolute; left: 0; height: 100%; background: ${isActive ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #9ca3af, #6b7280)'}; border-radius: 6px; width: ${isActive ? '100%' : '60%'}; opacity: 0.9;"></div>
                            <span style="position: relative; z-index: 1; font-size: 0.7rem; color: white; font-weight: 500;">${med.start} â†’ ${med.end}</span>
                        </div>
                        <div style="width: 120px; font-size: 0.75rem; color: var(--gray-500); text-align: right; padding-right: 0.5rem;">
                            ${med.prescriber ? 'Dr. ' + med.prescriber : ''}
                        </div>
                        <span class="badge ${isActive ? 'badge-success' : 'badge-gray'}" style="min-width: 60px; text-align: center;">${isActive ? 'Active' : 'Stopped'}</span>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderTimelineEvents(events) {
            const container = document.getElementById('timelineEvents');
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 2rem; text-align: center; color: var(--gray-500);"><i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>No timeline events yet</p></div>';
                return;
            }
            
            // Get event type icons and colors
            const eventStyles = {
                'prescription_added': { icon: 'ðŸ“‹', color: '#3b82f6', bg: '#eff6ff' },
                'medication_started': { icon: 'ðŸ’Š', color: '#059669', bg: '#ecfdf5' },
                'medication_stopped': { icon: 'â¹ï¸', color: '#dc2626', bg: '#fef2f2' },
                'dosage_changed': { icon: 'ðŸ“', color: '#d97706', bg: '#fffbeb' },
                'condition_added': { icon: 'ðŸ¥', color: '#7c3aed', bg: '#f5f3ff' },
                'allergy_added': { icon: 'âš ï¸', color: '#dc2626', bg: '#fef2f2' },
                'visit': { icon: 'ðŸ‘¨â€âš•ï¸', color: '#0891b2', bg: '#ecfeff' },
            };

            container.innerHTML = events.slice(0, 30).map(event => {
                const eventDate = event.event_date || event.date || '';
                const eventType = event.event_type || event.type || 'event';
                const description = event.description || '';
                const style = eventStyles[eventType] || { icon: 'ðŸ“Œ', color: '#6b7280', bg: '#f9fafb' };
                
                // Format date
                let displayDate = eventDate;
                try {
                    if (eventDate) {
                        const dt = new Date(eventDate);
                        displayDate = dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    }
                } catch (e) {}
                
                return `
                    <div style="display: flex; padding: 1rem; border-bottom: 1px solid var(--gray-100); align-items: flex-start;">
                        <div style="width: 36px; height: 36px; background: ${style.bg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-size: 1.1rem;">
                            ${style.icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; font-size: 0.85rem; color: ${style.color};">${eventType.replace(/_/g, ' ').toUpperCase()}</span>
                                <span style="font-size: 0.75rem; color: var(--gray-400);">â€¢</span>
                                <span style="font-size: 0.75rem; color: var(--gray-500);">${displayDate}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray-700);">${description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== Knowledge Graph Functions ====================
        
        let kgCurrentData = null;
        
        async function loadPatientKnowledgeGraph() {
            const patientUid = document.getElementById('kgPatientUid').value.trim();
            if (!patientUid) {
                alert('Please enter a patient UID');
                return;
            }

            const container = document.getElementById('kgGraphContent');
            document.getElementById('kgGraphCard').style.display = 'block';
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 300px;">
                    <div style="text-align: center; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 1rem;"></i>
                        <div>Building knowledge graph...</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/knowledge-graph`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load knowledge graph');
                }
                
                kgCurrentData = data;
                document.getElementById('kgPatientName').textContent = `${data.patient_name} (${patientUid})`;
                document.getElementById('kgLegendCard').style.display = 'block';
                document.getElementById('kgStats').textContent = `${data.graph.statistics.total_nodes} nodes â€¢ ${data.graph.statistics.total_edges} relationships`;
                
                renderCleanKnowledgeGraph(data);
                
            } catch (error) {
                console.error('Knowledge graph error:', error);
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 1rem;"></i>
                            <div>${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        async function loadDemoKnowledgeGraph() {
            const container = document.getElementById('kgGraphContent');
            document.getElementById('kgGraphCard').style.display = 'block';
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 300px;">
                    <div style="text-align: center; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 1rem;"></i>
                        <div>Loading demo...</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${STAFF_API}/knowledge-graph/demo`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load demo');
                }
                
                kgCurrentData = data;
                document.getElementById('kgPatientName').textContent = `Demo Patient (DEMO-001)`;
                document.getElementById('kgLegendCard').style.display = 'block';
                document.getElementById('kgStats').textContent = `${data.graph.statistics.total_nodes} nodes â€¢ ${data.graph.statistics.total_edges} relationships â€¢ DEMO`;
                
                renderCleanKnowledgeGraph(data);
                
            } catch (error) {
                console.error('Demo error:', error);
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 1rem;"></i>
                            <div>${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function renderCleanKnowledgeGraph(data) {
            const container = document.getElementById('kgGraphContent');
            const nodes = data.graph.nodes || [];
            const edges = data.graph.edges || [];
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--gray-500);">
                            <i class="fas fa-project-diagram fa-2x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>No data available</div>
                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">Add medications or conditions to see the graph</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group nodes by type
            const patientNodes = nodes.filter(n => n.group === 'patient');
            const medicationNodes = nodes.filter(n => n.group === 'medication');
            const conditionNodes = nodes.filter(n => n.group === 'condition');
            const allergyNodes = nodes.filter(n => n.group === 'allergy');
            const interactionNodes = nodes.filter(n => n.group === 'interaction');
            
            // Build relationships map
            const relationships = {};
            edges.forEach(edge => {
                if (!relationships[edge.from]) relationships[edge.from] = [];
                relationships[edge.from].push({ to: edge.to, label: edge.label });
            });
            
            // Find which medications treat which conditions
            const medTreatsCondition = {};
            edges.forEach(edge => {
                if (edge.label === 'treats') {
                    medTreatsCondition[edge.from] = edge.to;
                }
            });
            
            let html = `
                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    
                    <!-- Patient (Center) -->
                    ${patientNodes.map(patient => `
                        <div style="display: flex; justify-content: center;">
                            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1.25rem 2rem; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); min-width: 200px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ‘¤</div>
                                <div style="font-size: 1.1rem; font-weight: 700;">${patient.label?.replace(/ðŸ‘¤\n/, '') || 'Patient'}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Patient</div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <!-- Connection Lines Visual -->
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; gap: 3rem; align-items: flex-start;">
                            ${medicationNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">takes</div></div>` : ''}
                            ${conditionNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">has</div></div>` : ''}
                            ${allergyNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">allergic to</div></div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Row: Medications, Conditions, Allergies -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        
                        <!-- Medications Column -->
                        ${medicationNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #10b981; overflow: hidden; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medications (${medicationNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${medicationNodes.map(med => {
                                        const treatedCondition = medTreatsCondition[med.id];
                                        const condName = treatedCondition ? conditionNodes.find(c => c.id === treatedCondition)?.label?.replace(/ðŸ¥\n/, '') : null;
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.5rem;">
                                                <div style="width: 36px; height: 36px; background: #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸ’Š</div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #065f46;">${med.label?.replace(/ðŸ’Š\n/, '') || 'Medication'}</div>
                                                    ${condName ? `<div style="font-size: 0.75rem; color: #059669;"><i class="fas fa-arrow-right" style="margin-right: 0.25rem;"></i>treats ${condName}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Conditions Column -->
                        ${conditionNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #f59e0b; overflow: hidden; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem;"></i>Conditions (${conditionNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${conditionNodes.map(cond => `
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fffbeb; border-radius: 8px; margin-bottom: 0.5rem;">
                                            <div style="width: 36px; height: 36px; background: #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸ¥</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #92400e;">${cond.label?.replace(/ðŸ¥\n/, '') || 'Condition'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Allergies Column -->
                        ${allergyNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #ef4444; overflow: hidden; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);">
                                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Allergies (${allergyNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${allergyNodes.map(allergy => `
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fef2f2; border-radius: 8px; margin-bottom: 0.5rem;">
                                            <div style="width: 36px; height: 36px; background: #ef4444; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸš«</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #991b1b;">${allergy.label?.replace(/ðŸš«\n/, '') || 'Allergy'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Drug Interactions (if any) -->
                    ${interactionNodes.length > 0 ? `
                        <div style="background: white; border-radius: 12px; border: 2px solid #ec4899; overflow: hidden; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.15);">
                            <div style="background: linear-gradient(135deg, #ec4899, #be185d); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>Drug Interactions (${interactionNodes.length})
                            </div>
                            <div style="padding: 1rem;">
                                ${interactionNodes.map(interaction => `
                                    <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: #fdf2f8; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #ec4899;">
                                        <div style="width: 40px; height: 40px; background: #ec4899; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">âš ï¸</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #9d174d;">${interaction.label?.replace(/âš ï¸\n/, '') || 'Interaction'}</div>
                                            <div style="font-size: 0.85rem; color: #be185d; margin-top: 0.25rem;">
                                                ${interaction.title?.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim() || 'Potential drug interaction detected'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Relationship Summary -->
                    <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">
                            <i class="fas fa-project-diagram" style="margin-right: 0.5rem;"></i>Relationship Summary
                        </div>
                        <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                <span style="font-size: 1.25rem; color: #10b981;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ’Š</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">takes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                <span style="font-size: 1.25rem; color: #f59e0b;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ¥</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">has condition</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ’Š</span>
                                <span style="font-size: 1.25rem; color: #3b82f6;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ¥</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">treats</span>
                            </div>
                            ${allergyNodes.length > 0 ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                    <span style="font-size: 1.25rem; color: #ef4444;">â†’</span>
                                    <span style="font-size: 1.5rem;">ðŸš«</span>
                                    <span style="font-size: 0.8rem; color: var(--gray-600);">allergic to</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ==================== AI Medical Assistant Functions ====================
        
        let aiChatHistory = [];
        let aiPatientContext = null;
        
        // Toggle patient context panel
        function togglePatientContext() {
            const body = document.getElementById('patientContextBody');
            const toggle = document.getElementById('patientContextToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.classList.remove('fa-chevron-right');
                toggle.classList.add('fa-chevron-down');
            } else {
                body.style.display = 'none';
                toggle.classList.remove('fa-chevron-down');
                toggle.classList.add('fa-chevron-right');
            }
        }
        
        // Auto-set AI patient context from patient detail view
        async function autoSetAIPatientContext(patientId, summary) {
            try {
                // Extract medications from current medications
                const medications = (summary.patient.current_medications || []).map(med => ({
                    name: med.name || '',
                    dosage: med.dosage || '',
                    frequency: med.frequency || ''
                }));
                
                // Set the AI context
                aiPatientContext = {
                    patient_id: patientId,
                    name: summary.patient.name,
                    age: summary.patient.age,
                    gender: summary.patient.gender,
                    medications: medications,
                    allergies: summary.patient.allergies || [],
                    conditions: summary.patient.chronic_conditions || []
                };
                
                // Also sync with backend AI service
                await fetch(`${API_V2_BASE}/ai/set-patient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        name: summary.patient.name,
                        age: summary.patient.age?.toString() || '',
                        medications: medications,
                        allergies: summary.patient.allergies || [],
                        conditions: summary.patient.chronic_conditions || []
                    })
                });
                
                // Also pre-fill the AI form fields
                document.getElementById('aiPatientId').value = patientId;
                document.getElementById('aiPatientName').value = summary.patient.name || '';
                document.getElementById('aiPatientAge').value = summary.patient.age || '';
                document.getElementById('aiPatientAllergies').value = (summary.patient.allergies || []).join(', ');
                document.getElementById('aiPatientConditions').value = (summary.patient.chronic_conditions || []).join(', ');
                document.getElementById('aiPatientMedications').value = medications.map(m => 
                    `${m.name}, ${m.dosage}, ${m.frequency}`
                ).join('\n');
                
                console.log(`AI context auto-set for patient ${patientId} with ${medications.length} medications`);
                
            } catch (error) {
                console.error('Error auto-setting AI context:', error);
            }
        }
        
        // Save patient context for AI
        async function savePatientContext() {
            const patientId = document.getElementById('aiPatientId').value || `P${Date.now()}`;
            const name = document.getElementById('aiPatientName').value;
            const age = document.getElementById('aiPatientAge').value;
            const allergiesStr = document.getElementById('aiPatientAllergies').value;
            const conditionsStr = document.getElementById('aiPatientConditions').value;
            const medicationsStr = document.getElementById('aiPatientMedications').value;
            
            // Parse allergies and conditions
            const allergies = allergiesStr ? allergiesStr.split(',').map(a => a.trim()).filter(a => a) : [];
            const conditions = conditionsStr ? conditionsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            
            // Parse medications
            const medications = [];
            if (medicationsStr) {
                const lines = medicationsStr.split('\n');
                for (const line of lines) {
                    if (line.trim()) {
                        const parts = line.split(',').map(p => p.trim());
                        medications.push({
                            name: parts[0] || '',
                            dosage: parts[1] || '',
                            frequency: parts[2] || '',
                            prescribed_date: new Date().toISOString().split('T')[0]
                        });
                    }
                }
            }
            
            // Store locally
            aiPatientContext = {
                patient_id: patientId,
                name: name,
                age: age,
                medications: medications,
                allergies: allergies,
                conditions: conditions
            };
            
            // Save to backend
            try {
                await fetch(`${API_V2_BASE}/ai/set-patient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        name: name,
                        age: age,
                        medications: medications,
                        allergies: allergies,
                        conditions: conditions
                    })
                });
                
                // Show saved status
                const status = document.getElementById('contextSaveStatus');
                status.style.display = 'flex';
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                // Add system message
                addAIMessage('system', `âœ… Patient context saved for **${name || patientId}**\n- ${medications.length} medications\n- ${allergies.length} allergies\n- ${conditions.length} conditions`);
                
            } catch (error) {
                console.error('Error saving patient context:', error);
            }
        }
        
        // Clear patient context
        function clearPatientContext() {
            document.getElementById('aiPatientId').value = '';
            document.getElementById('aiPatientName').value = '';
            document.getElementById('aiPatientAge').value = '';
            document.getElementById('aiPatientAllergies').value = '';
            document.getElementById('aiPatientConditions').value = '';
            document.getElementById('aiPatientMedications').value = '';
            aiPatientContext = null;
        }
        
        // Submit AI query
        async function submitAIQuery() {
            const queryInput = document.getElementById('aiQueryInput');
            const query = queryInput.value.trim();
            
            if (!query) {
                return;
            }
            
            // Add user message to chat
            addAIMessage('user', query);
            queryInput.value = '';
            
            // Show typing indicator
            const typingId = addTypingIndicator();
            
            try {
                // Build context from form if no patient context saved
                let context = aiPatientContext;
                if (!context) {
                    context = buildContextFromForm();
                }
                
                const response = await fetch(`${API_V2_BASE}/ai/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        patient_id: context?.patient_id || null,
                        context: context
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                // Add AI response
                displayAIChatResponse(data);
                
            } catch (error) {
                removeTypingIndicator(typingId);
                addAIMessage('error', `âŒ Error: ${error.message}`);
            }
        }
        
        // Build context from form fields
        function buildContextFromForm() {
            const allergiesStr = document.getElementById('aiPatientAllergies').value;
            const conditionsStr = document.getElementById('aiPatientConditions').value;
            const medicationsStr = document.getElementById('aiPatientMedications').value;
            
            if (!allergiesStr && !conditionsStr && !medicationsStr) {
                return null;
            }
            
            const allergies = allergiesStr ? allergiesStr.split(',').map(a => a.trim()).filter(a => a) : [];
            const conditions = conditionsStr ? conditionsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            
            const medications = [];
            if (medicationsStr) {
                const lines = medicationsStr.split('\n');
                for (const line of lines) {
                    if (line.trim()) {
                        const parts = line.split(',').map(p => p.trim());
                        medications.push({
                            name: parts[0] || '',
                            dosage: parts[1] || '',
                            frequency: parts[2] || ''
                        });
                    }
                }
            }
            
            return {
                patient_id: document.getElementById('aiPatientId').value || null,
                medications: medications,
                allergies: allergies,
                conditions: conditions
            };
        }
        
        // Quick AI query shortcuts
        function quickAIQuery(type) {
            const queries = {
                'medications': 'What medications is the patient taking?',
                'allergies': 'What are the patient\'s allergies?',
                'interactions': 'Check for drug interactions between current medications',
                'safety': 'Run comprehensive safety analysis on current medications',
                'timeline': 'Show medication timeline and history'
            };
            
            document.getElementById('aiQueryInput').value = queries[type] || '';
            submitAIQuery();
        }
        
        // Add message to chat
        function addAIMessage(type, content) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            
            if (type === 'user') {
                messageDiv.style.flexDirection = 'row-reverse';
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        ðŸ‘¨â€âš•ï¸
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem 1.25rem; border-radius: 16px 0 16px 16px; max-width: 80%;">
                        <p style="margin: 0;">${escapeHtml(content)}</p>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        ðŸ¤–
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; max-width: 80%;">
                        <p style="margin: 0; color: var(--gray-700);">${formatAIContent(content)}</p>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        âš ï¸
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; max-width: 80%;">
                        <p style="margin: 0; color: #991b1b;">${escapeHtml(content)}</p>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const container = document.getElementById('aiChatContainer');
            const id = 'typing-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; gap: 4px;">
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: -0.32s;"></span>
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: -0.16s;"></span>
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></span>
                    </div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            return id;
        }
        
        // Remove typing indicator
        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }
        
        // Display AI chat response
        function displayAIChatResponse(data) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            
            // Build response HTML
            let responseContent = `<div style="margin-bottom: 0.75rem;">${formatAIContent(data.answer || 'No response available')}</div>`;
            
            // Add warnings if any
            if (data.warnings && data.warnings.length > 0) {
                responseContent += `<div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef2f2, #fee2e2); border-radius: 8px; border-left: 4px solid #dc2626;">`;
                responseContent += `<strong style="color: #991b1b;">âš ï¸ Warnings:</strong><ul style="margin: 0.5rem 0 0 1rem; color: #991b1b;">`;
                data.warnings.forEach(w => {
                    responseContent += `<li>${w.message || JSON.stringify(w)}</li>`;
                });
                responseContent += `</ul></div>`;
            }
            
            // Add recommendations if any
            if (data.recommendations && data.recommendations.length > 0) {
                responseContent += `<div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 8px; border-left: 4px solid #16a34a;">`;
                responseContent += `<strong style="color: #166534;">ðŸ’¡ Recommendations:</strong><ul style="margin: 0.5rem 0 0 1rem; color: #166534;">`;
                data.recommendations.forEach(r => {
                    responseContent += `<li>${r}</li>`;
                });
                responseContent += `</ul></div>`;
            }
            
            // Add follow-up questions
            if (data.follow_up_questions && data.follow_up_questions.length > 0) {
                responseContent += `<div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                data.follow_up_questions.slice(0, 3).forEach(q => {
                    responseContent += `<button onclick="fillQuery('${q.replace(/'/g, "\\'")}')" style="padding: 0.35rem 0.75rem; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 20px; font-size: 0.75rem; color: #667eea; cursor: pointer;">${q}</button>`;
                });
                responseContent += `</div>`;
            }
            
            // Add metadata
            const confidence = Math.round((data.confidence || 0) * 100);
            const confidenceColor = confidence >= 80 ? '#16a34a' : confidence >= 50 ? '#d97706' : '#dc2626';
            responseContent += `<div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--gray-500);">`;
            responseContent += `<span><i class="fas fa-chart-line"></i> Confidence: <strong style="color: ${confidenceColor}">${confidence}%</strong></span>`;
            if (data.processing_time_ms) {
                responseContent += `<span><i class="fas fa-clock"></i> ${Math.round(data.processing_time_ms)}ms</span>`;
            }
            responseContent += `</div>`;
            
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%;">
                    ${responseContent}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Format AI content (markdown-like)
        function formatAIContent(content) {
            if (!content) return '';
            return content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/â€¢ /g, '&bull; ')
                .replace(/- /g, '&ndash; ');
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Fill query input
        function fillQuery(query) {
            document.getElementById('aiQueryInput').value = query;
            document.getElementById('aiQueryInput').focus();
        }
        
        // Handle Enter key in query input
        document.addEventListener('DOMContentLoaded', () => {
            const queryInput = document.getElementById('aiQueryInput');
            if (queryInput) {
                queryInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitAIQuery();
                    }
                });
            }
        });

        // Review Queue Functions
        async function refreshReviewQueue() {
            try {
                const response = await fetch(`${API_V2_BASE}/review/queue?confidence_threshold=0.7&limit=50`);
                const data = await response.json();
                
                document.getElementById('pendingReviewCount').textContent = data.count || 0;
                document.getElementById('reviewBadge').textContent = data.count || 0;
                renderReviewQueue(data.items);

                // Load corrections
                const corrResponse = await fetch(`${API_V2_BASE}/review/corrections?limit=10`);
                const corrData = await corrResponse.json();
                renderCorrections(corrData.corrections);

                // Load stats
                const statsResponse = await fetch(`${API_V2_BASE}/review/statistics`);
                const statsData = await statsResponse.json();
                document.getElementById('correctionsMade').textContent = statsData.total_corrections || 0;
            } catch (error) {
                console.error('Error loading review queue:', error);
            }
        }

        function renderReviewQueue(items) {
            const container = document.getElementById('reviewQueueList');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h4>All caught up!</h4><p>No items pending review</p></div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span class="badge badge-info">${item.entity_type}</span>
                        <span class="badge ${item.confidence > 0.5 ? 'badge-warning' : 'badge-danger'}">${Math.round(item.confidence * 100)}%</span>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.entity_value}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.75rem;">Source: "${item.source_text?.substring(0, 80) || 'N/A'}..."</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="confirmItem(${item.id})"><i class="fas fa-check"></i> Confirm</button>
                        <button class="btn btn-warning btn-sm" onclick="correctItem(${item.id})"><i class="fas fa-edit"></i> Correct</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCorrections(corrections) {
            const tbody = document.getElementById('recentCorrections');
            if (!corrections || corrections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No corrections yet</td></tr>';
                return;
            }

            tbody.innerHTML = corrections.map(c => `
                <tr>
                    <td><span class="badge badge-gray">${c.type || 'N/A'}</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.original || '-'}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.corrected || '-'}</td>
                    <td>${c.by || '-'}</td>
                    <td>${c.at ? new Date(c.at).toLocaleDateString() : '-'}</td>
                    <td><span class="badge ${c.verified ? 'badge-success' : 'badge-warning'}">${c.verified ? 'Verified' : 'Pending'}</span></td>
                </tr>
            `).join('');
        }

        async function confirmItem(id) {
            alert('Item confirmed! (API integration ready)');
            refreshReviewQueue();
        }

        async function correctItem(id) {
            const newValue = prompt('Enter the correct value:');
            if (newValue) {
                alert('Correction submitted! (API integration ready)');
                refreshReviewQueue();
            }
        }

        // Page navigation update
        const enhancedTitles = {
            'timeline': 'Patient Timeline',
            'knowledge-graph': 'Knowledge Graph',
            'ask-ai': 'Ask AI',
            'review-queue': 'Review Queue',
            'clinical-decision': 'Pharmacogenomics',
            'treatment-outcomes': 'Treatment Outcomes'
        };

        const originalNavigateTo = navigateTo;
        navigateTo = function(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'history': 'Longitudinal Patient History',
                'explainability': 'Explainability & Evidence',
                'settings': 'Settings',
                ...enhancedTitles
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            // Load data for enhanced pages
            if (page === 'review-queue') refreshReviewQueue();
        };

        // ========================================
        // Doctor QR Scan & Patient Lookup Functions (Dashboard Page)
        // ========================================

        // Initialize Doctor QR drop zone on dashboard
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('doctorQrDropZone');
            const fileInput = document.getElementById('doctorQrFileInput');
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255,255,255,0.25)';
                    dropZone.style.borderColor = 'white';
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.background = 'rgba(255,255,255,0.15)';
                    dropZone.style.borderColor = 'rgba(255,255,255,0.4)';
                });
                
                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255,255,255,0.15)';
                    const file = e.dataTransfer.files[0];
                    if (file) await doctorScanQrImage(file);
                });
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) await doctorScanQrImage(file);
                    e.target.value = '';
                });
            }
        });

        async function doctorScanQrImage(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${STAFF_API}/doctor/scan-qr`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.patient_found) {
                    displayPatientDetails(data);
                } else if (data.decoded_uid && !data.patient_found) {
                    alert(`QR Code decoded (${data.decoded_uid}) but patient not found in database.`);
                } else {
                    alert('Could not read QR code. Please ensure the image is clear.');
                }
            } catch (error) {
                console.error('QR scan error:', error);
                alert('Error scanning QR code: ' + error.message);
            }
        }

        async function doctorLookupPatient() {
            const uid = document.getElementById('doctorPatientUidInput').value.trim();
            if (!uid) {
                alert('Please enter a patient UID');
                return;
            }
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/full-details`);
                const data = await response.json();
                
                if (data.success) {
                    displayPatientDetails(data);
                } else {
                    alert(data.detail || 'Patient not found');
                }
            } catch (error) {
                console.error('Lookup error:', error);
                alert('Patient not found: ' + error.message);
            }
        }

        function displayPatientDetails(data) {
            currentViewedPatient = data;
            
            // Hide initial state, show patient view
            document.getElementById('patientNotFoundState').style.display = 'none';
            document.getElementById('patientFoundState').style.display = 'block';
            
            // Patient header
            document.getElementById('viewPatientName').textContent = data.patient?.name || 'Unknown';
            document.getElementById('viewPatientUid').textContent = `UID: ${data.patient?.uid || data.decoded_uid}`;
            document.getElementById('viewPatientAge').textContent = data.patient?.age ? `${data.patient.age} years` : '';
            document.getElementById('viewPatientGender').textContent = data.patient?.gender || '';
            document.getElementById('viewPatientBlood').textContent = data.patient?.blood_group ? `ðŸ©¸ ${data.patient.blood_group}` : '';
            
            // Stats
            document.getElementById('viewTotalPrescriptions').textContent = data.summary?.total_prescriptions || 0;
            document.getElementById('viewActiveMeds').textContent = data.summary?.active_medications_count || 0;
            document.getElementById('viewLastVisit').textContent = data.summary?.last_visit || '-';
            
            // Allergies
            const allergiesEl = document.getElementById('viewAllergies');
            const allergies = data.patient?.allergies || [];
            if (allergies.length > 0) {
                allergiesEl.innerHTML = allergies.map(a => 
                    `<span class="badge" style="background: #fee2e2; color: #dc2626; margin-right: 0.5rem;">${a}</span>`
                ).join('');
            } else {
                allergiesEl.innerHTML = '<span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>';
            }
            
            // Conditions
            const conditionsEl = document.getElementById('viewConditions');
            const conditions = data.patient?.conditions || [];
            if (conditions.length > 0) {
                conditionsEl.innerHTML = conditions.map(c => 
                    `<span class="badge" style="background: #fef3c7; color: #d97706; margin-right: 0.5rem;">${c}</span>`
                ).join('');
            } else {
                conditionsEl.innerHTML = '<span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>';
            }
            
            // Active Medications - Extract from API response (database)
            const activeMedsEl = document.getElementById('viewActiveMedsList');
            const activeMeds = data.active_medications || [];
            
            if (activeMeds.length > 0) {
                activeMedsEl.innerHTML = `
                    <div style="display: grid; gap: 0.75rem;">
                        ${activeMeds.map(med => `
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0;">
                                <div style="font-weight: 600; color: #166534;">${med.name || 'Unknown Medication'}</div>
                                <div style="font-size: 0.85rem; color: #15803d;">
                                    ${med.dosage || ''} ${med.frequency ? 'â€¢ ' + med.frequency : ''}
                                </div>
                                ${med.prescriber ? `
                                <div style="font-size: 0.8rem; color: #059669; margin-top: 0.25rem;">
                                    <i class="fas fa-user-md"></i> ${med.prescriber}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                activeMedsEl.innerHTML = '<p style="color: var(--gray-500);">No active medications</p>';
            }
            
            // Analyze and display risks
            analyzePatientRisks(data);
        }

        // ==================== Patient Risk Assessment (Hardcoded Knowledge Base) ====================
        
        // Common Allergy-Drug Relationships
        const ALLERGY_DRUG_RISKS = {
            'Penicillin': {
                avoid: ['Amoxicillin', 'Ampicillin', 'Augmentin', 'Amoxyclav', 'Piperacillin', 'Cloxacillin'],
                crossReact: ['Cephalosporins', 'Ceftriaxone', 'Cefixime', 'Cefuroxime'],
                severity: 'CRITICAL',
                reaction: 'Anaphylaxis, severe rash, angioedema'
            },
            'Sulfa': {
                avoid: ['Sulfamethoxazole', 'Cotrimoxazole', 'Bactrim', 'Septran', 'Sulfasalazine'],
                crossReact: ['Thiazide diuretics', 'Furosemide', 'Celecoxib'],
                severity: 'HIGH',
                reaction: 'Stevens-Johnson syndrome, rash, fever'
            },
            'NSAIDs': {
                avoid: ['Ibuprofen', 'Diclofenac', 'Aspirin', 'Naproxen', 'Piroxicam', 'Flexura-D'],
                crossReact: ['COX-2 inhibitors', 'Celecoxib'],
                severity: 'HIGH',
                reaction: 'Bronchospasm, urticaria, angioedema'
            },
            'Aspirin': {
                avoid: ['Aspirin', 'Ecosprin', 'Disprin'],
                crossReact: ['NSAIDs', 'Ibuprofen', 'Diclofenac'],
                severity: 'HIGH',
                reaction: 'Asthma exacerbation, urticaria'
            },
            'Latex': {
                avoid: [],
                crossReact: ['Banana', 'Avocado', 'Kiwi', 'Chestnut'],
                severity: 'MODERATE',
                reaction: 'Cross-reactivity with certain fruits'
            },
            'Iodine': {
                avoid: ['Iodine contrast', 'Povidone-iodine', 'Amiodarone'],
                crossReact: [],
                severity: 'HIGH',
                reaction: 'Anaphylaxis, thyroid dysfunction'
            },
            'Codeine': {
                avoid: ['Codeine', 'Morphine', 'Tramadol', 'Fentanyl'],
                crossReact: ['Other opioids'],
                severity: 'HIGH',
                reaction: 'Respiratory depression, severe sedation'
            },
            'ACE Inhibitors': {
                avoid: ['Enalapril', 'Lisinopril', 'Ramipril', 'Captopril'],
                crossReact: [],
                severity: 'MODERATE',
                reaction: 'Angioedema, chronic cough'
            }
        };

        // Drug-Drug Interactions Database (Ranked by Severity)
        const DRUG_INTERACTIONS = [
            // CRITICAL - Life-threatening
            { drug1: 'Warfarin', drug2: 'Aspirin', severity: 'CRITICAL', effect: 'Major bleeding risk', recommendation: 'Avoid combination or monitor INR closely' },
            { drug1: 'Methotrexate', drug2: 'NSAIDs', severity: 'CRITICAL', effect: 'Methotrexate toxicity', recommendation: 'Avoid NSAIDs during methotrexate therapy' },
            { drug1: 'MAO Inhibitors', drug2: 'SSRIs', severity: 'CRITICAL', effect: 'Serotonin syndrome', recommendation: '14-day washout required' },
            { drug1: 'Potassium', drug2: 'ACE Inhibitors', severity: 'CRITICAL', effect: 'Hyperkalemia', recommendation: 'Monitor potassium levels closely' },
            { drug1: 'Digoxin', drug2: 'Amiodarone', severity: 'CRITICAL', effect: 'Digoxin toxicity', recommendation: 'Reduce digoxin dose by 50%' },
            
            // HIGH - Serious
            { drug1: 'Pantoprazole', drug2: 'Clopidogrel', severity: 'HIGH', effect: 'Reduced antiplatelet effect', recommendation: 'Consider switching PPI' },
            { drug1: 'Ciprofloxacin', drug2: 'Theophylline', severity: 'HIGH', effect: 'Theophylline toxicity', recommendation: 'Monitor theophylline levels' },
            { drug1: 'Statins', drug2: 'Macrolides', severity: 'HIGH', effect: 'Rhabdomyolysis risk', recommendation: 'Temporarily hold statin' },
            { drug1: 'Metformin', drug2: 'Contrast Dye', severity: 'HIGH', effect: 'Lactic acidosis', recommendation: 'Hold metformin 48h before/after contrast' },
            { drug1: 'Tramadol', drug2: 'SSRIs', severity: 'HIGH', effect: 'Seizure risk, serotonin syndrome', recommendation: 'Use with caution' },
            { drug1: 'Diclofenac', drug2: 'ACE Inhibitors', severity: 'HIGH', effect: 'Reduced antihypertensive effect, renal impairment', recommendation: 'Monitor BP and renal function' },
            
            // MODERATE - Clinically significant
            { drug1: 'Omeprazole', drug2: 'Iron', severity: 'MODERATE', effect: 'Reduced iron absorption', recommendation: 'Take iron 2h before PPI' },
            { drug1: 'Calcium', drug2: 'Levothyroxine', severity: 'MODERATE', effect: 'Reduced thyroid hormone absorption', recommendation: 'Separate by 4 hours' },
            { drug1: 'Antacids', drug2: 'Fluoroquinolones', severity: 'MODERATE', effect: 'Reduced antibiotic absorption', recommendation: 'Separate by 2 hours' },
            { drug1: 'Paracetamol', drug2: 'Alcohol', severity: 'MODERATE', effect: 'Hepatotoxicity risk', recommendation: 'Limit alcohol intake' },
            { drug1: 'Metoclopramide', drug2: 'Levodopa', severity: 'MODERATE', effect: 'Reduced efficacy of both', recommendation: 'Avoid combination' },
            
            // LOW - Minor
            { drug1: 'Multivitamins', drug2: 'Tetracyclines', severity: 'LOW', effect: 'Reduced antibiotic absorption', recommendation: 'Separate doses by 2 hours' },
            { drug1: 'Caffeine', drug2: 'Ciprofloxacin', severity: 'LOW', effect: 'Increased caffeine effect', recommendation: 'Reduce caffeine intake' }
        ];

        // Patient Context Risk Factors
        const CONTEXT_RISK_FACTORS = {
            age: {
                elderly: { threshold: 65, risks: ['Increased fall risk', 'Polypharmacy concerns', 'Reduced renal clearance', 'Cognitive side effects'], level: 'HIGH' },
                pediatric: { threshold: 12, risks: ['Dosing adjustment required', 'Limited drug approvals', 'Growth considerations'], level: 'MODERATE' }
            },
            conditions: {
                'Diabetes': { drugRisks: ['Steroids', 'Thiazides', 'Beta-blockers'], effect: 'May worsen glycemic control', level: 'MODERATE' },
                'Hypertension': { drugRisks: ['NSAIDs', 'Decongestants', 'Steroids'], effect: 'May elevate blood pressure', level: 'MODERATE' },
                'Kidney Disease': { drugRisks: ['NSAIDs', 'Aminoglycosides', 'Metformin', 'Contrast'], effect: 'Nephrotoxic/requires dose adjustment', level: 'HIGH' },
                'Liver Disease': { drugRisks: ['Paracetamol', 'Statins', 'Methotrexate'], effect: 'Hepatotoxic/requires dose adjustment', level: 'HIGH' },
                'Heart Failure': { drugRisks: ['NSAIDs', 'Calcium channel blockers', 'Thiazolidinediones'], effect: 'May worsen heart failure', level: 'HIGH' },
                'Asthma': { drugRisks: ['Beta-blockers', 'Aspirin', 'NSAIDs'], effect: 'May trigger bronchospasm', level: 'HIGH' },
                'GERD': { drugRisks: ['NSAIDs', 'Aspirin', 'Bisphosphonates'], effect: 'May worsen GI symptoms', level: 'MODERATE' },
                'Pregnancy': { drugRisks: ['ACE Inhibitors', 'Warfarin', 'Methotrexate', 'Statins', 'Isotretinoin'], effect: 'Teratogenic - CONTRAINDICATED', level: 'CRITICAL' }
            },
            polypharmacy: {
                threshold: 5,
                risks: ['Drug interactions', 'Adherence issues', 'Adverse effects', 'Falls risk'],
                level: 'MODERATE'
            }
        };

        function analyzePatientRisks(data) {
            const patient = data.patient || {};
            const allergies = patient.allergies || [];
            const conditions = patient.conditions || [];
            const activeMeds = data.active_medications || [];
            const age = patient.age || 0;
            
            // Get medication names for analysis
            const medNames = activeMeds.map(m => (m.name || m.drug_name || '').toUpperCase());
            
            // 1. Analyze Allergy-Based Risks
            analyzeAllergyRisks(allergies, medNames);
            
            // 2. Analyze Patient Context Risks
            analyzeContextRisks(age, conditions, medNames, activeMeds.length);
            
            // 3. Analyze Drug Interactions (Ranked by Severity)
            analyzeDrugInteractions(medNames);
        }

        function analyzeAllergyRisks(allergies, medNames) {
            const container = document.getElementById('allergyRisksContent');
            const countBadge = document.getElementById('allergyRiskCount');
            const risks = [];
            
            if (allergies.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #16a34a;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">No allergies recorded - no allergy-based risks detected</p>
                    </div>
                `;
                countBadge.textContent = '0';
                countBadge.style.background = '#16a34a';
                return;
            }
            
            allergies.forEach(allergy => {
                const allergyUpper = allergy.toUpperCase();
                
                // Check each known allergy type
                Object.entries(ALLERGY_DRUG_RISKS).forEach(([allergyType, info]) => {
                    if (allergyUpper.includes(allergyType.toUpperCase())) {
                        // Check if any current medications match
                        info.avoid.forEach(drug => {
                            if (medNames.some(m => m.includes(drug.toUpperCase()))) {
                                risks.push({
                                    type: 'DIRECT',
                                    severity: info.severity,
                                    allergy: allergy,
                                    drug: drug,
                                    reaction: info.reaction
                                });
                            }
                        });
                        
                        // Check cross-reactivity
                        info.crossReact.forEach(drug => {
                            if (medNames.some(m => m.includes(drug.toUpperCase()))) {
                                risks.push({
                                    type: 'CROSS-REACT',
                                    severity: 'MODERATE',
                                    allergy: allergy,
                                    drug: drug,
                                    reaction: 'Potential cross-reactivity'
                                });
                            }
                        });
                        
                        // General warning even if no current meds match
                        if (!risks.some(r => r.allergy === allergy)) {
                            risks.push({
                                type: 'AWARENESS',
                                severity: 'INFO',
                                allergy: allergy,
                                drugs: info.avoid.slice(0, 3).join(', '),
                                note: `Avoid: ${info.avoid.slice(0, 5).join(', ')}`
                            });
                        }
                    }
                });
            });
            
            if (risks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #16a34a;">
                        <i class="fas fa-shield-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">Allergies noted but no conflicts with current medications</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #64748b;">
                            Recorded allergies: ${allergies.join(', ')}
                        </p>
                    </div>
                `;
                countBadge.textContent = '0';
                countBadge.style.background = '#16a34a';
            } else {
                // Sort by severity
                const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MODERATE': 2, 'INFO': 3 };
                risks.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
                
                const criticalCount = risks.filter(r => r.severity === 'CRITICAL').length;
                countBadge.textContent = risks.length;
                countBadge.style.background = criticalCount > 0 ? '#dc2626' : '#f59e0b';
                
                container.innerHTML = risks.map(risk => {
                    const colors = {
                        'CRITICAL': { bg: '#fef2f2', border: '#dc2626', icon: 'skull-crossbones', text: '#991b1b' },
                        'HIGH': { bg: '#fef2f2', border: '#ef4444', icon: 'exclamation-triangle', text: '#b91c1c' },
                        'MODERATE': { bg: '#fef3c7', border: '#f59e0b', icon: 'exclamation-circle', text: '#92400e' },
                        'INFO': { bg: '#eff6ff', border: '#3b82f6', icon: 'info-circle', text: '#1e40af' }
                    };
                    const c = colors[risk.severity] || colors['INFO'];
                    
                    if (risk.type === 'AWARENESS') {
                        return `
                            <div style="background: ${c.bg}; border-left: 4px solid ${c.border}; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: ${c.text};">
                                    <i class="fas fa-${c.icon}"></i>
                                    <strong>Allergy: ${risk.allergy}</strong>
                                </div>
                                <p style="margin: 0.25rem 0 0 1.5rem; font-size: 0.85rem; color: #64748b;">${risk.note}</p>
                            </div>
                        `;
                    }
                    
                    return `
                        <div style="background: ${c.bg}; border-left: 4px solid ${c.border}; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: ${c.text};">
                                <i class="fas fa-${c.icon}"></i>
                                <strong>${risk.severity}: ${risk.type === 'CROSS-REACT' ? 'Cross-Reactivity' : 'Allergy Conflict'}</strong>
                                <span class="badge" style="background: ${c.border}; color: white; font-size: 0.7rem;">${risk.type}</span>
                            </div>
                            <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                <strong>${risk.allergy}</strong> allergy â†’ <strong style="color: ${c.border};">${risk.drug}</strong> prescribed
                            </p>
                            <p style="margin: 0.25rem 0 0 1.5rem; font-size: 0.85rem; color: #64748b;">
                                Potential reaction: ${risk.reaction}
                            </p>
                        </div>
                    `;
                }).join('');
            }
        }

        function analyzeContextRisks(age, conditions, medNames, medCount) {
            const container = document.getElementById('contextRisksContent');
            const levelBadge = document.getElementById('contextRiskLevel');
            const risks = [];
            let maxLevel = 'LOW';
            const levelOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MODERATE': 2, 'LOW': 1 };
            
            // Check age-related risks
            if (age >= CONTEXT_RISK_FACTORS.age.elderly.threshold) {
                risks.push({
                    category: 'Age (Elderly)',
                    icon: 'user-clock',
                    level: CONTEXT_RISK_FACTORS.age.elderly.level,
                    details: CONTEXT_RISK_FACTORS.age.elderly.risks,
                    note: `Patient is ${age} years old - increased sensitivity to medications`
                });
                if (levelOrder[CONTEXT_RISK_FACTORS.age.elderly.level] > levelOrder[maxLevel]) {
                    maxLevel = CONTEXT_RISK_FACTORS.age.elderly.level;
                }
            } else if (age > 0 && age <= CONTEXT_RISK_FACTORS.age.pediatric.threshold) {
                risks.push({
                    category: 'Age (Pediatric)',
                    icon: 'child',
                    level: CONTEXT_RISK_FACTORS.age.pediatric.level,
                    details: CONTEXT_RISK_FACTORS.age.pediatric.risks,
                    note: `Patient is ${age} years old - pediatric dosing considerations`
                });
                if (levelOrder[CONTEXT_RISK_FACTORS.age.pediatric.level] > levelOrder[maxLevel]) {
                    maxLevel = CONTEXT_RISK_FACTORS.age.pediatric.level;
                }
            }
            
            // Check condition-related risks
            conditions.forEach(condition => {
                const condUpper = condition.toUpperCase();
                Object.entries(CONTEXT_RISK_FACTORS.conditions).forEach(([condName, info]) => {
                    if (condUpper.includes(condName.toUpperCase())) {
                        // Check if any risky drugs are prescribed
                        const riskyDrugsFound = info.drugRisks.filter(drug => 
                            medNames.some(m => m.includes(drug.toUpperCase()))
                        );
                        
                        if (riskyDrugsFound.length > 0) {
                            risks.push({
                                category: `${condition} + Medication Conflict`,
                                icon: 'heartbeat',
                                level: info.level,
                                details: [`Conflicting drugs: ${riskyDrugsFound.join(', ')}`],
                                note: info.effect
                            });
                            if (levelOrder[info.level] > levelOrder[maxLevel]) {
                                maxLevel = info.level;
                            }
                        }
                    }
                });
            });
            
            // Check polypharmacy
            if (medCount >= CONTEXT_RISK_FACTORS.polypharmacy.threshold) {
                risks.push({
                    category: 'Polypharmacy',
                    icon: 'pills',
                    level: CONTEXT_RISK_FACTORS.polypharmacy.level,
                    details: CONTEXT_RISK_FACTORS.polypharmacy.risks,
                    note: `Patient is on ${medCount} medications - increased risk of interactions and side effects`
                });
                if (levelOrder[CONTEXT_RISK_FACTORS.polypharmacy.level] > levelOrder[maxLevel]) {
                    maxLevel = CONTEXT_RISK_FACTORS.polypharmacy.level;
                }
            }
            
            // Update badge
            const badgeColors = { 'CRITICAL': '#dc2626', 'HIGH': '#ef4444', 'MODERATE': '#f59e0b', 'LOW': '#16a34a' };
            levelBadge.textContent = risks.length > 0 ? maxLevel : 'LOW RISK';
            levelBadge.style.background = badgeColors[maxLevel] || '#16a34a';
            
            if (risks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #16a34a;">
                        <i class="fas fa-shield-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">No elevated context-based risks identified</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #64748b;">
                            Age: ${age || 'N/A'} â€¢ Conditions: ${conditions.length || 0} â€¢ Medications: ${medCount}
                        </p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; display: flex; gap: 2rem; flex-wrap: wrap;">
                        <span><strong>Age:</strong> ${age || 'N/A'}</span>
                        <span><strong>Conditions:</strong> ${conditions.length || 0}</span>
                        <span><strong>Active Meds:</strong> ${medCount}</span>
                        <span><strong>Overall Risk:</strong> <span style="color: ${badgeColors[maxLevel]}; font-weight: 700;">${maxLevel}</span></span>
                    </div>
                    ${risks.map(risk => {
                        const colors = {
                            'CRITICAL': { bg: '#fef2f2', border: '#dc2626', text: '#991b1b' },
                            'HIGH': { bg: '#fef2f2', border: '#ef4444', text: '#b91c1c' },
                            'MODERATE': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                            'LOW': { bg: '#f0fdf4', border: '#16a34a', text: '#166534' }
                        };
                        const c = colors[risk.level] || colors['MODERATE'];
                        
                        return `
                            <div style="background: ${c.bg}; border-left: 4px solid ${c.border}; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: ${c.text};">
                                    <i class="fas fa-${risk.icon}"></i>
                                    <strong>${risk.category}</strong>
                                    <span class="badge" style="background: ${c.border}; color: white; font-size: 0.7rem;">${risk.level}</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem; color: #374151;">${risk.note}</p>
                                <ul style="margin: 0.25rem 0 0 1.5rem; padding-left: 1rem; font-size: 0.85rem; color: #64748b;">
                                    ${risk.details.map(d => `<li>${d}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }).join('')}
                `;
            }
        }

        function analyzeDrugInteractions(medNames) {
            const container = document.getElementById('drugInteractionsContent');
            const countBadge = document.getElementById('interactionCount');
            const interactions = [];
            
            // Check each interaction in our database
            DRUG_INTERACTIONS.forEach(interaction => {
                const drug1Upper = interaction.drug1.toUpperCase();
                const drug2Upper = interaction.drug2.toUpperCase();
                
                const hasDrug1 = medNames.some(m => m.includes(drug1Upper));
                const hasDrug2 = medNames.some(m => m.includes(drug2Upper));
                
                if (hasDrug1 && hasDrug2) {
                    interactions.push(interaction);
                }
            });
            
            // Sort by severity
            const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MODERATE': 2, 'LOW': 3 };
            interactions.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
            
            const criticalCount = interactions.filter(i => i.severity === 'CRITICAL').length;
            const highCount = interactions.filter(i => i.severity === 'HIGH').length;
            
            countBadge.textContent = interactions.length;
            countBadge.style.background = criticalCount > 0 ? '#dc2626' : (highCount > 0 ? '#ef4444' : '#16a34a');
            
            if (interactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #16a34a;">
                        <i class="fas fa-check-double" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">No significant drug-drug interactions detected</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #64748b;">
                            ${medNames.length} medications analyzed against interaction database
                        </p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <span><strong>Total Interactions:</strong> ${interactions.length}</span>
                        ${criticalCount > 0 ? `<span class="badge" style="background: #dc2626; color: white;">âš ï¸ ${criticalCount} Critical</span>` : ''}
                        ${highCount > 0 ? `<span class="badge" style="background: #ef4444; color: white;">ðŸ”´ ${highCount} High</span>` : ''}
                    </div>
                    ${interactions.map((interaction, idx) => {
                        const colors = {
                            'CRITICAL': { bg: '#fef2f2', border: '#dc2626', icon: 'skull-crossbones', text: '#991b1b', emoji: 'â›”' },
                            'HIGH': { bg: '#fef2f2', border: '#ef4444', icon: 'exclamation-triangle', text: '#b91c1c', emoji: 'ðŸ”´' },
                            'MODERATE': { bg: '#fef3c7', border: '#f59e0b', icon: 'exclamation-circle', text: '#92400e', emoji: 'ðŸŸ¡' },
                            'LOW': { bg: '#eff6ff', border: '#3b82f6', icon: 'info-circle', text: '#1e40af', emoji: 'ðŸ”µ' }
                        };
                        const c = colors[interaction.severity];
                        
                        return `
                            <div style="background: ${c.bg}; border-left: 4px solid ${c.border}; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: ${c.text};">
                                    <span style="font-size: 1.25rem;">${c.emoji}</span>
                                    <strong>#${idx + 1} ${interaction.severity}</strong>
                                    <span style="font-weight: 400;">â€” ${interaction.drug1} + ${interaction.drug2}</span>
                                </div>
                                <div style="margin: 0.5rem 0 0 2rem;">
                                    <p style="margin: 0; font-size: 0.9rem; color: #374151;">
                                        <strong>Effect:</strong> ${interaction.effect}
                                    </p>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #059669;">
                                        <i class="fas fa-lightbulb" style="margin-right: 0.25rem;"></i>
                                        <strong>Recommendation:</strong> ${interaction.recommendation}
                                    </p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }
        }

        function clearPatientView() {
            currentViewedPatient = null;
            document.getElementById('patientNotFoundState').style.display = 'block';
            document.getElementById('patientFoundState').style.display = 'none';
            document.getElementById('doctorPatientUidInput').value = '';
        }

        // ==================== Longitudinal Patient History (Hardcoded Sample Data) ====================
        
        // Comprehensive patient history preserved without overwrite
        const LONGITUDINAL_HISTORY = {
            // Full Medication History - tracks all medications ever prescribed
            medicationHistory: [
                {
                    date: '2025-07-19',
                    action: 'STARTED',
                    medication: 'TAB FLEXURA-D (Diclofenac + Metaxalone)',
                    dosage: '1-0-1',
                    duration: '10 Days',
                    prescribedBy: 'Dr. Jayesh Dhake',
                    reason: 'Low Back Pain',
                    status: 'ACTIVE'
                },
                {
                    date: '2025-07-19',
                    action: 'STARTED',
                    medication: 'TAB SKELOCAL-CT (Calcium + Calcitriol)',
                    dosage: '1-0-0',
                    duration: '10 Days',
                    prescribedBy: 'Dr. Jayesh Dhake',
                    reason: 'Bone Health Support',
                    status: 'ACTIVE'
                },
                {
                    date: '2025-07-19',
                    action: 'STARTED',
                    medication: 'TAB NICOPENTA (Nicotinamide + Pantothenic Acid)',
                    dosage: '1-0-1',
                    duration: '30 Days',
                    prescribedBy: 'Dr. Jayesh Dhake',
                    reason: 'Vitamin B5 & B3 Supplementation',
                    status: 'ACTIVE'
                },
                {
                    date: '2025-07-19',
                    action: 'STARTED',
                    medication: 'TAB VITENCIAL (Multivitamin + Minerals)',
                    dosage: '0-1-0',
                    duration: '30 Days',
                    prescribedBy: 'Dr. Jayesh Dhake',
                    reason: 'General Health & Nutrition Support',
                    status: 'ACTIVE'
                },
                {
                    date: '2024-09-20',
                    action: 'STARTED',
                    medication: 'TAB TELMA 40 (Telmisartan)',
                    dosage: '1-0-0',
                    duration: 'Ongoing',
                    prescribedBy: 'Dr. Ramesh Patil',
                    reason: 'Hypertension',
                    status: 'ACTIVE'
                },
                {
                    date: '2025-06-16',
                    action: 'COMPLETED',
                    medication: 'TAB RIDOL (Loperamide)',
                    dosage: '1-0-1',
                    duration: '1 Day',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'Diarrhea',
                    status: 'COMPLETED',
                    outcome: 'Resolved'
                },
                {
                    date: '2025-06-06',
                    action: 'STARTED',
                    medication: 'CYRA D 10 TAB (Rabeprazole + Domperidone)',
                    dosage: '0-0-1',
                    duration: '5 Days',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'Gastroenteritis',
                    status: 'COMPLETED',
                    outcome: 'Symptoms resolved'
                },
                {
                    date: '2025-06-06',
                    action: 'STARTED',
                    medication: 'TAB O2 (Ofloxacin + Ornidazole)',
                    dosage: '1-0-1',
                    duration: '5 Days',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'Acute Gastroenteritis - Antibiotic',
                    status: 'COMPLETED',
                    outcome: 'Infection cleared'
                },
                {
                    date: '2025-03-18',
                    action: 'COMPLETED',
                    medication: 'CAP NEXPRO RD 40 MG (Esomeprazole)',
                    dosage: '0-0-1',
                    duration: '10 Days',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'GERD',
                    status: 'COMPLETED',
                    outcome: 'Acid reflux controlled'
                },
                {
                    date: '2025-03-08',
                    action: 'STARTED',
                    medication: 'TAB LEVOCET M (Levocetirizine + Montelukast)',
                    dosage: '0-0-1',
                    duration: '10 Days',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'Allergic Bronchitis',
                    status: 'COMPLETED',
                    outcome: 'Cough resolved'
                },
                {
                    date: '2025-03-08',
                    action: 'STARTED',
                    medication: 'SYP GRILINCTUS-L (Levocloperastine)',
                    dosage: '10ml 1-0-1',
                    duration: '5 Days',
                    prescribedBy: 'Dr. Harshal Pilodekar',
                    reason: 'Chronic Cough (2 months)',
                    status: 'COMPLETED',
                    outcome: 'Cough suppressed'
                },
                {
                    date: '2024-11-15',
                    action: 'DISCONTINUED',
                    medication: 'TAB ATORVASTATIN 10 MG',
                    dosage: '0-0-1',
                    duration: 'Long-term',
                    prescribedBy: 'Dr. Sunita Sharma',
                    reason: 'Elevated cholesterol',
                    status: 'DISCONTINUED',
                    outcome: 'Patient reported muscle pain - switched to alternative'
                }
            ],
            
            // Symptom Progression History - tracks how symptoms evolved
            symptomProgression: [
                {
                    date: '2025-07-19',
                    symptoms: ['Low back pain', 'Difficulty bending', 'Pain radiating to left leg'],
                    severity: 'MODERATE',
                    trigger: 'Lifting heavy object',
                    notes: 'Acute onset after lifting heavy furniture',
                    progression: 'NEW'
                },
                {
                    date: '2025-06-06',
                    symptoms: ['Loose motions', 'Abdominal cramps', 'Nausea', 'Low-grade fever'],
                    severity: 'MODERATE',
                    trigger: 'Suspected food contamination',
                    notes: '4-5 episodes/day, watery stools',
                    progression: 'NEW'
                },
                {
                    date: '2025-06-11',
                    symptoms: ['Loose motions resolved', 'Mild abdominal discomfort'],
                    severity: 'MILD',
                    trigger: null,
                    notes: 'Responding well to treatment',
                    progression: 'IMPROVING'
                },
                {
                    date: '2025-03-08',
                    symptoms: ['Persistent dry cough', 'Chest tightness', 'Acid reflux', 'Throat irritation'],
                    severity: 'MODERATE',
                    trigger: 'Seasonal change, dust exposure',
                    notes: 'Cough for 2 months, worse at night',
                    progression: 'CHRONIC'
                },
                {
                    date: '2025-03-18',
                    symptoms: ['Cough reduced by 70%', 'No acid reflux', 'Mild throat clearing'],
                    severity: 'MILD',
                    trigger: null,
                    notes: 'Good response to treatment',
                    progression: 'RESOLVED'
                },
                {
                    date: '2024-09-20',
                    symptoms: ['Headache', 'Dizziness', 'Fatigue'],
                    severity: 'MILD',
                    trigger: 'Routine health checkup revealed high BP',
                    notes: 'BP: 150/95 mmHg',
                    progression: 'NEW'
                },
                {
                    date: '2024-10-20',
                    symptoms: ['No headache', 'Occasional mild dizziness'],
                    severity: 'MILD',
                    trigger: null,
                    notes: 'BP improved to 135/88 with medication',
                    progression: 'IMPROVING'
                },
                {
                    date: '2025-01-15',
                    symptoms: ['No symptoms', 'Feels well'],
                    severity: 'NONE',
                    trigger: null,
                    notes: 'BP stable at 130/85',
                    progression: 'CONTROLLED'
                }
            ],
            
            // Diagnosis History - all diagnoses made over time
            diagnosisHistory: [
                {
                    date: '2025-07-19',
                    diagnosis: 'Lumbar Strain / Mechanical Low Back Pain',
                    icd10: 'M54.5',
                    diagnosedBy: 'Dr. Jayesh Dhake (Orthopedic Surgeon)',
                    confidence: 'CONFIRMED',
                    status: 'ACTIVE',
                    investigations: ['X-Ray LS Spine AP/LAT', 'MRI LS Spine (advised)'],
                    notes: 'No red flags, no neurological deficit'
                },
                {
                    date: '2025-06-06',
                    diagnosis: 'Acute Gastroenteritis',
                    icd10: 'A09',
                    diagnosedBy: 'Dr. Harshal Pilodekar (Internal Medicine)',
                    confidence: 'CONFIRMED',
                    status: 'RESOLVED',
                    investigations: ['Clinical examination'],
                    notes: 'Likely viral/bacterial etiology, no blood in stool'
                },
                {
                    date: '2025-03-08',
                    diagnosis: 'GERD with Allergic Bronchitis',
                    icd10: 'K21.0, J45.20',
                    diagnosedBy: 'Dr. Harshal Pilodekar (Internal Medicine)',
                    confidence: 'CLINICAL',
                    status: 'RESOLVED',
                    investigations: ['Clinical examination', 'Chest auscultation'],
                    notes: 'Chronic cough likely due to combination of acid reflux and allergic component'
                },
                {
                    date: '2024-09-20',
                    diagnosis: 'Essential Hypertension (Stage 1)',
                    icd10: 'I10',
                    diagnosedBy: 'Dr. Ramesh Patil (Cardiologist)',
                    confidence: 'CONFIRMED',
                    status: 'ONGOING',
                    investigations: ['BP monitoring', 'ECG', 'Lipid profile', 'Kidney function test'],
                    notes: 'No end-organ damage, lifestyle modifications advised'
                },
                {
                    date: '2024-09-20',
                    diagnosis: 'Dyslipidemia',
                    icd10: 'E78.5',
                    diagnosedBy: 'Dr. Ramesh Patil (Cardiologist)',
                    confidence: 'CONFIRMED',
                    status: 'MONITORING',
                    investigations: ['Lipid profile: TC 245, LDL 165, HDL 42, TG 190'],
                    notes: 'Statin discontinued due to side effects, on dietary management'
                }
            ],
            
            // Visit-wise Summaries - comprehensive visit records
            visitSummaries: [
                {
                    visitId: 'V005',
                    date: '2025-07-19',
                    time: '3:30 PM',
                    type: 'OPD',
                    opNo: '97395',
                    department: 'Orthopedics',
                    doctor: 'Dr. Jayesh Chandrakant Dhake',
                    chiefComplaint: 'Low back pain since 2 days after lifting heavy object',
                    vitals: { bp: '128/82', pulse: '78', temp: '98.4Â°F', weight: '72 kg' },
                    examination: 'Tenderness L4-L5, Paravertebral muscle spasm, SLR negative, No neurological deficit',
                    diagnosis: 'Lumbar Strain',
                    investigations: { ordered: ['X-Ray LS Spine', 'MRI LS Spine'], completed: ['X-Ray LS Spine'] },
                    treatment: ['TAB FLEXURA-D 1-0-1', 'TAB NICOPENTA 40 MG 1-0-1', 'TAB SKELOCAL-CT 1-0-0', 'TAB VITENCIAL 1-0-0'],
                    advice: ['Bed rest for 3 days', 'Hot fomentation', 'Avoid lifting heavy weights', 'Lumbar support belt'],
                    followUp: '1 week',
                    outcome: 'Under treatment'
                },
                {
                    visitId: 'V004',
                    date: '2025-06-06',
                    time: '6:40 PM',
                    type: 'OPD',
                    opNo: '75970',
                    department: 'Internal Medicine',
                    doctor: 'Dr. Harshal Chandrashekhar Pilodekar',
                    chiefComplaint: 'Loose motions and abdominal cramps since morning',
                    vitals: { bp: '118/76', pulse: '88', temp: '99.2Â°F', weight: '71 kg' },
                    examination: 'Mild dehydration, Abdomen soft, diffuse tenderness, hyperactive bowel sounds',
                    diagnosis: 'Acute Gastroenteritis',
                    investigations: { ordered: [], completed: ['Clinical examination'] },
                    treatment: ['CYRA D 10 TAB 0-0-1', 'TAB O2 1-0-1', 'TAB CYCLOPAM SOS', 'TAB SUMOL 650 SOS', 'TAB RIDOL 1-0-1 x1 day', 'ORS'],
                    advice: ['Plenty of fluids', 'Bland diet', 'Avoid spicy/oily food', 'Hand hygiene'],
                    followUp: 'If symptoms persist > 3 days',
                    outcome: 'Resolved within 5 days'
                },
                {
                    visitId: 'V003',
                    date: '2025-03-08',
                    time: '6:55 PM',
                    type: 'OPD',
                    opNo: '33701',
                    department: 'Internal Medicine',
                    doctor: 'Dr. Harshal Chandrashekhar Pilodekar',
                    chiefComplaint: 'Persistent cough for 2 months, worse at night, associated with acid reflux',
                    vitals: { bp: '132/84', pulse: '76', temp: '98.6Â°F', weight: '72 kg' },
                    examination: 'Chest clear, No wheeze, Throat congested, Epigastric tenderness',
                    diagnosis: 'GERD with Allergic Bronchitis',
                    investigations: { ordered: [], completed: ['Chest auscultation'] },
                    treatment: ['CAP NEXPRO RD 40 MG 0-0-1', 'SYP GRILINCTUS-L 10ml 1-0-1', 'TAB LEVOCET M 0-0-1'],
                    advice: ['Avoid late night meals', 'Elevate head during sleep', 'Avoid dust exposure', 'Steam inhalation'],
                    followUp: '10 days',
                    outcome: 'Symptoms resolved'
                },
                {
                    visitId: 'V002',
                    date: '2024-11-15',
                    time: '11:00 AM',
                    type: 'Follow-up',
                    opNo: '45123',
                    department: 'Cardiology',
                    doctor: 'Dr. Sunita Sharma',
                    chiefComplaint: 'Follow-up for hypertension, complaint of muscle pain',
                    vitals: { bp: '130/84', pulse: '72', temp: '98.4Â°F', weight: '73 kg' },
                    examination: 'General condition good, Muscle tenderness in thighs',
                    diagnosis: 'Statin-induced myalgia',
                    investigations: { ordered: ['CPK levels'], completed: ['CPK: 380 U/L (mildly elevated)'] },
                    treatment: ['Continue TAB TELMA 40', 'STOP Atorvastatin'],
                    advice: ['Dietary modification for cholesterol', 'Increase fiber intake', 'Regular exercise'],
                    followUp: '1 month',
                    outcome: 'Muscle pain resolved after stopping statin'
                },
                {
                    visitId: 'V001',
                    date: '2024-09-20',
                    time: '10:30 AM',
                    type: 'Health Checkup',
                    opNo: '38456',
                    department: 'Cardiology',
                    doctor: 'Dr. Ramesh Patil',
                    chiefComplaint: 'Routine health checkup, occasional headaches',
                    vitals: { bp: '150/95', pulse: '82', temp: '98.4Â°F', weight: '74 kg' },
                    examination: 'No abnormality detected, BMI: 26.2 (Overweight)',
                    diagnosis: 'Essential Hypertension Stage 1, Dyslipidemia',
                    investigations: { ordered: [], completed: ['ECG: Normal', 'Lipid Profile: TC 245, LDL 165', 'FBS: 98 mg/dL', 'Creatinine: 0.9'] },
                    treatment: ['TAB TELMA 40 1-0-0', 'TAB ATORVASTATIN 10 0-0-1'],
                    advice: ['Low salt diet', 'Regular exercise 30 min/day', 'Weight reduction', 'Avoid smoking/alcohol'],
                    followUp: '1 month',
                    outcome: 'BP controlled, Statin later discontinued'
                }
            ],
            
            // Historical States Preserved
            historicalStates: {
                allergiesTimeline: [
                    { date: '2024-09-20', allergies: [], updatedBy: 'Dr. Ramesh Patil' },
                    { date: '2025-03-08', allergies: ['Dust'], updatedBy: 'Dr. Harshal Pilodekar', note: 'Patient reported dust allergy triggering cough' }
                ],
                conditionsTimeline: [
                    { date: '2024-09-20', conditions: ['Hypertension', 'Dyslipidemia'], updatedBy: 'Dr. Ramesh Patil' },
                    { date: '2025-03-08', conditions: ['Hypertension', 'Dyslipidemia', 'GERD'], updatedBy: 'Dr. Harshal Pilodekar' }
                ],
                weightHistory: [
                    { date: '2024-09-20', weight: 74, unit: 'kg' },
                    { date: '2024-11-15', weight: 73, unit: 'kg' },
                    { date: '2025-03-08', weight: 72, unit: 'kg' },
                    { date: '2025-06-06', weight: 71, unit: 'kg' },
                    { date: '2025-07-19', weight: 72, unit: 'kg' }
                ],
                bpHistory: [
                    { date: '2024-09-20', systolic: 150, diastolic: 95, note: 'Initial detection' },
                    { date: '2024-11-15', systolic: 130, diastolic: 84, note: 'On Telmisartan' },
                    { date: '2025-03-08', systolic: 132, diastolic: 84, note: 'Stable' },
                    { date: '2025-06-06', systolic: 118, diastolic: 76, note: 'During illness' },
                    { date: '2025-07-19', systolic: 128, diastolic: 82, note: 'Well controlled' }
                ]
            }
        };

        let currentHistoryTab = 'medications';

        function switchHistoryTab(tab) {
            currentHistoryTab = tab;
            
            // Update tab button styles
            ['Meds', 'Symptoms', 'Diagnosis', 'Visits'].forEach(t => {
                const btn = document.getElementById('historyTab' + t);
                if (btn) {
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#374151';
                }
            });
            
            const tabMap = { 'medications': 'Meds', 'symptoms': 'Symptoms', 'diagnosis': 'Diagnosis', 'visits': 'Visits' };
            const activeBtn = document.getElementById('historyTab' + tabMap[tab]);
            if (activeBtn) {
                activeBtn.style.background = '#1d4ed8';
                activeBtn.style.color = 'white';
            }
            
            renderLongitudinalHistory();
        }

        function renderLongitudinalHistory() {
            const container = document.getElementById('viewPrescriptionHistory');
            const history = LONGITUDINAL_HISTORY;
            
            switch (currentHistoryTab) {
                case 'medications':
                    renderMedicationHistory(container, history.medicationHistory);
                    break;
                case 'symptoms':
                    renderSymptomProgression(container, history.symptomProgression);
                    break;
                case 'diagnosis':
                    renderDiagnosisHistory(container, history.diagnosisHistory);
                    break;
                case 'visits':
                    renderVisitSummaries(container, history.visitSummaries);
                    break;
            }
        }

        function renderMedicationHistory(container, meds) {
            const statusColors = {
                'ACTIVE': { bg: '#dcfce7', border: '#16a34a', text: '#166534' },
                'ONGOING': { bg: '#dbeafe', border: '#2563eb', text: '#1e40af' },
                'COMPLETED': { bg: '#f3f4f6', border: '#6b7280', text: '#374151' },
                'DISCONTINUED': { bg: '#fef2f2', border: '#dc2626', text: '#991b1b' }
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 8px;">
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.85rem;">
                        <span><i class="fas fa-pills" style="color: #16a34a;"></i> Active: ${meds.filter(m => m.status === 'ACTIVE').length}</span>
                        <span><i class="fas fa-sync" style="color: #2563eb;"></i> Ongoing: ${meds.filter(m => m.status === 'ONGOING').length}</span>
                        <span><i class="fas fa-check" style="color: #6b7280;"></i> Completed: ${meds.filter(m => m.status === 'COMPLETED').length}</span>
                        <span><i class="fas fa-times" style="color: #dc2626;"></i> Discontinued: ${meds.filter(m => m.status === 'DISCONTINUED').length}</span>
                    </div>
                </div>
                <div style="position: relative; padding-left: 20px;">
                    <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #3b82f6, #8b5cf6);"></div>
                    ${meds.map(med => {
                        const c = statusColors[med.status] || statusColors['COMPLETED'];
                        return `
                            <div style="position: relative; margin-bottom: 1rem;">
                                <div style="position: absolute; left: -16px; width: 12px; height: 12px; background: ${c.border}; border-radius: 50%; border: 2px solid white;"></div>
                                <div style="background: ${c.bg}; border-left: 3px solid ${c.border}; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                                        <div>
                                            <span style="font-weight: 600; color: ${c.text};">${med.medication}</span>
                                            <span class="badge" style="background: ${c.border}; color: white; font-size: 0.7rem; margin-left: 0.5rem;">${med.status}</span>
                                        </div>
                                        <span style="font-size: 0.8rem; color: #64748b;">${med.date}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">
                                        ${med.dosage} â€¢ ${med.duration} â€¢ ${med.prescribedBy}
                                    </div>
                                    <div style="font-size: 0.85rem; margin-top: 0.25rem;">
                                        <span style="color: #374151;"><strong>Reason:</strong> ${med.reason}</span>
                                    </div>
                                    ${med.outcome ? `<div style="font-size: 0.85rem; color: #059669; margin-top: 0.25rem;"><i class="fas fa-check-circle"></i> ${med.outcome}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderSymptomProgression(container, symptoms) {
            const severityColors = {
                'NONE': { bg: '#f0fdf4', color: '#16a34a' },
                'MILD': { bg: '#fef3c7', color: '#d97706' },
                'MODERATE': { bg: '#fed7aa', color: '#ea580c' },
                'SEVERE': { bg: '#fecaca', color: '#dc2626' }
            };
            
            const progressionIcons = {
                'NEW': { icon: 'plus-circle', color: '#dc2626' },
                'IMPROVING': { icon: 'arrow-down', color: '#16a34a' },
                'WORSENING': { icon: 'arrow-up', color: '#dc2626' },
                'CHRONIC': { icon: 'clock', color: '#f59e0b' },
                'RESOLVED': { icon: 'check-circle', color: '#16a34a' },
                'CONTROLLED': { icon: 'shield-alt', color: '#3b82f6' }
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #92400e;"><i class="fas fa-heartbeat"></i> Symptom Progression Timeline</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #78350f;">Tracking how symptoms evolved over time</p>
                </div>
                ${symptoms.map(sym => {
                    const sev = severityColors[sym.severity] || severityColors['MILD'];
                    const prog = progressionIcons[sym.progression] || progressionIcons['NEW'];
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-${prog.icon}" style="color: ${prog.color}; font-size: 1.25rem;"></i>
                                    <span style="font-weight: 600; color: #374151;">${sym.date}</span>
                                    <span class="badge" style="background: ${prog.color}; color: white;">${sym.progression}</span>
                                </div>
                                <span class="badge" style="background: ${sev.bg}; color: ${sev.color};">${sym.severity}</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                                ${sym.symptoms.map(s => `<span class="badge" style="background: #f1f5f9; color: #475569;">${s}</span>`).join('')}
                            </div>
                            ${sym.trigger ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #64748b;"><i class="fas fa-bolt" style="color: #f59e0b;"></i> Trigger: ${sym.trigger}</p>` : ''}
                            ${sym.notes ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #374151;"><i class="fas fa-sticky-note" style="color: #3b82f6;"></i> ${sym.notes}</p>` : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderDiagnosisHistory(container, diagnoses) {
            const statusColors = {
                'ACTIVE': { bg: '#fef2f2', border: '#ef4444', badge: '#dc2626' },
                'RESOLVED': { bg: '#f0fdf4', border: '#22c55e', badge: '#16a34a' },
                'ONGOING': { bg: '#fffbeb', border: '#f59e0b', badge: '#d97706' },
                'MONITORING': { bg: '#eff6ff', border: '#3b82f6', badge: '#2563eb' }
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fae8ff, #f5d0fe); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #86198f;"><i class="fas fa-diagnoses"></i> Complete Diagnosis History</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem;">
                        <span>Total: ${diagnoses.length}</span>
                        <span style="color: #dc2626;">Active: ${diagnoses.filter(d => d.status === 'ACTIVE').length}</span>
                        <span style="color: #d97706;">Ongoing: ${diagnoses.filter(d => d.status === 'ONGOING').length}</span>
                        <span style="color: #16a34a;">Resolved: ${diagnoses.filter(d => d.status === 'RESOLVED').length}</span>
                    </div>
                </div>
                ${diagnoses.map(diag => {
                    const c = statusColors[diag.status] || statusColors['MONITORING'];
                    return `
                        <div style="border: 1px solid ${c.border}; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: ${c.bg}; padding: 0.75rem 1rem; border-bottom: 1px solid ${c.border};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                                    <div>
                                        <span style="font-weight: 700; color: #1f2937; font-size: 1rem;">${diag.diagnosis}</span>
                                        <span class="badge" style="background: ${c.badge}; color: white; margin-left: 0.5rem;">${diag.status}</span>
                                    </div>
                                    <span style="font-size: 0.85rem; color: #64748b;">${diag.date}</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">
                                    ICD-10: ${diag.icd10} â€¢ ${diag.diagnosedBy}
                                </div>
                            </div>
                            <div style="padding: 0.75rem 1rem; background: white;">
                                <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                    <span class="badge" style="background: ${diag.confidence === 'CONFIRMED' ? '#dcfce7' : '#fef3c7'}; color: ${diag.confidence === 'CONFIRMED' ? '#166534' : '#92400e'};">
                                        ${diag.confidence}
                                    </span>
                                </div>
                                ${diag.investigations.length > 0 ? `
                                    <div style="font-size: 0.85rem; color: #374151; margin-bottom: 0.5rem;">
                                        <strong>Investigations:</strong> ${diag.investigations.join(', ')}
                                    </div>
                                ` : ''}
                                ${diag.notes ? `<p style="margin: 0; font-size: 0.85rem; color: #64748b;"><i class="fas fa-info-circle"></i> ${diag.notes}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderVisitSummaries(container, visits) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065f46;"><i class="fas fa-hospital-user"></i> Complete Visit History</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #047857;">Total Visits: ${visits.length} | Preserved without overwrite</p>
                </div>
                ${visits.map((visit, idx) => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 1rem; ${idx === 0 ? 'border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6;' : ''}">
                        <div style="background: ${idx === 0 ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'linear-gradient(135deg, #f8fafc, #f1f5f9)'}; color: ${idx === 0 ? 'white' : '#374151'}; padding: 0.75rem 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <span style="font-weight: 700;">${visit.date} ${visit.time}</span>
                                    ${idx === 0 ? '<span class="badge" style="background: rgba(255,255,255,0.3); color: white; margin-left: 0.5rem;">LATEST</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem;">
                                    <span class="badge" style="background: ${idx === 0 ? 'rgba(255,255,255,0.2)' : '#e5e7eb'}; color: ${idx === 0 ? 'white' : '#374151'};">${visit.type}</span>
                                    <span style="margin-left: 0.5rem;">OP# ${visit.opNo}</span>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; margin-top: 0.25rem; opacity: 0.9;">
                                ${visit.doctor} â€¢ ${visit.department}
                            </div>
                        </div>
                        <div style="padding: 1rem; background: white;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong style="color: #1f2937;">Chief Complaint:</strong>
                                <span style="color: #374151;"> ${visit.chiefComplaint}</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: #f8fafc; border-radius: 8px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: #64748b;">BP</div>
                                    <div style="font-weight: 600; color: #dc2626;">${visit.vitals.bp}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: #64748b;">Pulse</div>
                                    <div style="font-weight: 600; color: #f59e0b;">${visit.vitals.pulse}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: #64748b;">Temp</div>
                                    <div style="font-weight: 600; color: #3b82f6;">${visit.vitals.temp}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: #64748b;">Weight</div>
                                    <div style="font-weight: 600; color: #16a34a;">${visit.vitals.weight}</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: #7c3aed;">Diagnosis:</strong>
                                <span class="badge" style="background: #ede9fe; color: #5b21b6;">${visit.diagnosis}</span>
                            </div>
                            
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: #0369a1;">Treatment:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">
                                    ${visit.treatment.map(t => `<span class="badge" style="background: #e0f2fe; color: #0369a1; font-size: 0.75rem;">${t}</span>`).join('')}
                                </div>
                            </div>
                            
                            ${visit.advice.length > 0 ? `
                                <div style="margin-bottom: 0.5rem; font-size: 0.85rem;">
                                    <strong style="color: #16a34a;">Advice:</strong>
                                    <ul style="margin: 0.25rem 0 0 1.25rem; padding: 0; color: #374151;">
                                        ${visit.advice.map(a => `<li>${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-size: 0.85rem;">
                                <span style="color: #64748b;"><i class="fas fa-calendar-check"></i> Follow-up: ${visit.followUp}</span>
                                <span style="color: ${visit.outcome.includes('Resolved') || visit.outcome.includes('controlled') ? '#16a34a' : '#f59e0b'};">
                                    <i class="fas fa-${visit.outcome.includes('Resolved') ? 'check-circle' : 'clock'}"></i> ${visit.outcome}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ==================== Explainability & Evidence Tracking (Hardcoded Data) ====================
        
        const EXPLAINABILITY_DATA = {
            // Document Extractions - shows which document caused each extraction
            extractions: [
                {
                    fact: 'Patient Name: Mr. DHANANJAY NARAYAN GOSAVI',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 45, y: 120, width: 320, height: 28 },
                        extractedText: 'MR. DHANANJAY NARAYAN GOSAVI',
                        context: 'Patient header section, top-left of prescription form'
                    },
                    confidence: 0.98,
                    extractionMethod: 'OCR + NER (Named Entity Recognition)',
                    validatedBy: 'Pattern matching against UHID database'
                },
                {
                    fact: 'UHID: 23672',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 380, y: 120, width: 85, height: 24 },
                        extractedText: 'UHID : 23672',
                        context: 'Patient identifier field, adjacent to name'
                    },
                    confidence: 0.99,
                    extractionMethod: 'OCR + Regex Pattern (UHID: \\d+)',
                    validatedBy: 'Database lookup confirmed patient exists'
                },
                {
                    fact: 'Diagnosis: Lumbar Strain / Low Back Pain',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 50, y: 280, width: 400, height: 32 },
                        extractedText: 'LOW BACK PAIN, H/O LIFTING HEAVY OBJECT',
                        context: 'Chief complaint field after "C/O:" marker'
                    },
                    confidence: 0.94,
                    extractionMethod: 'OCR + Medical NLP (diagnosis extraction)',
                    validatedBy: 'ICD-10 code mapping: M54.5'
                },
                {
                    fact: 'Medication: TAB FLEXURA-D (Diclofenac + Metaxalone)',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 55, y: 350, width: 280, height: 26 },
                        extractedText: 'TAB FLEXURA-D    1-0-1 X 10 Days',
                        context: 'Medication list, Row 1 of Rx section'
                    },
                    confidence: 0.96,
                    extractionMethod: 'OCR + Drug Name NER + Dosage Parser',
                    validatedBy: 'Cross-referenced with RxNorm drug database'
                },
                {
                    fact: 'Doctor: Dr. Jayesh Chandrakant Dhake (ORTHOSURGEN)',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 320, y: 85, width: 250, height: 40 },
                        extractedText: 'Dr. Jayesh Chandrakant Dhake\nORTHOSURGEN',
                        context: 'Doctor signature block, top-right header'
                    },
                    confidence: 0.92,
                    extractionMethod: 'OCR + Doctor Registry Lookup',
                    validatedBy: 'Medical Council Registration verified'
                },
                {
                    fact: 'Allergy: Dust (triggers bronchitis)',
                    sourceDocument: 'Prescription_2025-03-08_InternalMed.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-03-08 18:58:12',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 50, y: 310, width: 180, height: 22 },
                        extractedText: 'Allergic Bronchitis',
                        context: 'Diagnosis field mentioning allergic component'
                    },
                    confidence: 0.88,
                    extractionMethod: 'Medical NLP + Allergy keyword extraction',
                    validatedBy: 'Flagged for manual confirmation by pharmacist'
                },
                {
                    fact: 'Visit Date: 19/07/2025 3:30PM',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 400, y: 155, width: 120, height: 20 },
                        extractedText: '19/07/2025  3:30PM',
                        context: 'Date/time stamp in prescription header'
                    },
                    confidence: 0.99,
                    extractionMethod: 'OCR + Date Parser (DD/MM/YYYY)',
                    validatedBy: 'Timestamp validation passed'
                },
                {
                    fact: 'Investigation: X-RAY LS SPINE - AP/LAT ordered',
                    sourceDocument: 'Prescription_2025-07-19_OrthoSurgery.pdf',
                    documentType: 'Prescription',
                    scannedDate: '2025-07-19 15:32:45',
                    textRegion: {
                        page: 1,
                        boundingBox: { x: 50, y: 480, width: 300, height: 24 },
                        extractedText: 'Adv. X-RAY LS SPINE - AP/LAT',
                        context: 'Investigation section after medication list'
                    },
                    confidence: 0.95,
                    extractionMethod: 'OCR + Medical Procedure NER',
                    validatedBy: 'LOINC code mapping verified'
                }
            ],
            
            // Drug Interaction Explanations
            interactionExplanations: [
                {
                    interaction: 'Diclofenac (FLEXURA-D) + Telmisartan (TELMA 40)',
                    severity: 'HIGH',
                    flaggedReason: 'NSAIDs reduce the antihypertensive effect of ACE inhibitors and ARBs',
                    evidenceSource: 'DrugBank Interaction Database v5.1.10',
                    mechanismOfAction: 'NSAIDs inhibit prostaglandin synthesis, which reduces renal blood flow and sodium excretion. This counteracts the vasodilatory and natriuretic effects of ARBs like Telmisartan.',
                    clinicalEvidence: [
                        'Meta-analysis of 50 studies (n=12,000+) showed 5-10 mmHg increase in BP',
                        'Increased risk of acute kidney injury in patients >65 years',
                        'Effect more pronounced with chronic NSAID use (>7 days)'
                    ],
                    patientContext: {
                        age: 46,
                        hasHypertension: true,
                        currentBP: '128/82 mmHg',
                        renalFunction: 'Normal (Cr: 0.9)'
                    },
                    riskAssessment: 'MODERATE - Short-term NSAID use (10 days) in patient with controlled BP. Monitor BP during treatment.',
                    recommendation: 'Monitor blood pressure every 2-3 days. Ensure adequate hydration. Consider paracetamol as alternative for pain if possible.',
                    references: [
                        'Fournier JP, et al. Drug-drug interactions with ACE inhibitors. Eur J Clin Pharmacol. 2014;70(12):1343-58.',
                        'FDA Drug Safety Communication: NSAIDs and Blood Pressure (2021)'
                    ]
                },
                {
                    interaction: 'Pantoprazole (NICOPENTA) + Potential future Clopidogrel use',
                    severity: 'MODERATE',
                    flaggedReason: 'PPIs may reduce antiplatelet effect of Clopidogrel if prescribed in future',
                    evidenceSource: 'FDA Drug Interaction Checker',
                    mechanismOfAction: 'Pantoprazole inhibits CYP2C19 enzyme which is required to convert Clopidogrel to its active metabolite. This reduces the antiplatelet effect.',
                    clinicalEvidence: [
                        'COGENT trial showed reduced GI bleeding with PPI + Clopidogrel',
                        'Some studies show 25-40% reduction in active metabolite levels',
                        'FDA warning issued in 2009, updated guidance in 2010'
                    ],
                    patientContext: {
                        currentlyOnClopidogrel: false,
                        hasCardiovascularRisk: true,
                        note: 'Patient has hypertension and dyslipidemia - may need antiplatelet in future'
                    },
                    riskAssessment: 'LOW (Currently) - Patient not on Clopidogrel. Flagged for awareness.',
                    recommendation: 'If Clopidogrel is prescribed in future, consider switching PPI to alternatives with less CYP2C19 inhibition (e.g., pantoprazole is actually among the safer options).',
                    references: [
                        'Bhatt DL, et al. Clopidogrel with or without omeprazole. N Engl J Med. 2010;363(20):1909-17.'
                    ]
                },
                {
                    interaction: 'Calcium (SKELOCAL-CT) + Potential Thyroid medication',
                    severity: 'LOW',
                    flaggedReason: 'Calcium supplements can reduce absorption of thyroid hormones if taken together',
                    evidenceSource: 'Lexicomp Drug Interactions',
                    mechanismOfAction: 'Calcium forms insoluble complexes with levothyroxine in the GI tract, reducing its absorption by up to 40%.',
                    clinicalEvidence: [
                        'Studies show 20-40% reduction in levothyroxine absorption',
                        'Effect prevented by separating doses by 4+ hours'
                    ],
                    patientContext: {
                        currentlyOnThyroid: false,
                        thyroidHistory: 'No thyroid disorder documented'
                    },
                    riskAssessment: 'INFORMATIONAL - Patient not on thyroid medication. Logged for future reference.',
                    recommendation: 'If thyroid medication is prescribed in future, advise patient to take calcium at least 4 hours apart.',
                    references: [
                        'Singh N, et al. Effect of calcium carbonate on the absorption of levothyroxine. JAMA Intern Med. 2000.'
                    ]
                }
            ],
            
            // Reasoning Steps for Conclusions
            reasoningChains: [
                {
                    conclusion: 'Patient has controlled Essential Hypertension',
                    confidenceScore: 0.94,
                    reasoningSteps: [
                        {
                            step: 1,
                            action: 'Extract BP readings from all visits',
                            evidence: 'Sept 2024: 150/95, Nov 2024: 130/84, Mar 2025: 132/84, Jul 2025: 128/82',
                            source: 'OCR extraction from 4 prescriptions'
                        },
                        {
                            step: 2,
                            action: 'Identify antihypertensive medication',
                            evidence: 'TAB TELMA 40 (Telmisartan) started Sept 2024, ongoing',
                            source: 'Medication timeline analysis'
                        },
                        {
                            step: 3,
                            action: 'Calculate BP trend',
                            evidence: 'Systolic: 150 â†’ 130 â†’ 132 â†’ 128 (22 mmHg reduction)',
                            source: 'Statistical trend analysis'
                        },
                        {
                            step: 4,
                            action: 'Compare with target BP',
                            evidence: 'Current 128/82 is within target (<140/90 for Stage 1 HTN)',
                            source: 'JNC 8 Guidelines comparison'
                        },
                        {
                            step: 5,
                            action: 'Final Assessment',
                            evidence: 'Sustained BP control over 10+ months on single agent therapy',
                            source: 'Clinical reasoning engine'
                        }
                    ],
                    alternativeHypotheses: [
                        { hypothesis: 'White coat hypertension', likelihood: 0.15, reason: 'Initial reading was single measurement' },
                        { hypothesis: 'Resistant hypertension', likelihood: 0.05, reason: 'Good response to single agent' }
                    ]
                },
                {
                    conclusion: 'GERD with Allergic Bronchitis - Resolved',
                    confidenceScore: 0.91,
                    reasoningSteps: [
                        {
                            step: 1,
                            action: 'Extract symptoms from Mar 2025 visit',
                            evidence: 'Persistent cough (2 months), acid reflux, chest tightness',
                            source: 'Chief complaint OCR extraction'
                        },
                        {
                            step: 2,
                            action: 'Identify prescribed treatment',
                            evidence: 'PPI (Nexpro), Antihistamine (Levocet M), Cough suppressant',
                            source: 'Medication extraction'
                        },
                        {
                            step: 3,
                            action: 'Check for follow-up symptoms',
                            evidence: 'No cough/GERD complaints in subsequent visits (Jun, Jul 2025)',
                            source: 'Longitudinal symptom tracking'
                        },
                        {
                            step: 4,
                            action: 'Assess treatment duration compliance',
                            evidence: '10-day course completed as prescribed',
                            source: 'Medication timeline'
                        },
                        {
                            step: 5,
                            action: 'Mark condition status',
                            evidence: 'No recurrence in 4+ months, marking as RESOLVED',
                            source: 'Clinical status engine'
                        }
                    ],
                    alternativeHypotheses: [
                        { hypothesis: 'Chronic GERD requiring maintenance', likelihood: 0.25, reason: 'May recur without lifestyle changes' }
                    ]
                },
                {
                    conclusion: 'Polypharmacy Risk: MODERATE',
                    confidenceScore: 0.87,
                    reasoningSteps: [
                        {
                            step: 1,
                            action: 'Count active medications',
                            evidence: '5 active medications: Telma, Flexura-D, Nicopenta, Skelocal-CT, Vitencial',
                            source: 'Active medication list'
                        },
                        {
                            step: 2,
                            action: 'Apply polypharmacy threshold',
                            evidence: '5 medications meets the â‰¥5 threshold for polypharmacy concern',
                            source: 'WHO polypharmacy guidelines'
                        },
                        {
                            step: 3,
                            action: 'Assess patient age factor',
                            evidence: 'Age 46 - not elderly (>65), reducing polypharmacy risk',
                            source: 'Age-based risk adjustment'
                        },
                        {
                            step: 4,
                            action: 'Check for duplicate therapy',
                            evidence: 'No therapeutic duplication detected',
                            source: 'Drug class analysis'
                        },
                        {
                            step: 5,
                            action: 'Calculate interaction potential',
                            evidence: '1 significant interaction (NSAID + ARB), 2 minor interactions',
                            source: 'Interaction matrix analysis'
                        },
                        {
                            step: 6,
                            action: 'Final risk score',
                            evidence: 'MODERATE - Meets medication count threshold but mitigated by age and short-term nature of some medications',
                            source: 'Polypharmacy risk calculator'
                        }
                    ],
                    alternativeHypotheses: [
                        { hypothesis: 'LOW risk if acute meds excluded', likelihood: 0.40, reason: 'Only 2 long-term medications' }
                    ]
                }
            ],
            
            // Confidence Scores for All Outputs
            confidenceScores: [
                { category: 'Patient Identification', field: 'Name', value: 'Mr. DHANANJAY NARAYAN GOSAVI', confidence: 0.98, factors: ['Clear text', 'Database match', 'Consistent across documents'] },
                { category: 'Patient Identification', field: 'UHID', value: '23672', confidence: 0.99, factors: ['Numeric pattern', 'Database validated', 'Unique identifier'] },
                { category: 'Patient Identification', field: 'Age', value: '46 years', confidence: 0.95, factors: ['Calculated from DOB', 'Consistent in records'] },
                { category: 'Patient Identification', field: 'Gender', value: 'Male', confidence: 0.97, factors: ['Title prefix "Mr."', 'Database record'] },
                { category: 'Clinical Data', field: 'Current Diagnosis', value: 'Lumbar Strain', confidence: 0.94, factors: ['Clear handwriting', 'ICD-10 mapped', 'Consistent with treatment'] },
                { category: 'Clinical Data', field: 'Allergies', value: 'Dust', confidence: 0.88, factors: ['Inferred from diagnosis', 'Needs patient confirmation'] },
                { category: 'Clinical Data', field: 'BP Reading', value: '128/82 mmHg', confidence: 0.96, factors: ['Standard format', 'Plausible range', 'Handwriting clear'] },
                { category: 'Medications', field: 'Drug Name', value: 'TAB FLEXURA-D', confidence: 0.96, factors: ['Known drug', 'RxNorm matched', 'Dosage logical'] },
                { category: 'Medications', field: 'Dosage', value: '1-0-1', confidence: 0.94, factors: ['Standard notation', 'Appropriate for drug'] },
                { category: 'Medications', field: 'Duration', value: '10 Days', confidence: 0.92, factors: ['Numeric extraction', 'Clinically appropriate'] },
                { category: 'Risk Assessment', field: 'Drug Interaction (Flexura+Telma)', value: 'HIGH', confidence: 0.91, factors: ['Known interaction', 'Database verified', 'Mechanism understood'] },
                { category: 'Risk Assessment', field: 'Polypharmacy Level', value: 'MODERATE', confidence: 0.87, factors: ['Algorithm-based', '5 medications counted', 'Age-adjusted'] },
                { category: 'Risk Assessment', field: 'Allergy Risk', value: 'No conflicts', confidence: 0.85, factors: ['Single allergy', 'No matching drugs', 'Needs confirmation'] },
                { category: 'Analysis', field: 'Hypertension Control', value: 'Controlled', confidence: 0.94, factors: ['4 BP readings', 'Trend analysis', 'Guideline comparison'] },
                { category: 'Analysis', field: 'GERD Status', value: 'Resolved', confidence: 0.91, factors: ['No recurrence', 'Treatment completed', '4-month follow-up'] }
            ]
        };

        let currentExplainTab = 'extractions';

        function switchExplainTab(tab) {
            currentExplainTab = tab;
            
            // Update tab button styles
            ['Extractions', 'Interactions', 'Reasoning'].forEach(t => {
                const btn = document.getElementById('explainTab' + t);
                if (btn) {
                    btn.style.background = '#e5e7eb';
                    btn.style.color = '#374151';
                }
            });
            
            const tabMap = { 'extractions': 'Extractions', 'interactions': 'Interactions', 'reasoning': 'Reasoning' };
            const activeBtn = document.getElementById('explainTab' + tabMap[tab]);
            if (activeBtn) {
                activeBtn.style.background = '#7c3aed';
                activeBtn.style.color = 'white';
            }
            
            renderExplainabilityContent();
        }

        function renderExplainabilityContent() {
            const container = document.getElementById('explainabilityContent');
            const data = EXPLAINABILITY_DATA;
            
            switch (currentExplainTab) {
                case 'extractions':
                    renderExtractionEvidence(container, data.extractions, data.confidenceScores);
                    break;
                case 'interactions':
                    renderInteractionExplanations(container, data.interactionExplanations);
                    break;
                case 'reasoning':
                    renderReasoningChains(container, data.reasoningChains);
                    break;
            }
        }

        function renderExtractionEvidence(container, extractions, confidenceScores) {
            // Get current patient name for dynamic replacement
            let currentPatientName = 'Mr. DHANANJAY NARAYAN GOSAVI'; // default
            if (currentViewedPatient && currentViewedPatient.patient && currentViewedPatient.patient.name) {
                currentPatientName = currentViewedPatient.patient.name;
            } else if (loggedInStaff && loggedInStaff.name) {
                // If staff is logged in but viewing a patient, use demo patient
                currentPatientName = 'Mr. Dhananjay Narayan Gosavi';
            }
            
            // Create modified extractions with dynamic patient name
            const dynamicExtractions = extractions.map(ext => {
                const newExt = {...ext};
                // Replace hardcoded patient name with current patient
                if (newExt.fact.includes('Patient Name:')) {
                    newExt.fact = `Patient Name: ${currentPatientName}`;
                    newExt.textRegion = {...newExt.textRegion, extractedText: currentPatientName.toUpperCase()};
                }
                return newExt;
            });

            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fdf4ff, #fae8ff); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #86198f;"><i class="fas fa-file-alt"></i> Document Extraction Evidence</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #a21caf;">Showing which document and text region caused each extraction</p>
                </div>
                
                <!-- Confidence Score Summary -->
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h5 style="margin: 0 0 0.5rem 0; color: #475569;"><i class="fas fa-chart-bar"></i> Confidence Overview</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <div style="text-align: center; padding: 0.5rem; background: #dcfce7; border-radius: 6px;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #16a34a;">${confidenceScores.filter(c => c.confidence >= 0.95).length}</div>
                            <div style="font-size: 0.75rem; color: #166534;">High (â‰¥95%)</div>
                        </div>
                        <div style="text-align: center; padding: 0.5rem; background: #fef3c7; border-radius: 6px;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #d97706;">${confidenceScores.filter(c => c.confidence >= 0.85 && c.confidence < 0.95).length}</div>
                            <div style="font-size: 0.75rem; color: #92400e;">Medium (85-94%)</div>
                        </div>
                        <div style="text-align: center; padding: 0.5rem; background: #fee2e2; border-radius: 6px;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: #dc2626;">${confidenceScores.filter(c => c.confidence < 0.85).length}</div>
                            <div style="font-size: 0.75rem; color: #991b1b;">Low (<85%)</div>
                        </div>
                    </div>
                </div>
                
                ${dynamicExtractions.map((ext, idx) => {
                    const confColor = ext.confidence >= 0.95 ? '#16a34a' : (ext.confidence >= 0.85 ? '#d97706' : '#dc2626');
                    const confBg = ext.confidence >= 0.95 ? '#dcfce7' : (ext.confidence >= 0.85 ? '#fef3c7' : '#fee2e2');
                    
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-weight: 600; color: #1f2937;">${ext.fact}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: ${confBg}; color: ${confColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                                            ${Math.round(ext.confidence * 100)}% confidence
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 0.75rem 1rem; background: white;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Source Document</div>
                                        <div style="font-size: 0.9rem; color: #1e40af; font-weight: 500;">
                                            <i class="fas fa-file-pdf" style="color: #dc2626;"></i> ${ext.sourceDocument}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Scanned Date</div>
                                        <div style="font-size: 0.9rem; color: #374151;">${ext.scannedDate}</div>
                                    </div>
                                </div>
                                
                                <div style="background: #fffbeb; border: 1px dashed #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.75rem; color: #92400e; text-transform: uppercase; margin-bottom: 0.25rem;">
                                        <i class="fas fa-crosshairs"></i> Text Region (Page ${ext.textRegion.page})
                                    </div>
                                    <div style="font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; color: #1f2937; border-left: 3px solid #f59e0b;">
                                        "${ext.textRegion.extractedText}"
                                    </div>
                                    <div style="font-size: 0.8rem; color: #78350f; margin-top: 0.25rem;">
                                        ðŸ“ ${ext.textRegion.context}
                                    </div>
                                </div>
                                
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.8rem;">
                                    <span style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                        <i class="fas fa-cog"></i> ${ext.extractionMethod}
                                    </span>
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                        <i class="fas fa-check-circle"></i> ${ext.validatedBy}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderInteractionExplanations(container, interactions) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef2f2, #fecaca); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #991b1b;"><i class="fas fa-exclamation-triangle"></i> Drug Interaction Explanations</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #b91c1c;">Detailed reasoning for each flagged interaction</p>
                </div>
                
                ${interactions.map((int, idx) => {
                    const sevColors = {
                        'HIGH': { bg: '#fef2f2', border: '#ef4444', badge: '#dc2626' },
                        'MODERATE': { bg: '#fef3c7', border: '#f59e0b', badge: '#d97706' },
                        'LOW': { bg: '#eff6ff', border: '#3b82f6', badge: '#2563eb' }
                    };
                    const c = sevColors[int.severity] || sevColors['MODERATE'];
                    
                    return `
                        <div style="border: 2px solid ${c.border}; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: ${c.bg}; padding: 0.75rem 1rem; border-bottom: 1px solid ${c.border};">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                    <div>
                                        <span class="badge" style="background: ${c.badge}; color: white;">${int.severity}</span>
                                        <span style="font-weight: 700; color: #1f2937; margin-left: 0.5rem;">${int.interaction}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 1rem; background: white;">
                                <!-- Why Flagged -->
                                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">
                                        <i class="fas fa-question-circle"></i> Why was this flagged?
                                    </div>
                                    <p style="margin: 0; color: #78350f;">${int.flaggedReason}</p>
                                    <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #a16207;">
                                        Source: ${int.evidenceSource}
                                    </div>
                                </div>
                                
                                <!-- Mechanism -->
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                        <i class="fas fa-dna" style="color: #7c3aed;"></i> Mechanism of Action
                                    </div>
                                    <p style="margin: 0; font-size: 0.9rem; color: #374151;">${int.mechanismOfAction}</p>
                                </div>
                                
                                <!-- Clinical Evidence -->
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                        <i class="fas fa-book-medical" style="color: #0891b2;"></i> Clinical Evidence
                                    </div>
                                    <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; color: #374151;">
                                        ${int.clinicalEvidence.map(e => `<li>${e}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                <!-- Patient Context -->
                                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">
                                        <i class="fas fa-user"></i> Patient-Specific Context
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.85rem;">
                                        ${Object.entries(int.patientContext).map(([k, v]) => `
                                            <span style="background: white; padding: 0.2rem 0.5rem; border-radius: 4px; color: #374151;">
                                                <strong>${k}:</strong> ${v}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Risk Assessment -->
                                <div style="margin-bottom: 1rem; padding: 0.75rem; background: ${c.bg}; border-radius: 8px; border-left: 4px solid ${c.border};">
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                        <i class="fas fa-balance-scale"></i> Risk Assessment
                                    </div>
                                    <p style="margin: 0; font-size: 0.9rem; color: #374151;">${int.riskAssessment}</p>
                                </div>
                                
                                <!-- Recommendation -->
                                <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem;">
                                        <i class="fas fa-lightbulb"></i> Recommendation
                                    </div>
                                    <p style="margin: 0; font-size: 0.9rem; color: #15803d;">${int.recommendation}</p>
                                </div>
                                
                                <!-- References -->
                                <div style="font-size: 0.8rem; color: #64748b;">
                                    <strong>References:</strong>
                                    <ul style="margin: 0.25rem 0 0 1.25rem; padding: 0;">
                                        ${int.references.map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderReasoningChains(container, chains) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #065f46;"><i class="fas fa-project-diagram"></i> Reasoning Chains</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #047857;">Step-by-step reasoning for each clinical conclusion</p>
                </div>
                
                ${chains.map((chain, idx) => {
                    const confColor = chain.confidenceScore >= 0.90 ? '#16a34a' : (chain.confidenceScore >= 0.80 ? '#d97706' : '#dc2626');
                    
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 0.75rem 1rem; border-bottom: 1px solid #bbf7d0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                    <div style="font-weight: 700; color: #166534; font-size: 1rem;">
                                        <i class="fas fa-check-double"></i> ${chain.conclusion}
                                    </div>
                                    <div style="background: white; color: ${confColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; border: 2px solid ${confColor};">
                                        ${Math.round(chain.confidenceScore * 100)}% Confidence
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 1rem; background: white;">
                                <!-- Reasoning Steps -->
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                                        <i class="fas fa-list-ol" style="color: #7c3aed;"></i> Reasoning Steps
                                    </div>
                                    <div style="position: relative; padding-left: 25px;">
                                        <div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #7c3aed, #a855f7, #c084fc);"></div>
                                        ${chain.reasoningSteps.map(step => `
                                            <div style="position: relative; margin-bottom: 0.75rem;">
                                                <div style="position: absolute; left: -19px; width: 18px; height: 18px; background: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                                                    ${step.step}
                                                </div>
                                                <div style="background: #faf5ff; border-radius: 8px; padding: 0.5rem 0.75rem;">
                                                    <div style="font-weight: 600; color: #5b21b6; font-size: 0.9rem;">${step.action}</div>
                                                    <div style="font-size: 0.85rem; color: #374151; margin-top: 0.25rem;">
                                                        <i class="fas fa-arrow-right" style="color: #a855f7; font-size: 0.7rem;"></i> ${step.evidence}
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                                                        ðŸ“„ ${step.source}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Alternative Hypotheses -->
                                ${chain.alternativeHypotheses.length > 0 ? `
                                    <div style="padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #475569; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                            <i class="fas fa-random"></i> Alternative Hypotheses Considered
                                        </div>
                                        ${chain.alternativeHypotheses.map(alt => `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; font-size: 0.85rem;">
                                                <div style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                                    <div style="width: ${alt.likelihood * 100}%; height: 100%; background: #94a3b8;"></div>
                                                </div>
                                                <span style="color: #64748b;">${Math.round(alt.likelihood * 100)}%</span>
                                                <span style="color: #374151;">${alt.hypothesis}</span>
                                                <span style="color: #94a3b8; font-size: 0.8rem;">- ${alt.reason}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // ==================== Standalone Longitudinal History Page Functions ====================
        
        let currentPageHistoryTab = 'medications';

        function loadLongitudinalHistoryPage() {
            // Update patient badge
            const badgeEl = document.getElementById('pageHistoryPatientBadge');
            if (currentViewedPatient && currentViewedPatient.patient) {
                const patient = currentViewedPatient.patient;
                badgeEl.innerHTML = `<i class="fas fa-user"></i> ${patient.name || 'Unknown'} (UID: ${patient.uid || 'N/A'})`;
            } else if (loggedInStaff) {
                badgeEl.innerHTML = `<i class="fas fa-user"></i> Mr. Dhananjay Narayan Gosavi (UID: 23672)`;
            } else {
                badgeEl.innerHTML = `<i class="fas fa-user"></i> No patient loaded`;
            }

            // Update stats using correct keys
            document.getElementById('pageHistoryMedCount').textContent = LONGITUDINAL_HISTORY.medicationHistory.length;
            document.getElementById('pageHistoryVisitCount').textContent = LONGITUDINAL_HISTORY.visitSummaries.length;
            document.getElementById('pageHistoryDiagCount').textContent = LONGITUDINAL_HISTORY.diagnosisHistory.length;
            document.getElementById('pageHistorySymptomCount').textContent = LONGITUDINAL_HISTORY.symptomProgression.length;

            // Set active tab and render content
            currentPageHistoryTab = 'medications';
            updatePageHistoryTabStyles();
            renderPageHistoryContent();
        }

        function switchPageHistoryTab(tab) {
            currentPageHistoryTab = tab;
            updatePageHistoryTabStyles();
            renderPageHistoryContent();
        }

        function updatePageHistoryTabStyles() {
            // Remove active from all tabs
            document.querySelectorAll('.page-history-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#e5e7eb';
                btn.style.color = '#374151';
            });
            
            // Add active to current tab
            const activeBtn = document.querySelector(`.page-history-tab[data-tab="${currentPageHistoryTab}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#667eea';
                activeBtn.style.color = 'white';
            }
        }

        function renderPageHistoryContent() {
            const container = document.getElementById('pageHistoryContent');
            const history = LONGITUDINAL_HISTORY;

            switch (currentPageHistoryTab) {
                case 'medications':
                    renderPageMedicationHistory(container, history.medicationHistory);
                    break;
                case 'symptoms':
                    renderPageSymptomProgression(container, history.symptomProgression);
                    break;
                case 'diagnosis':
                    renderPageDiagnosisHistory(container, history.diagnosisHistory);
                    break;
                case 'visits':
                    renderPageVisitSummaries(container, history.visitSummaries);
                    break;
            }
        }

        function renderPageMedicationHistory(container, medications) {
            const grouped = {};
            medications.forEach(med => {
                const year = med.date.split('-')[0];
                if (!grouped[year]) grouped[year] = [];
                grouped[year].push(med);
            });

            const sortedYears = Object.keys(grouped).sort((a, b) => b - a);

            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 8px;">
                    <h4 style="margin: 0; color: #1e40af;"><i class="fas fa-pills"></i> Complete Medication History</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #3730a3;">Comprehensive record of all medications prescribed to this patient</p>
                </div>
                
                <div style="position: relative; padding-left: 2rem;">
                    <div style="position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #667eea, #764ba2);"></div>
                    
                    ${sortedYears.map(year => `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="position: relative; margin-bottom: 0.75rem;">
                                <div style="position: absolute; left: -1.65rem; width: 12px; height: 12px; background: #667eea; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px #667eea;"></div>
                                <span style="font-weight: 700; font-size: 1.1rem; color: #667eea;">${year}</span>
                            </div>
                            ${grouped[year].map(med => {
                                const statusColor = med.status === 'ACTIVE' ? '#16a34a' : (med.status === 'COMPLETED' ? '#6b7280' : '#3b82f6');
                                const statusBg = med.status === 'ACTIVE' ? '#dcfce7' : (med.status === 'COMPLETED' ? '#f3f4f6' : '#dbeafe');
                                return `
                                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; margin-left: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                            <div>
                                                <span style="font-weight: 600; color: #1f2937; font-size: 1rem;">${med.medication}</span>
                                                <span style="color: #64748b; font-size: 0.9rem;"> - ${med.dosage}</span>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">${med.action}</span>
                                                <span style="background: ${statusBg}; color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">${med.status}</span>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.85rem;">
                                            <div>
                                                <span style="color: #9ca3af;">Dosage:</span>
                                                <span style="color: #374151; font-weight: 500;"> ${med.dosage}</span>
                                            </div>
                                            <div>
                                                <span style="color: #9ca3af;">Duration:</span>
                                                <span style="color: #374151; font-weight: 500;"> ${med.duration}</span>
                                            </div>
                                            <div>
                                                <span style="color: #9ca3af;">Date:</span>
                                                <span style="color: #374151; font-weight: 500;"> ${med.date}</span>
                                            </div>
                                            <div>
                                                <span style="color: #9ca3af;">Prescriber:</span>
                                                <span style="color: #374151; font-weight: 500;"> ${med.prescribedBy}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                            <span style="color: #9ca3af;">Reason:</span>
                                            <span style="color: #374151;"> ${med.reason}</span>
                                            ${med.outcome ? `<span style="color: #16a34a; margin-left: 1rem;"><i class="fas fa-check-circle"></i> ${med.outcome}</span>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPageSymptomProgression(container, symptoms) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px;">
                    <h4 style="margin: 0; color: #92400e;"><i class="fas fa-heartbeat"></i> Symptom Progression Timeline</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #a16207;">Track how symptoms have evolved over time</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${symptoms.map((symptom, idx) => {
                        const severityColor = symptom.severity === 'SEVERE' ? '#dc2626' : (symptom.severity === 'MODERATE' ? '#f59e0b' : '#22c55e');
                        const severityBg = symptom.severity === 'SEVERE' ? '#fee2e2' : (symptom.severity === 'MODERATE' ? '#fef3c7' : '#dcfce7');
                        const progressionIcon = symptom.progression === 'RESOLVED' ? 'check-circle' : (symptom.progression === 'NEW' ? 'plus-circle' : (symptom.progression === 'IMPROVING' ? 'arrow-up' : 'sync'));
                        const progressionColor = symptom.progression === 'RESOLVED' ? '#16a34a' : (symptom.progression === 'NEW' ? '#dc2626' : (symptom.progression === 'IMPROVING' ? '#3b82f6' : '#f59e0b'));
                        
                        return `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid ${severityColor};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <div style="width: 36px; height: 36px; background: ${severityBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-notes-medical" style="color: ${severityColor};"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">${symptom.symptoms.join(', ')}</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">${symptom.date} ${symptom.trigger ? 'â€¢ Trigger: ' + symptom.trigger : ''}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <span style="background: ${severityBg}; color: ${severityColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${symptom.severity}</span>
                                        <span style="background: #f1f5f9; color: ${progressionColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">
                                            <i class="fas fa-${progressionIcon}" style="margin-right: 0.25rem;"></i>${symptom.progression}
                                        </span>
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #4b5563; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                                    ${symptom.notes}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPageDiagnosisHistory(container, diagnoses) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-radius: 8px;">
                    <h4 style="margin: 0; color: #5b21b6;"><i class="fas fa-stethoscope"></i> Diagnosis History</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #6d28d9;">Complete diagnostic record with ICD codes and treatment status</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${diagnoses.map(diag => {
                        const statusColor = diag.status === 'ACTIVE' ? '#dc2626' : (diag.status === 'ONGOING' || diag.status === 'MONITORING' ? '#f59e0b' : '#22c55e');
                        const statusBg = diag.status === 'ACTIVE' ? '#fee2e2' : (diag.status === 'ONGOING' || diag.status === 'MONITORING' ? '#fef3c7' : '#dcfce7');
                        
                        return `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: white; font-weight: 600; font-size: 1rem;">${diag.diagnosis}</span>
                                    <span style="background: rgba(255,255,255,0.2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">
                                        <i class="fas fa-code"></i> ${diag.icd10}
                                    </span>
                                </div>
                                <div style="padding: 1rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Date Diagnosed</div>
                                            <div style="color: #374151; font-weight: 500;">${diag.date}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Diagnosed By</div>
                                            <div style="color: #374151; font-weight: 500;">${diag.diagnosedBy}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Status</div>
                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${diag.status}</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; margin-bottom: 0.25rem;">Confidence</div>
                                        <span style="background: #dbeafe; color: #1d4ed8; padding: 0.2rem 0.6rem; border-radius: 8px; font-size: 0.8rem;">${diag.confidence}</span>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; margin-bottom: 0.25rem;">Investigations</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                            ${diag.investigations.map(inv => `<span style="background: #f1f5f9; color: #475569; padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.8rem;">${inv}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div style="border-top: 1px solid #e5e7eb; padding-top: 0.75rem;">
                                        <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; margin-bottom: 0.25rem;">Notes</div>
                                        <div style="color: #4b5563; font-size: 0.9rem;">${diag.notes}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPageVisitSummaries(container, visits) {
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 8px;">
                    <h4 style="margin: 0; color: #166534;"><i class="fas fa-calendar-check"></i> Visit-wise Summaries</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #15803d;">Complete record of all hospital visits with outcomes</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${visits.map((visit, idx) => {
                        const typeColor = visit.type === 'Emergency' ? '#dc2626' : (visit.type === 'Follow-up' ? '#3b82f6' : '#8b5cf6');
                        const typeBg = visit.type === 'Emergency' ? '#fee2e2' : (visit.type === 'Follow-up' ? '#dbeafe' : '#ede9fe');
                        
                        return `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="background: ${typeBg}; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                            <span style="font-weight: 700; color: ${typeColor};">${visit.visitId}</span>
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">${visit.date} at ${visit.time}</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">${visit.department} â€¢ OP No: ${visit.opNo}</div>
                                        </div>
                                    </div>
                                    <span style="background: white; color: ${typeColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; border: 1px solid ${typeColor};">
                                        ${visit.type}
                                    </span>
                                </div>
                                <div style="padding: 1rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <span style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Chief Complaint</span>
                                        <div style="color: #374151; font-weight: 500; margin-top: 0.25rem;">${visit.chiefComplaint}</div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                                        <div>
                                            <span style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Attending Physician</span>
                                            <div style="color: #374151; font-weight: 500; margin-top: 0.25rem;">${visit.doctor}</div>
                                        </div>
                                        <div>
                                            <span style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Diagnosis</span>
                                            <div style="margin-top: 0.25rem;">
                                                <span style="background: #ede9fe; color: #6d28d9; padding: 0.2rem 0.5rem; border-radius: 8px; font-size: 0.8rem;">${visit.diagnosis}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 0.75rem;">
                                        <span style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Examination Findings</span>
                                        <div style="color: #4b5563; font-size: 0.9rem; margin-top: 0.25rem; padding: 0.5rem; background: #f8fafc; border-radius: 8px;">${visit.examination}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 0.75rem;">
                                        <span style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Treatment Prescribed</span>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem;">
                                            ${visit.treatment.map(rx => `
                                                <span style="background: #dbeafe; color: #1d4ed8; padding: 0.25rem 0.6rem; border-radius: 8px; font-size: 0.8rem;">
                                                    <i class="fas fa-prescription" style="margin-right: 0.25rem;"></i>${rx}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div style="border-top: 1px solid #e5e7eb; padding-top: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="font-size: 0.75rem; color: #9ca3af;">Follow-up:</span>
                                            <span style="color: #374151; font-weight: 500;"> ${visit.followUp}</span>
                                        </div>
                                        <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">
                                            <i class="fas fa-clipboard-check" style="margin-right: 0.25rem;"></i>${visit.outcome}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ==================== Standalone Explainability Page Functions ====================
        
        let currentPageExplainTab = 'extractions';

        function loadExplainabilityPageAuto() {
            // Update patient badge
            const badgeEl = document.getElementById('explainPagePatientBadge');
            if (currentViewedPatient && currentViewedPatient.patient) {
                const patient = currentViewedPatient.patient;
                badgeEl.innerHTML = `<i class="fas fa-user"></i> ${patient.name || 'Unknown'} (UID: ${patient.uid || 'N/A'})`;
            } else if (loggedInStaff) {
                badgeEl.innerHTML = `<i class="fas fa-user"></i> Mr. Dhananjay Narayan Gosavi (UID: 23672)`;
            } else {
                badgeEl.innerHTML = `<i class="fas fa-user"></i> Demo Patient`;
            }

            // Update stats
            const data = EXPLAINABILITY_DATA;
            document.getElementById('explainExtractionCount').textContent = data.extractions.length;
            document.getElementById('explainInteractionCount').textContent = data.interactionExplanations.length;
            document.getElementById('explainReasoningCount').textContent = data.reasoningChains.length;
            const avgConf = data.confidenceScores.reduce((sum, s) => sum + s.confidence, 0) / data.confidenceScores.length;
            document.getElementById('explainAvgConfidence').textContent = Math.round(avgConf * 100) + '%';

            // Set active tab and render content
            currentPageExplainTab = 'extractions';
            updatePageExplainTabStyles();
            renderPageExplainabilityContent();
        }

        function loadExplainabilityPage() {
            // Legacy function - now just calls auto version
            loadExplainabilityPageAuto();
        }

        function switchPageExplainTab(tab) {
            currentPageExplainTab = tab;
            updatePageExplainTabStyles();
            renderPageExplainabilityContent();
        }

        function updatePageExplainTabStyles() {
            // Remove active from all tabs
            document.querySelectorAll('.page-explain-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#e5e7eb';
                btn.style.color = '#374151';
            });
            
            // Add active to current tab
            const activeBtn = document.querySelector(`.page-explain-tab[data-tab="${currentPageExplainTab}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#7c3aed';
                activeBtn.style.color = 'white';
            }
        }

        function renderPageExplainabilityContent() {
            const container = document.getElementById('explainabilityPageContent');
            const data = EXPLAINABILITY_DATA;
            
            switch (currentPageExplainTab) {
                case 'extractions':
                    renderExtractionEvidence(container, data.extractions, data.confidenceScores);
                    break;
                case 'interactions':
                    renderInteractionExplanations(container, data.interactionExplanations);
                    break;
                case 'reasoning':
                    renderReasoningChains(container, data.reasoningChains);
                    break;
                case 'confidence':
                    renderConfidenceScores(container, data.confidenceScores);
                    break;
            }
        }

        function renderConfidenceScores(container, scores) {
            // Group by category
            const grouped = {};
            scores.forEach(score => {
                if (!grouped[score.category]) grouped[score.category] = [];
                grouped[score.category].push(score);
            });
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;"><i class="fas fa-chart-bar"></i> Confidence Scores for All Outputs</h4>
                    <p style="margin: 0; font-size: 0.85rem; color: #15803d;">Every extraction and analysis includes a confidence score with contributing factors</p>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: #dcfce7; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #16a34a;">${scores.filter(s => s.confidence >= 0.95).length}</div>
                        <div style="font-size: 0.85rem; color: #166534;">Very High (â‰¥95%)</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #dbeafe; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #2563eb;">${scores.filter(s => s.confidence >= 0.90 && s.confidence < 0.95).length}</div>
                        <div style="font-size: 0.85rem; color: #1e40af;">High (90-94%)</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #d97706;">${scores.filter(s => s.confidence >= 0.85 && s.confidence < 0.90).length}</div>
                        <div style="font-size: 0.85rem; color: #92400e;">Medium (85-89%)</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 12px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #dc2626;">${scores.filter(s => s.confidence < 0.85).length}</div>
                        <div style="font-size: 0.85rem; color: #991b1b;">Review Needed (<85%)</div>
                    </div>
                </div>
                
                <!-- Grouped Scores -->
                ${Object.entries(grouped).map(([category, items]) => {
                    const avgConf = items.reduce((sum, i) => sum + i.confidence, 0) / items.length;
                    const avgColor = avgConf >= 0.95 ? '#16a34a' : (avgConf >= 0.90 ? '#2563eb' : (avgConf >= 0.85 ? '#d97706' : '#dc2626'));
                    
                    return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: #f8fafc; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: #1f2937;">
                                    <i class="fas fa-folder" style="color: #7c3aed; margin-right: 0.5rem;"></i>${category}
                                </span>
                                <span style="background: white; color: ${avgColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; border: 1px solid ${avgColor};">
                                    Avg: ${Math.round(avgConf * 100)}%
                                </span>
                            </div>
                            <div style="padding: 0.75rem;">
                                ${items.map(item => {
                                    const conf = item.confidence;
                                    const color = conf >= 0.95 ? '#16a34a' : (conf >= 0.90 ? '#2563eb' : (conf >= 0.85 ? '#d97706' : '#dc2626'));
                                    const bg = conf >= 0.95 ? '#dcfce7' : (conf >= 0.90 ? '#dbeafe' : (conf >= 0.85 ? '#fef3c7' : '#fee2e2'));
                                    
                                    return `
                                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem; background: ${bg};">
                                            <div style="width: 80px; text-align: center;">
                                                <div style="font-size: 1.1rem; font-weight: 700; color: ${color};">${Math.round(conf * 100)}%</div>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 500; color: #374151;">${item.field}</div>
                                                <div style="font-size: 0.85rem; color: #64748b;">${item.value}</div>
                                            </div>
                                            <div style="flex: 1.5;">
                                                <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem;">Contributing Factors</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                                    ${item.factors.map(f => `<span style="background: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; color: #475569;">${f}</span>`).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function loadPatientToAI() {
            if (!currentViewedPatient) return;
            
            const patient = currentViewedPatient.patient;
            const activeMeds = currentViewedPatient.active_medications || [];
            
            // Navigate to AI page
            navigateTo('ask-ai');
            
            // Fill patient context
            document.getElementById('aiPatientId').value = patient?.uid || '';
            document.getElementById('aiPatientName').value = patient?.name || '';
            document.getElementById('aiPatientAge').value = patient?.age || '';
            document.getElementById('aiPatientAllergies').value = (patient?.allergies || []).join(', ');
            document.getElementById('aiPatientConditions').value = (patient?.conditions || []).join(', ');
            
            // Fill medications
            const medsText = activeMeds.map(med => 
                `${med.name || med.drug_name}, ${med.dosage || ''}, ${med.frequency || ''}`
            ).join('\n');
            document.getElementById('aiPatientMedications').value = medsText;
            
            // Save context
            savePatientContext();
        }

        function viewPatientTimeline() {
            if (!currentViewedPatient) return;
            // Navigate to timeline page with patient context
            navigateTo('timeline');
        }

        // ========================================
        // AI Context Loading from Database
        // ========================================

        async function loadPatientContextFromDB() {
            const uid = document.getElementById('aiLoadPatientUid').value.trim();
            const statusEl = document.getElementById('aiLoadPatientStatus');
            
            if (!uid) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter a patient UID</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Loading...</span>';
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/ai-context`);
                const data = await response.json();
                
                if (data.success) {
                    const ctx = data.ai_context;
                    
                    // Fill form fields
                    document.getElementById('aiPatientId').value = ctx.patient_info?.uid || '';
                    document.getElementById('aiPatientName').value = ctx.patient_info?.name || '';
                    document.getElementById('aiPatientAge').value = ctx.patient_info?.age || '';
                    document.getElementById('aiPatientAllergies').value = (ctx.medical_profile?.allergies || []).join(', ');
                    document.getElementById('aiPatientConditions').value = (ctx.medical_profile?.chronic_conditions || []).join(', ');
                    
                    // Fill medications
                    const medsText = (ctx.current_medications || []).map(med => 
                        `${med.name}, ${med.dosage || ''}, ${med.frequency || ''}`
                    ).join('\n');
                    document.getElementById('aiPatientMedications').value = medsText;
                    
                    // Save the context
                    savePatientContext();
                    
                    statusEl.innerHTML = `<span style="color: #059669;"><i class="fas fa-check-circle"></i> Loaded ${ctx.patient_info?.name}'s context successfully!</span>`;
                    
                    // Add AI message about loaded context
                    addAIMessage(`ðŸ“‹ Loaded patient context for <strong>${ctx.patient_info?.name}</strong>:
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.9rem;">
                            <li>Age: ${ctx.patient_info?.age || 'Unknown'}</li>
                            <li>Allergies: ${(ctx.medical_profile?.allergies || []).join(', ') || 'None'}</li>
                            <li>Conditions: ${(ctx.medical_profile?.chronic_conditions || []).join(', ') || 'None'}</li>
                            <li>Active Medications: ${ctx.current_medications?.length || 0}</li>
                            <li>Prescription History: ${ctx.prescription_history?.length || 0} records</li>
                        </ul>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-500);">You can now ask me questions about this patient!</p>`);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${data.detail || 'Patient not found'}</span>`;
                }
            } catch (error) {
                console.error('Error loading context:', error);
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> Error: ${error.message}</span>`;
            }
        }

        function addAIMessage(content) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 80%;">
                    ${content}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ========================================
        // Pharmacogenomics Functions
        // ========================================

        async function loadPharmacogenomics() {
            const uid = document.getElementById('cdsPatientUid').value.trim();
            const statusEl = document.getElementById('cdsLoadStatus');
            
            if (!uid) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter a patient UID</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #8b5cf6;"><i class="fas fa-spinner fa-spin"></i> Analyzing pharmacogenomics...</span>';
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/clinical-decision-support`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load pharmacogenomics data');
                }
                
                displayPharmacogenomics(data);
                
                statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Analysis complete!</span>';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                
            } catch (error) {
                console.error('Pharmacogenomics Error:', error);
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        function displayPharmacogenomics(data) {
            const cds = data.clinical_decision_support;
            
            document.getElementById('cdsResultsContainer').style.display = 'block';
            
            // Pharmacogenomic Alerts
            const pgxAlerts = cds.pharmacogenomic_alerts || [];
            document.getElementById('cdsPgxCount').textContent = pgxAlerts.length + ' alerts';
            
            if (pgxAlerts.length > 0) {
                let pgxHtml = '';
                pgxAlerts.forEach(alert => {
                    pgxHtml += `
                        <div style="border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 0 12px 12px 0; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: #5b21b6;">
                                    <i class="fas fa-dna" style="margin-right: 0.5rem;"></i>${alert.drug}
                                </div>
                                <span class="badge badge-purple">Gene: ${alert.gene}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b21a8; margin-bottom: 0.5rem;">
                                <strong>Phenotype:</strong> ${alert.phenotype}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <strong>Clinical Implication:</strong> ${alert.clinical_implication}
                            </div>
                            <div style="background: white; border-radius: 6px; padding: 0.75rem; font-size: 0.875rem;">
                                <strong style="color: #059669;"><i class="fas fa-lightbulb"></i> Recommendation:</strong> ${alert.recommendation}
                            </div>
                            ${alert.alternative_drugs?.length > 0 ? `
                                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                                    <strong>Alternatives:</strong> ${alert.alternative_drugs.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('cdsPgxAlertsList').innerHTML = pgxHtml;
            } else {
                document.getElementById('cdsPgxAlertsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 0.5rem;"></i>
                        <p>No pharmacogenomic alerts for current medications.</p>
                        <p style="font-size: 0.8rem;">All prescribed medications appear to have standard metabolic profiles.</p>
                    </div>
                `;
            }
        }

        // ========================================
        // Treatment Outcome Functions
        // ========================================

        // Update vital unit when type changes
        document.addEventListener('DOMContentLoaded', function() {
            const vitalTypeSelect = document.getElementById('vitalRecordType');
            if (vitalTypeSelect) {
                vitalTypeSelect.addEventListener('change', function() {
                    const units = {
                        'bp_systolic': 'mmHg',
                        'bp_diastolic': 'mmHg',
                        'heart_rate': 'bpm',
                        'blood_glucose': 'mg/dL',
                        'hba1c': '%',
                        'ldl_cholesterol': 'mg/dL',
                        'hdl_cholesterol': 'mg/dL',
                        'weight': 'kg',
                        'pain_score': '0-10',
                        'egfr': 'mL/min/1.73mÂ²',
                        'creatinine': 'mg/dL'
                    };
                    document.getElementById('vitalRecordUnit').value = units[this.value] || 'units';
                });
                vitalTypeSelect.dispatchEvent(new Event('change'));
            }
        });

        async function recordOutcome() {
            const patientUid = document.getElementById('outcomePatientUid').value.trim();
            const medication = document.getElementById('outcomeRecordMed').value.trim();
            const outcomeType = document.getElementById('outcomeRecordType').value;
            const description = document.getElementById('outcomeRecordDesc').value.trim();
            const sideEffects = document.getElementById('outcomeRecordSideEffects').value.trim();
            const statusEl = document.getElementById('outcomeRecordStatus');
            
            if (!patientUid || !medication || !description) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please fill in patient UID, medication, and description</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Recording outcome...</span>';
            
            try {
                const formData = new FormData();
                formData.append('medication', medication);
                formData.append('outcome_type', outcomeType);
                formData.append('description', description);
                if (sideEffects) formData.append('side_effects', sideEffects);
                
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/record-outcome`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Outcome recorded successfully!</span>';
                    // Clear fields
                    document.getElementById('outcomeRecordMed').value = '';
                    document.getElementById('outcomeRecordDesc').value = '';
                    document.getElementById('outcomeRecordSideEffects').value = '';
                    
                    setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed to record outcome');
                }
            } catch (error) {
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        async function recordVital() {
            const patientUid = document.getElementById('outcomePatientUid').value.trim();
            const vitalType = document.getElementById('vitalRecordType').value;
            const value = document.getElementById('vitalRecordValue').value;
            const unit = document.getElementById('vitalRecordUnit').value;
            const notes = document.getElementById('vitalRecordNotes').value.trim();
            const statusEl = document.getElementById('vitalRecordStatus');
            
            if (!patientUid || !value) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter patient UID and vital value</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Recording vital...</span>';
            
            try {
                const formData = new FormData();
                formData.append('vital_type', vitalType);
                formData.append('value', value);
                formData.append('unit', unit);
                if (notes) formData.append('notes', notes);
                
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/record-vital`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Vital recorded successfully!</span>';
                    document.getElementById('vitalRecordValue').value = '';
                    document.getElementById('vitalRecordNotes').value = '';
                    
                    setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed to record vital');
                }
            } catch (error) {
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        async function loadOutcomeReport() {
            const uid = document.getElementById('outcomePatientUid').value.trim();
            
            if (!uid) {
                alert('Please enter a patient UID');
                return;
            }
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/comprehensive-outcome-report`);
                const data = await response.json();
                
                if (data.success) {
                    displayOutcomeReport(data.report);
                } else {
                    alert(data.detail || 'Failed to load outcome report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading outcome report: ' + error.message);
            }
        }

        function displayOutcomeReport(report) {
            document.getElementById('outcomeTimelineContainer').style.display = 'block';
            
            // Health trend badge
            const trendEl = document.getElementById('outcomeHealthTrend');
            const trend = report.overall_health_trend || 'stable';
            const trendConfig = {
                'improving': { class: 'badge-success', text: 'ðŸ“ˆ Improving' },
                'stable': { class: 'badge-info', text: 'âž¡ï¸ Stable' },
                'declining': { class: 'badge-danger', text: 'ðŸ“‰ Declining' },
                'insufficient_data': { class: 'badge-gray', text: 'â“ Insufficient Data' }
            };
            const config = trendConfig[trend] || trendConfig.stable;
            trendEl.className = 'badge ' + config.class;
            trendEl.textContent = config.text;
            
            // Timeline
            const timeline = report.outcome_timeline;
            const treatments = timeline?.treatments || [];
            
            if (treatments.length > 0) {
                let timelineHtml = '';
                treatments.forEach((t, idx) => {
                    const outcomeColors = {
                        'improved': { bg: '#dcfce7', border: '#22c55e', icon: 'âœ…' },
                        'resolved': { bg: '#dbeafe', border: '#3b82f6', icon: 'ðŸŽ‰' },
                        'stable': { bg: '#f3f4f6', border: '#6b7280', icon: 'âž¡ï¸' },
                        'worsened': { bg: '#fee2e2', border: '#ef4444', icon: 'âš ï¸' },
                        'discontinued': { bg: '#fef3c7', border: '#f59e0b', icon: 'ðŸ›‘' },
                        'adverse_event': { bg: '#fce7f3', border: '#ec4899', icon: 'âŒ' }
                    };
                    const colors = outcomeColors[t.outcome_type] || outcomeColors.stable;
                    
                    timelineHtml += `
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="width: 40px; height: 40px; background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">
                                ${colors.icon}
                            </div>
                            <div style="flex: 1; border-left: 2px solid var(--gray-200); padding-left: 1.5rem; ${idx === treatments.length - 1 ? 'border-left-color: transparent;' : ''}">
                                <div style="font-weight: 600; color: var(--gray-800);">${t.medication}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0;">${t.outcome_description}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-400);">
                                    ${t.outcome_recorded_at ? new Date(t.outcome_recorded_at).toLocaleDateString() : 'Date unknown'}
                                    ${t.effectiveness_score ? ` â€¢ Effectiveness: ${t.effectiveness_score.toFixed(0)}%` : ''}
                                </div>
                                ${t.side_effects?.length > 0 ? `
                                    <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                        ${t.side_effects.map(se => `<span class="badge badge-warning" style="font-size: 0.7rem;">âš ï¸ ${se}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('outcomeTimelineList').innerHTML = timelineHtml;
            } else {
                document.getElementById('outcomeTimelineList').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No treatment outcomes recorded yet.</p>';
            }
            
            // Vital Trends
            const vitalTrends = timeline?.vital_trends || {};
            if (Object.keys(vitalTrends).length > 0) {
                let trendsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                
                const vitalNames = {
                    'bp_systolic': 'BP Systolic',
                    'bp_diastolic': 'BP Diastolic',
                    'heart_rate': 'Heart Rate',
                    'blood_glucose': 'Blood Glucose',
                    'hba1c': 'HbA1c',
                    'ldl_cholesterol': 'LDL Cholesterol',
                    'weight': 'Weight',
                    'pain_score': 'Pain Score'
                };
                
                for (const [type, readings] of Object.entries(vitalTrends)) {
                    if (readings.length > 0) {
                        const latest = readings[readings.length - 1];
                        const first = readings[0];
                        const change = latest.value - first.value;
                        const changePercent = ((change / first.value) * 100).toFixed(1);
                        
                        trendsHtml += `
                            <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">${vitalNames[type] || type}</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800);">${latest.value}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-400);">${latest.unit}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: ${change < 0 ? '#059669' : change > 0 ? '#dc2626' : '#6b7280'};">
                                    ${change > 0 ? 'â†‘' : change < 0 ? 'â†“' : 'â†’'} ${Math.abs(changePercent)}%
                                </div>
                            </div>
                        `;
                    }
                }
                
                trendsHtml += '</div>';
                document.getElementById('vitalTrendsContainer').innerHTML = trendsHtml;
            } else {
                document.getElementById('vitalTrendsContainer').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No vital readings recorded yet.</p>';
            }
            
            // Insights
            const insights = report.insights || [];
            if (insights.length > 0) {
                let insightsHtml = '';
                insights.forEach(insight => {
                    const insightColors = {
                        'positive': { bg: '#dcfce7', border: '#22c55e', icon: 'âœ…' },
                        'warning': { bg: '#fee2e2', border: '#ef4444', icon: 'âš ï¸' },
                        'info': { bg: '#dbeafe', border: '#3b82f6', icon: 'â„¹ï¸' }
                    };
                    const colors = insightColors[insight.type] || insightColors.info;
                    
                    insightsHtml += `
                        <div style="border-left: 4px solid ${colors.border}; background: ${colors.bg}; border-radius: 0 8px 8px 0; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${colors.icon} ${insight.title}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-700);">${insight.message}</div>
                        </div>
                    `;
                });
                document.getElementById('treatmentInsightsList').innerHTML = insightsHtml;
            } else {
                document.getElementById('treatmentInsightsList').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No insights available yet. Record more outcomes to generate insights.</p>';
            }
        }
        
        // ==================== Allergy & Condition Badge Rendering ====================
        
        const CRITICAL_ALLERGY_KEYWORDS = ['penicillin', 'sulfa', 'latex', 'iodine', 'contrast', 'shellfish', 'peanut', 'bee', 'wasp', 'anaphylaxis'];
        const HIGH_ALLERGY_KEYWORDS = ['aspirin', 'nsaid', 'codeine', 'morphine', 'cephalosporin', 'tetracycline'];
        
        const CROSS_REACTIVITY_MAP = {
            'penicillin': ['Amoxicillin', 'Ampicillin', 'Cephalosporins'],
            'sulfa': ['Bactrim', 'Sulfamethoxazole'],
            'aspirin': ['Ibuprofen', 'Naproxen', 'All NSAIDs'],
            'codeine': ['Morphine', 'Tramadol'],
            'cephalosporin': ['Cefixime', 'Ceftriaxone']
        };
        
        function renderAllergyBadges(allergies) {
            const container = document.getElementById('detailAllergiesContainer');
            if (!allergies || allergies.length === 0) {
                container.innerHTML = '<span style="color: #059669; font-size: 0.875rem;"><i class="fas fa-check-circle"></i> No allergies recorded</span>';
                return;
            }
            
            container.innerHTML = allergies.map(allergy => {
                const allergyLower = allergy.toLowerCase();
                const isCritical = CRITICAL_ALLERGY_KEYWORDS.some(kw => allergyLower.includes(kw));
                const isHigh = HIGH_ALLERGY_KEYWORDS.some(kw => allergyLower.includes(kw));
                
                let badgeClass = 'standard';
                let icon = 'âš ï¸';
                let tooltip = '';
                
                if (isCritical) {
                    badgeClass = 'critical';
                    icon = 'ðŸš¨';
                    // Check cross-reactivity
                    for (const [key, drugs] of Object.entries(CROSS_REACTIVITY_MAP)) {
                        if (allergyLower.includes(key)) {
                            tooltip = `Cross-reactive with: ${drugs.join(', ')}`;
                            break;
                        }
                    }
                } else if (isHigh) {
                    badgeClass = 'high';
                    icon = 'âš ï¸';
                }
                
                return `<span class="allergy-badge ${badgeClass}" title="${tooltip}">${icon} ${allergy}</span>`;
            }).join('');
        }
        
        const HIGH_IMPACT_CONDITIONS = {
            'kidney': 'Affects drug dosing',
            'renal': 'Affects drug dosing',
            'liver': 'Affects drug metabolism',
            'hepatic': 'Affects drug metabolism',
            'heart': 'Avoid NSAIDs, certain drugs',
            'cardiac': 'Avoid NSAIDs, certain drugs',
            'pregnant': 'Many drugs contraindicated',
            'pregnancy': 'Many drugs contraindicated',
            'asthma': 'Avoid beta-blockers',
            'diabetes': 'Monitor with steroids',
            'bleeding': 'Avoid anticoagulants',
            'ulcer': 'Avoid NSAIDs'
        };
        
        function renderConditionBadges(conditions) {
            const container = document.getElementById('detailConditionsContainer');
            if (!conditions || conditions.length === 0) {
                container.innerHTML = '<span style="color: var(--gray-400); font-size: 0.875rem;">No chronic conditions recorded</span>';
                return;
            }
            
            container.innerHTML = conditions.map(condition => {
                const conditionLower = condition.toLowerCase();
                let isHighImpact = false;
                let impact = '';
                
                for (const [keyword, desc] of Object.entries(HIGH_IMPACT_CONDITIONS)) {
                    if (conditionLower.includes(keyword)) {
                        isHighImpact = true;
                        impact = desc;
                        break;
                    }
                }
                
                const badgeClass = isHighImpact ? 'high-impact' : 'standard';
                const icon = isHighImpact ? 'âš¡' : 'â€¢';
                
                return `<span class="condition-badge ${badgeClass}" title="${impact}">${icon} ${condition}</span>`;
            }).join('');
        }
        
        // ==================== Real-Time Drug Safety Check ====================
        
        let safetyAlertTimeout = null;
        
        async function checkDrugSafety(drugName, patientAllergies, patientConditions, currentMeds) {
            if (!drugName || drugName.length < 2) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/staff/check-drug-safety`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        drug_name: drugName,
                        patient_allergies: patientAllergies || [],
                        patient_conditions: patientConditions || [],
                        current_medications: currentMeds || []
                    })
                });
                
                const result = await response.json();
                
                if (result.alerts_count > 0) {
                    showDrugSafetyAlerts(result.alerts, drugName);
                }
                
                return result;
            } catch (error) {
                console.error('Drug safety check error:', error);
                return null;
            }
        }
        
        function showDrugSafetyAlerts(alerts, drugName) {
            // Remove existing popup
            const existing = document.getElementById('drugSafetyPopup');
            if (existing) existing.remove();
            
            if (!alerts || alerts.length === 0) return;
            
            const popup = document.createElement('div');
            popup.id = 'drugSafetyPopup';
            popup.className = 'drug-safety-popup';
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 700; font-size: 0.9rem;">âš ï¸ Safety Alerts for ${drugName}</span>
                    <button onclick="document.getElementById('drugSafetyPopup').remove()" style="background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--gray-500);">Ã—</button>
                </div>
                ${alerts.slice(0, 3).map(alert => `
                    <div class="safety-alert-card ${alert.severity.toLowerCase()}">
                        <div class="safety-alert-header ${alert.severity.toLowerCase()}">
                            ${alert.icon} ${alert.type}: ${alert.title}
                        </div>
                        <div class="safety-alert-body">
                            ${alert.message}
                        </div>
                        ${alert.action ? `<div class="safety-alert-action"><strong>Action:</strong> ${alert.action}</div>` : ''}
                    </div>
                `).join('')}
                ${alerts.length > 3 ? `<div style="text-align: center; font-size: 0.8rem; color: var(--gray-500);">+${alerts.length - 3} more alerts</div>` : ''}
            `;
            
            document.body.appendChild(popup);
            
            // Auto-hide after 15 seconds for non-critical alerts
            const hasCritical = alerts.some(a => a.severity === 'CRITICAL');
            if (!hasCritical) {
                safetyAlertTimeout = setTimeout(() => {
                    popup.remove();
                }, 15000);
            }
        }
        
        // Helper: Get patient context for safety checks
        function getPatientContextForSafety() {
            if (!currentPatientData) return { allergies: [], conditions: [], meds: [] };
            
            return {
                allergies: currentPatientData.patient?.allergies || [],
                conditions: currentPatientData.patient?.chronic_conditions || [],
                meds: (currentPatientData.patient?.current_medications || []).map(m => m.name || m)
            };
        }
        
    </script>
</body>
</html>

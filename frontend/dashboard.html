<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Gateway 2.0 | Hospital Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--gray-900);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-700);
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo h1 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .logo p {
            font-size: 0.7rem;
            color: var(--gray-400);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            color: var(--gray-400);
            text-decoration: none;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: var(--gray-800);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--gray-100);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            width: 300px;
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            padding-left: 0.5rem;
            font-size: 0.875rem;
        }

        .search-box input:focus {
            outline: none;
        }

        .notification-btn, .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        /* Page Content */
        .page-content {
            padding: 1.5rem 2rem;
        }

        /* Page sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--gray-200);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue { background: #dbeafe; color: var(--primary); }
        .stat-icon.green { background: #dcfce7; color: var(--success); }
        .stat-icon.yellow { background: #fef3c7; color: var(--warning); }
        .stat-icon.red { background: #fee2e2; color: var(--danger); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-body.no-padding {
            padding: 0;
        }

        /* Upload Section */
        .upload-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-50);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .upload-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--gray-500);
        }

        .upload-zone h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        #fileInput {
            display: none;
        }

        .upload-settings {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Status */
        .status-box {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }

        .status-box.show {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-box.processing {
            background: #eff6ff;
            color: var(--primary);
            border: 1px solid #bfdbfe;
        }

        .status-box.success {
            background: #ecfdf5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .status-box.error {
            background: #fef2f2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 1.5rem;
        }

        .results-container.show {
            display: block;
        }

        /* Alert Boxes */
        .alert-box {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .alert-box.warning {
            background: #fffbeb;
            border: 1px solid #fcd34d;
        }

        .alert-box.danger {
            background: #fef2f2;
            border: 1px solid #fca5a5;
        }

        .alert-box.info {
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-content h5 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-content p {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }

        /* Prescription Details */
        .prescription-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-block {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 1rem;
        }

        .info-block h4 {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .info-item label {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: block;
        }

        .info-item span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .info-item span.missing {
            color: var(--gray-400);
            font-style: italic;
        }

        /* Medications Table */
        .med-table {
            width: 100%;
            border-collapse: collapse;
        }

        .med-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .med-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .med-table tr:last-child td {
            border-bottom: none;
        }

        .med-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .med-form {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .med-dosage {
            font-weight: 500;
            color: var(--primary);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-gray { background: var(--gray-200); color: var(--gray-700); }

        /* Confidence Meter */
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .confidence-fill.high { background: var(--success); }
        .confidence-fill.medium { background: var(--warning); }
        .confidence-fill.low { background: var(--danger); }

        .confidence-text {
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        /* Tags */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--gray-100);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--gray-700);
        }

        /* Vitals Grid */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .vital-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .vital-item label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            display: block;
            margin-bottom: 0.25rem;
        }

        .vital-item span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Review Banner */
        .review-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 10px;
            padding: 0.875rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .review-banner.hidden {
            display: none;
        }

        .review-banner i {
            color: var(--warning);
        }

        .review-banner span {
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Raw Text */
        .raw-text-box {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header i {
            transition: transform 0.2s;
        }

        .collapsible-header.active i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .collapsible-content.show {
            max-height: 500px;
        }

        /* Recent Prescriptions Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        /* Patient List */
        .patient-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .patient-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .patient-info {
            display: flex;
            flex-direction: column;
        }

        .patient-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .patient-id {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Empty State */
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-300);
        }

        .empty-state h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        /* Chart placeholder */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
            border-radius: 8px;
            color: var(--gray-400);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Print styles */
        @media print {
            .sidebar, .header {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
            .results-container {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">üè•</div>
            <div>
                <h1>Medical AI</h1>
                <p>Gateway 2.0</p>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="scan">
                    <i class="fas fa-camera"></i>
                    <span>Scan Prescription</span>
                </a>
                <a class="nav-item" data-page="patients">
                    <i class="fas fa-users"></i>
                    <span>Patients</span>
                </a>
                <a class="nav-item" data-page="history">
                    <i class="fas fa-history"></i>
                    <span>Prescription History</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Drug Tools</div>
                <a class="nav-item" data-page="drug-normalize">
                    <i class="fas fa-pills"></i>
                    <span>Drug Normalization</span>
                </a>
                <a class="nav-item" data-page="interactions">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Safety Analysis</span>
                    <span class="nav-badge" id="alertBadge">0</span>
                </a>
                <a class="nav-item" data-page="allergies">
                    <i class="fas fa-allergies"></i>
                    <span>Allergy Checker</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Temporal</div>
                <a class="nav-item" data-page="timeline">
                    <i class="fas fa-stream"></i>
                    <span>Medication Timeline</span>
                </a>
                <a class="nav-item" data-page="med-changes">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Medication Changes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a class="nav-item" data-page="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Reports</span>
                </a>
                <a class="nav-item" data-page="knowledge-graph">
                    <i class="fas fa-project-diagram"></i>
                    <span>Knowledge Graph</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Advanced</div>
                <a class="nav-item" data-page="ask-ai">
                    <i class="fas fa-robot"></i>
                    <span>Ask AI</span>
                </a>
                <a class="nav-item" data-page="review-queue">
                    <i class="fas fa-tasks"></i>
                    <span>Review Queue</span>
                    <span class="nav-badge" id="reviewBadge">0</span>
                </a>
                <a class="nav-item" data-page="audit">
                    <i class="fas fa-shield-alt"></i>
                    <span>Audit & Compliance</span>
                </a>
                <a class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--gray-700);">
            <div class="nav-item">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h2 class="page-title" id="pageTitle">Dashboard</h2>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--gray-400);"></i>
                    <input type="text" placeholder="Search patients, prescriptions...">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-dot"></span>
                </button>
                <button class="profile-btn">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Dashboard Page -->
            <section class="page-section active" id="page-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalScans">0</div>
                                <div class="stat-label">Total Scans Today</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 12% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalMeds">0</div>
                                <div class="stat-label">Medications Processed</div>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-pills"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 8% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="alertsFound">0</div>
                                <div class="stat-label">Safety Alerts</div>
                            </div>
                            <div class="stat-icon yellow">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-change down">
                            <i class="fas fa-arrow-down"></i> 5% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="avgConfidence">-</div>
                                <div class="stat-label">Avg Confidence</div>
                            </div>
                            <div class="stat-icon red">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 3% from yesterday
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Prescriptions</span>
                            <button class="btn btn-sm btn-secondary" onclick="navigateTo('history')">View All</button>
                        </div>
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Medications</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recentPrescriptions">
                                    <tr>
                                        <td colspan="5" class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>No prescriptions yet. Upload your first prescription!</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Quick Actions</span>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" style="width: 100%; justify-content: center; margin-bottom: 0.75rem;" onclick="navigateTo('scan')">
                                <i class="fas fa-camera"></i> Scan New Prescription
                            </button>
                            <button class="btn btn-secondary" style="width: 100%; justify-content: center; margin-bottom: 0.75rem;" onclick="openTextInput()">
                                <i class="fas fa-keyboard"></i> Manual Text Entry
                            </button>
                            <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="navigateTo('patients')">
                                <i class="fas fa-user-plus"></i> Add Patient
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scan Page -->
            <section class="page-section" id="page-scan">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-camera" style="margin-right: 0.5rem;"></i>Scan Prescription</span>
                    </div>
                    <div class="card-body">
                        <div class="upload-area">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Drop prescription here</h3>
                                <p>or click to browse files</p>
                                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                                    Supports: PDF, PNG, JPG, JPEG, TIFF
                                </p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp,.webp">

                            <div class="upload-settings">
                                <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;">
                                    <i class="fas fa-sliders-h" style="margin-right: 0.5rem;"></i>Processing Settings
                                </h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Patient Name (optional)</label>
                                    <input type="text" class="form-input" id="patientNameInput" placeholder="Enter patient name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Known Allergies</label>
                                    <input type="text" class="form-input" id="allergiesInput" placeholder="e.g., Penicillin, Sulfa, Aspirin">
                                    <small style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; display: block;">
                                        Comma-separated list of known allergies
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Processing Mode</label>
                                    <select class="form-select" id="processingMode">
                                        <option value="auto">Auto (AI + Fallback)</option>
                                        <option value="ai">AI Only (Gemini)</option>
                                        <option value="regex">Pattern Matching Only</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" style="width: 100%; justify-content: center;" id="processBtn" disabled>
                                    <i class="fas fa-magic"></i> Process Prescription
                                </button>
                            </div>
                        </div>

                        <div class="status-box" id="statusBox">
                            <span class="spinner"></span>
                            <span id="statusText">Processing...</span>
                        </div>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer">
                    <!-- Review Banner -->
                    <div class="review-banner hidden" id="reviewBanner">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="reviewReason">Manual review recommended</span>
                    </div>

                    <!-- Safety Alerts -->
                    <div id="alertsContainer"></div>

                    <!-- Prescription Details -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-file-medical" style="margin-right: 0.5rem;"></i>Prescription Details</span>
                            <span class="badge badge-info" id="prescriptionDate">-</span>
                        </div>
                        <div class="card-body">
                            <div class="prescription-grid">
                                <div class="info-block">
                                    <h4><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Patient Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Name</label>
                                            <span id="resultPatientName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Age / Gender</label>
                                            <span id="resultAgeGender" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Patient ID</label>
                                            <span id="resultPatientId" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Phone</label>
                                            <span id="resultPatientPhone" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item" style="grid-column: span 2;">
                                            <label>Address</label>
                                            <span id="resultPatientAddress" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-block">
                                    <h4><i class="fas fa-user-md" style="margin-right: 0.5rem;"></i>Doctor Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Doctor</label>
                                            <span id="resultDoctorName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Qualification</label>
                                            <span id="resultDoctorQual" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Clinic</label>
                                            <span id="resultClinic" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Reg. No</label>
                                            <span id="resultDoctorRegNo" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Diagnosis -->
                            <div style="margin-top: 1rem;" id="diagnosisSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-stethoscope" style="margin-right: 0.5rem;"></i>Diagnosis
                                </label>
                                <div class="tag-list" id="diagnosisList"></div>
                            </div>

                            <!-- Vitals -->
                            <div style="margin-top: 1rem;" id="vitalsSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem;"></i>Vitals
                                </label>
                                <div class="vitals-grid" id="vitalsGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medications</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="badge badge-info" id="medBadge">0 items</span>
                                <div class="confidence-meter" style="width: 150px;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" id="confidenceFill" style="width: 0;"></div>
                                    </div>
                                    <span class="confidence-text" id="confidenceText">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body no-padding">
                            <table class="med-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Medication</th>
                                        <th style="width: 12%;">Dosage</th>
                                        <th style="width: 18%;">Frequency</th>
                                        <th style="width: 12%;">Duration</th>
                                        <th style="width: 18%;">Instructions</th>
                                        <th style="width: 15%;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="medicationsList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Advice & Follow-up -->
                    <div class="card" id="adviceCard">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-clipboard-list" style="margin-right: 0.5rem;"></i>Advice & Follow-up</span>
                        </div>
                        <div class="card-body">
                            <div id="adviceSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Advice</label>
                                <div class="tag-list" id="adviceList"></div>
                            </div>
                            <div id="followUpSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Follow-up</label>
                                <span id="followUpDate" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Raw OCR Text -->
                    <div class="card">
                        <div class="card-header collapsible-header" id="rawOcrHeader">
                            <span class="card-title"><i class="fas fa-code" style="margin-right: 0.5rem;"></i>Raw OCR Text</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="collapsible-content" id="rawOcrContent">
                            <div class="card-body">
                                <pre class="raw-text-box" id="rawText"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-secondary" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy Summary
                            </button>
                            <button class="btn btn-secondary" onclick="exportJSON()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                            <button class="btn btn-success" onclick="savePrescription()">
                                <i class="fas fa-save"></i> Save to Database
                            </button>
                            <button class="btn btn-secondary" style="margin-left: auto;" onclick="resetScan()">
                                <i class="fas fa-redo"></i> New Scan
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patients Page -->
            <section class="page-section" id="page-patients">
                <!-- Patient Selection / Creation -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" onclick="refreshPatientList()" style="cursor: pointer;">
                        <div class="stat-icon blue" style="margin-bottom: 0.5rem;"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="totalPatientsCount">0</div>
                        <div class="stat-label">Total Patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green" style="margin-bottom: 0.5rem;"><i class="fas fa-file-medical"></i></div>
                        <div class="stat-value" id="totalPrescriptionsCount">0</div>
                        <div class="stat-label">Total Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow" style="margin-bottom: 0.5rem;"><i class="fas fa-pills"></i></div>
                        <div class="stat-value" id="activeMedicationsCount">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red" style="margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="activeAlertsCount">0</div>
                        <div class="stat-label">Active Alerts</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem;">
                    <!-- Left Panel: Patient List & Selection -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-user-plus"></i> Select / Create Patient</span>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Patient ID</label>
                                    <input type="text" class="form-input" id="patientIdInput" placeholder="Enter patient ID (e.g., P001)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Patient Name</label>
                                    <input type="text" class="form-input" id="patientNameInput" placeholder="Patient full name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Known Allergies (comma-separated)</label>
                                    <input type="text" class="form-input" id="patientAllergiesInput" placeholder="e.g., Penicillin, Sulfa">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Chronic Conditions (comma-separated)</label>
                                    <input type="text" class="form-input" id="patientConditionsInput" placeholder="e.g., diabetes, hypertension">
                                </div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="selectPatient()">
                                    <i class="fas fa-check"></i> Select / Create Patient
                                </button>
                            </div>
                        </div>

                        <!-- Existing Patients List -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-list"></i> Existing Patients</span>
                                <button class="btn btn-sm" onclick="refreshPatientList()"><i class="fas fa-sync"></i></button>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 0;">
                                <div id="existingPatientsList">
                                    <div class="empty-state" style="padding: 2rem;">
                                        <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                                        <p style="margin-top: 0.5rem;">No patients yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Upload Prescriptions -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-cloud-upload-alt"></i> Upload Prescriptions</span>
                                <span class="badge" id="selectedPatientBadge" style="display: none;">No patient selected</span>
                            </div>
                            <div class="card-body">
                                <div id="noPatientSelectedMsg" class="alert-box info">
                                    <span class="alert-icon">‚ÑπÔ∏è</span>
                                    <div class="alert-content">
                                        <h5>Select a Patient First</h5>
                                        <p>Enter a patient ID on the left to start uploading prescriptions.</p>
                                    </div>
                                </div>

                                <div id="prescriptionUploadArea" style="display: none;">
                                    <div class="upload-zone" id="multiUploadZone" style="border: 2px dashed var(--primary); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                                        <i class="fas fa-images" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                                        <h4>Drop Prescription Images Here</h4>
                                        <p style="color: var(--gray-500);">or click to select files (PDF, JPG, PNG)</p>
                                        <p style="color: var(--gray-400); font-size: 0.8rem; margin-top: 0.5rem;">
                                            You can upload multiple prescriptions at once
                                        </p>
                                        <input type="file" id="multiFileInput" multiple accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp,.webp" style="display: none;">
                                    </div>

                                    <div id="selectedFilesPreview" style="margin-top: 1rem; display: none;">
                                        <h5><i class="fas fa-file-alt"></i> Selected Files:</h5>
                                        <div id="filesListPreview" style="margin-top: 0.5rem;"></div>
                                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                            <button class="btn btn-primary" onclick="processAllPrescriptions()" id="processAllBtn">
                                                <i class="fas fa-play"></i> Process All Prescriptions
                                            </button>
                                            <button class="btn" onclick="clearSelectedFiles()">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>

                                    <div id="processingStatus" style="margin-top: 1rem; display: none;">
                                        <div class="status-box show processing">
                                            <span class="spinner"></span>
                                            <span id="processingText">Processing prescriptions...</span>
                                        </div>
                                        <div id="processingProgress" style="margin-top: 1rem;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Results Summary -->
                        <div class="card" style="margin-top: 1rem; display: none;" id="uploadResultsCard">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-check-circle"></i> Processing Complete</span>
                            </div>
                            <div class="card-body">
                                <div id="uploadResultsSummary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Detail View (New Page) -->
            <section class="page-section" id="page-patient-detail">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <button class="btn" onclick="navigateTo('patients')">
                            <i class="fas fa-arrow-left"></i> Back to Patients
                        </button>
                    </div>
                    <div id="patientDetailHeader">
                        <h2 id="patientDetailName">Patient Name</h2>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="refreshPatientDetail()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Patient Info Cards -->
                <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value" id="detailPrescriptionCount">0</div>
                        <div class="stat-label">Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailActiveMeds">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailDiscontinuedMeds">0</div>
                        <div class="stat-label">Discontinued</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailTimelineEvents">0</div>
                        <div class="stat-label">Timeline Events</div>
                    </div>
                    <div class="stat-card" id="detailRiskCard">
                        <div class="stat-value" id="detailRiskLevel">-</div>
                        <div class="stat-label">Risk Level</div>
                    </div>
                </div>

                <!-- Safety Alerts -->
                <div class="card" id="safetyAlertsCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <span class="card-title" style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Active Safety Alerts</span>
                    </div>
                    <div class="card-body" id="safetyAlertsContainer"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <!-- Current Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills"></i> Current Medications</span>
                        </div>
                        <div class="card-body" id="currentMedicationsContainer">
                            <div class="empty-state">
                                <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                                <p>No active medications</p>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-user"></i> Patient Information</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Patient ID</label>
                                    <p id="detailPatientId" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Age / Gender</label>
                                    <p id="detailAgeGender" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Known Allergies</label>
                                    <p id="detailAllergies" style="font-weight: 500;">None recorded</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Chronic Conditions</label>
                                    <p id="detailConditions" style="font-weight: 500;">None recorded</p>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="font-size: 0.75rem; color: var(--gray-500);">Treating Doctors</label>
                                <p id="detailDoctors" style="font-weight: 500;">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Timeline -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream"></i> Complete Medical Timeline</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="timelineFilter" style="width: auto;" onchange="filterTimeline()">
                                <option value="">All Events</option>
                                <option value="prescription_added">Prescriptions</option>
                                <option value="medication_started">New Medications</option>
                                <option value="medication_stopped">Discontinued</option>
                                <option value="medication_changed">Dose Changes</option>
                                <option value="safety_alert">Safety Alerts</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="timelineContainer">
                        <div class="empty-state">
                            <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No timeline events yet</p>
                        </div>
                    </div>
                </div>

                <!-- Prescriptions List -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-file-medical"></i> All Prescriptions</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Doctor</th>
                                    <th>Diagnosis</th>
                                    <th>Medications</th>
                                    <th>File</th>
                                </tr>
                            </thead>
                            <tbody id="prescriptionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                        No prescriptions yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- History Page -->
            <section class="page-section" id="page-history">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Prescription History</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="date" class="form-input" style="width: auto;">
                            <select class="form-select" style="width: auto;">
                                <option>All Status</option>
                                <option>Completed</option>
                                <option>Needs Review</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Document ID</th>
                                    <th>Patient</th>
                                    <th>Date</th>
                                    <th>Medications</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyList">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <i class="fas fa-file-medical-alt"></i>
                                            <h4>No prescription history</h4>
                                            <p>Processed prescriptions will appear here</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Drug Normalization Page -->
            <section class="page-section" id="page-drug-normalize">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugsNormalized">0</div>
                                <div class="stat-label">Drugs Normalized</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-pills"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalBrandNames">50+</div>
                                <div class="stat-label">Brand Names in Database</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-database"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugClasses">15+</div>
                                <div class="stat-label">Drug Classes</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-layer-group"></i></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Single Drug Normalization -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-search" style="margin-right: 0.5rem;"></i>Drug Lookup</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Enter drug name (brand or generic)</label>
                                <input type="text" class="form-input" id="normalizeDrugInput" placeholder="e.g., Tylenol, Advil, Lipitor">
                            </div>
                            <button class="btn btn-primary" onclick="normalizeSingleDrug()">
                                <i class="fas fa-exchange-alt"></i> Normalize
                            </button>
                            <div id="normalizeResult" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>

                    <!-- Batch Normalization -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-list" style="margin-right: 0.5rem;"></i>Batch Normalization</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Enter multiple drugs (comma-separated)</label>
                                <input type="text" class="form-input" id="batchNormalizeInput" placeholder="e.g., Tylenol, Advil, Zantac, Lipitor">
                            </div>
                            <button class="btn btn-primary" onclick="normalizeBatchDrugs()">
                                <i class="fas fa-layer-group"></i> Normalize All
                            </button>
                            <div id="batchNormalizeResult" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Detection -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-clone" style="margin-right: 0.5rem;"></i>Duplicate Detection</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Check if a medication list contains the same drug under different names (brand vs generic).
                        </p>
                        <div class="form-group">
                            <label class="form-label">Enter medications to check</label>
                            <input type="text" class="form-input" id="duplicateCheckInput" placeholder="e.g., Tylenol, Paracetamol, Crocin, Advil">
                        </div>
                        <button class="btn btn-warning" onclick="checkDuplicateDrugs()">
                            <i class="fas fa-search"></i> Check for Duplicates
                        </button>
                        <div id="duplicateResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Drug Comparison -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-balance-scale" style="margin-right: 0.5rem;"></i>Drug Comparison</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 1</label>
                                <input type="text" class="form-input" id="compareDrug1" placeholder="e.g., Tylenol">
                            </div>
                            <div style="padding-bottom: 0.5rem;">
                                <i class="fas fa-exchange-alt" style="color: var(--gray-400);"></i>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 2</label>
                                <input type="text" class="form-input" id="compareDrug2" placeholder="e.g., Crocin">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="compareDrugs()">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                        <div id="compareResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </section>

            <!-- Drug Safety Analysis Page -->
            <section class="page-section" id="page-interactions">
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card">
                        <div class="stat-icon blue" style="margin-bottom: 0.5rem;"><i class="fas fa-pills"></i></div>
                        <div class="stat-value">30+</div>
                        <div class="stat-label">Drug Interaction Pairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green" style="margin-bottom: 0.5rem;"><i class="fas fa-layer-group"></i></div>
                        <div class="stat-value">7</div>
                        <div class="stat-label">Class-Level Interactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow" style="margin-bottom: 0.5rem;"><i class="fas fa-allergies"></i></div>
                        <div class="stat-value">4</div>
                        <div class="stat-label">Allergy Cross-Reactivity</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red" style="margin-bottom: 0.5rem;"><i class="fas fa-ban"></i></div>
                        <div class="stat-value">6</div>
                        <div class="stat-label">Contraindication Groups</div>
                    </div>
                </div>

                <!-- Comprehensive Safety Analysis -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>Comprehensive Drug Safety Analysis</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications (comma-separated)</label>
                                <input type="text" class="form-input" id="safetyMedications" placeholder="e.g., Warfarin, Aspirin, Ibuprofen">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Allergies (optional)</label>
                                <input type="text" class="form-input" id="safetyAllergies" placeholder="e.g., Penicillin, Sulfa">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Conditions (optional)</label>
                                <input type="text" class="form-input" id="safetyConditions" placeholder="e.g., heart_failure, renal_impairment">
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="runComprehensiveSafetyAnalysis()">
                            <i class="fas fa-search"></i> Run Complete Safety Analysis
                        </button>
                        <div id="comprehensiveSafetyResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Quick Interaction Check -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-bolt" style="margin-right: 0.5rem;"></i>Quick Interaction Check</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Enter medications (comma-separated)</label>
                            <input type="text" class="form-input" id="interactionDrugs" placeholder="e.g., Aspirin, Warfarin, Ibuprofen">
                        </div>
                        <button class="btn btn-primary" onclick="checkInteractionsV2()">
                            <i class="fas fa-search"></i> Check Interactions
                        </button>
                        <div id="interactionResults" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Severity Reference -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>Severity Classification Guide</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div class="info-block" style="border-left: 4px solid #22c55e;">
                                <h4 style="color: #22c55e;">Minor</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Minimal clinical significance. Monitor if needed.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #f59e0b;">
                                <h4 style="color: #f59e0b;">Moderate</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    May require dosage adjustment or monitoring.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #ef4444;">
                                <h4 style="color: #ef4444;">Major</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Significant clinical consequences. Avoid or use extreme caution.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #7c3aed;">
                                <h4 style="color: #7c3aed;">Contraindicated</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Life-threatening. Do NOT use together.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Allergy Checker Page -->
            <section class="page-section" id="page-allergies">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-allergies" style="margin-right: 0.5rem;"></i>Medication Allergy Checker</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Check if medications are safe given patient allergies. Detects both direct matches and cross-reactivity risks.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications to check</label>
                                <input type="text" class="form-input" id="allergyCheckMeds" placeholder="e.g., Amoxicillin, Cephalexin">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Allergies</label>
                                <input type="text" class="form-input" id="allergyCheckAllergies" placeholder="e.g., Penicillin, Sulfa">
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="checkAllergyRisks()">
                            <i class="fas fa-search"></i> Check Allergy Risks
                        </button>
                        <div id="allergyCheckResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Cross-Reactivity Reference -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-book-medical" style="margin-right: 0.5rem;"></i>Common Allergy Cross-Reactivity Patterns</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="info-block" style="border-left: 4px solid #ef4444;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Penicillin Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    ‚Ä¢ Amoxicillin, Ampicillin, Piperacillin<br>
                                    ‚Ä¢ Cephalosporins (1-10% risk)
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #f59e0b;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Sulfa Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    ‚Ä¢ Sulfamethoxazole, Sulfasalazine<br>
                                    ‚Ä¢ Some diuretics, Celecoxib
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #3b82f6;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #3b82f6;"></i> NSAID/Aspirin Sensitivity</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    ‚Ä¢ Ibuprofen, Diclofenac, Naproxen<br>
                                    ‚Ä¢ Use COX-2 inhibitors with caution
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #10b981;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #10b981;"></i> Cephalosporin Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    ‚Ä¢ Cephalexin, Cefixime, Ceftriaxone<br>
                                    ‚Ä¢ Penicillins (minor risk)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contraindications Checker -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-ban" style="margin-right: 0.5rem;"></i>Contraindication Checker</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications</label>
                                <input type="text" class="form-input" id="contraMeds" placeholder="e.g., Metformin, Ibuprofen">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Conditions</label>
                                <select class="form-input" id="contraConditions" multiple style="height: 100px;">
                                    <option value="renal_impairment">Renal Impairment</option>
                                    <option value="liver_disease">Liver Disease</option>
                                    <option value="heart_failure">Heart Failure</option>
                                    <option value="asthma">Asthma</option>
                                    <option value="pregnancy">Pregnancy</option>
                                    <option value="gi_ulcer">GI Ulcer</option>
                                </select>
                                <small style="color: var(--gray-500);">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                        </div>
                        <button class="btn btn-warning" onclick="checkContraindications()">
                            <i class="fas fa-search"></i> Check Contraindications
                        </button>
                        <div id="contraResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </section>

            <!-- Medication Changes Page -->
            <section class="page-section" id="page-med-changes">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-exchange-alt" style="margin-right: 0.5rem;"></i>Medication Change Tracker</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Track changes in medication regimens over time. Detects new medications, dose changes, and discontinued drugs.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <!-- Previous Prescription -->
                            <div class="info-block">
                                <h4><i class="fas fa-calendar-minus"></i> Previous Prescription</h4>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-input" id="prevRxDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Medications (one per line: name, dosage, frequency)</label>
                                    <textarea class="form-input" id="prevRxMeds" rows="4" placeholder="Amlodipine, 5mg, once daily
Metformin, 500mg, twice daily"></textarea>
                                </div>
                            </div>
                            
                            <!-- Current Prescription -->
                            <div class="info-block">
                                <h4><i class="fas fa-calendar-plus"></i> Current Prescription</h4>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-input" id="currRxDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Medications (one per line: name, dosage, frequency)</label>
                                    <textarea class="form-input" id="currRxMeds" rows="4" placeholder="Amlodipine, 10mg, once daily
Metformin, 500mg, twice daily
Aspirin, 75mg, once daily"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="analyzeMedicationChanges()">
                            <i class="fas fa-search"></i> Analyze Changes
                        </button>
                        <div id="medChangesResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Medication Overlap Analysis -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-layer-group" style="margin-right: 0.5rem;"></i>Medication Overlap Analysis</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Analyze overlapping medication periods to identify concurrent therapies.
                        </p>
                        <div id="overlapAnalysisResult">
                            <div class="empty-state">
                                <i class="fas fa-calendar-alt" style="font-size: 2rem; color: var(--gray-400);"></i>
                                <p>Analyze prescriptions above to see overlap data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Page -->
            <section class="page-section" id="page-analytics">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Total Prescriptions</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-file-medical"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Unique Patients</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Interactions Found</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">-</div>
                                <div class="stat-label">Avg OCR Accuracy</div>
                            </div>
                            <div class="stat-icon red"><i class="fas fa-chart-bar"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Processing Statistics</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <i class="fas fa-chart-area" style="font-size: 3rem;"></i>
                            <span style="margin-left: 1rem;">Charts will appear once you have processing data</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-cog" style="margin-right: 0.5rem;"></i>Settings</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">API Endpoint</label>
                            <input type="text" class="form-input" value="http://localhost:8000" id="apiEndpoint">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Processing Mode</label>
                            <select class="form-select" id="defaultMode">
                                <option value="auto">Auto (AI + Fallback)</option>
                                <option value="ai">AI Only</option>
                                <option value="regex">Pattern Matching Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="autoSave" checked> Auto-save prescriptions to database
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Patient Timeline Page -->
            <section class="page-section" id="page-timeline">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream" style="margin-right: 0.5rem;"></i>Patient Timeline</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="form-label">Patient ID</label>
                                <input type="number" class="form-input" id="timelinePatientId" placeholder="Enter patient ID">
                            </div>
                            <button class="btn btn-primary" onclick="loadTimeline()">
                                <i class="fas fa-search"></i> Load Timeline
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="timelineResults" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medication Timeline (Gantt View)</span>
                    </div>
                    <div class="card-body">
                        <div id="timelineChart" style="min-height: 300px;">
                            <!-- Gantt chart will be rendered here -->
                        </div>
                    </div>
                </div>

                <div class="card" id="timelineEventsCard" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-list-ul" style="margin-right: 0.5rem;"></i>Timeline Events</span>
                    </div>
                    <div class="card-body no-padding">
                        <div id="timelineEvents"></div>
                    </div>
                </div>
            </section>

            <!-- Knowledge Graph Page -->
            <section class="page-section" id="page-knowledge-graph">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-project-diagram" style="margin-right: 0.5rem;"></i>Knowledge Graph</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="form-label">Patient ID</label>
                                <input type="number" class="form-input" id="graphPatientId" placeholder="Enter patient ID">
                            </div>
                            <button class="btn btn-primary" onclick="loadKnowledgeGraph()">
                                <i class="fas fa-search"></i> Load Graph
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" id="graphResults" style="display: none;">
                    <div class="card-header">
                        <span class="card-title">Patient Knowledge Graph</span>
                        <div id="graphStats" style="font-size: 0.875rem; color: var(--gray-500);"></div>
                    </div>
                    <div class="card-body">
                        <div id="knowledgeGraphContainer" style="min-height: 400px; background: var(--gray-50); border-radius: 8px;">
                            <!-- Graph will be rendered here -->
                        </div>
                        <div id="graphLegend" style="margin-top: 1rem; display: flex; gap: 1.5rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 16px; height: 16px; background: #3b82f6; border-radius: 50%;"></span>
                                <span>Patient</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 16px; height: 16px; background: #10b981; border-radius: 50%;"></span>
                                <span>Medication</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 16px; height: 16px; background: #f59e0b; border-radius: 50%;"></span>
                                <span>Condition</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 16px; height: 16px; background: #ef4444; border-radius: 50%;"></span>
                                <span>Symptom</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ask AI Page -->
            <section class="page-section" id="page-ask-ai">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-robot" style="margin-right: 0.5rem;"></i>Ask AI - Medical Query Assistant</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Your Question</label>
                            <textarea class="form-input" id="aiQueryInput" rows="3" placeholder="Ask a question about patients, medications, interactions...

Examples:
‚Ä¢ What medications is patient #1 taking?
‚Ä¢ Check interactions between aspirin and warfarin
‚Ä¢ Show medication history for patient #2"></textarea>
                        </div>
                        <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div>
                                <label class="form-label">Patient ID (optional)</label>
                                <input type="number" class="form-input" id="aiQueryPatientId" placeholder="Patient ID" style="width: 150px;">
                            </div>
                            <button class="btn btn-primary" onclick="submitAIQuery()">
                                <i class="fas fa-paper-plane"></i> Ask AI
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" id="aiResponseCard" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-comment-alt" style="margin-right: 0.5rem;"></i>AI Response</span>
                        <span class="badge" id="aiConfidenceBadge">-</span>
                    </div>
                    <div class="card-body">
                        <div id="queryResponse"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>Suggested Questions</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('What medications is patient #1 taking?')">Current medications</button>
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('Show medication history for patient #1')">Medication history</button>
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('Check interactions between aspirin and ibuprofen')">Check interactions</button>
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('Show timeline for patient #1')">Patient timeline</button>
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('What conditions does patient #1 have?')">Conditions</button>
                            <button class="btn btn-secondary btn-sm" onclick="fillQuery('Give me a summary for patient #1')">Patient summary</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Review Queue Page -->
            <section class="page-section" id="page-review-queue">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pendingReviewCount">0</div>
                                <div class="stat-label">Pending Review</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-clock"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="correctionsMade">0</div>
                                <div class="stat-label">Corrections Made</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="dismissedAlerts">0</div>
                                <div class="stat-label">Dismissed Alerts</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-times-circle"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>Items Pending Review</span>
                        <button class="btn btn-secondary btn-sm" onclick="refreshReviewQueue()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="reviewQueueList">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <h4>All caught up!</h4>
                                <p>No items pending review</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Recent Corrections</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Original</th>
                                    <th>Corrected</th>
                                    <th>By</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentCorrections">
                                <tr>
                                    <td colspan="6" class="empty-state">No corrections yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Audit & Compliance Page -->
            <section class="page-section" id="page-audit">
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalAuditEvents">0</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-list"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalCorrections">0</div>
                                <div class="stat-label">Corrections</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-edit"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="integrityScore">100%</div>
                                <div class="stat-label">Integrity Score</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-shield-alt"></i></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-scroll" style="margin-right: 0.5rem;"></i>Audit Trail</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="auditActionFilter" style="width: auto;" onchange="filterAuditTrail()">
                                    <option value="">All Actions</option>
                                    <option value="upload">Upload</option>
                                    <option value="extract">Extract</option>
                                    <option value="view">View</option>
                                    <option value="correct">Correct</option>
                                    <option value="dismiss">Dismiss</option>
                                    <option value="export">Export</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="refreshAuditTrail()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body no-padding">
                            <div id="auditTrailList"></div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-chart-pie" style="margin-right: 0.5rem;"></i>Compliance Report</span>
                            </div>
                            <div class="card-body">
                                <div id="complianceReport">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-pie"></i>
                                        <p>Loading compliance data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Export</span>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="exportAuditTrail()">
                                    <i class="fas fa-file-export"></i> Export Audit Trail
                                </button>
                                <button class="btn btn-secondary" style="width: 100%;" onclick="generateComplianceReport()">
                                    <i class="fas fa-file-pdf"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Add Patient Modal -->
    <div class="modal-overlay" id="addPatientModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Patient</h3>
                <button class="modal-close" onclick="closeModal('addPatientModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="newPatientName" placeholder="Enter patient name">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-input" id="newPatientAge" placeholder="Age">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-select" id="newPatientGender">
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="newPatientPhone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Known Allergies</label>
                    <input type="text" class="form-input" id="newPatientAllergies" placeholder="e.g., Penicillin, Sulfa">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPatientModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePatient()">
                    <i class="fas fa-save"></i> Save Patient
                </button>
            </div>
        </div>
    </div>

    <!-- Text Input Modal -->
    <div class="modal-overlay" id="textInputModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <h3>Manual Text Entry</h3>
                <button class="modal-close" onclick="closeModal('textInputModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Paste or type prescription text</label>
                    <textarea class="form-input" id="manualText" rows="10" placeholder="Paste prescription text here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Known Allergies (optional)</label>
                    <input type="text" class="form-input" id="manualAllergies" placeholder="e.g., Penicillin, Sulfa">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('textInputModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processManualText()">
                    <i class="fas fa-magic"></i> Process Text
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        let currentResult = null;
        let selectedFile = null;
        let stats = { scans: 0, meds: 0, alerts: 0, totalConfidence: 0 };
        let prescriptionHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initUpload();
            loadStats();
        });

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });
        }

        function navigateTo(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'patient-detail': 'Patient Details',
                'history': 'Prescription History',
                'drug-normalize': 'Drug Normalization',
                'interactions': 'Drug Safety Analysis',
                'allergies': 'Allergy & Contraindication Checker',
                'med-changes': 'Medication Changes Tracker',
                'analytics': 'Analytics & Reports',
                'settings': 'Settings',
                'timeline': 'Medication Timeline',
                'knowledge-graph': 'Knowledge Graph',
                'ask-ai': 'Ask AI',
                'review-queue': 'Review Queue',
                'audit': 'Audit Trail'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
        }

        // Upload handling
        function initUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) selectFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) selectFile(file);
            });

            processBtn.addEventListener('click', processFile);

            // Collapsible
            document.getElementById('rawOcrHeader').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('rawOcrContent').classList.toggle('show');
            });
        }

        function selectFile(file) {
            selectedFile = file;
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-icon" style="background: #dcfce7; color: var(--success);">
                    <i class="fas fa-check"></i>
                </div>
                <h3>${file.name}</h3>
                <p>${(file.size / 1024).toFixed(1)} KB</p>
                <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-400);">
                    Click to change file
                </p>
            `;
            document.getElementById('processBtn').disabled = false;
        }

        async function processFile() {
            if (!selectedFile) return;

            const statusBox = document.getElementById('statusBox');
            const processBtn = document.getElementById('processBtn');

            // Show processing status
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing prescription with AI...';
            processBtn.disabled = true;
            document.getElementById('resultsContainer').classList.remove('show');

            const formData = new FormData();
            formData.append('file', selectedFile);

            const allergies = document.getElementById('allergiesInput').value;
            if (allergies) {
                formData.append('allergies', allergies);
            }

            try {
                const response = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = '‚úì Prescription processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = '‚úó ' + error.message;
            } finally {
                processBtn.disabled = false;
            }
        }

        function displayResults(data) {
            document.getElementById('resultsContainer').classList.add('show');

            // Review banner
            const reviewBanner = document.getElementById('reviewBanner');
            if (data.needs_review) {
                reviewBanner.classList.remove('hidden');
                document.getElementById('reviewReason').textContent = 
                    data.review_reasons?.join(', ') || 'Manual review recommended';
            } else {
                reviewBanner.classList.add('hidden');
            }

            // Safety alerts
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';

            if (data.drug_interactions?.length > 0) {
                data.drug_interactions.forEach(int => {
                    const alertClass = int.severity === 'major' || int.severity === 'contraindicated' ? 'danger' : 'warning';
                    alertsContainer.innerHTML += `
                        <div class="alert-box ${alertClass}">
                            <span class="alert-icon">${alertClass === 'danger' ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>Drug Interaction: ${int.drug1} + ${int.drug2}</h5>
                                <p><strong>Severity:</strong> ${int.severity.toUpperCase()}</p>
                                <p>${int.description}</p>
                            </div>
                        </div>
                    `;
                });
            }

            if (data.allergy_alerts?.length > 0) {
                data.allergy_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box danger">
                            <span class="alert-icon">üö®</span>
                            <div class="alert-content">
                                <h5>ALLERGY ALERT: ${alert.drug}</h5>
                                <p>Patient is allergic to ${alert.allergen}</p>
                                ${alert.cross_reactivity ? `<p><strong>Cross-reactivity:</strong> ${alert.cross_reactivity}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            if (data.safety_alerts?.length > 0) {
                data.safety_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div class="alert-content">
                                <h5>${alert}</h5>
                            </div>
                        </div>
                    `;
                });
            }

            // Prescription date
            document.getElementById('prescriptionDate').textContent = data.prescription_date || 'Date not found';

            // Patient info
            setField('resultPatientName', data.patient_name);
            setField('resultAgeGender', formatAgeGender(data.patient_age, data.patient_gender));
            setField('resultPatientId', data.patient_id);
            setField('resultPatientPhone', data.patient_phone);
            setField('resultPatientAddress', data.patient_address);

            // Doctor info
            setField('resultDoctorName', data.doctor_name);
            setField('resultDoctorQual', data.doctor_qualification);
            setField('resultClinic', data.clinic_name);
            setField('resultDoctorRegNo', data.doctor_reg_no);

            // Diagnosis
            const diagnosisList = document.getElementById('diagnosisList');
            diagnosisList.innerHTML = '';
            if (data.diagnosis?.length > 0) {
                data.diagnosis.forEach(d => {
                    diagnosisList.innerHTML += `<span class="tag">${d}</span>`;
                });
                document.getElementById('diagnosisSection').style.display = 'block';
            } else {
                document.getElementById('diagnosisSection').style.display = 'none';
            }

            // Vitals
            const vitalsGrid = document.getElementById('vitalsGrid');
            vitalsGrid.innerHTML = '';
            if (data.vitals && Object.keys(data.vitals).length > 0) {
                for (const [key, value] of Object.entries(data.vitals)) {
                    if (value) {
                        vitalsGrid.innerHTML += `
                            <div class="vital-item">
                                <label>${formatVitalName(key)}</label>
                                <span>${value}</span>
                            </div>
                        `;
                    }
                }
                document.getElementById('vitalsSection').style.display = 'block';
            } else {
                document.getElementById('vitalsSection').style.display = 'none';
            }

            // Medications
            const medCount = data.medications?.length || 0;
            const medsList = document.getElementById('medicationsList');
            medsList.innerHTML = '';
            document.getElementById('medBadge').textContent = medCount + ' items';

            // Get interaction drugs for highlighting
            const interactionDrugs = new Set();
            data.drug_interactions?.forEach(i => {
                interactionDrugs.add(i.drug1.toLowerCase());
                interactionDrugs.add(i.drug2.toLowerCase());
            });

            if (medCount > 0) {
                data.medications.forEach((med) => {
                    const hasInteraction = interactionDrugs.has(med.name?.toLowerCase());
                    const statusBadge = hasInteraction 
                        ? '<span class="badge badge-warning">‚ö†Ô∏è Interaction</span>'
                        : '<span class="badge badge-success">‚úì Safe</span>';
                    
                    medsList.innerHTML += `
                        <tr>
                            <td>
                                <div class="med-name">${med.name || 'Unknown'}</div>
                                ${med.form ? `<div class="med-form">${med.form}</div>` : ''}
                            </td>
                            <td class="med-dosage">${med.dosage || '-'}</td>
                            <td>
                                ${med.frequency || '-'}
                                ${med.timing ? `<div style="font-size: 0.75rem; color: var(--gray-500);">${med.timing}</div>` : ''}
                            </td>
                            <td>${med.duration || '-'}</td>
                            <td>${med.instructions || '-'}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            } else {
                medsList.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            No medications found in prescription
                        </td>
                    </tr>
                `;
            }

            // Confidence
            const confidence = Math.round((data.confidence || 0) * 100);
            const confidenceFill = document.getElementById('confidenceFill');
            confidenceFill.style.width = confidence + '%';
            confidenceFill.className = 'confidence-fill ' + (confidence >= 70 ? 'high' : confidence >= 40 ? 'medium' : 'low');
            document.getElementById('confidenceText').textContent = confidence + '%';

            // Advice
            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';
            if (data.advice?.length > 0) {
                data.advice.forEach(a => {
                    adviceList.innerHTML += `<span class="tag">${a}</span>`;
                });
                document.getElementById('adviceSection').style.display = 'block';
            } else {
                document.getElementById('adviceSection').style.display = 'none';
            }

            // Follow-up
            document.getElementById('followUpDate').textContent = data.follow_up || 'Not specified';

            // Raw text
            document.getElementById('rawText').textContent = data.raw_ocr_text || 'No OCR text available';

            // Add to history
            addToHistory(data);
        }

        function setField(id, value) {
            const el = document.getElementById(id);
            if (value) {
                el.textContent = value;
                el.classList.remove('missing');
            } else {
                el.textContent = 'Not found';
                el.classList.add('missing');
            }
        }

        function formatAgeGender(age, gender) {
            const parts = [];
            if (age) parts.push(age);
            if (gender) parts.push(gender);
            return parts.join(' / ') || null;
        }

        function formatVitalName(key) {
            const names = {
                'blood_pressure': 'BP',
                'temperature': 'Temp',
                'pulse': 'Pulse',
                'spo2': 'SpO2',
                'weight': 'Weight'
            };
            return names[key] || key.replace(/_/g, ' ').toUpperCase();
        }

        function updateStats(data) {
            stats.scans++;
            stats.meds += data.medications?.length || 0;
            stats.alerts += (data.drug_interactions?.length || 0) + (data.allergy_alerts?.length || 0);
            stats.totalConfidence += (data.confidence || 0);

            document.getElementById('totalScans').textContent = stats.scans;
            document.getElementById('totalMeds').textContent = stats.meds;
            document.getElementById('alertsFound').textContent = stats.alerts;
            document.getElementById('avgConfidence').textContent = 
                Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
            document.getElementById('alertBadge').textContent = stats.alerts;
        }

        function loadStats() {
            // Load from localStorage or API
            const saved = localStorage.getItem('medicalGatewayStats');
            if (saved) {
                stats = JSON.parse(saved);
                document.getElementById('totalScans').textContent = stats.scans;
                document.getElementById('totalMeds').textContent = stats.meds;
                document.getElementById('alertsFound').textContent = stats.alerts;
                document.getElementById('alertBadge').textContent = stats.alerts;
                if (stats.scans > 0) {
                    document.getElementById('avgConfidence').textContent = 
                        Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
                }
            }
        }

        function addToHistory(data) {
            prescriptionHistory.unshift({
                id: data.document_id || Date.now().toString(),
                patient: data.patient_name || 'Unknown',
                date: data.prescription_date || new Date().toLocaleDateString(),
                medCount: data.medications?.length || 0,
                confidence: Math.round((data.confidence || 0) * 100),
                status: data.needs_review ? 'Review' : 'Complete',
                data: data
            });

            updateHistoryTable();
            updateRecentTable();

            // Save stats
            localStorage.setItem('medicalGatewayStats', JSON.stringify(stats));
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyList');
            if (prescriptionHistory.length === 0) return;

            tbody.innerHTML = prescriptionHistory.map(p => `
                <tr>
                    <td><code style="font-size: 0.75rem;">${p.id.substring(0, 8)}...</code></td>
                    <td>${p.patient}</td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <div class="confidence-meter" style="width: 100px;">
                            <div class="confidence-bar">
                                <div class="confidence-fill ${p.confidence >= 70 ? 'high' : p.confidence >= 40 ? 'medium' : 'low'}" style="width: ${p.confidence}%;"></div>
                            </div>
                            <span style="font-size: 0.75rem;">${p.confidence}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentTable() {
            const tbody = document.getElementById('recentPrescriptions');
            const recent = prescriptionHistory.slice(0, 5);
            
            if (recent.length === 0) return;

            tbody.innerHTML = recent.map(p => `
                <tr>
                    <td>
                        <div class="patient-row">
                            <div class="patient-avatar">${(p.patient[0] || '?').toUpperCase()}</div>
                            <div class="patient-info">
                                <span class="patient-name">${p.patient}</span>
                            </div>
                        </div>
                    </td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewPrescription(id) {
            const prescription = prescriptionHistory.find(p => p.id === id);
            if (prescription) {
                navigateTo('scan');
                displayResults(prescription.data);
            }
        }

        function resetScan() {
            selectedFile = null;
            currentResult = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('allergiesInput').value = '';
            document.getElementById('patientNameInput').value = '';
            document.getElementById('statusBox').classList.remove('show');
            document.getElementById('resultsContainer').classList.remove('show');
            document.getElementById('processBtn').disabled = true;
            
            document.getElementById('uploadZone').innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Drop prescription here</h3>
                <p>or click to browse files</p>
                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                    Supports: PDF, PNG, JPG, JPEG, TIFF
                </p>
            `;
        }

        function copyToClipboard() {
            if (!currentResult) return;

            let text = `PRESCRIPTION SUMMARY\n`;
            text += `==================\n\n`;
            text += `Patient: ${currentResult.patient_name || 'N/A'}\n`;
            text += `Date: ${currentResult.prescription_date || 'N/A'}\n`;
            text += `Doctor: ${currentResult.doctor_name || 'N/A'}\n\n`;
            text += `MEDICATIONS:\n`;

            currentResult.medications?.forEach((med, i) => {
                text += `${i+1}. ${med.name} ${med.dosage || ''}\n`;
                text += `   ${med.frequency || ''} ${med.timing || ''} ${med.duration || ''}\n`;
            });

            if (currentResult.drug_interactions?.length > 0) {
                text += `\n‚ö†Ô∏è DRUG INTERACTIONS:\n`;
                currentResult.drug_interactions.forEach(i => {
                    text += `- ${i.drug1} + ${i.drug2}: ${i.description}\n`;
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                alert('Summary copied to clipboard!');
            });
        }

        function exportJSON() {
            if (!currentResult) return;

            const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prescription_${currentResult.document_id || Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function savePrescription() {
            if (!currentResult) return;
            alert('Prescription saved to database!');
        }

        // Modal functions
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function openAddPatient() {
            openModal('addPatientModal');
        }

        function savePatient() {
            const name = document.getElementById('newPatientName').value;
            if (!name) {
                alert('Please enter patient name');
                return;
            }
            
            // Save patient logic here
            alert('Patient saved successfully!');
            closeModal('addPatientModal');
        }

        function openTextInput() {
            openModal('textInputModal');
        }

        async function processManualText() {
            const text = document.getElementById('manualText').value;
            const allergies = document.getElementById('manualAllergies').value;
            
            if (!text.trim()) {
                alert('Please enter prescription text');
                return;
            }

            closeModal('textInputModal');
            navigateTo('scan');

            const statusBox = document.getElementById('statusBox');
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing text...';

            try {
                const formData = new FormData();
                formData.append('text', text);
                if (allergies) formData.append('allergies', allergies);

                const response = await fetch(`${API_BASE}/api/documents/extract-text`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = '‚úì Text processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = '‚úó ' + error.message;
            }
        }

        async function checkInteractions() {
            const drugs = document.getElementById('interactionDrugs').value;
            if (!drugs.trim()) {
                alert('Please enter medications');
                return;
            }

            const resultsDiv = document.getElementById('interactionResults');
            resultsDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking interactions...</div>';

            try {
                const formData = new FormData();
                formData.append('medications', drugs);

                const response = await fetch(`${API_BASE}/api/documents/check-interactions`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Check failed');
                }

                if (data.drug_interactions?.length > 0) {
                    resultsDiv.innerHTML = data.drug_interactions.map(i => `
                        <div class="alert-box ${i.severity === 'major' || i.severity === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${i.severity === 'major' || i.severity === 'contraindicated' ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>${i.drug1} + ${i.drug2}</h5>
                                <p><strong>Severity:</strong> ${i.severity.toUpperCase()}</p>
                                <p>${i.description}</p>
                                ${i.management ? `<p><strong>Management:</strong> ${i.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No interactions found</h5>
                                <p>The entered medications (${data.medications_checked.join(', ')}) appear to be safe to use together.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert-box danger">
                        <span class="alert-icon">‚ùå</span>
                        <div class="alert-content">
                            <h5>Error</h5>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function saveSettings() {
            localStorage.setItem('apiEndpoint', document.getElementById('apiEndpoint').value);
            localStorage.setItem('defaultMode', document.getElementById('defaultMode').value);
            localStorage.setItem('autoSave', document.getElementById('autoSave').checked);
            alert('Settings saved!');
        }

        // ==================== Patient Prescription Management ====================
        const PATIENT_API = 'http://localhost:8000/api/v2/patient-prescriptions';
        
        let currentPatientId = null;
        let selectedFiles = [];
        let currentPatientData = null;
        let allTimelineEvents = [];

        // Initialize patient upload area
        document.addEventListener('DOMContentLoaded', () => {
            initPatientUpload();
            refreshPatientList();
        });

        function initPatientUpload() {
            const uploadZone = document.getElementById('multiUploadZone');
            const fileInput = document.getElementById('multiFileInput');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--success)';
                uploadZone.style.background = 'rgba(34, 197, 94, 0.05)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
                handleFilesSelected(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFilesSelected(e.target.files);
            });
        }

        function handleFilesSelected(files) {
            selectedFiles = Array.from(files);
            
            if (selectedFiles.length === 0) return;

            const previewArea = document.getElementById('selectedFilesPreview');
            const filesList = document.getElementById('filesListPreview');
            
            previewArea.style.display = 'block';
            
            filesList.innerHTML = selectedFiles.map((f, idx) => `
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                    <i class="fas fa-file-image" style="color: var(--primary);"></i>
                    <span style="flex: 1;">${f.name}</span>
                    <span style="color: var(--gray-500); font-size: 0.75rem;">${(f.size / 1024).toFixed(1)} KB</span>
                    <span class="badge" id="fileStatus${idx}">Pending</span>
                </div>
            `).join('');
        }

        function clearSelectedFiles() {
            selectedFiles = [];
            document.getElementById('multiFileInput').value = '';
            document.getElementById('selectedFilesPreview').style.display = 'none';
            document.getElementById('filesListPreview').innerHTML = '';
        }

        function selectPatient() {
            const patientId = document.getElementById('patientIdInput').value.trim();
            const patientName = document.getElementById('patientNameInput').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }

            currentPatientId = patientId;
            
            // Show upload area
            document.getElementById('noPatientSelectedMsg').style.display = 'none';
            document.getElementById('prescriptionUploadArea').style.display = 'block';
            
            // Update badge
            const badge = document.getElementById('selectedPatientBadge');
            badge.style.display = 'inline-block';
            badge.textContent = `Patient: ${patientId}${patientName ? ` (${patientName})` : ''}`;
            badge.style.background = 'var(--success)';
            badge.style.color = 'white';
            
            // Check if patient exists
            checkExistingPatient(patientId);
        }

        async function checkExistingPatient(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}`);
                if (response.ok) {
                    const patient = await response.json();
                    // Auto-fill fields
                    if (patient.name) document.getElementById('patientNameInput').value = patient.name;
                    if (patient.allergies?.length) document.getElementById('patientAllergiesInput').value = patient.allergies.join(', ');
                    if (patient.chronic_conditions?.length) document.getElementById('patientConditionsInput').value = patient.chronic_conditions.join(', ');
                }
            } catch (e) {
                // Patient doesn't exist yet, that's fine
            }
        }

        async function refreshPatientList() {
            try {
                const response = await fetch(`${PATIENT_API}/patients`);
                const patients = await response.json();
                
                const container = document.getElementById('existingPatientsList');
                document.getElementById('totalPatientsCount').textContent = patients.length;
                
                // Calculate totals
                let totalRx = 0, totalMeds = 0;
                patients.forEach(p => {
                    totalRx += p.prescriptions_count || 0;
                    totalMeds += p.active_medications || 0;
                });
                document.getElementById('totalPrescriptionsCount').textContent = totalRx;
                document.getElementById('activeMedicationsCount').textContent = totalMeds;
                
                if (patients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                            <p style="margin-top: 0.5rem;">No patients yet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = patients.map(p => `
                    <div class="patient-list-item" onclick="loadPatientDetail('${p.patient_id}')" 
                         style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.2s;"
                         onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                        <div>
                            <div style="font-weight: 500;">${p.name}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">ID: ${p.patient_id}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem;">${p.prescriptions_count} Rx</div>
                            <div style="font-size: 0.7rem; color: var(--gray-500);">${p.active_medications} active meds</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load patients:', e);
            }
        }

        async function processAllPrescriptions() {
            if (!currentPatientId) {
                alert('Please select a patient first');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const patientName = document.getElementById('patientNameInput').value.trim();
            const allergies = document.getElementById('patientAllergiesInput').value.trim();
            const conditions = document.getElementById('patientConditionsInput').value.trim();

            // Show processing status
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('processAllBtn').disabled = true;
            
            const progressDiv = document.getElementById('processingProgress');
            const results = [];
            const errors = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                // Update status
                document.getElementById('processingText').textContent = `Processing ${i + 1} of ${selectedFiles.length}: ${file.name}`;
                document.getElementById(`fileStatus${i}`).textContent = 'Processing...';
                document.getElementById(`fileStatus${i}`).style.background = 'var(--warning)';
                document.getElementById(`fileStatus${i}`).style.color = 'white';

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('patient_id', currentPatientId);
                    if (patientName) formData.append('patient_name', patientName);
                    if (allergies) formData.append('allergies', allergies);
                    if (conditions) formData.append('conditions', conditions);

                    const response = await fetch(`${PATIENT_API}/scan`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        results.push({
                            file: file.name,
                            prescription_number: data.analysis.prescription_number,
                            changes: data.analysis.changes_detected,
                            safety: data.analysis.safety_analysis
                        });
                        
                        document.getElementById(`fileStatus${i}`).textContent = '‚úì Done';
                        document.getElementById(`fileStatus${i}`).style.background = 'var(--success)';
                        
                        // Show changes in progress
                        const changes = data.analysis.changes_detected;
                        if (changes.new_medications?.length || changes.stopped_medications?.length || changes.dose_changes?.length) {
                            progressDiv.innerHTML += `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; font-size: 0.8rem;">
                                    <strong>Rx #${data.analysis.prescription_number}:</strong>
                                    ${changes.new_medications?.length ? `<span style="color: var(--success);">+${changes.new_medications.length} new</span>` : ''}
                                    ${changes.stopped_medications?.length ? `<span style="color: var(--danger);"> -${changes.stopped_medications.length} stopped</span>` : ''}
                                    ${changes.dose_changes?.length ? `<span style="color: var(--warning);"> ${changes.dose_changes.length} changed</span>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        throw new Error(data.detail || 'Processing failed');
                    }
                } catch (e) {
                    errors.push({ file: file.name, error: e.message });
                    document.getElementById(`fileStatus${i}`).textContent = '‚úó Error';
                    document.getElementById(`fileStatus${i}`).style.background = 'var(--danger)';
                }
            }

            // Show completion
            document.getElementById('processingText').textContent = `‚úì Completed: ${results.length} of ${selectedFiles.length} processed`;
            document.getElementById('processAllBtn').disabled = false;

            // Show results card
            document.getElementById('uploadResultsCard').style.display = 'block';
            document.getElementById('uploadResultsSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #059669;">${results.length}</div>
                        <div style="font-size: 0.8rem; color: #065f46;">Successfully Processed</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #d97706;">${results.reduce((sum, r) => sum + (r.changes?.new_medications?.length || 0), 0)}</div>
                        <div style="font-size: 0.8rem; color: #92400e;">New Medications</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: ${errors.length ? '#fee2e2' : '#e0f2fe'}; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: ${errors.length ? '#dc2626' : '#0284c7'};">${errors.length || 'None'}</div>
                        <div style="font-size: 0.8rem; color: ${errors.length ? '#991b1b' : '#075985'};">Errors</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="loadPatientDetail('${currentPatientId}')">
                    <i class="fas fa-user"></i> View Patient Timeline & Details
                </button>
            `;

            // Refresh patient list
            refreshPatientList();
        }

        async function loadPatientDetail(patientId) {
            currentPatientId = patientId;
            
            // Navigate to detail page
            navigateTo('patient-detail');
            
            try {
                // Load patient summary
                const summaryRes = await fetch(`${PATIENT_API}/patients/${patientId}/summary`);
                const summary = await summaryRes.json();
                
                currentPatientData = summary;
                
                // Update header
                document.getElementById('patientDetailName').textContent = summary.patient.name || patientId;
                
                // Update stats
                document.getElementById('detailPrescriptionCount').textContent = summary.statistics.total_prescriptions;
                document.getElementById('detailActiveMeds').textContent = summary.statistics.current_active_medications;
                document.getElementById('detailDiscontinuedMeds').textContent = summary.statistics.discontinued_medications;
                document.getElementById('detailTimelineEvents').textContent = summary.statistics.timeline_events;
                
                // Risk level
                const riskLevel = summary.patient.safety_alerts?.length > 0 ? 'HIGH' : 'LOW';
                document.getElementById('detailRiskLevel').textContent = riskLevel;
                document.getElementById('detailRiskCard').style.background = riskLevel === 'HIGH' ? 
                    'linear-gradient(135deg, #fef2f2, #fee2e2)' : 'linear-gradient(135deg, #f0fdf4, #dcfce7)';
                
                // Patient info
                document.getElementById('detailPatientId').textContent = summary.patient.patient_id;
                document.getElementById('detailAgeGender').textContent = 
                    `${summary.patient.age || 'Unknown'} / ${summary.patient.gender || 'Unknown'}`;
                document.getElementById('detailAllergies').textContent = 
                    summary.patient.allergies?.length ? summary.patient.allergies.join(', ') : 'None recorded';
                document.getElementById('detailConditions').textContent = 
                    summary.patient.chronic_conditions?.length ? summary.patient.chronic_conditions.join(', ') : 'None recorded';
                document.getElementById('detailDoctors').textContent = 
                    summary.all_doctors?.length ? summary.all_doctors.join(', ') : '-';
                
                // Safety alerts
                const alertsCard = document.getElementById('safetyAlertsCard');
                const alertsContainer = document.getElementById('safetyAlertsContainer');
                
                if (summary.patient.safety_alerts?.length > 0) {
                    alertsCard.style.display = 'block';
                    document.getElementById('activeAlertsCount').textContent = summary.patient.safety_alerts.length;
                    alertsContainer.innerHTML = summary.patient.safety_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">üö®</span>
                            <div class="alert-content">
                                <h5>${alert.type?.toUpperCase() || 'ALERT'}: ${alert.drugs?.join(' + ') || alert.drug || 'Unknown'}</h5>
                                <p>${alert.description || ''}</p>
                                ${alert.action_required ? `<p style="color: var(--danger);"><strong>Action:</strong> ${alert.action_required}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    alertsCard.style.display = 'none';
                    document.getElementById('activeAlertsCount').textContent = '0';
                }
                
                // Current medications
                const medsContainer = document.getElementById('currentMedicationsContainer');
                if (summary.patient.current_medications?.length > 0) {
                    medsContainer.innerHTML = summary.patient.current_medications.map(med => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: 500;">${med.name}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.generic_name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: var(--primary);">${med.dosage}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.frequency}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    medsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No active medications</p>
                        </div>
                    `;
                }
                
                // Load timeline
                loadPatientTimeline(patientId);
                
                // Load prescriptions table
                loadPrescriptionsTable(summary.patient.prescriptions);
                
            } catch (e) {
                console.error('Failed to load patient:', e);
                alert('Failed to load patient details: ' + e.message);
            }
        }

        async function loadPatientTimeline(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}/timeline`);
                const data = await response.json();
                
                allTimelineEvents = data.timeline || [];
                renderTimeline(allTimelineEvents);
            } catch (e) {
                console.error('Failed to load timeline:', e);
            }
        }

        function filterTimeline() {
            const filter = document.getElementById('timelineFilter').value;
            const filtered = filter ? 
                allTimelineEvents.filter(e => e.event_type === filter) : 
                allTimelineEvents;
            renderTimeline(filtered);
        }

        function renderTimeline(events) {
            const container = document.getElementById('timelineContainer');
            
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                        <p>No timeline events</p>
                    </div>
                `;
                return;
            }

            const eventIcons = {
                'prescription_added': { icon: 'fa-file-medical', color: '#3b82f6' },
                'medication_started': { icon: 'fa-plus-circle', color: '#22c55e' },
                'medication_stopped': { icon: 'fa-minus-circle', color: '#ef4444' },
                'medication_changed': { icon: 'fa-exchange-alt', color: '#f59e0b' },
                'medication_restarted': { icon: 'fa-redo', color: '#8b5cf6' },
                'diagnosis_recorded': { icon: 'fa-stethoscope', color: '#06b6d4' },
                'safety_alert': { icon: 'fa-exclamation-triangle', color: '#dc2626' }
            };

            container.innerHTML = events.map(event => {
                const config = eventIcons[event.event_type] || { icon: 'fa-circle', color: '#6b7280' };
                return `
                    <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: ${config.color}20; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="font-weight: 500;">${event.description}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${event.event_date}</div>
                            </div>
                            ${event.details ? `
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-600); background: var(--gray-50); padding: 0.5rem; border-radius: 6px;">
                                    ${Object.entries(event.details).filter(([k, v]) => v && k !== 'diagnosis').map(([k, v]) => 
                                        `<span style="margin-right: 1rem;"><strong>${k.replace(/_/g, ' ')}:</strong> ${Array.isArray(v) ? v.join(', ') : v}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadPrescriptionsTable(prescriptions) {
            const tbody = document.getElementById('prescriptionsTableBody');
            
            if (!prescriptions || prescriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            No prescriptions yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = prescriptions.map((rx, idx) => `
                <tr>
                    <td><strong>#${idx + 1}</strong></td>
                    <td>${rx.prescription_date || '-'}</td>
                    <td>
                        <div>${rx.doctor_name || 'Unknown'}</div>
                        <div style="font-size: 0.7rem; color: var(--gray-500);">${rx.clinic_name || ''}</div>
                    </td>
                    <td>${rx.diagnosis?.join(', ') || '-'}</td>
                    <td>
                        ${rx.medications?.map(m => `<span class="tag" style="margin: 0.125rem;">${m.name || m}</span>`).join('') || '-'}
                    </td>
                    <td style="font-size: 0.75rem; color: var(--gray-500);">${rx.file_name || '-'}</td>
                </tr>
            `).join('');
        }

        function refreshPatientDetail() {
            if (currentPatientId) {
                loadPatientDetail(currentPatientId);
            }
        }

        // ==================== Enhanced Features ====================
        const API_V2_BASE = 'http://localhost:8000/api/v2';

        // ==================== Drug Normalization Functions ====================
        
        async function normalizeSingleDrug() {
            const drugName = document.getElementById('normalizeDrugInput').value.trim();
            if (!drugName) {
                alert('Please enter a drug name');
                return;
            }

            const resultDiv = document.getElementById('normalizeResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Looking up drug...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/normalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug_name: drugName })
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="info-block" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${data.generic_name}</h4>
                                <p style="font-size: 0.75rem; color: var(--gray-500);">
                                    ${data.is_brand_name ? `Brand name: ${data.original_name}` : 'Generic name'}
                                </p>
                            </div>
                            <span class="badge" style="background: ${data.confidence > 0.8 ? '#dcfce7' : '#fef3c7'}; color: ${data.confidence > 0.8 ? '#059669' : '#d97706'};">
                                ${Math.round(data.confidence * 100)}% confidence
                            </span>
                        </div>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Drug Class</strong>
                                <p style="font-size: 0.875rem;">${data.drug_class.replace(/_/g, ' ')}</p>
                            </div>
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Common Dosages</strong>
                                <p style="font-size: 0.875rem;">${data.common_dosages?.join(', ') || 'N/A'}</p>
                            </div>
                        </div>
                        ${data.brand_names?.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Known Brand Names</strong>
                                <p style="font-size: 0.875rem;">${data.brand_names.slice(0, 6).join(', ')}${data.brand_names.length > 6 ? '...' : ''}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Update counter
                const counter = document.getElementById('totalDrugsNormalized');
                counter.textContent = parseInt(counter.textContent) + 1;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function normalizeBatchDrugs() {
            const drugs = document.getElementById('batchNormalizeInput').value.trim();
            if (!drugs) {
                alert('Please enter drug names');
                return;
            }

            const drugList = drugs.split(',').map(d => d.trim()).filter(d => d);
            const resultDiv = document.getElementById('batchNormalizeResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Normalizing drugs...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/normalize/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug_names: drugList })
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: var(--gray-100);">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Original</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Generic Name</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Drug Class</th>
                                    <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--gray-200);">Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.drugs.map(drug => `
                                    <tr style="border-bottom: 1px solid var(--gray-100);">
                                        <td style="padding: 0.75rem;">${drug.original_name} ${drug.is_brand_name ? '<span style="color: var(--info); font-size: 0.7rem;">BRAND</span>' : ''}</td>
                                        <td style="padding: 0.75rem; font-weight: 500;">${drug.generic_name}</td>
                                        <td style="padding: 0.75rem;">${drug.drug_class.replace(/_/g, ' ')}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span class="badge" style="background: ${drug.confidence > 0.8 ? '#dcfce7' : '#fef3c7'}; color: ${drug.confidence > 0.8 ? '#059669' : '#d97706'};">
                                                ${Math.round(drug.confidence * 100)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkDuplicateDrugs() {
            const drugs = document.getElementById('duplicateCheckInput').value.trim();
            if (!drugs) {
                alert('Please enter medications');
                return;
            }

            const drugList = drugs.split(',').map(d => d.trim()).filter(d => d);
            const resultDiv = document.getElementById('duplicateResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking for duplicates...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/duplicates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ medications: drugList })
                });
                const data = await response.json();

                if (data.has_duplicates) {
                    resultDiv.innerHTML = data.duplicates.map(dup => `
                        <div class="alert-box warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div class="alert-content">
                                <h5>Duplicate Found: ${dup.generic_name}</h5>
                                <p><strong>Same drug under different names:</strong> ${dup.medications.join(', ')}</p>
                                <p style="color: var(--warning);">${dup.warning}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No Duplicates Found</h5>
                                <p>All medications appear to be unique drugs.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function compareDrugs() {
            const drug1 = document.getElementById('compareDrug1').value.trim();
            const drug2 = document.getElementById('compareDrug2').value.trim();
            if (!drug1 || !drug2) {
                alert('Please enter both drug names');
                return;
            }

            const resultDiv = document.getElementById('compareResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Comparing drugs...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/compare`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug1, drug2 })
                });
                const data = await response.json();

                const isSame = data.is_same_drug;
                resultDiv.innerHTML = `
                    <div class="alert-box ${isSame ? 'warning' : 'info'}">
                        <span class="alert-icon">${isSame ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                        <div class="alert-content">
                            <h5>${isSame ? 'Same Medication!' : 'Different Medications'}</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                <div>
                                    <strong>${data.drug1.original}</strong><br>
                                    Generic: ${data.drug1.generic}<br>
                                    Class: ${data.drug1.class.replace(/_/g, ' ')}
                                </div>
                                <div>
                                    <strong>${data.drug2.original}</strong><br>
                                    Generic: ${data.drug2.generic}<br>
                                    Class: ${data.drug2.class.replace(/_/g, ' ')}
                                </div>
                            </div>
                            ${isSame ? `<p style="margin-top: 0.5rem; color: var(--warning);"><strong>Warning:</strong> These are the same medication under different names!</p>` : ''}
                            ${data.same_class && !isSame ? `<p style="margin-top: 0.5rem; color: var(--info);">Note: Same therapeutic class - check for duplicate therapy.</p>` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        // ==================== Drug Safety Functions ====================

        async function runComprehensiveSafetyAnalysis() {
            const meds = document.getElementById('safetyMedications').value.trim();
            const allergies = document.getElementById('safetyAllergies').value.trim();
            const conditions = document.getElementById('safetyConditions').value.trim();

            if (!meds) {
                alert('Please enter medications');
                return;
            }

            const resultDiv = document.getElementById('comprehensiveSafetyResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Running comprehensive safety analysis...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/safety/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        patient_allergies: allergies ? allergies.split(',').map(a => a.trim()).filter(a => a) : [],
                        patient_conditions: conditions ? conditions.split(',').map(c => c.trim()).filter(c => c) : [],
                        suppress_low_value: false
                    })
                });
                const data = await response.json();

                // Risk Level Badge
                const riskColors = {
                    'MINIMAL': '#22c55e', 'LOW': '#84cc16', 'MODERATE': '#f59e0b', 
                    'HIGH': '#ef4444', 'CRITICAL': '#7c3aed'
                };
                
                let html = `
                    <div style="background: linear-gradient(135deg, ${riskColors[data.overall_risk_level]}20, ${riskColors[data.overall_risk_level]}10); 
                                border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid ${riskColors[data.overall_risk_level]};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: ${riskColors[data.overall_risk_level]}; margin-bottom: 0.25rem;">
                                    Overall Risk: ${data.overall_risk_level}
                                </h3>
                                <p style="color: var(--gray-600); font-size: 0.875rem;">
                                    ${data.interactions?.length || 0} interactions ¬∑ ${data.allergy_alerts?.length || 0} allergy alerts ¬∑ ${data.contraindications?.length || 0} contraindications
                                </p>
                            </div>
                            <div style="font-size: 2.5rem;">${data.overall_risk_level === 'CRITICAL' ? 'üö®' : data.overall_risk_level === 'HIGH' ? '‚ö†Ô∏è' : '‚úì'}</div>
                        </div>
                    </div>
                `;

                // High Priority Alerts
                if (data.high_priority_alerts?.length > 0) {
                    html += '<h4 style="margin-bottom: 0.75rem;"><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> High Priority Alerts</h4>';
                    html += data.high_priority_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.75rem;">
                            <span class="alert-icon">üö®</span>
                            <div class="alert-content">
                                <h5>${alert.type === 'interaction' ? alert.drugs.join(' + ') : alert.drug}</h5>
                                <p><strong>Severity:</strong> ${alert.severity.toUpperCase()}</p>
                                <p>${alert.description}</p>
                                <p style="color: var(--danger);"><strong>Action:</strong> ${alert.action_required}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Drug Interactions
                if (data.interactions?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-pills" style="color: #f59e0b;"></i> Drug-Drug Interactions</h4>';
                    html += data.interactions.map(int => `
                        <div class="alert-box ${int.severity === 'major' || int.severity === 'contraindicated' ? 'danger' : 'warning'}" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">${int.severity === 'contraindicated' ? 'üö´' : int.severity === 'major' ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>${int.drug1} + ${int.drug2}</h5>
                                <p>${int.description}</p>
                                ${int.management ? `<p><strong>Management:</strong> ${int.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                // Allergy Alerts
                if (data.allergy_alerts?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-allergies" style="color: #ef4444;"></i> Allergy Alerts</h4>';
                    html += data.allergy_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">üö®</span>
                            <div class="alert-content">
                                <h5>${alert.drug}</h5>
                                <p>${alert.description}</p>
                                <p><strong>Risk Type:</strong> ${alert.risk_type}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Contraindications
                if (data.contraindications?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-ban" style="color: #7c3aed;"></i> Contraindications</h4>';
                    html += data.contraindications.map(contra => `
                        <div class="alert-box ${contra.level === 'contraindicated' ? 'danger' : 'warning'}" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">${contra.level === 'contraindicated' ? 'üö´' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>${contra.drug}</h5>
                                <p>${contra.description}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Duplicate Therapies
                if (data.duplicate_therapies?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-clone" style="color: #0891b2;"></i> Duplicate Therapy</h4>';
                    html += data.duplicate_therapies.map(dup => `
                        <div class="alert-box info" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">üìã</span>
                            <div class="alert-content">
                                <h5>${dup.drugs.join(', ')}</h5>
                                <p>${dup.description}</p>
                                <p><strong>Recommendation:</strong> ${dup.recommendation}</p>
                            </div>
                        </div>
                    `).join('');
                }

                if (!data.interactions?.length && !data.allergy_alerts?.length && !data.contraindications?.length) {
                    html += `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No Safety Issues Found</h5>
                                <p>The medication combination appears safe based on available data.</p>
                            </div>
                        </div>
                    `;
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkInteractionsV2() {
            const drugs = document.getElementById('interactionDrugs').value;
            if (!drugs.trim()) {
                alert('Please enter medications');
                return;
            }

            const resultDiv = document.getElementById('interactionResults');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking interactions...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/interactions/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: drugs.split(',').map(d => d.trim()).filter(d => d)
                    })
                });
                const data = await response.json();

                if (data.interaction_count > 0) {
                    resultDiv.innerHTML = data.interactions.map(i => `
                        <div class="alert-box ${i.severity === 'major' || i.severity === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${i.severity === 'contraindicated' ? 'üö´' : i.severity === 'major' ? 'üö®' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>${i.drug1} + ${i.drug2}</h5>
                                <p><strong>Severity:</strong> <span class="badge" style="background: ${i.severity === 'contraindicated' ? '#7c3aed' : i.severity === 'major' ? '#ef4444' : '#f59e0b'}; color: white;">${i.severity.toUpperCase()}</span></p>
                                <p>${i.description}</p>
                                ${i.mechanism ? `<p><strong>Mechanism:</strong> ${i.mechanism}</p>` : ''}
                                ${i.clinical_effects ? `<p><strong>Clinical Effects:</strong> ${i.clinical_effects}</p>` : ''}
                                ${i.management ? `<p><strong>Management:</strong> ${i.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No Interactions Found</h5>
                                <p>The entered medications appear safe to use together.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkAllergyRisks() {
            const meds = document.getElementById('allergyCheckMeds').value.trim();
            const allergies = document.getElementById('allergyCheckAllergies').value.trim();

            if (!meds || !allergies) {
                alert('Please enter both medications and allergies');
                return;
            }

            const resultDiv = document.getElementById('allergyCheckResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking allergy risks...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/allergies/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        allergies: allergies.split(',').map(a => a.trim()).filter(a => a)
                    })
                });
                const data = await response.json();

                if (data.alert_count > 0) {
                    resultDiv.innerHTML = data.allergy_alerts.map(alert => `
                        <div class="alert-box danger">
                            <span class="alert-icon">üö®</span>
                            <div class="alert-content">
                                <h5>${alert.drug}</h5>
                                <p><strong>Allergen:</strong> ${alert.allergen}</p>
                                <p><strong>Risk Type:</strong> ${alert.risk_type === 'direct' ? 'Direct Match' : 'Cross-Reactivity'}</p>
                                <p>${alert.description}</p>
                                ${alert.alternatives?.length > 0 ? `<p><strong>Alternatives:</strong> ${alert.alternatives.join(', ')}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No Allergy Risks Found</h5>
                                <p>The medications appear safe based on the provided allergies.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkContraindications() {
            const meds = document.getElementById('contraMeds').value.trim();
            const conditionsSelect = document.getElementById('contraConditions');
            const conditions = Array.from(conditionsSelect.selectedOptions).map(opt => opt.value);

            if (!meds || conditions.length === 0) {
                alert('Please enter medications and select conditions');
                return;
            }

            const resultDiv = document.getElementById('contraResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking contraindications...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/contraindications/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        conditions: conditions
                    })
                });
                const data = await response.json();

                if (data.contraindication_count > 0) {
                    resultDiv.innerHTML = data.contraindications.map(contra => `
                        <div class="alert-box ${contra.level === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${contra.level === 'contraindicated' ? 'üö´' : '‚ö†Ô∏è'}</span>
                            <div class="alert-content">
                                <h5>${contra.drug}</h5>
                                <p><strong>Condition:</strong> ${contra.condition.replace(/_/g, ' ')}</p>
                                <p><strong>Level:</strong> ${contra.level.toUpperCase()}</p>
                                <p>${contra.description}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <h5>No Contraindications Found</h5>
                                <p>The medications appear safe for the selected conditions.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        // ==================== Temporal Reasoning Functions ====================

        async function analyzeMedicationChanges() {
            const prevDate = document.getElementById('prevRxDate').value;
            const currDate = document.getElementById('currRxDate').value;
            const prevMeds = document.getElementById('prevRxMeds').value.trim();
            const currMeds = document.getElementById('currRxMeds').value.trim();

            if (!prevDate || !currDate || !prevMeds || !currMeds) {
                alert('Please fill in all fields');
                return;
            }

            // Parse medications
            const parseMeds = (text) => {
                return text.split('\n').map(line => {
                    const parts = line.split(',').map(p => p.trim());
                    return {
                        medication_name: parts[0] || '',
                        dosage: parts[1] || '',
                        frequency: parts[2] || ''
                    };
                }).filter(m => m.medication_name);
            };

            const resultDiv = document.getElementById('medChangesResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Analyzing medication changes...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/temporal/medication-changes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prescriptions: [
                            { date: prevDate, medications: parseMeds(prevMeds) },
                            { date: currDate, medications: parseMeds(currMeds) }
                        ]
                    })
                });
                const data = await response.json();

                let html = `<div style="margin-bottom: 1rem;"><strong>Total Changes:</strong> ${data.total_changes}</div>`;
                
                // Started medications
                if (data.grouped_changes.started?.length > 0) {
                    html += `
                        <h5 style="color: #10b981; margin-top: 1rem;"><i class="fas fa-plus-circle"></i> Started</h5>
                        ${data.grouped_changes.started.map(c => `
                            <div class="info-block" style="border-left: 4px solid #10b981; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.new_value} - Started on ${c.change_date}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Dose changes
                if (data.grouped_changes.dose_changed?.length > 0) {
                    html += `
                        <h5 style="color: #f59e0b; margin-top: 1rem;"><i class="fas fa-edit"></i> Dose Changed</h5>
                        ${data.grouped_changes.dose_changed.map(c => `
                            <div class="info-block" style="border-left: 4px solid #f59e0b; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.old_value} ‚Üí ${c.new_value}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Frequency changes
                if (data.grouped_changes.frequency_changed?.length > 0) {
                    html += `
                        <h5 style="color: #3b82f6; margin-top: 1rem;"><i class="fas fa-clock"></i> Frequency Changed</h5>
                        ${data.grouped_changes.frequency_changed.map(c => `
                            <div class="info-block" style="border-left: 4px solid #3b82f6; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.old_value} ‚Üí ${c.new_value}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Stopped medications
                if (data.grouped_changes.stopped?.length > 0) {
                    html += `
                        <h5 style="color: #ef4444; margin-top: 1rem;"><i class="fas fa-minus-circle"></i> Stopped</h5>
                        ${data.grouped_changes.stopped.map(c => `
                            <div class="info-block" style="border-left: 4px solid #ef4444; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">Stopped on ${c.change_date}</p>
                            </div>
                        `).join('')}
                    `;
                }

                resultDiv.innerHTML = html;

                // Also load overlap analysis
                loadOverlapAnalysis(prevDate, currDate, parseMeds(prevMeds), parseMeds(currMeds));

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function loadOverlapAnalysis(prevDate, currDate, prevMeds, currMeds) {
            const resultDiv = document.getElementById('overlapAnalysisResult');

            try {
                const response = await fetch(`${API_V2_BASE}/temporal/overlaps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prescriptions: [
                            { date: prevDate, medications: prevMeds },
                            { date: currDate, medications: currMeds }
                        ]
                    })
                });
                const data = await response.json();

                if (data.overlap_count > 0) {
                    resultDiv.innerHTML = `
                        <div style="margin-bottom: 1rem;"><strong>Overlapping Medications:</strong> ${data.overlap_count} pairs</div>
                        ${data.significant_overlaps.map(o => `
                            <div class="info-block" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div>
                                    <strong>${o.medication1}</strong> + <strong>${o.medication2}</strong>
                                    <p style="font-size: 0.75rem; color: var(--gray-600);">${o.notes}</p>
                                </div>
                                <span class="badge" style="background: ${o.is_significant ? '#fef3c7' : '#dcfce7'};">
                                    ${o.duration_days} days
                                </span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                            <p>No significant overlaps detected</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading overlap analysis:', error);
            }
        }

        // Timeline Functions
        async function loadTimeline() {
            const patientId = document.getElementById('timelinePatientId').value;
            if (!patientId) {
                alert('Please enter a patient ID');
                return;
            }

            try {
                // Load Gantt data
                const ganttResponse = await fetch(`${API_V2_BASE}/temporal/patient/${patientId}/gantt`);
                const ganttData = await ganttResponse.json();
                
                // Load timeline events
                const eventsResponse = await fetch(`${API_V2_BASE}/temporal/patient/${patientId}/timeline`);
                const eventsData = await eventsResponse.json();

                document.getElementById('timelineResults').style.display = 'block';
                document.getElementById('timelineEventsCard').style.display = 'block';

                renderGanttChart(ganttData);
                renderTimelineEvents(eventsData.events);
            } catch (error) {
                alert('Error loading timeline: ' + error.message);
            }
        }

        function renderGanttChart(data) {
            const container = document.getElementById('timelineChart');
            if (!data.medications || data.medications.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-pills"></i><p>No medication timeline data</p></div>';
                return;
            }

            let html = '<div style="overflow-x: auto;">';
            data.medications.forEach(med => {
                const isActive = med.active;
                html += `
                    <div style="display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="width: 150px; font-weight: 500; font-size: 0.875rem;">${med.name}</div>
                        <div style="flex: 1; background: var(--gray-100); height: 24px; border-radius: 4px; position: relative; margin: 0 1rem;">
                            <div style="position: absolute; left: 0; height: 100%; background: ${isActive ? 'linear-gradient(135deg, #10b981, #059669)' : 'var(--gray-400)'}; border-radius: 4px; width: 80%;"></div>
                        </div>
                        <div style="width: 100px; font-size: 0.75rem; color: var(--gray-500);">
                            ${med.start || 'N/A'}
                        </div>
                        <span class="badge ${isActive ? 'badge-success' : 'badge-gray'}">${isActive ? 'Active' : 'Stopped'}</span>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderTimelineEvents(events) {
            const container = document.getElementById('timelineEvents');
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="empty-state">No timeline events</div>';
                return;
            }

            container.innerHTML = events.slice(0, 20).map(event => `
                <div style="display: flex; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100);">
                    <div style="width: 100px; font-size: 0.75rem; color: var(--gray-500);">${event.date}</div>
                    <div style="flex: 1;">
                        <span class="badge badge-info" style="margin-right: 0.5rem;">${event.type}</span>
                        <span style="font-size: 0.875rem;">${event.description}</span>
                    </div>
                </div>
            `).join('');
        }

        // Knowledge Graph Functions
        async function loadKnowledgeGraph() {
            const patientId = document.getElementById('graphPatientId').value;
            if (!patientId) {
                alert('Please enter a patient ID');
                return;
            }

            try {
                const response = await fetch(`${API_V2_BASE}/knowledge-graph/patient/${patientId}`);
                const data = await response.json();

                document.getElementById('graphResults').style.display = 'block';
                renderKnowledgeGraph(data);
                
                const statsDiv = document.getElementById('graphStats');
                statsDiv.textContent = `${data.nodes?.length || 0} nodes, ${data.edges?.length || 0} connections`;
            } catch (error) {
                alert('Error loading graph: ' + error.message);
            }
        }

        function renderKnowledgeGraph(data) {
            const container = document.getElementById('knowledgeGraphContainer');
            const nodes = data.nodes || [];
            const edges = data.edges || [];

            if (nodes.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-project-diagram"></i><p>No graph data for this patient</p></div>';
                return;
            }

            const width = container.clientWidth || 600;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 3;

            const nodePositions = {};
            nodes.forEach((node, i) => {
                const angle = (2 * Math.PI * i) / nodes.length;
                nodePositions[node.id] = {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });

            const colors = {
                'patient': '#3b82f6',
                'medication': '#10b981',
                'condition': '#f59e0b',
                'symptom': '#ef4444',
                'doctor': '#8b5cf6'
            };

            let svg = `<svg width="${width}" height="${height}" style="background: var(--gray-50);">`;
            
            // Draw edges
            edges.forEach(edge => {
                const from = nodePositions[edge.from_node_id];
                const to = nodePositions[edge.to_node_id];
                if (from && to) {
                    svg += `<line x1="${from.x}" y1="${from.y}" x2="${to.x}" y2="${to.y}" stroke="#d1d5db" stroke-width="2" stroke-opacity="0.5"/>`;
                }
            });

            // Draw nodes
            nodes.forEach(node => {
                const pos = nodePositions[node.id];
                const color = colors[node.node_type] || '#6b7280';
                svg += `
                    <g transform="translate(${pos.x}, ${pos.y})">
                        <circle r="25" fill="${color}" stroke="white" stroke-width="3"/>
                        <text y="40" text-anchor="middle" style="font-size: 11px; fill: var(--gray-700);">${node.name?.substring(0, 15) || ''}</text>
                    </g>
                `;
            });

            svg += '</svg>';
            container.innerHTML = svg;
        }

        // AI Query Functions
        async function submitAIQuery() {
            const query = document.getElementById('aiQueryInput').value;
            const patientId = document.getElementById('aiQueryPatientId').value;

            if (!query) {
                alert('Please enter a question');
                return;
            }

            document.getElementById('aiResponseCard').style.display = 'block';
            document.getElementById('queryResponse').innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Processing your question...</p></div>';

            try {
                const response = await fetch(`${API_V2_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        patient_id: patientId ? parseInt(patientId) : null
                    })
                });

                const data = await response.json();
                displayAIResponse(data);
            } catch (error) {
                document.getElementById('queryResponse').innerHTML = `
                    <div class="alert-box danger">
                        <span class="alert-icon">‚ùå</span>
                        <div class="alert-content">
                            <h5>Error</h5>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function displayAIResponse(data) {
            const confidence = Math.round((data.confidence || 0) * 100);
            const badgeClass = confidence >= 70 ? 'badge-success' : confidence >= 40 ? 'badge-warning' : 'badge-danger';
            document.getElementById('aiConfidenceBadge').className = `badge ${badgeClass}`;
            document.getElementById('aiConfidenceBadge').textContent = `${confidence}% confidence`;

            let html = `
                <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="white-space: pre-wrap; line-height: 1.6;">${data.answer || 'No answer available'}</div>
                </div>
            `;

            if (data.evidence && data.evidence.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--gray-500);">Evidence</label>
                        <ul style="margin-top: 0.5rem; padding-left: 1.25rem;">
                            ${data.evidence.map(e => `<li style="font-size: 0.875rem; margin-bottom: 0.25rem;">${JSON.stringify(e)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (data.related_queries && data.related_queries.length > 0) {
                html += `
                    <div>
                        <label style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--gray-500);">Related Questions</label>
                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${data.related_queries.map(q => `<button class="btn btn-secondary btn-sm" onclick="fillQuery('${q}')">${q}</button>`).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('queryResponse').innerHTML = html;
        }

        function fillQuery(query) {
            document.getElementById('aiQueryInput').value = query;
        }

        // Review Queue Functions
        async function refreshReviewQueue() {
            try {
                const response = await fetch(`${API_V2_BASE}/review/queue?confidence_threshold=0.7&limit=50`);
                const data = await response.json();
                
                document.getElementById('pendingReviewCount').textContent = data.count || 0;
                document.getElementById('reviewBadge').textContent = data.count || 0;
                renderReviewQueue(data.items);

                // Load corrections
                const corrResponse = await fetch(`${API_V2_BASE}/review/corrections?limit=10`);
                const corrData = await corrResponse.json();
                renderCorrections(corrData.corrections);

                // Load stats
                const statsResponse = await fetch(`${API_V2_BASE}/review/statistics`);
                const statsData = await statsResponse.json();
                document.getElementById('correctionsMade').textContent = statsData.total_corrections || 0;
            } catch (error) {
                console.error('Error loading review queue:', error);
            }
        }

        function renderReviewQueue(items) {
            const container = document.getElementById('reviewQueueList');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h4>All caught up!</h4><p>No items pending review</p></div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span class="badge badge-info">${item.entity_type}</span>
                        <span class="badge ${item.confidence > 0.5 ? 'badge-warning' : 'badge-danger'}">${Math.round(item.confidence * 100)}%</span>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.entity_value}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.75rem;">Source: "${item.source_text?.substring(0, 80) || 'N/A'}..."</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="confirmItem(${item.id})"><i class="fas fa-check"></i> Confirm</button>
                        <button class="btn btn-warning btn-sm" onclick="correctItem(${item.id})"><i class="fas fa-edit"></i> Correct</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCorrections(corrections) {
            const tbody = document.getElementById('recentCorrections');
            if (!corrections || corrections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No corrections yet</td></tr>';
                return;
            }

            tbody.innerHTML = corrections.map(c => `
                <tr>
                    <td><span class="badge badge-gray">${c.type || 'N/A'}</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.original || '-'}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.corrected || '-'}</td>
                    <td>${c.by || '-'}</td>
                    <td>${c.at ? new Date(c.at).toLocaleDateString() : '-'}</td>
                    <td><span class="badge ${c.verified ? 'badge-success' : 'badge-warning'}">${c.verified ? 'Verified' : 'Pending'}</span></td>
                </tr>
            `).join('');
        }

        async function confirmItem(id) {
            alert('Item confirmed! (API integration ready)');
            refreshReviewQueue();
        }

        async function correctItem(id) {
            const newValue = prompt('Enter the correct value:');
            if (newValue) {
                alert('Correction submitted! (API integration ready)');
                refreshReviewQueue();
            }
        }

        // Audit Functions
        async function refreshAuditTrail() {
            try {
                const action = document.getElementById('auditActionFilter').value;
                const params = action ? `?action=${action}&limit=50` : '?limit=50';
                
                const response = await fetch(`${API_V2_BASE}/audit/trail${params}`);
                const data = await response.json();
                renderAuditTrail(data.logs);

                // Load compliance report
                const compResponse = await fetch(`${API_V2_BASE}/compliance/report`);
                const compData = await compResponse.json();
                renderComplianceReport(compData);

                document.getElementById('totalAuditEvents').textContent = compData.total_events || 0;
                document.getElementById('totalUsers').textContent = Object.keys(compData.events_by_user || {}).length;
                document.getElementById('totalCorrections').textContent = compData.corrections_count || 0;
            } catch (error) {
                console.error('Error loading audit trail:', error);
            }
        }

        function filterAuditTrail() {
            refreshAuditTrail();
        }

        function renderAuditTrail(logs) {
            const container = document.getElementById('auditTrailList');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="empty-state">No audit records found</div>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Entity</th>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td style="font-size: 0.75rem;">${log.timestamp ? new Date(log.timestamp).toLocaleString() : '-'}</td>
                                <td><span class="badge badge-info">${log.action || '-'}</span></td>
                                <td>${log.entity_type || '-'} ${log.entity_id ? '#' + log.entity_id : ''}</td>
                                <td>${log.user || 'system'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderComplianceReport(report) {
            const container = document.getElementById('complianceReport');
            if (!report) {
                container.innerHTML = '<div class="empty-state">No compliance data</div>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">Events by Action</div>
                    ${Object.entries(report.events_by_action || {}).map(([action, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                            <span>${action}</span>
                            <span class="badge badge-gray">${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function exportAuditTrail() {
            try {
                const response = await fetch(`${API_V2_BASE}/compliance/export`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting audit trail: ' + error.message);
            }
        }

        function generateComplianceReport() {
            alert('Compliance report generated! (PDF export coming soon)');
        }

        // Page navigation update
        const enhancedTitles = {
            'timeline': 'Patient Timeline',
            'knowledge-graph': 'Knowledge Graph',
            'ask-ai': 'Ask AI',
            'review-queue': 'Review Queue',
            'audit': 'Audit & Compliance'
        };

        const originalNavigateTo = navigateTo;
        navigateTo = function(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'history': 'Prescription History',
                'interactions': 'Drug Interaction Checker',
                'allergies': 'Allergy Database',
                'analytics': 'Analytics & Reports',
                'settings': 'Settings',
                ...enhancedTitles
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            // Load data for enhanced pages
            if (page === 'review-queue') refreshReviewQueue();
            if (page === 'audit') refreshAuditTrail();
        };
    </script>
</body>
</html>

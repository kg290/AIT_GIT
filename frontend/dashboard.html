<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Gateway 2.0 | Hospital Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Vis.js for Interactive Knowledge Graph -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #059669;
            --success-light: #10b981;
            --warning: #d97706;
            --warning-light: #f59e0b;
            --danger: #dc2626;
            --danger-light: #ef4444;
            --info: #0891b2;
            --info-light: #06b6d4;
            --purple: #7c3aed;
            --pink: #ec4899;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --sidebar-width: 280px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); }
            50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.8); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            color: var(--gray-900);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            animation: slideInLeft 0.5s ease-out;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse 3s ease-in-out infinite;
        }

        .logo h1 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .logo p {
            font-size: 0.7rem;
            color: var(--gray-400);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 0.35rem;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.25s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            transform: translateX(5px);
        }

        .nav-item:hover::before {
            transform: scaleY(1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(to right, white, rgba(249, 250, 251, 0.95));
            border-bottom: 1px solid var(--gray-200);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gray-900), var(--gray-700));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 0.65rem 1.25rem;
            width: 320px;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .search-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            padding-left: 0.5rem;
            font-size: 0.875rem;
        }

        .search-box input:focus {
            outline: none;
        }

        .notification-btn, .profile-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-sm);
        }

        .notification-btn:hover, .profile-btn:hover {
            background: var(--gray-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Page Content */
        .page-content {
            padding: 1.5rem 2rem;
        }

        /* Page sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: none;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35rem;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon.blue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: var(--primary); }
        .stat-icon.green { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: var(--success); }
        .stat-icon.yellow { background: linear-gradient(135deg, #fef3c7, #fde68a); color: var(--warning); }
        .stat-icon.red { background: linear-gradient(135deg, #fee2e2, #fecaca); color: var(--danger); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            border: none;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, rgba(249, 250, 251, 0.8), white);
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-body.no-padding {
            padding: 0;
        }

        /* Upload Section */
        .upload-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .upload-zone:hover::before {
            left: 100%;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
            transform: scale(1.01);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .upload-zone.processing {
            pointer-events: none;
            opacity: 0.7;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .upload-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-zone h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        #fileInput {
            display: none;
        }

        .upload-settings {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label i {
            color: var(--primary);
            font-size: 0.8rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:hover {
            border-color: var(--gray-300);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .form-select:hover {
            border-color: var(--gray-300);
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 0.85rem 1.5rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Status */
        .status-box {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }

        .status-box.show {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-box.processing {
            background: #eff6ff;
            color: var(--primary);
            border: 1px solid #bfdbfe;
        }

        .status-box.success {
            background: #ecfdf5;
            color: var(--success);
            border: 1px solid #a7f3d0;
        }

        .status-box.error {
            background: #fef2f2;
            color: var(--danger);
            border: 1px solid #fecaca;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 1.5rem;
        }

        .results-container.show {
            display: block;
        }

        /* Alert Boxes */
        .alert-box {
            padding: 1.25rem;
            border-radius: 14px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            animation: fadeInUp 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .alert-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .alert-box.warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border: none;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
        }

        .alert-box.warning::before {
            background: linear-gradient(180deg, #f59e0b, #d97706);
        }

        .alert-box.danger {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .alert-box.danger::before {
            background: linear-gradient(180deg, #ef4444, #dc2626);
        }

        .alert-box.info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: none;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .alert-box.info::before {
            background: linear-gradient(180deg, #0ea5e9, #0284c7);
        }

        .alert-box.success {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: none;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
        }

        .alert-box.success::before {
            background: linear-gradient(180deg, #22c55e, #16a34a);
        }

        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
        }

        .alert-content h5 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .alert-content p {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }

        /* Allergy & Condition Badges */
        .allergy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0.15rem;
        }
        
        .allergy-badge.critical {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
            border: 2px solid #ef4444;
            animation: pulse 2s infinite;
        }
        
        .allergy-badge.high {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            color: #ea580c;
            border: 1px solid #f97316;
        }
        
        .allergy-badge.standard {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.15rem;
        }
        
        .condition-badge.high-impact {
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            color: #7c3aed;
            border: 1px solid #a78bfa;
        }
        
        .condition-badge.standard {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        
        /* Drug Safety Alert Popup */
        .drug-safety-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .safety-alert-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .safety-alert-card.critical {
            border-left: 5px solid #dc2626;
        }
        
        .safety-alert-card.high {
            border-left: 5px solid #f97316;
        }
        
        .safety-alert-card.moderate {
            border-left: 5px solid #eab308;
        }
        
        .safety-alert-header {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
        }
        
        .safety-alert-header.critical {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
        }
        
        .safety-alert-header.high {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            color: #ea580c;
        }
        
        .safety-alert-header.moderate {
            background: linear-gradient(135deg, #fefce8, #fef9c3);
            color: #ca8a04;
        }
        
        .safety-alert-body {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .safety-alert-action {
            padding: 0.5rem 1rem;
            background: var(--gray-50);
            font-size: 0.8rem;
            color: var(--gray-600);
            border-top: 1px solid var(--gray-100);
        }

        /* Prescription Details */
        .prescription-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-block {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 1rem;
        }

        .info-block h4 {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .info-item label {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: block;
        }

        .info-item span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .info-item span.missing {
            color: var(--gray-400);
            font-style: italic;
        }

        /* Medications Table */
        .med-table {
            width: 100%;
            border-collapse: collapse;
        }

        .med-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .med-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .med-table tr:last-child td {
            border-bottom: none;
        }

        .med-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .med-form {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .med-dosage {
            font-weight: 500;
            color: var(--primary);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .badge-success { 
            background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
            color: #166534;
            box-shadow: 0 2px 4px rgba(22, 101, 52, 0.1);
        }
        .badge-warning { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #92400e;
            box-shadow: 0 2px 4px rgba(146, 64, 14, 0.1);
        }
        .badge-danger { 
            background: linear-gradient(135deg, #fee2e2, #fecaca); 
            color: #991b1b;
            box-shadow: 0 2px 4px rgba(153, 27, 27, 0.1);
        }
        .badge-info { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.1);
        }
        .badge-gray { 
            background: linear-gradient(135deg, var(--gray-200), var(--gray-100)); 
            color: var(--gray-700);
        }
        .badge-purple {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            box-shadow: 0 2px 4px rgba(91, 33, 182, 0.1);
        }

        /* Confidence Meter */
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .confidence-bar {
            flex: 1;
            height: 10px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .confidence-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .confidence-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .confidence-fill.high { 
            background: linear-gradient(90deg, #10b981, #059669); 
        }
        .confidence-fill.medium { 
            background: linear-gradient(90deg, #f59e0b, #d97706); 
        }
        .confidence-fill.low { 
            background: linear-gradient(90deg, #ef4444, #dc2626); 
        }

        .confidence-text {
            font-size: 1rem;
            font-weight: 700;
            min-width: 55px;
            text-align: right;
            
            text-align: right;
        }

        /* Tags */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--gray-100);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--gray-700);
        }

        /* Vitals Grid */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .vital-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .vital-item label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            display: block;
            margin-bottom: 0.25rem;
        }

        .vital-item span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Review Banner */
        .review-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 10px;
            padding: 0.875rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .review-banner.hidden {
            display: none;
        }

        .review-banner i {
            color: var(--warning);
        }

        .review-banner span {
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Raw Text */
        .raw-text-box {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header i {
            transition: transform 0.2s;
        }

        .collapsible-header.active i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .collapsible-content.show {
            max-height: 500px;
        }

        /* Recent Prescriptions Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        /* Patient List */
        .patient-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .patient-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .patient-info {
            display: flex;
            flex-direction: column;
        }

        .patient-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .patient-id {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Empty State */
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-300);
        }

        .empty-state h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        /* Chart placeholder */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
            border-radius: 8px;
            color: var(--gray-400);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Print styles */
        @media print {
            .sidebar, .header {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
            .results-container {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">ðŸ’Š</div>
            <div>
                <h1 style="font-size: 1.2rem; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MedAI Gateway</h1>
                <p style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 2px;">Hospital Edition v2.0</p>
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="patients">
                    <i class="fas fa-users"></i>
                    <span>Patients</span>
                </a>
                <a class="nav-item" data-page="history">
                    <i class="fas fa-history"></i>
                    <span>Prescription History</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Drug Tools</div>
                <a class="nav-item" data-page="drug-normalize">
                    <i class="fas fa-pills"></i>
                    <span>Drug Normalization</span>
                </a>
                <a class="nav-item" data-page="interactions">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Safety Analysis</span>
                    <span class="nav-badge" id="alertBadge">0</span>
                </a>
                <a class="nav-item" data-page="allergies">
                    <i class="fas fa-allergies"></i>
                    <span>Allergy Checker</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Temporal</div>
                <a class="nav-item" data-page="timeline">
                    <i class="fas fa-stream"></i>
                    <span>Medication Timeline</span>
                </a>
                <a class="nav-item" data-page="med-changes">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Medication Changes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a class="nav-item" data-page="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Reports</span>
                </a>
                <a class="nav-item" data-page="knowledge-graph">
                    <i class="fas fa-project-diagram"></i>
                    <span>Knowledge Graph</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clinical Intelligence</div>
                <a class="nav-item" data-page="clinical-decision">
                    <i class="fas fa-brain"></i>
                    <span>Clinical Decision Support</span>
                </a>
                <a class="nav-item" data-page="treatment-outcomes">
                    <i class="fas fa-heartbeat"></i>
                    <span>Treatment Outcomes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Advanced</div>
                <a class="nav-item" data-page="ask-ai">
                    <i class="fas fa-robot"></i>
                    <span>Ask AI</span>
                </a>
                <a class="nav-item" data-page="review-queue">
                    <i class="fas fa-tasks"></i>
                    <span>Review Queue</span>
                    <span class="nav-badge" id="reviewBadge">0</span>
                </a>
                <a class="nav-item" data-page="audit">
                    <i class="fas fa-shield-alt"></i>
                    <span>Audit & Compliance</span>
                </a>
                <a class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--gray-700);">
            <div class="nav-item">
                <i class="fas fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h2 class="page-title" id="pageTitle">Dashboard</h2>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--gray-400);"></i>
                    <input type="text" placeholder="Search patients, prescriptions...">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-dot"></span>
                </button>
                <button class="profile-btn">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Dashboard Page -->
            <section class="page-section active" id="page-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalScans">0</div>
                                <div class="stat-label">Total Scans Today</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 12% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalMeds">0</div>
                                <div class="stat-label">Medications Processed</div>
                            </div>
                            <div class="stat-icon green">
                                <i class="fas fa-pills"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 8% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="alertsFound">0</div>
                                <div class="stat-label">Safety Alerts</div>
                            </div>
                            <div class="stat-icon yellow">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-change down">
                            <i class="fas fa-arrow-down"></i> 5% from yesterday
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="avgConfidence">-</div>
                                <div class="stat-label">Avg Confidence</div>
                            </div>
                            <div class="stat-icon red">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-change up">
                            <i class="fas fa-arrow-up"></i> 3% from yesterday
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Prescriptions</span>
                            <button class="btn btn-sm btn-secondary" onclick="navigateTo('history')">View All</button>
                        </div>
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Medications</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recentPrescriptions">
                                    <tr>
                                        <td colspan="5" class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>No prescriptions yet. Upload your first prescription!</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Quick Actions</span>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" style="width: 100%; justify-content: center; margin-bottom: 0.75rem;" onclick="navigateTo('scan')">
                                <i class="fas fa-camera"></i> Scan New Prescription
                            </button>
                            <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="openTextInput()">
                                <i class="fas fa-keyboard"></i> Manual Text Entry
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scan Page -->
            <section class="page-section" id="page-scan">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-camera" style="margin-right: 0.5rem;"></i>Scan Prescription</span>
                    </div>
                    <div class="card-body">
                        <div class="upload-area">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Drop prescription here</h3>
                                <p>or click to browse files</p>
                                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                                    Supports: PDF, PNG, JPG, JPEG, TIFF
                                </p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp,.webp">

                            <div class="upload-settings">
                                <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;">
                                    <i class="fas fa-sliders-h" style="margin-right: 0.5rem;"></i>Processing Settings
                                </h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Patient Name (optional)</label>
                                    <input type="text" class="form-input" id="patientNameInput" placeholder="Enter patient name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Known Allergies</label>
                                    <input type="text" class="form-input" id="allergiesInput" placeholder="e.g., Penicillin, Sulfa, Aspirin">
                                    <small style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; display: block;">
                                        Comma-separated list of known allergies
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Processing Mode</label>
                                    <select class="form-select" id="processingMode">
                                        <option value="auto">Auto (AI + Fallback)</option>
                                        <option value="ai">AI Only (Gemini)</option>
                                        <option value="regex">Pattern Matching Only</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary" style="width: 100%; justify-content: center;" id="processBtn" disabled>
                                    <i class="fas fa-magic"></i> Process Prescription
                                </button>
                            </div>
                        </div>

                        <div class="status-box" id="statusBox">
                            <span class="spinner"></span>
                            <span id="statusText">Processing...</span>
                        </div>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer">
                    <!-- Review Banner -->
                    <div class="review-banner hidden" id="reviewBanner">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="reviewReason">Manual review recommended</span>
                    </div>

                    <!-- Safety Alerts -->
                    <div id="alertsContainer"></div>

                    <!-- Prescription Details -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-file-medical" style="margin-right: 0.5rem;"></i>Prescription Details</span>
                            <span class="badge badge-info" id="prescriptionDate">-</span>
                        </div>
                        <div class="card-body">
                            <div class="prescription-grid">
                                <div class="info-block">
                                    <h4><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Patient Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Name</label>
                                            <span id="resultPatientName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Age / Gender</label>
                                            <span id="resultAgeGender" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Patient ID</label>
                                            <span id="resultPatientId" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Phone</label>
                                            <span id="resultPatientPhone" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item" style="grid-column: span 2;">
                                            <label>Address</label>
                                            <span id="resultPatientAddress" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="info-block">
                                    <h4><i class="fas fa-user-md" style="margin-right: 0.5rem;"></i>Doctor Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <label>Doctor</label>
                                            <span id="resultDoctorName" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Qualification</label>
                                            <span id="resultDoctorQual" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Clinic</label>
                                            <span id="resultClinic" class="missing">Not found</span>
                                        </div>
                                        <div class="info-item">
                                            <label>Reg. No</label>
                                            <span id="resultDoctorRegNo" class="missing">Not found</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Diagnosis -->
                            <div style="margin-top: 1rem;" id="diagnosisSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-stethoscope" style="margin-right: 0.5rem;"></i>Diagnosis
                                </label>
                                <div class="tag-list" id="diagnosisList"></div>
                            </div>

                            <!-- Vitals -->
                            <div style="margin-top: 1rem;" id="vitalsSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem;"></i>Vitals
                                </label>
                                <div class="vitals-grid" id="vitalsGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medications</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="badge badge-info" id="medBadge">0 items</span>
                                <div class="confidence-meter" style="width: 150px;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" id="confidenceFill" style="width: 0;"></div>
                                    </div>
                                    <span class="confidence-text" id="confidenceText">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body no-padding">
                            <table class="med-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Medication</th>
                                        <th style="width: 12%;">Dosage</th>
                                        <th style="width: 18%;">Frequency</th>
                                        <th style="width: 12%;">Duration</th>
                                        <th style="width: 18%;">Instructions</th>
                                        <th style="width: 15%;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="medicationsList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Advice & Follow-up -->
                    <div class="card" id="adviceCard">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-clipboard-list" style="margin-right: 0.5rem;"></i>Advice & Follow-up</span>
                        </div>
                        <div class="card-body">
                            <div id="adviceSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Advice</label>
                                <div class="tag-list" id="adviceList"></div>
                            </div>
                            <div id="followUpSection">
                                <label style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">Follow-up</label>
                                <span id="followUpDate" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Raw OCR Text -->
                    <div class="card">
                        <div class="card-header collapsible-header" id="rawOcrHeader">
                            <span class="card-title"><i class="fas fa-code" style="margin-right: 0.5rem;"></i>Raw OCR Text</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="collapsible-content" id="rawOcrContent">
                            <div class="card-body">
                                <pre class="raw-text-box" id="rawText"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-secondary" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy Summary
                            </button>
                            <button class="btn btn-secondary" onclick="exportJSON()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                            <button class="btn btn-success" onclick="savePrescription()">
                                <i class="fas fa-save"></i> Save to Database
                            </button>
                            <button class="btn btn-secondary" style="margin-left: auto;" onclick="resetScan()">
                                <i class="fas fa-redo"></i> New Scan
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patients Page -->
            <section class="page-section" id="page-patients">
                <!-- Patient Selection / Creation -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" onclick="refreshPatientList()" style="cursor: pointer;">
                        <div class="stat-icon blue" style="margin-bottom: 0.5rem;"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="totalPatientsCount">0</div>
                        <div class="stat-label">Total Patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green" style="margin-bottom: 0.5rem;"><i class="fas fa-file-medical"></i></div>
                        <div class="stat-value" id="totalPrescriptionsCount">0</div>
                        <div class="stat-label">Total Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow" style="margin-bottom: 0.5rem;"><i class="fas fa-pills"></i></div>
                        <div class="stat-value" id="activeMedicationsCount">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red" style="margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="activeAlertsCount">0</div>
                        <div class="stat-label">Active Alerts</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 400px 1fr; gap: 1.5rem;">
                    <!-- Left Panel: QR Scan & Patient Lookup -->
                    <div>
                        <!-- Doctor QR Scan Card -->
                        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white;">
                            <div class="card-body" style="padding: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        ðŸ“±
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-weight: 600;">Scan Patient QR</h3>
                                        <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Upload QR code image to view patient</p>
                                    </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px dashed rgba(255,255,255,0.4); transition: all 0.3s;" id="doctorQrDropZone">
                                    <i class="fas fa-qrcode" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 500;">Drop QR Image Here</p>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">or click to browse</p>
                                    <input type="file" id="doctorQrFileInput" accept=".png,.jpg,.jpeg,.bmp,.gif,.webp" style="display: none;">
                                </div>
                            </div>
                        </div>

                        <!-- Manual UID Entry -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-keyboard"></i> Manual Lookup</span>
                            </div>
                            <div class="card-body">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label">Patient UID</label>
                                    <input type="text" class="form-input" id="doctorPatientUidInput" placeholder="e.g., PT20260130-A1B2">
                                </div>
                                <button class="btn btn-primary" style="width: 100%;" onclick="doctorLookupPatient()">
                                    <i class="fas fa-search"></i> Find Patient
                                </button>
                            </div>
                        </div>

                        <!-- Existing Patients List -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-list"></i> Recent Patients</span>
                                <button class="btn btn-sm" onclick="refreshPatientList()"><i class="fas fa-sync"></i></button>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 0;">
                                <div id="existingPatientsList">
                                    <div class="empty-state" style="padding: 2rem;">
                                        <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                                        <p style="margin-top: 0.5rem;">No patients yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Portal Link -->
                        <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                            <div class="card-body" style="text-align: center; padding: 1.25rem;">
                                <i class="fas fa-user-plus" style="font-size: 1.5rem; color: #0284c7; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0 0 0.75rem 0; color: #0369a1; font-weight: 500;">Need to register a new patient?</p>
                                <a href="/staff" target="_blank" class="btn" style="background: #0284c7; color: white; width: 100%;">
                                    <i class="fas fa-external-link-alt"></i> Open Staff Portal
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Patient Details View -->
                    <div>
                        <!-- Patient Not Found / Initial State -->
                        <div id="patientNotFoundState">
                            <div class="card">
                                <div class="card-body" style="text-align: center; padding: 4rem 2rem;">
                                    <i class="fas fa-user-md" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--gray-500); margin-bottom: 0.5rem;">Scan Patient QR Code</h3>
                                    <p style="color: var(--gray-400);">Upload a patient QR code image or enter their UID to view prescription details</p>
                                </div>
                            </div>
                        </div>

                        <!-- Patient Found - Details View -->
                        <div id="patientFoundState" style="display: none;">
                            <!-- Patient Header Card -->
                            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                                <div class="card-body" style="padding: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                                                ðŸ‘¤
                                            </div>
                                            <div>
                                                <h2 id="viewPatientName" style="margin: 0; font-size: 1.5rem;">Patient Name</h2>
                                                <p id="viewPatientUid" style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">
                                                    <span id="viewPatientAge"></span>
                                                    <span id="viewPatientGender"></span>
                                                    <span id="viewPatientBlood"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="clearPatientView()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewTotalPrescriptions">0</div>
                                            <div class="stat-label">Prescriptions</div>
                                        </div>
                                        <div class="stat-icon blue"><i class="fas fa-file-prescription"></i></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewActiveMeds">0</div>
                                            <div class="stat-label">Active Medications</div>
                                        </div>
                                        <div class="stat-icon green"><i class="fas fa-pills"></i></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <div>
                                            <div class="stat-value" id="viewLastVisit">-</div>
                                            <div class="stat-label">Last Visit</div>
                                        </div>
                                        <div class="stat-icon purple"><i class="fas fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Allergies & Conditions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="card">
                                    <div class="card-header" style="background: #fef2f2;">
                                        <span class="card-title" style="color: #dc2626;"><i class="fas fa-allergies"></i> Allergies</span>
                                    </div>
                                    <div class="card-body" id="viewAllergies">
                                        <span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header" style="background: #fef3c7;">
                                        <span class="card-title" style="color: #d97706;"><i class="fas fa-notes-medical"></i> Conditions</span>
                                    </div>
                                    <div class="card-body" id="viewConditions">
                                        <span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Active Medications -->
                            <div class="card" style="margin-top: 1rem;">
                                <div class="card-header">
                                    <span class="card-title"><i class="fas fa-pills"></i> Active Medications</span>
                                </div>
                                <div class="card-body" id="viewActiveMedsList">
                                    <p style="color: var(--gray-500);">No active medications</p>
                                </div>
                            </div>

                            <!-- Prescription History -->
                            <div class="card" style="margin-top: 1rem;">
                                <div class="card-header">
                                    <span class="card-title"><i class="fas fa-history"></i> Prescription History</span>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="viewPrescriptionHistory">
                                    <p style="color: var(--gray-500);">No prescriptions found</p>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="loadPatientToAI()">
                                    <i class="fas fa-robot"></i> Ask AI About This Patient
                                </button>
                                <button class="btn btn-secondary" onclick="viewPatientTimeline()">
                                    <i class="fas fa-stream"></i> View Timeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Detail View (New Page) -->
            <section class="page-section" id="page-patient-detail">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <button class="btn" onclick="navigateTo('patients')">
                            <i class="fas fa-arrow-left"></i> Back to Patients
                        </button>
                    </div>
                    <div id="patientDetailHeader">
                        <h2 id="patientDetailName">Patient Name</h2>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="refreshPatientDetail()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Patient Info Cards -->
                <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value" id="detailPrescriptionCount">0</div>
                        <div class="stat-label">Prescriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailActiveMeds">0</div>
                        <div class="stat-label">Active Medications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailDiscontinuedMeds">0</div>
                        <div class="stat-label">Discontinued</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detailTimelineEvents">0</div>
                        <div class="stat-label">Timeline Events</div>
                    </div>
                    <div class="stat-card" id="detailRiskCard">
                        <div class="stat-value" id="detailRiskLevel">-</div>
                        <div class="stat-label">Risk Level</div>
                    </div>
                </div>

                <!-- Safety Alerts -->
                <div class="card" id="safetyAlertsCard" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <span class="card-title" style="color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Active Safety Alerts</span>
                    </div>
                    <div class="card-body" id="safetyAlertsContainer"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <!-- Current Medications -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-pills"></i> Current Medications</span>
                        </div>
                        <div class="card-body" id="currentMedicationsContainer">
                            <div class="empty-state">
                                <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                                <p>No active medications</p>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-user"></i> Patient Information</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Patient ID</label>
                                    <p id="detailPatientId" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Age / Gender</label>
                                    <p id="detailAgeGender" style="font-weight: 500;">-</p>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--gray-500);">Blood Group</label>
                                    <p id="detailBloodGroup" style="font-weight: 600; color: #dc2626;">-</p>
                                </div>
                            </div>
                            
                            <!-- Critical Allergies Section -->
                            <div id="allergiesSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.75rem; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i> Known Allergies
                                </label>
                                <div id="detailAllergiesContainer">
                                    <span style="color: var(--gray-400); font-size: 0.875rem;">None recorded</span>
                                </div>
                            </div>
                            
                            <!-- Chronic Conditions Section -->
                            <div id="conditionsSection" style="margin-bottom: 1rem;">
                                <label style="font-size: 0.75rem; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-heart" style="color: #7c3aed;"></i> Chronic Conditions
                                </label>
                                <div id="detailConditionsContainer">
                                    <span style="color: var(--gray-400); font-size: 0.875rem;">None recorded</span>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.75rem; color: var(--gray-500);">Treating Doctors</label>
                                <p id="detailDoctors" style="font-weight: 500;">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Timeline -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream"></i> Complete Medical Timeline</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="timelineFilter" style="width: auto;" onchange="filterTimeline()">
                                <option value="">All Events</option>
                                <option value="prescription_added">Prescriptions</option>
                                <option value="medication_started">New Medications</option>
                                <option value="medication_stopped">Discontinued</option>
                                <option value="medication_changed">Dose Changes</option>
                                <option value="safety_alert">Safety Alerts</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="timelineContainer">
                        <div class="empty-state">
                            <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No timeline events yet</p>
                        </div>
                    </div>
                </div>

                <!-- Prescriptions List -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-file-medical"></i> All Prescriptions</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Doctor</th>
                                    <th>Diagnosis</th>
                                    <th>Medications</th>
                                    <th>File</th>
                                </tr>
                            </thead>
                            <tbody id="prescriptionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                        No prescriptions yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- History Page -->
            <section class="page-section" id="page-history">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Prescription History</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="date" class="form-input" style="width: auto;">
                            <select class="form-select" style="width: auto;">
                                <option>All Status</option>
                                <option>Completed</option>
                                <option>Needs Review</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Document ID</th>
                                    <th>Patient</th>
                                    <th>Date</th>
                                    <th>Medications</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyList">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <i class="fas fa-file-medical-alt"></i>
                                            <h4>No prescription history</h4>
                                            <p>Processed prescriptions will appear here</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Drug Normalization Page -->
            <section class="page-section" id="page-drug-normalize">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugsNormalized">0</div>
                                <div class="stat-label">Drugs Normalized</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-pills"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalBrandNames">50+</div>
                                <div class="stat-label">Brand Names in Database</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-database"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalDrugClasses">15+</div>
                                <div class="stat-label">Drug Classes</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-layer-group"></i></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Single Drug Normalization -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-search" style="margin-right: 0.5rem;"></i>Drug Lookup</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Enter drug name (brand or generic)</label>
                                <input type="text" class="form-input" id="normalizeDrugInput" placeholder="e.g., Tylenol, Advil, Lipitor">
                            </div>
                            <button class="btn btn-primary" onclick="normalizeSingleDrug()">
                                <i class="fas fa-exchange-alt"></i> Normalize
                            </button>
                            <div id="normalizeResult" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>

                    <!-- Batch Normalization -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-list" style="margin-right: 0.5rem;"></i>Batch Normalization</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Enter multiple drugs (comma-separated)</label>
                                <input type="text" class="form-input" id="batchNormalizeInput" placeholder="e.g., Tylenol, Advil, Zantac, Lipitor">
                            </div>
                            <button class="btn btn-primary" onclick="normalizeBatchDrugs()">
                                <i class="fas fa-layer-group"></i> Normalize All
                            </button>
                            <div id="batchNormalizeResult" style="margin-top: 1.5rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Detection -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-clone" style="margin-right: 0.5rem;"></i>Duplicate Detection</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Check if a medication list contains the same drug under different names (brand vs generic).
                        </p>
                        <div class="form-group">
                            <label class="form-label">Enter medications to check</label>
                            <input type="text" class="form-input" id="duplicateCheckInput" placeholder="e.g., Tylenol, Paracetamol, Crocin, Advil">
                        </div>
                        <button class="btn btn-warning" onclick="checkDuplicateDrugs()">
                            <i class="fas fa-search"></i> Check for Duplicates
                        </button>
                        <div id="duplicateResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Drug Comparison -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-balance-scale" style="margin-right: 0.5rem;"></i>Drug Comparison</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 1</label>
                                <input type="text" class="form-input" id="compareDrug1" placeholder="e.g., Tylenol">
                            </div>
                            <div style="padding-bottom: 0.5rem;">
                                <i class="fas fa-exchange-alt" style="color: var(--gray-400);"></i>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Drug 2</label>
                                <input type="text" class="form-input" id="compareDrug2" placeholder="e.g., Crocin">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="compareDrugs()">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                        <div id="compareResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </section>

            <!-- Drug Safety Analysis Page -->
            <section class="page-section" id="page-interactions">
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card">
                        <div class="stat-icon blue" style="margin-bottom: 0.5rem;"><i class="fas fa-pills"></i></div>
                        <div class="stat-value">30+</div>
                        <div class="stat-label">Drug Interaction Pairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green" style="margin-bottom: 0.5rem;"><i class="fas fa-layer-group"></i></div>
                        <div class="stat-value">7</div>
                        <div class="stat-label">Class-Level Interactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow" style="margin-bottom: 0.5rem;"><i class="fas fa-allergies"></i></div>
                        <div class="stat-value">4</div>
                        <div class="stat-label">Allergy Cross-Reactivity</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red" style="margin-bottom: 0.5rem;"><i class="fas fa-ban"></i></div>
                        <div class="stat-value">6</div>
                        <div class="stat-label">Contraindication Groups</div>
                    </div>
                </div>

                <!-- Comprehensive Safety Analysis -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>Comprehensive Drug Safety Analysis</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications (comma-separated)</label>
                                <input type="text" class="form-input" id="safetyMedications" placeholder="e.g., Warfarin, Aspirin, Ibuprofen">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Allergies (optional)</label>
                                <input type="text" class="form-input" id="safetyAllergies" placeholder="e.g., Penicillin, Sulfa">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Conditions (optional)</label>
                                <input type="text" class="form-input" id="safetyConditions" placeholder="e.g., heart_failure, renal_impairment">
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="runComprehensiveSafetyAnalysis()">
                            <i class="fas fa-search"></i> Run Complete Safety Analysis
                        </button>
                        <div id="comprehensiveSafetyResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Quick Interaction Check -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-bolt" style="margin-right: 0.5rem;"></i>Quick Interaction Check</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Enter medications (comma-separated)</label>
                            <input type="text" class="form-input" id="interactionDrugs" placeholder="e.g., Aspirin, Warfarin, Ibuprofen">
                        </div>
                        <button class="btn btn-primary" onclick="checkInteractionsV2()">
                            <i class="fas fa-search"></i> Check Interactions
                        </button>
                        <div id="interactionResults" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Severity Reference -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>Severity Classification Guide</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div class="info-block" style="border-left: 4px solid #22c55e;">
                                <h4 style="color: #22c55e;">Minor</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Minimal clinical significance. Monitor if needed.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #f59e0b;">
                                <h4 style="color: #f59e0b;">Moderate</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    May require dosage adjustment or monitoring.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #ef4444;">
                                <h4 style="color: #ef4444;">Major</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Significant clinical consequences. Avoid or use extreme caution.
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #7c3aed;">
                                <h4 style="color: #7c3aed;">Contraindicated</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    Life-threatening. Do NOT use together.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Allergy Checker Page -->
            <section class="page-section" id="page-allergies">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-allergies" style="margin-right: 0.5rem;"></i>Medication Allergy Checker</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Check if medications are safe given patient allergies. Detects both direct matches and cross-reactivity risks.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications to check</label>
                                <input type="text" class="form-input" id="allergyCheckMeds" placeholder="e.g., Amoxicillin, Cephalexin">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Allergies</label>
                                <input type="text" class="form-input" id="allergyCheckAllergies" placeholder="e.g., Penicillin, Sulfa">
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="checkAllergyRisks()">
                            <i class="fas fa-search"></i> Check Allergy Risks
                        </button>
                        <div id="allergyCheckResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Cross-Reactivity Reference -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-book-medical" style="margin-right: 0.5rem;"></i>Common Allergy Cross-Reactivity Patterns</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="info-block" style="border-left: 4px solid #ef4444;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Penicillin Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    â€¢ Amoxicillin, Ampicillin, Piperacillin<br>
                                    â€¢ Cephalosporins (1-10% risk)
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #f59e0b;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Sulfa Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    â€¢ Sulfamethoxazole, Sulfasalazine<br>
                                    â€¢ Some diuretics, Celecoxib
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #3b82f6;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #3b82f6;"></i> NSAID/Aspirin Sensitivity</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    â€¢ Ibuprofen, Diclofenac, Naproxen<br>
                                    â€¢ Use COX-2 inhibitors with caution
                                </p>
                            </div>
                            <div class="info-block" style="border-left: 4px solid #10b981;">
                                <h4><i class="fas fa-exclamation-triangle" style="color: #10b981;"></i> Cephalosporin Allergy</h4>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">
                                    <strong>May cross-react with:</strong><br>
                                    â€¢ Cephalexin, Cefixime, Ceftriaxone<br>
                                    â€¢ Penicillins (minor risk)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contraindications Checker -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-ban" style="margin-right: 0.5rem;"></i>Contraindication Checker</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medications</label>
                                <input type="text" class="form-input" id="contraMeds" placeholder="e.g., Metformin, Ibuprofen">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Patient Conditions</label>
                                <select class="form-input" id="contraConditions" multiple style="height: 100px;">
                                    <option value="renal_impairment">Renal Impairment</option>
                                    <option value="liver_disease">Liver Disease</option>
                                    <option value="heart_failure">Heart Failure</option>
                                    <option value="asthma">Asthma</option>
                                    <option value="pregnancy">Pregnancy</option>
                                    <option value="gi_ulcer">GI Ulcer</option>
                                </select>
                                <small style="color: var(--gray-500);">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                        </div>
                        <button class="btn btn-warning" onclick="checkContraindications()">
                            <i class="fas fa-search"></i> Check Contraindications
                        </button>
                        <div id="contraResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>
            </section>

            <!-- Medication Changes Page -->
            <section class="page-section" id="page-med-changes">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-exchange-alt" style="margin-right: 0.5rem;"></i>Medication Change Tracker</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Track changes in medication regimens over time. Detects new medications, dose changes, and discontinued drugs.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <!-- Previous Prescription -->
                            <div class="info-block">
                                <h4><i class="fas fa-calendar-minus"></i> Previous Prescription</h4>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-input" id="prevRxDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Medications (one per line: name, dosage, frequency)</label>
                                    <textarea class="form-input" id="prevRxMeds" rows="4" placeholder="Amlodipine, 5mg, once daily
Metformin, 500mg, twice daily"></textarea>
                                </div>
                            </div>
                            
                            <!-- Current Prescription -->
                            <div class="info-block">
                                <h4><i class="fas fa-calendar-plus"></i> Current Prescription</h4>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-input" id="currRxDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Medications (one per line: name, dosage, frequency)</label>
                                    <textarea class="form-input" id="currRxMeds" rows="4" placeholder="Amlodipine, 10mg, once daily
Metformin, 500mg, twice daily
Aspirin, 75mg, once daily"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="analyzeMedicationChanges()">
                            <i class="fas fa-search"></i> Analyze Changes
                        </button>
                        <div id="medChangesResult" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <!-- Medication Overlap Analysis -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-layer-group" style="margin-right: 0.5rem;"></i>Medication Overlap Analysis</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            Analyze overlapping medication periods to identify concurrent therapies.
                        </p>
                        <div id="overlapAnalysisResult">
                            <div class="empty-state">
                                <i class="fas fa-calendar-alt" style="font-size: 2rem; color: var(--gray-400);"></i>
                                <p>Analyze prescriptions above to see overlap data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analytics Page -->
            <section class="page-section" id="page-analytics">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Total Prescriptions</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-file-medical"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Unique Patients</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">0</div>
                                <div class="stat-label">Interactions Found</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value">-</div>
                                <div class="stat-label">Avg OCR Accuracy</div>
                            </div>
                            <div class="stat-icon red"><i class="fas fa-chart-bar"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Processing Statistics</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <i class="fas fa-chart-area" style="font-size: 3rem;"></i>
                            <span style="margin-left: 1rem;">Charts will appear once you have processing data</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-cog" style="margin-right: 0.5rem;"></i>Settings</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">API Endpoint</label>
                            <input type="text" class="form-input" value="http://localhost:8000" id="apiEndpoint">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Processing Mode</label>
                            <select class="form-select" id="defaultMode">
                                <option value="auto">Auto (AI + Fallback)</option>
                                <option value="ai">AI Only</option>
                                <option value="regex">Pattern Matching Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="autoSave" checked> Auto-save prescriptions to database
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Clinical Decision Support Page -->
            <section class="page-section" id="page-clinical-decision">
                <!-- Header Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-value" style="color: white;">AI-Powered</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.8);">Clinical Intelligence</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-book-medical"></i></div>
                        <div class="stat-value">15+</div>
                        <div class="stat-label">Medical Guidelines</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-dna"></i></div>
                        <div class="stat-value">50+</div>
                        <div class="stat-label">Pharmacogenomic Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-lightbulb"></i></div>
                        <div class="stat-value">100+</div>
                        <div class="stat-label">Treatment Alternatives</div>
                    </div>
                </div>

                <!-- Patient Selector -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user-md" style="margin-right: 0.5rem;"></i>Select Patient for Clinical Decision Support</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="cdsPatientUid" placeholder="Enter patient UID (e.g., PT20260130-A1B2)">
                            </div>
                            <button class="btn btn-primary" onclick="loadClinicalDecisionSupport()">
                                <i class="fas fa-brain"></i> Analyze Patient
                            </button>
                        </div>
                        <div id="cdsLoadStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="cdsResultsContainer" style="display: none;">
                    <!-- Guideline Compliance Score -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-clipboard-check" style="margin-right: 0.5rem; color: #10b981;"></i>Guideline Compliance Assessment</span>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 1.5rem;">
                                <div style="text-align: center;">
                                    <div id="cdsComplianceScore" style="font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">--</div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500);">Compliance Score</div>
                                </div>
                                <div id="cdsComplianceGauge" style="flex: 1; height: 12px; background: var(--gray-200); border-radius: 6px; overflow: hidden;">
                                    <div id="cdsComplianceFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #059669); transition: width 1s ease;"></div>
                                </div>
                            </div>
                            <div id="cdsGuidelineDetails"></div>
                        </div>
                    </div>

                    <!-- Treatment Alternatives -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-exchange-alt" style="margin-right: 0.5rem; color: #3b82f6;"></i>Evidence-Based Treatment Alternatives</span>
                            <span class="badge badge-info" id="cdsAlternativesCount">0 alternatives</span>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                These are NOT "obvious" recommendations. Each alternative is backed by clinical trial data and medical guidelines, 
                                considering the patient's specific profile.
                            </p>
                            <div id="cdsAlternativesList"></div>
                        </div>
                    </div>

                    <!-- Pharmacogenomic Alerts -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-dna" style="margin-right: 0.5rem; color: #8b5cf6;"></i>Pharmacogenomic Considerations</span>
                            <span class="badge badge-purple" id="cdsPgxCount">0 alerts</span>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                Genetic factors that may affect drug response. Consider genetic testing for high-risk medications.
                            </p>
                            <div id="cdsPgxAlertsList"></div>
                        </div>
                    </div>

                    <!-- Optimization Suggestions -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-lightbulb" style="margin-right: 0.5rem; color: #f59e0b;"></i>Treatment Optimization Opportunities</span>
                        </div>
                        <div class="card-body">
                            <div id="cdsOptimizationsList"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Treatment Outcomes Page -->
            <section class="page-section" id="page-treatment-outcomes">
                <!-- Header Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div class="stat-icon" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="stat-value" style="color: white;">Track</div>
                        <div class="stat-label" style="color: rgba(255,255,255,0.8);">Treatment Outcomes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value">Vitals</div>
                        <div class="stat-label">Trend Analysis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-robot"></i></div>
                        <div class="stat-value">ML</div>
                        <div class="stat-label">Success Prediction</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow"><i class="fas fa-link"></i></div>
                        <div class="stat-value">Link</div>
                        <div class="stat-label">Rx to Outcomes</div>
                    </div>
                </div>

                <!-- Patient Selector -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Patient Outcome Tracking</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="outcomePatientUid" placeholder="Enter patient UID">
                            </div>
                            <button class="btn btn-primary" onclick="loadOutcomeReport()">
                                <i class="fas fa-chart-line"></i> Load Outcomes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Record Outcome Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: #10b981;"></i>Record Treatment Outcome</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Medication</label>
                                <input type="text" class="form-input" id="outcomeRecordMed" placeholder="e.g., Amlodipine">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Outcome Type</label>
                                <select class="form-select" id="outcomeRecordType">
                                    <option value="improved">âœ… Improved</option>
                                    <option value="resolved">ðŸŽ‰ Resolved</option>
                                    <option value="stable">âž¡ï¸ Stable</option>
                                    <option value="worsened">âš ï¸ Worsened</option>
                                    <option value="discontinued">ðŸ›‘ Discontinued</option>
                                    <option value="adverse_event">âŒ Adverse Event</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Side Effects (optional)</label>
                                <input type="text" class="form-input" id="outcomeRecordSideEffects" placeholder="e.g., Headache, Dizziness">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Outcome Description</label>
                            <textarea class="form-input" id="outcomeRecordDesc" rows="2" placeholder="e.g., BP improved from 160/100 to 130/85 over 3 months"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="recordOutcome()">
                            <i class="fas fa-save"></i> Record Outcome
                        </button>
                        <div id="outcomeRecordStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Record Vital Reading -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-heartbeat" style="margin-right: 0.5rem; color: #ef4444;"></i>Record Vital Reading</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Vital Type</label>
                                <select class="form-select" id="vitalRecordType">
                                    <option value="bp_systolic">BP Systolic</option>
                                    <option value="bp_diastolic">BP Diastolic</option>
                                    <option value="heart_rate">Heart Rate</option>
                                    <option value="blood_glucose">Blood Glucose</option>
                                    <option value="hba1c">HbA1c</option>
                                    <option value="ldl_cholesterol">LDL Cholesterol</option>
                                    <option value="hdl_cholesterol">HDL Cholesterol</option>
                                    <option value="weight">Weight</option>
                                    <option value="pain_score">Pain Score (0-10)</option>
                                    <option value="egfr">eGFR</option>
                                    <option value="creatinine">Creatinine</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Value</label>
                                <input type="number" class="form-input" id="vitalRecordValue" placeholder="e.g., 130" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit (auto-filled)</label>
                                <input type="text" class="form-input" id="vitalRecordUnit" placeholder="mmHg" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes (optional)</label>
                                <input type="text" class="form-input" id="vitalRecordNotes" placeholder="e.g., Fasting">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="recordVital()">
                            <i class="fas fa-plus"></i> Record Vital
                        </button>
                        <div id="vitalRecordStatus" style="margin-top: 0.75rem; display: none;"></div>
                    </div>
                </div>

                <!-- Treatment Prediction -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-robot" style="margin-right: 0.5rem; color: #8b5cf6;"></i>ML Treatment Success Prediction</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Medication to Predict</label>
                                <input type="text" class="form-input" id="predictionMed" placeholder="e.g., Metformin">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">Target Condition</label>
                                <input type="text" class="form-input" id="predictionCondition" placeholder="e.g., Type 2 Diabetes">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-purple" onclick="predictTreatmentSuccess()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); width: 100%;">
                                    <i class="fas fa-magic"></i> Predict Success
                                </button>
                            </div>
                        </div>
                        <div id="predictionResults" style="display: none;"></div>
                    </div>
                </div>

                <!-- Outcome Timeline -->
                <div id="outcomeTimelineContainer" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Treatment Outcome Timeline</span>
                            <span class="badge" id="outcomeHealthTrend">-</span>
                        </div>
                        <div class="card-body">
                            <div id="outcomeTimelineList"></div>
                        </div>
                    </div>

                    <!-- Vital Trends -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-chart-area" style="margin-right: 0.5rem;"></i>Vital Sign Trends</span>
                        </div>
                        <div class="card-body">
                            <div id="vitalTrendsContainer"></div>
                        </div>
                    </div>

                    <!-- Treatment Insights -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-lightbulb" style="margin-right: 0.5rem; color: #f59e0b;"></i>Treatment Insights</span>
                        </div>
                        <div class="card-body">
                            <div id="treatmentInsightsList"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Timeline Page -->
            <section class="page-section" id="page-timeline">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-stream" style="margin-right: 0.5rem;"></i>Patient Timeline</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="timelinePatientUid" placeholder="Enter patient UID (e.g., PT20260131-XXXX)" style="font-family: monospace;">
                            </div>
                            <button class="btn btn-primary" onclick="loadTimeline()">
                                <i class="fas fa-search"></i> Load Timeline
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="timelineResults" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medication Timeline (Gantt View)</span>
                    </div>
                    <div class="card-body">
                        <div id="timelineChart" style="min-height: 300px;">
                            <!-- Gantt chart will be rendered here -->
                        </div>
                    </div>
                </div>

                <div class="card" id="timelineEventsCard" style="display: none;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-list-ul" style="margin-right: 0.5rem;"></i>Timeline Events</span>
                    </div>
                    <div class="card-body no-padding">
                        <div id="timelineEvents"></div>
                    </div>
                </div>
            </section>

            <!-- Knowledge Graph Page - Clean Visual Layout -->
            <section class="page-section" id="page-knowledge-graph">
                <!-- Header Card -->
                <div class="card" style="background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); border: none; color: white; margin-bottom: 1.5rem;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem;">
                                ðŸ”—
                            </div>
                            <div>
                                <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.25rem;">Patient Knowledge Graph</h2>
                                <p style="opacity: 0.9; font-size: 0.9rem;">Visual relationships: Patient â†” Medications â†” Conditions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Selection -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-search" style="margin-right: 0.5rem;"></i>Load Patient Graph</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-label">Patient UID</label>
                                <input type="text" class="form-input" id="kgPatientUid" placeholder="PT20260131-XXXX" style="font-family: monospace; font-size: 1rem;">
                            </div>
                            <button class="btn btn-primary" onclick="loadPatientKnowledgeGraph()" style="height: 44px;">
                                <i class="fas fa-project-diagram"></i> Build Graph
                            </button>
                            <button class="btn btn-secondary" onclick="loadDemoKnowledgeGraph()" style="height: 44px;">
                                <i class="fas fa-eye"></i> View Demo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Graph Visualization -->
                <div class="card" id="kgGraphCard" style="display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #f8fafc, #f1f5f9);">
                        <span class="card-title">
                            <i class="fas fa-sitemap" style="margin-right: 0.5rem; color: #7c3aed;"></i>
                            <span id="kgPatientName">Knowledge Graph</span>
                        </span>
                        <span id="kgStats" class="badge badge-info"></span>
                    </div>
                    <div class="card-body" id="kgGraphContent" style="padding: 2rem; background: #f8fafc; min-height: 500px;">
                        <!-- Graph will be rendered here -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="card" id="kgLegendCard" style="display: none;">
                    <div class="card-body" style="padding: 1rem 1.5rem;">
                        <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Patient</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Medication</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Condition</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Allergy</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #ec4899, #be185d); border-radius: 6px;"></div>
                                <span style="font-size: 0.85rem; font-weight: 500;">Drug Interaction</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ask AI Page - Medical AI Assistant -->
            <section class="page-section" id="page-ask-ai">
                <!-- AI Assistant Header -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                    <div class="card-body" style="padding: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                                ðŸ¤–
                            </div>
                            <div>
                                <h2 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Medical AI Assistant</h2>
                                <p style="opacity: 0.9; font-size: 1rem;">Your intelligent companion for patient queries, drug analysis, safety checks & more</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Context Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-user-circle"></i> Patient Context</span>
                        <button class="btn btn-secondary btn-sm" onclick="togglePatientContext()">
                            <i class="fas fa-chevron-down" id="patientContextToggle"></i>
                        </button>
                    </div>
                    <div class="card-body" id="patientContextBody">
                        <!-- Load from Database Section -->
                        <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <i class="fas fa-database" style="font-size: 1.5rem; color: #0284c7;"></i>
                                <div>
                                    <h4 style="margin: 0; color: #0369a1;">Load Patient from Database</h4>
                                    <p style="margin: 0; font-size: 0.85rem; color: #0284c7;">Enter patient UID to auto-fill context with saved data</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <input type="text" class="form-input" id="aiLoadPatientUid" placeholder="e.g., PT20260130-A1B2" style="flex: 1;">
                                <button class="btn btn-primary" onclick="loadPatientContextFromDB()">
                                    <i class="fas fa-download"></i> Load Context
                                </button>
                            </div>
                            <div id="aiLoadPatientStatus" style="margin-top: 0.75rem; display: none;"></div>
                        </div>

                        <div style="text-align: center; color: var(--gray-400); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            â€” OR enter manually â€”
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-id-card"></i> Patient ID</label>
                                <input type="text" class="form-input" id="aiPatientId" placeholder="e.g., P001">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user"></i> Patient Name</label>
                                <input type="text" class="form-input" id="aiPatientName" placeholder="Patient name">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                                <input type="text" class="form-input" id="aiPatientAge" placeholder="e.g., 45">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-allergies"></i> Allergies (comma-separated)</label>
                                <input type="text" class="form-input" id="aiPatientAllergies" placeholder="e.g., Penicillin, Aspirin, Sulfa">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-notes-medical"></i> Conditions (comma-separated)</label>
                                <input type="text" class="form-input" id="aiPatientConditions" placeholder="e.g., Diabetes, Hypertension">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label"><i class="fas fa-pills"></i> Current Medications (one per line: Name, Dosage, Frequency)</label>
                            <textarea class="form-input" id="aiPatientMedications" rows="3" placeholder="Metformin, 500mg, twice daily
Lisinopril, 10mg, once daily
Aspirin, 81mg, once daily"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="savePatientContext()">
                                <i class="fas fa-save"></i> Save Context
                            </button>
                            <button class="btn btn-secondary" onclick="clearPatientContext()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <span id="contextSaveStatus" style="display: flex; align-items: center; color: var(--success); display: none;">
                                <i class="fas fa-check-circle"></i> Saved!
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-comments"></i> Chat with AI</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="badge badge-success" id="aiStatusBadge">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Online
                            </span>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <!-- Chat Messages Container -->
                        <div id="aiChatContainer" style="height: 400px; overflow-y: auto; padding: 1.5rem; background: linear-gradient(180deg, #f8fafc, #f1f5f9);">
                            <!-- Welcome Message -->
                            <div class="ai-message" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                                    ðŸ¤–
                                </div>
                                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 80%;">
                                    <p style="margin: 0; color: var(--gray-700);">
                                        <strong>Hello, Doctor!</strong> I'm your Medical AI Assistant. I can help you with:
                                    </p>
                                    <ul style="margin: 0.75rem 0 0 1.25rem; color: var(--gray-600); font-size: 0.9rem;">
                                        <li>Patient medication queries</li>
                                        <li>Drug interaction checks</li>
                                        <li>Allergy verification</li>
                                        <li>Drug normalization (brand â†’ generic)</li>
                                        <li>Comprehensive safety analysis</li>
                                        <li>Medication timeline & history</li>
                                    </ul>
                                    <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--gray-500);">
                                        ðŸ’¡ Tip: Set patient context above for more accurate responses!
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); background: white;">
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 1; position: relative;">
                                    <textarea class="form-input" id="aiQueryInput" rows="2" placeholder="Ask me anything... e.g., 'What medications is the patient taking?' or 'Check for drug interactions'" style="padding-right: 50px; resize: none;"></textarea>
                                    <button class="btn btn-primary" onclick="submitAIQuery()" style="position: absolute; right: 8px; bottom: 8px; padding: 0.5rem 1rem; border-radius: 8px;">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                                <span style="font-size: 0.8rem; color: var(--gray-500); margin-right: 0.5rem;">Quick:</span>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); color: #4338ca; border: none; font-size: 0.75rem;" onclick="quickAIQuery('medications')">
                                    ðŸ’Š Medications
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: none; font-size: 0.75rem;" onclick="quickAIQuery('allergies')">
                                    ðŸš¨ Allergies
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border: none; font-size: 0.75rem;" onclick="quickAIQuery('interactions')">
                                    âš ï¸ Interactions
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border: none; font-size: 0.75rem;" onclick="quickAIQuery('safety')">
                                    ðŸ”¬ Safety Analysis
                                </button>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #5b21b6; border: none; font-size: 0.75rem;" onclick="quickAIQuery('timeline')">
                                    ðŸ“… Timeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions Card -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-lightbulb"></i> Suggested Questions</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;" id="aiSuggestions">
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('What medications is the patient taking?')">
                                <i class="fas fa-pills" style="color: var(--primary);"></i> What medications is the patient taking?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Does the patient have any allergies?')">
                                <i class="fas fa-allergies" style="color: var(--danger);"></i> Does the patient have any allergies?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Check for drug interactions')">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Check for drug interactions
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Run comprehensive safety analysis')">
                                <i class="fas fa-shield-alt" style="color: var(--success);"></i> Run comprehensive safety analysis
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('What is the generic name for Lipitor?')">
                                <i class="fas fa-search" style="color: var(--info);"></i> What is the generic name for Lipitor?
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start; text-align: left;" onclick="fillQuery('Is Aspirin safe with Warfarin?')">
                                <i class="fas fa-question-circle" style="color: var(--purple);"></i> Is Aspirin safe with Warfarin?
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Review Queue Page -->
            <section class="page-section" id="page-review-queue">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="pendingReviewCount">0</div>
                                <div class="stat-label">Pending Review</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-clock"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="correctionsMade">0</div>
                                <div class="stat-label">Corrections Made</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="dismissedAlerts">0</div>
                                <div class="stat-label">Dismissed Alerts</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-times-circle"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>Items Pending Review</span>
                        <button class="btn btn-secondary btn-sm" onclick="refreshReviewQueue()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="reviewQueueList">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <h4>All caught up!</h4>
                                <p>No items pending review</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Recent Corrections</span>
                    </div>
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Original</th>
                                    <th>Corrected</th>
                                    <th>By</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentCorrections">
                                <tr>
                                    <td colspan="6" class="empty-state">No corrections yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Audit & Compliance Page -->
            <section class="page-section" id="page-audit">
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalAuditEvents">0</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-list"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="totalCorrections">0</div>
                                <div class="stat-label">Corrections</div>
                            </div>
                            <div class="stat-icon yellow"><i class="fas fa-edit"></i></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-value" id="integrityScore">100%</div>
                                <div class="stat-label">Integrity Score</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-shield-alt"></i></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-scroll" style="margin-right: 0.5rem;"></i>Audit Trail</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="auditActionFilter" style="width: auto;" onchange="filterAuditTrail()">
                                    <option value="">All Actions</option>
                                    <option value="upload">Upload</option>
                                    <option value="extract">Extract</option>
                                    <option value="view">View</option>
                                    <option value="correct">Correct</option>
                                    <option value="dismiss">Dismiss</option>
                                    <option value="export">Export</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="refreshAuditTrail()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body no-padding">
                            <div id="auditTrailList"></div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-chart-pie" style="margin-right: 0.5rem;"></i>Compliance Report</span>
                            </div>
                            <div class="card-body">
                                <div id="complianceReport">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-pie"></i>
                                        <p>Loading compliance data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Export</span>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="exportAuditTrail()">
                                    <i class="fas fa-file-export"></i> Export Audit Trail
                                </button>
                                <button class="btn btn-secondary" style="width: 100%;" onclick="generateComplianceReport()">
                                    <i class="fas fa-file-pdf"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Text Input Modal -->
    <div class="modal-overlay" id="textInputModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <h3>Manual Text Entry</h3>
                <button class="modal-close" onclick="closeModal('textInputModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Paste or type prescription text</label>
                    <textarea class="form-input" id="manualText" rows="10" placeholder="Paste prescription text here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Known Allergies (optional)</label>
                    <input type="text" class="form-input" id="manualAllergies" placeholder="e.g., Penicillin, Sulfa">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('textInputModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processManualText()">
                    <i class="fas fa-magic"></i> Process Text
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Use relative URLs for portability
        const API_BASE = '';
        let currentResult = null;
        let selectedFile = null;
        let stats = { scans: 0, meds: 0, alerts: 0, totalConfidence: 0 };
        let prescriptionHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initUpload();
            loadStats();
        });

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });
        }

        function navigateTo(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'patient-detail': 'Patient Details',
                'history': 'Prescription History',
                'drug-normalize': 'Drug Normalization',
                'interactions': 'Drug Safety Analysis',
                'allergies': 'Allergy & Contraindication Checker',
                'med-changes': 'Medication Changes Tracker',
                'analytics': 'Analytics & Reports',
                'settings': 'Settings',
                'timeline': 'Medication Timeline',
                'knowledge-graph': 'Knowledge Graph',
                'ask-ai': 'Ask AI',
                'review-queue': 'Review Queue',
                'audit': 'Audit Trail'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
        }

        // Upload handling
        function initUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) selectFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) selectFile(file);
            });

            processBtn.addEventListener('click', processFile);

            // Collapsible
            document.getElementById('rawOcrHeader').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('rawOcrContent').classList.toggle('show');
            });
        }

        function selectFile(file) {
            selectedFile = file;
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-icon" style="background: #dcfce7; color: var(--success);">
                    <i class="fas fa-check"></i>
                </div>
                <h3>${file.name}</h3>
                <p>${(file.size / 1024).toFixed(1)} KB</p>
                <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-400);">
                    Click to change file
                </p>
            `;
            document.getElementById('processBtn').disabled = false;
        }

        async function processFile() {
            if (!selectedFile) return;

            const statusBox = document.getElementById('statusBox');
            const processBtn = document.getElementById('processBtn');

            // Show processing status
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing prescription with AI...';
            processBtn.disabled = true;
            document.getElementById('resultsContainer').classList.remove('show');

            const formData = new FormData();
            formData.append('file', selectedFile);

            const allergies = document.getElementById('allergiesInput').value;
            if (allergies) {
                formData.append('allergies', allergies);
            }

            try {
                const response = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = 'âœ“ Prescription processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = 'âœ— ' + error.message;
            } finally {
                processBtn.disabled = false;
            }
        }

        function displayResults(data) {
            document.getElementById('resultsContainer').classList.add('show');

            // Review banner
            const reviewBanner = document.getElementById('reviewBanner');
            if (data.needs_review) {
                reviewBanner.classList.remove('hidden');
                document.getElementById('reviewReason').textContent = 
                    data.review_reasons?.join(', ') || 'Manual review recommended';
            } else {
                reviewBanner.classList.add('hidden');
            }

            // Safety alerts
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';

            if (data.drug_interactions?.length > 0) {
                data.drug_interactions.forEach(int => {
                    const alertClass = int.severity === 'major' || int.severity === 'contraindicated' ? 'danger' : 'warning';
                    alertsContainer.innerHTML += `
                        <div class="alert-box ${alertClass}">
                            <span class="alert-icon">${alertClass === 'danger' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>Drug Interaction: ${int.drug1} + ${int.drug2}</h5>
                                <p><strong>Severity:</strong> ${int.severity.toUpperCase()}</p>
                                <p>${int.description}</p>
                            </div>
                        </div>
                    `;
                });
            }

            if (data.allergy_alerts?.length > 0) {
                data.allergy_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box danger">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>ALLERGY ALERT: ${alert.drug}</h5>
                                <p>Patient is allergic to ${alert.allergen}</p>
                                ${alert.cross_reactivity ? `<p><strong>Cross-reactivity:</strong> ${alert.cross_reactivity}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            if (data.safety_alerts?.length > 0) {
                data.safety_alerts.forEach(alert => {
                    alertsContainer.innerHTML += `
                        <div class="alert-box warning">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <h5>${alert}</h5>
                            </div>
                        </div>
                    `;
                });
            }

            // Prescription date
            document.getElementById('prescriptionDate').textContent = data.prescription_date || 'Date not found';

            // Patient info
            setField('resultPatientName', data.patient_name);
            setField('resultAgeGender', formatAgeGender(data.patient_age, data.patient_gender));
            setField('resultPatientId', data.patient_id);
            setField('resultPatientPhone', data.patient_phone);
            setField('resultPatientAddress', data.patient_address);

            // Doctor info
            setField('resultDoctorName', data.doctor_name);
            setField('resultDoctorQual', data.doctor_qualification);
            setField('resultClinic', data.clinic_name);
            setField('resultDoctorRegNo', data.doctor_reg_no);

            // Diagnosis
            const diagnosisList = document.getElementById('diagnosisList');
            diagnosisList.innerHTML = '';
            if (data.diagnosis?.length > 0) {
                data.diagnosis.forEach(d => {
                    diagnosisList.innerHTML += `<span class="tag">${d}</span>`;
                });
                document.getElementById('diagnosisSection').style.display = 'block';
            } else {
                document.getElementById('diagnosisSection').style.display = 'none';
            }

            // Vitals
            const vitalsGrid = document.getElementById('vitalsGrid');
            vitalsGrid.innerHTML = '';
            if (data.vitals && Object.keys(data.vitals).length > 0) {
                for (const [key, value] of Object.entries(data.vitals)) {
                    if (value) {
                        vitalsGrid.innerHTML += `
                            <div class="vital-item">
                                <label>${formatVitalName(key)}</label>
                                <span>${value}</span>
                            </div>
                        `;
                    }
                }
                document.getElementById('vitalsSection').style.display = 'block';
            } else {
                document.getElementById('vitalsSection').style.display = 'none';
            }

            // Medications
            const medCount = data.medications?.length || 0;
            const medsList = document.getElementById('medicationsList');
            medsList.innerHTML = '';
            document.getElementById('medBadge').textContent = medCount + ' items';

            // Get interaction drugs for highlighting
            const interactionDrugs = new Set();
            data.drug_interactions?.forEach(i => {
                interactionDrugs.add(i.drug1.toLowerCase());
                interactionDrugs.add(i.drug2.toLowerCase());
            });

            if (medCount > 0) {
                data.medications.forEach((med) => {
                    const hasInteraction = interactionDrugs.has(med.name?.toLowerCase());
                    const statusBadge = hasInteraction 
                        ? '<span class="badge badge-warning">âš ï¸ Interaction</span>'
                        : '<span class="badge badge-success">âœ“ Safe</span>';
                    
                    medsList.innerHTML += `
                        <tr>
                            <td>
                                <div class="med-name">${med.name || 'Unknown'}</div>
                                ${med.form ? `<div class="med-form">${med.form}</div>` : ''}
                            </td>
                            <td class="med-dosage">${med.dosage || '-'}</td>
                            <td>
                                ${med.frequency || '-'}
                                ${med.timing ? `<div style="font-size: 0.75rem; color: var(--gray-500);">${med.timing}</div>` : ''}
                            </td>
                            <td>${med.duration || '-'}</td>
                            <td>${med.instructions || '-'}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            } else {
                medsList.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            No medications found in prescription
                        </td>
                    </tr>
                `;
            }

            // Confidence
            const confidence = Math.round((data.confidence || 0) * 100);
            const confidenceFill = document.getElementById('confidenceFill');
            confidenceFill.style.width = confidence + '%';
            confidenceFill.className = 'confidence-fill ' + (confidence >= 70 ? 'high' : confidence >= 40 ? 'medium' : 'low');
            document.getElementById('confidenceText').textContent = confidence + '%';

            // Advice
            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';
            if (data.advice?.length > 0) {
                data.advice.forEach(a => {
                    adviceList.innerHTML += `<span class="tag">${a}</span>`;
                });
                document.getElementById('adviceSection').style.display = 'block';
            } else {
                document.getElementById('adviceSection').style.display = 'none';
            }

            // Follow-up
            document.getElementById('followUpDate').textContent = data.follow_up || 'Not specified';

            // Raw text
            document.getElementById('rawText').textContent = data.raw_ocr_text || 'No OCR text available';

            // Add to history
            addToHistory(data);
        }

        function setField(id, value) {
            const el = document.getElementById(id);
            if (value) {
                el.textContent = value;
                el.classList.remove('missing');
            } else {
                el.textContent = 'Not found';
                el.classList.add('missing');
            }
        }

        function formatAgeGender(age, gender) {
            const parts = [];
            if (age) parts.push(age);
            if (gender) parts.push(gender);
            return parts.join(' / ') || null;
        }

        function formatVitalName(key) {
            const names = {
                'blood_pressure': 'BP',
                'temperature': 'Temp',
                'pulse': 'Pulse',
                'spo2': 'SpO2',
                'weight': 'Weight'
            };
            return names[key] || key.replace(/_/g, ' ').toUpperCase();
        }

        function updateStats(data) {
            stats.scans++;
            stats.meds += data.medications?.length || 0;
            stats.alerts += (data.drug_interactions?.length || 0) + (data.allergy_alerts?.length || 0);
            stats.totalConfidence += (data.confidence || 0);

            document.getElementById('totalScans').textContent = stats.scans;
            document.getElementById('totalMeds').textContent = stats.meds;
            document.getElementById('alertsFound').textContent = stats.alerts;
            document.getElementById('avgConfidence').textContent = 
                Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
            document.getElementById('alertBadge').textContent = stats.alerts;
        }

        function loadStats() {
            // Load from localStorage or API
            const saved = localStorage.getItem('medicalGatewayStats');
            if (saved) {
                stats = JSON.parse(saved);
                document.getElementById('totalScans').textContent = stats.scans;
                document.getElementById('totalMeds').textContent = stats.meds;
                document.getElementById('alertsFound').textContent = stats.alerts;
                document.getElementById('alertBadge').textContent = stats.alerts;
                if (stats.scans > 0) {
                    document.getElementById('avgConfidence').textContent = 
                        Math.round((stats.totalConfidence / stats.scans) * 100) + '%';
                }
            }
        }

        function addToHistory(data) {
            prescriptionHistory.unshift({
                id: data.document_id || Date.now().toString(),
                patient: data.patient_name || 'Unknown',
                date: data.prescription_date || new Date().toLocaleDateString(),
                medCount: data.medications?.length || 0,
                confidence: Math.round((data.confidence || 0) * 100),
                status: data.needs_review ? 'Review' : 'Complete',
                data: data
            });

            updateHistoryTable();
            updateRecentTable();

            // Save stats
            localStorage.setItem('medicalGatewayStats', JSON.stringify(stats));
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyList');
            if (prescriptionHistory.length === 0) return;

            tbody.innerHTML = prescriptionHistory.map(p => `
                <tr>
                    <td><code style="font-size: 0.75rem;">${p.id.substring(0, 8)}...</code></td>
                    <td>${p.patient}</td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <div class="confidence-meter" style="width: 100px;">
                            <div class="confidence-bar">
                                <div class="confidence-fill ${p.confidence >= 70 ? 'high' : p.confidence >= 40 ? 'medium' : 'low'}" style="width: ${p.confidence}%;"></div>
                            </div>
                            <span style="font-size: 0.75rem;">${p.confidence}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentTable() {
            const tbody = document.getElementById('recentPrescriptions');
            const recent = prescriptionHistory.slice(0, 5);
            
            if (recent.length === 0) return;

            tbody.innerHTML = recent.map(p => `
                <tr>
                    <td>
                        <div class="patient-row">
                            <div class="patient-avatar">${(p.patient[0] || '?').toUpperCase()}</div>
                            <div class="patient-info">
                                <span class="patient-name">${p.patient}</span>
                            </div>
                        </div>
                    </td>
                    <td>${p.date}</td>
                    <td>${p.medCount} items</td>
                    <td>
                        <span class="badge ${p.status === 'Complete' ? 'badge-success' : 'badge-warning'}">${p.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewPrescription('${p.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewPrescription(id) {
            const prescription = prescriptionHistory.find(p => p.id === id);
            if (prescription) {
                navigateTo('scan');
                displayResults(prescription.data);
            }
        }

        function resetScan() {
            selectedFile = null;
            currentResult = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('allergiesInput').value = '';
            document.getElementById('patientNameInput').value = '';
            document.getElementById('statusBox').classList.remove('show');
            document.getElementById('resultsContainer').classList.remove('show');
            document.getElementById('processBtn').disabled = true;
            
            document.getElementById('uploadZone').innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Drop prescription here</h3>
                <p>or click to browse files</p>
                <p style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-400);">
                    Supports: PDF, PNG, JPG, JPEG, TIFF
                </p>
            `;
        }

        function copyToClipboard() {
            if (!currentResult) return;

            let text = `PRESCRIPTION SUMMARY\n`;
            text += `==================\n\n`;
            text += `Patient: ${currentResult.patient_name || 'N/A'}\n`;
            text += `Date: ${currentResult.prescription_date || 'N/A'}\n`;
            text += `Doctor: ${currentResult.doctor_name || 'N/A'}\n\n`;
            text += `MEDICATIONS:\n`;

            currentResult.medications?.forEach((med, i) => {
                text += `${i+1}. ${med.name} ${med.dosage || ''}\n`;
                text += `   ${med.frequency || ''} ${med.timing || ''} ${med.duration || ''}\n`;
            });

            if (currentResult.drug_interactions?.length > 0) {
                text += `\nâš ï¸ DRUG INTERACTIONS:\n`;
                currentResult.drug_interactions.forEach(i => {
                    text += `- ${i.drug1} + ${i.drug2}: ${i.description}\n`;
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                alert('Summary copied to clipboard!');
            });
        }

        function exportJSON() {
            if (!currentResult) return;

            const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prescription_${currentResult.document_id || Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function savePrescription() {
            if (!currentResult) return;
            alert('Prescription saved to database!');
        }

        // Modal functions
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function openTextInput() {
            openModal('textInputModal');
        }

        async function processManualText() {
            const text = document.getElementById('manualText').value;
            const allergies = document.getElementById('manualAllergies').value;
            
            if (!text.trim()) {
                alert('Please enter prescription text');
                return;
            }

            closeModal('textInputModal');
            navigateTo('scan');

            const statusBox = document.getElementById('statusBox');
            statusBox.className = 'status-box show processing';
            document.getElementById('statusText').innerHTML = '<span class="spinner"></span> Processing text...';

            try {
                const formData = new FormData();
                formData.append('text', text);
                if (allergies) formData.append('allergies', allergies);

                const response = await fetch(`${API_BASE}/api/documents/extract-text`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Processing failed');
                }

                currentResult = data;
                displayResults(data);
                updateStats(data);

                statusBox.className = 'status-box show success';
                document.getElementById('statusText').textContent = 'âœ“ Text processed successfully';

            } catch (error) {
                statusBox.className = 'status-box show error';
                document.getElementById('statusText').textContent = 'âœ— ' + error.message;
            }
        }

        async function checkInteractions() {
            const drugs = document.getElementById('interactionDrugs').value;
            if (!drugs.trim()) {
                alert('Please enter medications');
                return;
            }

            const resultsDiv = document.getElementById('interactionResults');
            resultsDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking interactions...</div>';

            try {
                const formData = new FormData();
                formData.append('medications', drugs);

                const response = await fetch(`${API_BASE}/api/documents/check-interactions`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Check failed');
                }

                if (data.drug_interactions?.length > 0) {
                    resultsDiv.innerHTML = data.drug_interactions.map(i => `
                        <div class="alert-box ${i.severity === 'major' || i.severity === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${i.severity === 'major' || i.severity === 'contraindicated' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${i.drug1} + ${i.drug2}</h5>
                                <p><strong>Severity:</strong> ${i.severity.toUpperCase()}</p>
                                <p>${i.description}</p>
                                ${i.management ? `<p><strong>Management:</strong> ${i.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No interactions found</h5>
                                <p>The entered medications (${data.medications_checked.join(', ')}) appear to be safe to use together.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert-box danger">
                        <span class="alert-icon">âŒ</span>
                        <div class="alert-content">
                            <h5>Error</h5>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function saveSettings() {
            localStorage.setItem('apiEndpoint', document.getElementById('apiEndpoint').value);
            localStorage.setItem('defaultMode', document.getElementById('defaultMode').value);
            localStorage.setItem('autoSave', document.getElementById('autoSave').checked);
            alert('Settings saved!');
        }

        // ==================== Patient Prescription Management ====================
        const PATIENT_API = '/api/v2/patient-prescriptions';
        
        let currentPatientId = null;
        let selectedFiles = [];
        let currentPatientData = null;
        let allTimelineEvents = [];

        // Initialize patient upload area
        document.addEventListener('DOMContentLoaded', () => {
            initPatientUpload();
            refreshPatientList();
        });

        function initPatientUpload() {
            const uploadZone = document.getElementById('multiUploadZone');
            const fileInput = document.getElementById('multiFileInput');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--success)';
                uploadZone.style.background = 'rgba(34, 197, 94, 0.05)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'transparent';
                handleFilesSelected(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFilesSelected(e.target.files);
            });
        }

        function handleFilesSelected(files) {
            selectedFiles = Array.from(files);
            
            if (selectedFiles.length === 0) return;

            const previewArea = document.getElementById('selectedFilesPreview');
            const filesList = document.getElementById('filesListPreview');
            
            previewArea.style.display = 'block';
            
            filesList.innerHTML = selectedFiles.map((f, idx) => `
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                    <i class="fas fa-file-image" style="color: var(--primary);"></i>
                    <span style="flex: 1;">${f.name}</span>
                    <span style="color: var(--gray-500); font-size: 0.75rem;">${(f.size / 1024).toFixed(1)} KB</span>
                    <span class="badge" id="fileStatus${idx}">Pending</span>
                </div>
            `).join('');
        }

        function clearSelectedFiles() {
            selectedFiles = [];
            document.getElementById('multiFileInput').value = '';
            document.getElementById('selectedFilesPreview').style.display = 'none';
            document.getElementById('filesListPreview').innerHTML = '';
        }

        function selectPatient() {
            const patientId = document.getElementById('patientIdInput').value.trim();
            const patientName = document.getElementById('patientNameInput').value.trim();
            
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }

            currentPatientId = patientId;
            
            // Show upload area
            document.getElementById('noPatientSelectedMsg').style.display = 'none';
            document.getElementById('prescriptionUploadArea').style.display = 'block';
            
            // Update badge
            const badge = document.getElementById('selectedPatientBadge');
            badge.style.display = 'inline-block';
            badge.textContent = `Patient: ${patientId}${patientName ? ` (${patientName})` : ''}`;
            badge.style.background = 'var(--success)';
            badge.style.color = 'white';
            
            // Check if patient exists
            checkExistingPatient(patientId);
        }

        async function checkExistingPatient(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}`);
                if (response.ok) {
                    const patient = await response.json();
                    // Auto-fill fields
                    if (patient.name) document.getElementById('patientNameInput').value = patient.name;
                    if (patient.allergies?.length) document.getElementById('patientAllergiesInput').value = patient.allergies.join(', ');
                    if (patient.chronic_conditions?.length) document.getElementById('patientConditionsInput').value = patient.chronic_conditions.join(', ');
                }
            } catch (e) {
                // Patient doesn't exist yet, that's fine
            }
        }

        async function refreshPatientList() {
            try {
                const response = await fetch(`${PATIENT_API}/patients`);
                const patients = await response.json();
                
                const container = document.getElementById('existingPatientsList');
                document.getElementById('totalPatientsCount').textContent = patients.length;
                
                // Calculate totals
                let totalRx = 0, totalMeds = 0;
                patients.forEach(p => {
                    totalRx += p.prescriptions_count || 0;
                    totalMeds += p.active_medications || 0;
                });
                document.getElementById('totalPrescriptionsCount').textContent = totalRx;
                document.getElementById('activeMedicationsCount').textContent = totalMeds;
                
                if (patients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-user-slash" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                            <p style="margin-top: 0.5rem;">No patients yet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = patients.map(p => `
                    <div class="patient-list-item" onclick="loadPatientDetail('${p.patient_id}')" 
                         style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.2s;"
                         onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                        <div>
                            <div style="font-weight: 500;">${p.name}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">ID: ${p.patient_id}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem;">${p.prescriptions_count} Rx</div>
                            <div style="font-size: 0.7rem; color: var(--gray-500);">${p.active_medications} active meds</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load patients:', e);
            }
        }

        async function processAllPrescriptions() {
            if (!currentPatientId) {
                alert('Please select a patient first');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const patientName = document.getElementById('patientNameInput').value.trim();
            const allergies = document.getElementById('patientAllergiesInput').value.trim();
            const conditions = document.getElementById('patientConditionsInput').value.trim();

            // Show processing status
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('processAllBtn').disabled = true;
            
            const progressDiv = document.getElementById('processingProgress');
            const results = [];
            const errors = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                // Update status
                document.getElementById('processingText').textContent = `Processing ${i + 1} of ${selectedFiles.length}: ${file.name}`;
                document.getElementById(`fileStatus${i}`).textContent = 'Processing...';
                document.getElementById(`fileStatus${i}`).style.background = 'var(--warning)';
                document.getElementById(`fileStatus${i}`).style.color = 'white';

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('patient_id', currentPatientId);
                    if (patientName) formData.append('patient_name', patientName);
                    if (allergies) formData.append('allergies', allergies);
                    if (conditions) formData.append('conditions', conditions);

                    const response = await fetch(`${PATIENT_API}/scan`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        results.push({
                            file: file.name,
                            prescription_number: data.analysis.prescription_number,
                            changes: data.analysis.changes_detected,
                            safety: data.analysis.safety_analysis
                        });
                        
                        document.getElementById(`fileStatus${i}`).textContent = 'âœ“ Done';
                        document.getElementById(`fileStatus${i}`).style.background = 'var(--success)';
                        
                        // Show changes in progress
                        const changes = data.analysis.changes_detected;
                        if (changes.new_medications?.length || changes.stopped_medications?.length || changes.dose_changes?.length) {
                            progressDiv.innerHTML += `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; font-size: 0.8rem;">
                                    <strong>Rx #${data.analysis.prescription_number}:</strong>
                                    ${changes.new_medications?.length ? `<span style="color: var(--success);">+${changes.new_medications.length} new</span>` : ''}
                                    ${changes.stopped_medications?.length ? `<span style="color: var(--danger);"> -${changes.stopped_medications.length} stopped</span>` : ''}
                                    ${changes.dose_changes?.length ? `<span style="color: var(--warning);"> ${changes.dose_changes.length} changed</span>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        throw new Error(data.detail || 'Processing failed');
                    }
                } catch (e) {
                    errors.push({ file: file.name, error: e.message });
                    document.getElementById(`fileStatus${i}`).textContent = 'âœ— Error';
                    document.getElementById(`fileStatus${i}`).style.background = 'var(--danger)';
                }
            }

            // Show completion
            document.getElementById('processingText').textContent = `âœ“ Completed: ${results.length} of ${selectedFiles.length} processed`;
            document.getElementById('processAllBtn').disabled = false;

            // Show results card
            document.getElementById('uploadResultsCard').style.display = 'block';
            document.getElementById('uploadResultsSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #059669;">${results.length}</div>
                        <div style="font-size: 0.8rem; color: #065f46;">Successfully Processed</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: #d97706;">${results.reduce((sum, r) => sum + (r.changes?.new_medications?.length || 0), 0)}</div>
                        <div style="font-size: 0.8rem; color: #92400e;">New Medications</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: ${errors.length ? '#fee2e2' : '#e0f2fe'}; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: ${errors.length ? '#dc2626' : '#0284c7'};">${errors.length || 'None'}</div>
                        <div style="font-size: 0.8rem; color: ${errors.length ? '#991b1b' : '#075985'};">Errors</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="loadPatientDetail('${currentPatientId}')">
                    <i class="fas fa-user"></i> View Patient Timeline & Details
                </button>
            `;

            // Refresh patient list
            refreshPatientList();
        }

        async function loadPatientDetail(patientId) {
            currentPatientId = patientId;
            
            // Navigate to detail page
            navigateTo('patient-detail');
            
            try {
                // Load patient summary
                const summaryRes = await fetch(`${PATIENT_API}/patients/${patientId}/summary`);
                const summary = await summaryRes.json();
                
                currentPatientData = summary;
                
                // Update header
                document.getElementById('patientDetailName').textContent = summary.patient.name || patientId;
                
                // Update stats
                document.getElementById('detailPrescriptionCount').textContent = summary.statistics.total_prescriptions;
                document.getElementById('detailActiveMeds').textContent = summary.statistics.current_active_medications;
                document.getElementById('detailDiscontinuedMeds').textContent = summary.statistics.discontinued_medications;
                document.getElementById('detailTimelineEvents').textContent = summary.statistics.timeline_events;
                
                // Risk level
                const riskLevel = summary.patient.safety_alerts?.length > 0 ? 'HIGH' : 'LOW';
                document.getElementById('detailRiskLevel').textContent = riskLevel;
                document.getElementById('detailRiskCard').style.background = riskLevel === 'HIGH' ? 
                    'linear-gradient(135deg, #fef2f2, #fee2e2)' : 'linear-gradient(135deg, #f0fdf4, #dcfce7)';
                
                // Patient basic info
                document.getElementById('detailPatientId').textContent = summary.patient.patient_id;
                document.getElementById('detailAgeGender').textContent = 
                    `${summary.patient.age || 'Unknown'} / ${summary.patient.gender || 'Unknown'}`;
                document.getElementById('detailBloodGroup').textContent = summary.patient.blood_group || '-';
                document.getElementById('detailDoctors').textContent = 
                    summary.all_doctors?.length ? summary.all_doctors.join(', ') : '-';
                
                // Render allergies with color-coded badges
                renderAllergyBadges(summary.patient.allergies || []);
                
                // Render conditions with color-coded badges
                renderConditionBadges(summary.patient.chronic_conditions || []);
                
                // Safety alerts
                const alertsCard = document.getElementById('safetyAlertsCard');
                const alertsContainer = document.getElementById('safetyAlertsContainer');
                
                if (summary.patient.safety_alerts?.length > 0) {
                    alertsCard.style.display = 'block';
                    document.getElementById('activeAlertsCount').textContent = summary.patient.safety_alerts.length;
                    alertsContainer.innerHTML = summary.patient.safety_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>${alert.type?.toUpperCase() || 'ALERT'}: ${alert.drugs?.join(' + ') || alert.drug || 'Unknown'}</h5>
                                <p>${alert.description || ''}</p>
                                ${alert.action_required ? `<p style="color: var(--danger);"><strong>Action:</strong> ${alert.action_required}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    alertsCard.style.display = 'none';
                    document.getElementById('activeAlertsCount').textContent = '0';
                }
                
                // Current medications
                const medsContainer = document.getElementById('currentMedicationsContainer');
                if (summary.patient.current_medications?.length > 0) {
                    medsContainer.innerHTML = summary.patient.current_medications.map(med => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: 500;">${med.name}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.generic_name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 500; color: var(--primary);">${med.dosage}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${med.frequency}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    medsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-pills" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p>No active medications</p>
                        </div>
                    `;
                }
                
                // Load timeline
                loadPatientTimeline(patientId);
                
                // Load prescriptions table
                loadPrescriptionsTable(summary.patient.prescriptions);
                
                // Auto-set AI context with patient data for AI queries
                autoSetAIPatientContext(patientId, summary);
                
            } catch (e) {
                console.error('Failed to load patient:', e);
                alert('Failed to load patient details: ' + e.message);
            }
        }

        async function loadPatientTimeline(patientId) {
            try {
                const response = await fetch(`${PATIENT_API}/patients/${patientId}/timeline`);
                const data = await response.json();
                
                allTimelineEvents = data.timeline || [];
                renderTimeline(allTimelineEvents);
            } catch (e) {
                console.error('Failed to load timeline:', e);
            }
        }

        function filterTimeline() {
            const filter = document.getElementById('timelineFilter').value;
            const filtered = filter ? 
                allTimelineEvents.filter(e => e.event_type === filter) : 
                allTimelineEvents;
            renderTimeline(filtered);
        }

        function renderTimeline(events) {
            const container = document.getElementById('timelineContainer');
            
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-stream" style="font-size: 2rem; color: var(--gray-400);"></i>
                        <p>No timeline events</p>
                    </div>
                `;
                return;
            }

            const eventIcons = {
                'prescription_added': { icon: 'fa-file-medical', color: '#3b82f6' },
                'medication_started': { icon: 'fa-plus-circle', color: '#22c55e' },
                'medication_stopped': { icon: 'fa-minus-circle', color: '#ef4444' },
                'medication_changed': { icon: 'fa-exchange-alt', color: '#f59e0b' },
                'medication_restarted': { icon: 'fa-redo', color: '#8b5cf6' },
                'diagnosis_recorded': { icon: 'fa-stethoscope', color: '#06b6d4' },
                'safety_alert': { icon: 'fa-exclamation-triangle', color: '#dc2626' }
            };

            container.innerHTML = events.map(event => {
                const config = eventIcons[event.event_type] || { icon: 'fa-circle', color: '#6b7280' };
                return `
                    <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: ${config.color}20; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="font-weight: 500;">${event.description}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">${event.event_date}</div>
                            </div>
                            ${event.details ? `
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-600); background: var(--gray-50); padding: 0.5rem; border-radius: 6px;">
                                    ${Object.entries(event.details).filter(([k, v]) => v && k !== 'diagnosis').map(([k, v]) => 
                                        `<span style="margin-right: 1rem;"><strong>${k.replace(/_/g, ' ')}:</strong> ${Array.isArray(v) ? v.join(', ') : v}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadPrescriptionsTable(prescriptions) {
            const tbody = document.getElementById('prescriptionsTableBody');
            
            if (!prescriptions || prescriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            No prescriptions yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = prescriptions.map((rx, idx) => `
                <tr>
                    <td><strong>#${idx + 1}</strong></td>
                    <td>${rx.prescription_date || '-'}</td>
                    <td>
                        <div>${rx.doctor_name || 'Unknown'}</div>
                        <div style="font-size: 0.7rem; color: var(--gray-500);">${rx.clinic_name || ''}</div>
                    </td>
                    <td>${rx.diagnosis?.join(', ') || '-'}</td>
                    <td>
                        ${rx.medications?.map(m => `<span class="tag" style="margin: 0.125rem;">${m.name || m}</span>`).join('') || '-'}
                    </td>
                    <td style="font-size: 0.75rem; color: var(--gray-500);">${rx.file_name || '-'}</td>
                </tr>
            `).join('');
        }

        function refreshPatientDetail() {
            if (currentPatientId) {
                loadPatientDetail(currentPatientId);
            }
        }

        // ==================== Enhanced Features ====================
        const API_V2_BASE = '/api/v2';

        // ==================== Drug Normalization Functions ====================
        
        async function normalizeSingleDrug() {
            const drugName = document.getElementById('normalizeDrugInput').value.trim();
            if (!drugName) {
                alert('Please enter a drug name');
                return;
            }

            const resultDiv = document.getElementById('normalizeResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Looking up drug...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/normalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug_name: drugName })
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div class="info-block" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${data.generic_name}</h4>
                                <p style="font-size: 0.75rem; color: var(--gray-500);">
                                    ${data.is_brand_name ? `Brand name: ${data.original_name}` : 'Generic name'}
                                </p>
                            </div>
                            <span class="badge" style="background: ${data.confidence > 0.8 ? '#dcfce7' : '#fef3c7'}; color: ${data.confidence > 0.8 ? '#059669' : '#d97706'};">
                                ${Math.round(data.confidence * 100)}% confidence
                            </span>
                        </div>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Drug Class</strong>
                                <p style="font-size: 0.875rem;">${data.drug_class.replace(/_/g, ' ')}</p>
                            </div>
                            <div>
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Common Dosages</strong>
                                <p style="font-size: 0.875rem;">${data.common_dosages?.join(', ') || 'N/A'}</p>
                            </div>
                        </div>
                        ${data.brand_names?.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong style="font-size: 0.75rem; color: var(--gray-600);">Known Brand Names</strong>
                                <p style="font-size: 0.875rem;">${data.brand_names.slice(0, 6).join(', ')}${data.brand_names.length > 6 ? '...' : ''}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Update counter
                const counter = document.getElementById('totalDrugsNormalized');
                counter.textContent = parseInt(counter.textContent) + 1;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function normalizeBatchDrugs() {
            const drugs = document.getElementById('batchNormalizeInput').value.trim();
            if (!drugs) {
                alert('Please enter drug names');
                return;
            }

            const drugList = drugs.split(',').map(d => d.trim()).filter(d => d);
            const resultDiv = document.getElementById('batchNormalizeResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Normalizing drugs...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/normalize/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug_names: drugList })
                });
                const data = await response.json();

                resultDiv.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: var(--gray-100);">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Original</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Generic Name</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--gray-200);">Drug Class</th>
                                    <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--gray-200);">Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.drugs.map(drug => `
                                    <tr style="border-bottom: 1px solid var(--gray-100);">
                                        <td style="padding: 0.75rem;">${drug.original_name} ${drug.is_brand_name ? '<span style="color: var(--info); font-size: 0.7rem;">BRAND</span>' : ''}</td>
                                        <td style="padding: 0.75rem; font-weight: 500;">${drug.generic_name}</td>
                                        <td style="padding: 0.75rem;">${drug.drug_class.replace(/_/g, ' ')}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span class="badge" style="background: ${drug.confidence > 0.8 ? '#dcfce7' : '#fef3c7'}; color: ${drug.confidence > 0.8 ? '#059669' : '#d97706'};">
                                                ${Math.round(drug.confidence * 100)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkDuplicateDrugs() {
            const drugs = document.getElementById('duplicateCheckInput').value.trim();
            if (!drugs) {
                alert('Please enter medications');
                return;
            }

            const drugList = drugs.split(',').map(d => d.trim()).filter(d => d);
            const resultDiv = document.getElementById('duplicateResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking for duplicates...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/duplicates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ medications: drugList })
                });
                const data = await response.json();

                if (data.has_duplicates) {
                    resultDiv.innerHTML = data.duplicates.map(dup => `
                        <div class="alert-box warning">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <h5>Duplicate Found: ${dup.generic_name}</h5>
                                <p><strong>Same drug under different names:</strong> ${dup.medications.join(', ')}</p>
                                <p style="color: var(--warning);">${dup.warning}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No Duplicates Found</h5>
                                <p>All medications appear to be unique drugs.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function compareDrugs() {
            const drug1 = document.getElementById('compareDrug1').value.trim();
            const drug2 = document.getElementById('compareDrug2').value.trim();
            if (!drug1 || !drug2) {
                alert('Please enter both drug names');
                return;
            }

            const resultDiv = document.getElementById('compareResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Comparing drugs...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/compare`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug1, drug2 })
                });
                const data = await response.json();

                const isSame = data.is_same_drug;
                resultDiv.innerHTML = `
                    <div class="alert-box ${isSame ? 'warning' : 'info'}">
                        <span class="alert-icon">${isSame ? 'âš ï¸' : 'âœ…'}</span>
                        <div class="alert-content">
                            <h5>${isSame ? 'Same Medication!' : 'Different Medications'}</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                <div>
                                    <strong>${data.drug1.original}</strong><br>
                                    Generic: ${data.drug1.generic}<br>
                                    Class: ${data.drug1.class.replace(/_/g, ' ')}
                                </div>
                                <div>
                                    <strong>${data.drug2.original}</strong><br>
                                    Generic: ${data.drug2.generic}<br>
                                    Class: ${data.drug2.class.replace(/_/g, ' ')}
                                </div>
                            </div>
                            ${isSame ? `<p style="margin-top: 0.5rem; color: var(--warning);"><strong>Warning:</strong> These are the same medication under different names!</p>` : ''}
                            ${data.same_class && !isSame ? `<p style="margin-top: 0.5rem; color: var(--info);">Note: Same therapeutic class - check for duplicate therapy.</p>` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        // ==================== Drug Safety Functions ====================

        async function runComprehensiveSafetyAnalysis() {
            const meds = document.getElementById('safetyMedications').value.trim();
            const allergies = document.getElementById('safetyAllergies').value.trim();
            const conditions = document.getElementById('safetyConditions').value.trim();

            if (!meds) {
                alert('Please enter medications');
                return;
            }

            const resultDiv = document.getElementById('comprehensiveSafetyResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Running comprehensive safety analysis...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/safety/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        patient_allergies: allergies ? allergies.split(',').map(a => a.trim()).filter(a => a) : [],
                        patient_conditions: conditions ? conditions.split(',').map(c => c.trim()).filter(c => c) : [],
                        suppress_low_value: false
                    })
                });
                const data = await response.json();

                // Risk Level Badge
                const riskColors = {
                    'MINIMAL': '#22c55e', 'LOW': '#84cc16', 'MODERATE': '#f59e0b', 
                    'HIGH': '#ef4444', 'CRITICAL': '#7c3aed'
                };
                
                let html = `
                    <div style="background: linear-gradient(135deg, ${riskColors[data.overall_risk_level]}20, ${riskColors[data.overall_risk_level]}10); 
                                border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid ${riskColors[data.overall_risk_level]};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: ${riskColors[data.overall_risk_level]}; margin-bottom: 0.25rem;">
                                    Overall Risk: ${data.overall_risk_level}
                                </h3>
                                <p style="color: var(--gray-600); font-size: 0.875rem;">
                                    ${data.interactions?.length || 0} interactions Â· ${data.allergy_alerts?.length || 0} allergy alerts Â· ${data.contraindications?.length || 0} contraindications
                                </p>
                            </div>
                            <div style="font-size: 2.5rem;">${data.overall_risk_level === 'CRITICAL' ? 'ðŸš¨' : data.overall_risk_level === 'HIGH' ? 'âš ï¸' : 'âœ“'}</div>
                        </div>
                    </div>
                `;

                // High Priority Alerts
                if (data.high_priority_alerts?.length > 0) {
                    html += '<h4 style="margin-bottom: 0.75rem;"><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> High Priority Alerts</h4>';
                    html += data.high_priority_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.75rem;">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>${alert.type === 'interaction' ? alert.drugs.join(' + ') : alert.drug}</h5>
                                <p><strong>Severity:</strong> ${alert.severity.toUpperCase()}</p>
                                <p>${alert.description}</p>
                                <p style="color: var(--danger);"><strong>Action:</strong> ${alert.action_required}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Drug Interactions
                if (data.interactions?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-pills" style="color: #f59e0b;"></i> Drug-Drug Interactions</h4>';
                    html += data.interactions.map(int => `
                        <div class="alert-box ${int.severity === 'major' || int.severity === 'contraindicated' ? 'danger' : 'warning'}" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">${int.severity === 'contraindicated' ? 'ðŸš«' : int.severity === 'major' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${int.drug1} + ${int.drug2}</h5>
                                <p>${int.description}</p>
                                ${int.management ? `<p><strong>Management:</strong> ${int.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

                // Allergy Alerts
                if (data.allergy_alerts?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-allergies" style="color: #ef4444;"></i> Allergy Alerts</h4>';
                    html += data.allergy_alerts.map(alert => `
                        <div class="alert-box danger" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>${alert.drug}</h5>
                                <p>${alert.description}</p>
                                <p><strong>Risk Type:</strong> ${alert.risk_type}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Contraindications
                if (data.contraindications?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-ban" style="color: #7c3aed;"></i> Contraindications</h4>';
                    html += data.contraindications.map(contra => `
                        <div class="alert-box ${contra.level === 'contraindicated' ? 'danger' : 'warning'}" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">${contra.level === 'contraindicated' ? 'ðŸš«' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${contra.drug}</h5>
                                <p>${contra.description}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Duplicate Therapies
                if (data.duplicate_therapies?.length > 0) {
                    html += '<h4 style="margin: 1rem 0 0.75rem;"><i class="fas fa-clone" style="color: #0891b2;"></i> Duplicate Therapy</h4>';
                    html += data.duplicate_therapies.map(dup => `
                        <div class="alert-box info" style="margin-bottom: 0.5rem;">
                            <span class="alert-icon">ðŸ“‹</span>
                            <div class="alert-content">
                                <h5>${dup.drugs.join(', ')}</h5>
                                <p>${dup.description}</p>
                                <p><strong>Recommendation:</strong> ${dup.recommendation}</p>
                            </div>
                        </div>
                    `).join('');
                }

                if (!data.interactions?.length && !data.allergy_alerts?.length && !data.contraindications?.length) {
                    html += `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No Safety Issues Found</h5>
                                <p>The medication combination appears safe based on available data.</p>
                            </div>
                        </div>
                    `;
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkInteractionsV2() {
            const drugs = document.getElementById('interactionDrugs').value;
            if (!drugs.trim()) {
                alert('Please enter medications');
                return;
            }

            const resultDiv = document.getElementById('interactionResults');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking interactions...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/interactions/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: drugs.split(',').map(d => d.trim()).filter(d => d)
                    })
                });
                const data = await response.json();

                if (data.interaction_count > 0) {
                    resultDiv.innerHTML = data.interactions.map(i => `
                        <div class="alert-box ${i.severity === 'major' || i.severity === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${i.severity === 'contraindicated' ? 'ðŸš«' : i.severity === 'major' ? 'ðŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${i.drug1} + ${i.drug2}</h5>
                                <p><strong>Severity:</strong> <span class="badge" style="background: ${i.severity === 'contraindicated' ? '#7c3aed' : i.severity === 'major' ? '#ef4444' : '#f59e0b'}; color: white;">${i.severity.toUpperCase()}</span></p>
                                <p>${i.description}</p>
                                ${i.mechanism ? `<p><strong>Mechanism:</strong> ${i.mechanism}</p>` : ''}
                                ${i.clinical_effects ? `<p><strong>Clinical Effects:</strong> ${i.clinical_effects}</p>` : ''}
                                ${i.management ? `<p><strong>Management:</strong> ${i.management}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No Interactions Found</h5>
                                <p>The entered medications appear safe to use together.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkAllergyRisks() {
            const meds = document.getElementById('allergyCheckMeds').value.trim();
            const allergies = document.getElementById('allergyCheckAllergies').value.trim();

            if (!meds || !allergies) {
                alert('Please enter both medications and allergies');
                return;
            }

            const resultDiv = document.getElementById('allergyCheckResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking allergy risks...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/allergies/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        allergies: allergies.split(',').map(a => a.trim()).filter(a => a)
                    })
                });
                const data = await response.json();

                if (data.alert_count > 0) {
                    resultDiv.innerHTML = data.allergy_alerts.map(alert => `
                        <div class="alert-box danger">
                            <span class="alert-icon">ðŸš¨</span>
                            <div class="alert-content">
                                <h5>${alert.drug}</h5>
                                <p><strong>Allergen:</strong> ${alert.allergen}</p>
                                <p><strong>Risk Type:</strong> ${alert.risk_type === 'direct' ? 'Direct Match' : 'Cross-Reactivity'}</p>
                                <p>${alert.description}</p>
                                ${alert.alternatives?.length > 0 ? `<p><strong>Alternatives:</strong> ${alert.alternatives.join(', ')}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No Allergy Risks Found</h5>
                                <p>The medications appear safe based on the provided allergies.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function checkContraindications() {
            const meds = document.getElementById('contraMeds').value.trim();
            const conditionsSelect = document.getElementById('contraConditions');
            const conditions = Array.from(conditionsSelect.selectedOptions).map(opt => opt.value);

            if (!meds || conditions.length === 0) {
                alert('Please enter medications and select conditions');
                return;
            }

            const resultDiv = document.getElementById('contraResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Checking contraindications...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/drugs/contraindications/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medications: meds.split(',').map(m => m.trim()).filter(m => m),
                        conditions: conditions
                    })
                });
                const data = await response.json();

                if (data.contraindication_count > 0) {
                    resultDiv.innerHTML = data.contraindications.map(contra => `
                        <div class="alert-box ${contra.level === 'contraindicated' ? 'danger' : 'warning'}">
                            <span class="alert-icon">${contra.level === 'contraindicated' ? 'ðŸš«' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <h5>${contra.drug}</h5>
                                <p><strong>Condition:</strong> ${contra.condition.replace(/_/g, ' ')}</p>
                                <p><strong>Level:</strong> ${contra.level.toUpperCase()}</p>
                                <p>${contra.description}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert-box info">
                            <span class="alert-icon">âœ…</span>
                            <div class="alert-content">
                                <h5>No Contraindications Found</h5>
                                <p>The medications appear safe for the selected conditions.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        // ==================== Temporal Reasoning Functions ====================

        async function analyzeMedicationChanges() {
            const prevDate = document.getElementById('prevRxDate').value;
            const currDate = document.getElementById('currRxDate').value;
            const prevMeds = document.getElementById('prevRxMeds').value.trim();
            const currMeds = document.getElementById('currRxMeds').value.trim();

            if (!prevDate || !currDate || !prevMeds || !currMeds) {
                alert('Please fill in all fields');
                return;
            }

            // Parse medications
            const parseMeds = (text) => {
                return text.split('\n').map(line => {
                    const parts = line.split(',').map(p => p.trim());
                    return {
                        medication_name: parts[0] || '',
                        dosage: parts[1] || '',
                        frequency: parts[2] || ''
                    };
                }).filter(m => m.medication_name);
            };

            const resultDiv = document.getElementById('medChangesResult');
            resultDiv.innerHTML = '<div class="status-box show processing"><span class="spinner"></span> Analyzing medication changes...</div>';

            try {
                const response = await fetch(`${API_V2_BASE}/temporal/medication-changes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prescriptions: [
                            { date: prevDate, medications: parseMeds(prevMeds) },
                            { date: currDate, medications: parseMeds(currMeds) }
                        ]
                    })
                });
                const data = await response.json();

                let html = `<div style="margin-bottom: 1rem;"><strong>Total Changes:</strong> ${data.total_changes}</div>`;
                
                // Started medications
                if (data.grouped_changes.started?.length > 0) {
                    html += `
                        <h5 style="color: #10b981; margin-top: 1rem;"><i class="fas fa-plus-circle"></i> Started</h5>
                        ${data.grouped_changes.started.map(c => `
                            <div class="info-block" style="border-left: 4px solid #10b981; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.new_value} - Started on ${c.change_date}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Dose changes
                if (data.grouped_changes.dose_changed?.length > 0) {
                    html += `
                        <h5 style="color: #f59e0b; margin-top: 1rem;"><i class="fas fa-edit"></i> Dose Changed</h5>
                        ${data.grouped_changes.dose_changed.map(c => `
                            <div class="info-block" style="border-left: 4px solid #f59e0b; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.old_value} â†’ ${c.new_value}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Frequency changes
                if (data.grouped_changes.frequency_changed?.length > 0) {
                    html += `
                        <h5 style="color: #3b82f6; margin-top: 1rem;"><i class="fas fa-clock"></i> Frequency Changed</h5>
                        ${data.grouped_changes.frequency_changed.map(c => `
                            <div class="info-block" style="border-left: 4px solid #3b82f6; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">${c.old_value} â†’ ${c.new_value}</p>
                            </div>
                        `).join('')}
                    `;
                }

                // Stopped medications
                if (data.grouped_changes.stopped?.length > 0) {
                    html += `
                        <h5 style="color: #ef4444; margin-top: 1rem;"><i class="fas fa-minus-circle"></i> Stopped</h5>
                        ${data.grouped_changes.stopped.map(c => `
                            <div class="info-block" style="border-left: 4px solid #ef4444; margin-bottom: 0.5rem;">
                                <strong>${c.medication_name}</strong>
                                <p style="font-size: 0.8125rem; color: var(--gray-600);">Stopped on ${c.change_date}</p>
                            </div>
                        `).join('')}
                    `;
                }

                resultDiv.innerHTML = html;

                // Also load overlap analysis
                loadOverlapAnalysis(prevDate, currDate, parseMeds(prevMeds), parseMeds(currMeds));

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert-box danger"><span class="alert-icon">âŒ</span><div class="alert-content"><h5>Error</h5><p>${error.message}</p></div></div>`;
            }
        }

        async function loadOverlapAnalysis(prevDate, currDate, prevMeds, currMeds) {
            const resultDiv = document.getElementById('overlapAnalysisResult');

            try {
                const response = await fetch(`${API_V2_BASE}/temporal/overlaps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prescriptions: [
                            { date: prevDate, medications: prevMeds },
                            { date: currDate, medications: currMeds }
                        ]
                    })
                });
                const data = await response.json();

                if (data.overlap_count > 0) {
                    resultDiv.innerHTML = `
                        <div style="margin-bottom: 1rem;"><strong>Overlapping Medications:</strong> ${data.overlap_count} pairs</div>
                        ${data.significant_overlaps.map(o => `
                            <div class="info-block" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div>
                                    <strong>${o.medication1}</strong> + <strong>${o.medication2}</strong>
                                    <p style="font-size: 0.75rem; color: var(--gray-600);">${o.notes}</p>
                                </div>
                                <span class="badge" style="background: ${o.is_significant ? '#fef3c7' : '#dcfce7'};">
                                    ${o.duration_days} days
                                </span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                            <p>No significant overlaps detected</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading overlap analysis:', error);
            }
        }

        // Timeline Functions
        async function loadTimeline() {
            const patientUid = document.getElementById('timelinePatientUid').value.trim();
            if (!patientUid) {
                alert('Please enter a patient UID');
                return;
            }

            try {
                // Load Gantt data from staff API
                const ganttResponse = await fetch(`${STAFF_API}/patient/${patientUid}/gantt`);
                const ganttData = await ganttResponse.json();
                
                if (!ganttData.success) {
                    throw new Error(ganttData.detail || 'Failed to load gantt data');
                }
                
                // Load timeline events from staff API
                const eventsResponse = await fetch(`${STAFF_API}/patient/${patientUid}/timeline`);
                const eventsData = await eventsResponse.json();

                document.getElementById('timelineResults').style.display = 'block';
                document.getElementById('timelineEventsCard').style.display = 'block';

                renderGanttChart(ganttData);
                renderTimelineEvents(eventsData.events || []);
            } catch (error) {
                console.error('Timeline error:', error);
                alert('Error loading timeline: ' + error.message);
            }
        }

        function renderGanttChart(data) {
            const container = document.getElementById('timelineChart');
            if (!data.medications || data.medications.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-pills"></i><p>No medication timeline data</p></div>';
                return;
            }

            // Summary header
            let html = `
                <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${data.active_medications || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Active Medications</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">${data.total_medications || 0}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">Total Medications</div>
                    </div>
                </div>
            `;
            
            html += '<div style="overflow-x: auto;">';
            data.medications.forEach(med => {
                const isActive = med.active;
                html += `
                    <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-100);">
                        <div style="width: 180px;">
                            <div style="font-weight: 600; font-size: 0.9rem;">${med.name}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">${med.dosage || ''} ${med.frequency ? 'â€¢ ' + med.frequency : ''}</div>
                        </div>
                        <div style="flex: 1; background: var(--gray-100); height: 28px; border-radius: 6px; position: relative; margin: 0 1rem; display: flex; align-items: center; padding: 0 10px;">
                            <div style="position: absolute; left: 0; height: 100%; background: ${isActive ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #9ca3af, #6b7280)'}; border-radius: 6px; width: ${isActive ? '100%' : '60%'}; opacity: 0.9;"></div>
                            <span style="position: relative; z-index: 1; font-size: 0.7rem; color: white; font-weight: 500;">${med.start} â†’ ${med.end}</span>
                        </div>
                        <div style="width: 120px; font-size: 0.75rem; color: var(--gray-500); text-align: right; padding-right: 0.5rem;">
                            ${med.prescriber ? 'Dr. ' + med.prescriber : ''}
                        </div>
                        <span class="badge ${isActive ? 'badge-success' : 'badge-gray'}" style="min-width: 60px; text-align: center;">${isActive ? 'Active' : 'Stopped'}</span>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderTimelineEvents(events) {
            const container = document.getElementById('timelineEvents');
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 2rem; text-align: center; color: var(--gray-500);"><i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><p>No timeline events yet</p></div>';
                return;
            }
            
            // Get event type icons and colors
            const eventStyles = {
                'prescription_added': { icon: 'ðŸ“‹', color: '#3b82f6', bg: '#eff6ff' },
                'medication_started': { icon: 'ðŸ’Š', color: '#059669', bg: '#ecfdf5' },
                'medication_stopped': { icon: 'â¹ï¸', color: '#dc2626', bg: '#fef2f2' },
                'dosage_changed': { icon: 'ðŸ“', color: '#d97706', bg: '#fffbeb' },
                'condition_added': { icon: 'ðŸ¥', color: '#7c3aed', bg: '#f5f3ff' },
                'allergy_added': { icon: 'âš ï¸', color: '#dc2626', bg: '#fef2f2' },
                'visit': { icon: 'ðŸ‘¨â€âš•ï¸', color: '#0891b2', bg: '#ecfeff' },
            };

            container.innerHTML = events.slice(0, 30).map(event => {
                const eventDate = event.event_date || event.date || '';
                const eventType = event.event_type || event.type || 'event';
                const description = event.description || '';
                const style = eventStyles[eventType] || { icon: 'ðŸ“Œ', color: '#6b7280', bg: '#f9fafb' };
                
                // Format date
                let displayDate = eventDate;
                try {
                    if (eventDate) {
                        const dt = new Date(eventDate);
                        displayDate = dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    }
                } catch (e) {}
                
                return `
                    <div style="display: flex; padding: 1rem; border-bottom: 1px solid var(--gray-100); align-items: flex-start;">
                        <div style="width: 36px; height: 36px; background: ${style.bg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-size: 1.1rem;">
                            ${style.icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span style="font-weight: 600; font-size: 0.85rem; color: ${style.color};">${eventType.replace(/_/g, ' ').toUpperCase()}</span>
                                <span style="font-size: 0.75rem; color: var(--gray-400);">â€¢</span>
                                <span style="font-size: 0.75rem; color: var(--gray-500);">${displayDate}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray-700);">${description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== Knowledge Graph Functions ====================
        
        let kgCurrentData = null;
        
        async function loadPatientKnowledgeGraph() {
            const patientUid = document.getElementById('kgPatientUid').value.trim();
            if (!patientUid) {
                alert('Please enter a patient UID');
                return;
            }

            const container = document.getElementById('kgGraphContent');
            document.getElementById('kgGraphCard').style.display = 'block';
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 300px;">
                    <div style="text-align: center; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 1rem;"></i>
                        <div>Building knowledge graph...</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/knowledge-graph`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load knowledge graph');
                }
                
                kgCurrentData = data;
                document.getElementById('kgPatientName').textContent = `${data.patient_name} (${patientUid})`;
                document.getElementById('kgLegendCard').style.display = 'block';
                document.getElementById('kgStats').textContent = `${data.graph.statistics.total_nodes} nodes â€¢ ${data.graph.statistics.total_edges} relationships`;
                
                renderCleanKnowledgeGraph(data);
                
            } catch (error) {
                console.error('Knowledge graph error:', error);
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 1rem;"></i>
                            <div>${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        async function loadDemoKnowledgeGraph() {
            const container = document.getElementById('kgGraphContent');
            document.getElementById('kgGraphCard').style.display = 'block';
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 300px;">
                    <div style="text-align: center; color: var(--gray-500);">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 1rem;"></i>
                        <div>Loading demo...</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${STAFF_API}/knowledge-graph/demo`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load demo');
                }
                
                kgCurrentData = data;
                document.getElementById('kgPatientName').textContent = `Demo Patient (DEMO-001)`;
                document.getElementById('kgLegendCard').style.display = 'block';
                document.getElementById('kgStats').textContent = `${data.graph.statistics.total_nodes} nodes â€¢ ${data.graph.statistics.total_edges} relationships â€¢ DEMO`;
                
                renderCleanKnowledgeGraph(data);
                
            } catch (error) {
                console.error('Demo error:', error);
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 1rem;"></i>
                            <div>${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function renderCleanKnowledgeGraph(data) {
            const container = document.getElementById('kgGraphContent');
            const nodes = data.graph.nodes || [];
            const edges = data.graph.edges || [];
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center; color: var(--gray-500);">
                            <i class="fas fa-project-diagram fa-2x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>No data available</div>
                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">Add medications or conditions to see the graph</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group nodes by type
            const patientNodes = nodes.filter(n => n.group === 'patient');
            const medicationNodes = nodes.filter(n => n.group === 'medication');
            const conditionNodes = nodes.filter(n => n.group === 'condition');
            const allergyNodes = nodes.filter(n => n.group === 'allergy');
            const interactionNodes = nodes.filter(n => n.group === 'interaction');
            
            // Build relationships map
            const relationships = {};
            edges.forEach(edge => {
                if (!relationships[edge.from]) relationships[edge.from] = [];
                relationships[edge.from].push({ to: edge.to, label: edge.label });
            });
            
            // Find which medications treat which conditions
            const medTreatsCondition = {};
            edges.forEach(edge => {
                if (edge.label === 'treats') {
                    medTreatsCondition[edge.from] = edge.to;
                }
            });
            
            let html = `
                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    
                    <!-- Patient (Center) -->
                    ${patientNodes.map(patient => `
                        <div style="display: flex; justify-content: center;">
                            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1.25rem 2rem; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); min-width: 200px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ‘¤</div>
                                <div style="font-size: 1.1rem; font-weight: 700;">${patient.label?.replace(/ðŸ‘¤\n/, '') || 'Patient'}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Patient</div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <!-- Connection Lines Visual -->
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; gap: 3rem; align-items: flex-start;">
                            ${medicationNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">takes</div></div>` : ''}
                            ${conditionNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">has</div></div>` : ''}
                            ${allergyNodes.length > 0 ? `<div style="text-align: center; color: var(--gray-400);"><i class="fas fa-arrow-down fa-lg"></i><div style="font-size: 0.75rem; margin-top: 0.25rem;">allergic to</div></div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Row: Medications, Conditions, Allergies -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        
                        <!-- Medications Column -->
                        ${medicationNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #10b981; overflow: hidden; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-pills" style="margin-right: 0.5rem;"></i>Medications (${medicationNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${medicationNodes.map(med => {
                                        const treatedCondition = medTreatsCondition[med.id];
                                        const condName = treatedCondition ? conditionNodes.find(c => c.id === treatedCondition)?.label?.replace(/ðŸ¥\n/, '') : null;
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.5rem;">
                                                <div style="width: 36px; height: 36px; background: #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸ’Š</div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #065f46;">${med.label?.replace(/ðŸ’Š\n/, '') || 'Medication'}</div>
                                                    ${condName ? `<div style="font-size: 0.75rem; color: #059669;"><i class="fas fa-arrow-right" style="margin-right: 0.25rem;"></i>treats ${condName}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Conditions Column -->
                        ${conditionNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #f59e0b; overflow: hidden; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem;"></i>Conditions (${conditionNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${conditionNodes.map(cond => `
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fffbeb; border-radius: 8px; margin-bottom: 0.5rem;">
                                            <div style="width: 36px; height: 36px; background: #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸ¥</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #92400e;">${cond.label?.replace(/ðŸ¥\n/, '') || 'Condition'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Allergies Column -->
                        ${allergyNodes.length > 0 ? `
                            <div style="background: white; border-radius: 12px; border: 2px solid #ef4444; overflow: hidden; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);">
                                <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Allergies (${allergyNodes.length})
                                </div>
                                <div style="padding: 1rem;">
                                    ${allergyNodes.map(allergy => `
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fef2f2; border-radius: 8px; margin-bottom: 0.5rem;">
                                            <div style="width: 36px; height: 36px; background: #ef4444; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0;">ðŸš«</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #991b1b;">${allergy.label?.replace(/ðŸš«\n/, '') || 'Allergy'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Drug Interactions (if any) -->
                    ${interactionNodes.length > 0 ? `
                        <div style="background: white; border-radius: 12px; border: 2px solid #ec4899; overflow: hidden; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.15);">
                            <div style="background: linear-gradient(135deg, #ec4899, #be185d); color: white; padding: 0.75rem 1rem; font-weight: 600;">
                                <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>Drug Interactions (${interactionNodes.length})
                            </div>
                            <div style="padding: 1rem;">
                                ${interactionNodes.map(interaction => `
                                    <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: #fdf2f8; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #ec4899;">
                                        <div style="width: 40px; height: 40px; background: #ec4899; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">âš ï¸</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #9d174d;">${interaction.label?.replace(/âš ï¸\n/, '') || 'Interaction'}</div>
                                            <div style="font-size: 0.85rem; color: #be185d; margin-top: 0.25rem;">
                                                ${interaction.title?.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim() || 'Potential drug interaction detected'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Relationship Summary -->
                    <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">
                            <i class="fas fa-project-diagram" style="margin-right: 0.5rem;"></i>Relationship Summary
                        </div>
                        <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                <span style="font-size: 1.25rem; color: #10b981;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ’Š</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">takes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                <span style="font-size: 1.25rem; color: #f59e0b;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ¥</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">has condition</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ’Š</span>
                                <span style="font-size: 1.25rem; color: #3b82f6;">â†’</span>
                                <span style="font-size: 1.5rem;">ðŸ¥</span>
                                <span style="font-size: 0.8rem; color: var(--gray-600);">treats</span>
                            </div>
                            ${allergyNodes.length > 0 ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">ðŸ‘¤</span>
                                    <span style="font-size: 1.25rem; color: #ef4444;">â†’</span>
                                    <span style="font-size: 1.5rem;">ðŸš«</span>
                                    <span style="font-size: 0.8rem; color: var(--gray-600);">allergic to</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ==================== AI Medical Assistant Functions ====================
        
        let aiChatHistory = [];
        let aiPatientContext = null;
        
        // Toggle patient context panel
        function togglePatientContext() {
            const body = document.getElementById('patientContextBody');
            const toggle = document.getElementById('patientContextToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.classList.remove('fa-chevron-right');
                toggle.classList.add('fa-chevron-down');
            } else {
                body.style.display = 'none';
                toggle.classList.remove('fa-chevron-down');
                toggle.classList.add('fa-chevron-right');
            }
        }
        
        // Auto-set AI patient context from patient detail view
        async function autoSetAIPatientContext(patientId, summary) {
            try {
                // Extract medications from current medications
                const medications = (summary.patient.current_medications || []).map(med => ({
                    name: med.name || '',
                    dosage: med.dosage || '',
                    frequency: med.frequency || ''
                }));
                
                // Set the AI context
                aiPatientContext = {
                    patient_id: patientId,
                    name: summary.patient.name,
                    age: summary.patient.age,
                    gender: summary.patient.gender,
                    medications: medications,
                    allergies: summary.patient.allergies || [],
                    conditions: summary.patient.chronic_conditions || []
                };
                
                // Also sync with backend AI service
                await fetch(`${API_V2_BASE}/ai/set-patient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        name: summary.patient.name,
                        age: summary.patient.age?.toString() || '',
                        medications: medications,
                        allergies: summary.patient.allergies || [],
                        conditions: summary.patient.chronic_conditions || []
                    })
                });
                
                // Also pre-fill the AI form fields
                document.getElementById('aiPatientId').value = patientId;
                document.getElementById('aiPatientName').value = summary.patient.name || '';
                document.getElementById('aiPatientAge').value = summary.patient.age || '';
                document.getElementById('aiPatientAllergies').value = (summary.patient.allergies || []).join(', ');
                document.getElementById('aiPatientConditions').value = (summary.patient.chronic_conditions || []).join(', ');
                document.getElementById('aiPatientMedications').value = medications.map(m => 
                    `${m.name}, ${m.dosage}, ${m.frequency}`
                ).join('\n');
                
                console.log(`AI context auto-set for patient ${patientId} with ${medications.length} medications`);
                
            } catch (error) {
                console.error('Error auto-setting AI context:', error);
            }
        }
        
        // Save patient context for AI
        async function savePatientContext() {
            const patientId = document.getElementById('aiPatientId').value || `P${Date.now()}`;
            const name = document.getElementById('aiPatientName').value;
            const age = document.getElementById('aiPatientAge').value;
            const allergiesStr = document.getElementById('aiPatientAllergies').value;
            const conditionsStr = document.getElementById('aiPatientConditions').value;
            const medicationsStr = document.getElementById('aiPatientMedications').value;
            
            // Parse allergies and conditions
            const allergies = allergiesStr ? allergiesStr.split(',').map(a => a.trim()).filter(a => a) : [];
            const conditions = conditionsStr ? conditionsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            
            // Parse medications
            const medications = [];
            if (medicationsStr) {
                const lines = medicationsStr.split('\n');
                for (const line of lines) {
                    if (line.trim()) {
                        const parts = line.split(',').map(p => p.trim());
                        medications.push({
                            name: parts[0] || '',
                            dosage: parts[1] || '',
                            frequency: parts[2] || '',
                            prescribed_date: new Date().toISOString().split('T')[0]
                        });
                    }
                }
            }
            
            // Store locally
            aiPatientContext = {
                patient_id: patientId,
                name: name,
                age: age,
                medications: medications,
                allergies: allergies,
                conditions: conditions
            };
            
            // Save to backend
            try {
                await fetch(`${API_V2_BASE}/ai/set-patient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        name: name,
                        age: age,
                        medications: medications,
                        allergies: allergies,
                        conditions: conditions
                    })
                });
                
                // Show saved status
                const status = document.getElementById('contextSaveStatus');
                status.style.display = 'flex';
                setTimeout(() => { status.style.display = 'none'; }, 2000);
                
                // Add system message
                addAIMessage('system', `âœ… Patient context saved for **${name || patientId}**\n- ${medications.length} medications\n- ${allergies.length} allergies\n- ${conditions.length} conditions`);
                
            } catch (error) {
                console.error('Error saving patient context:', error);
            }
        }
        
        // Clear patient context
        function clearPatientContext() {
            document.getElementById('aiPatientId').value = '';
            document.getElementById('aiPatientName').value = '';
            document.getElementById('aiPatientAge').value = '';
            document.getElementById('aiPatientAllergies').value = '';
            document.getElementById('aiPatientConditions').value = '';
            document.getElementById('aiPatientMedications').value = '';
            aiPatientContext = null;
        }
        
        // Submit AI query
        async function submitAIQuery() {
            const queryInput = document.getElementById('aiQueryInput');
            const query = queryInput.value.trim();
            
            if (!query) {
                return;
            }
            
            // Add user message to chat
            addAIMessage('user', query);
            queryInput.value = '';
            
            // Show typing indicator
            const typingId = addTypingIndicator();
            
            try {
                // Build context from form if no patient context saved
                let context = aiPatientContext;
                if (!context) {
                    context = buildContextFromForm();
                }
                
                const response = await fetch(`${API_V2_BASE}/ai/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        patient_id: context?.patient_id || null,
                        context: context
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                // Add AI response
                displayAIChatResponse(data);
                
            } catch (error) {
                removeTypingIndicator(typingId);
                addAIMessage('error', `âŒ Error: ${error.message}`);
            }
        }
        
        // Build context from form fields
        function buildContextFromForm() {
            const allergiesStr = document.getElementById('aiPatientAllergies').value;
            const conditionsStr = document.getElementById('aiPatientConditions').value;
            const medicationsStr = document.getElementById('aiPatientMedications').value;
            
            if (!allergiesStr && !conditionsStr && !medicationsStr) {
                return null;
            }
            
            const allergies = allergiesStr ? allergiesStr.split(',').map(a => a.trim()).filter(a => a) : [];
            const conditions = conditionsStr ? conditionsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            
            const medications = [];
            if (medicationsStr) {
                const lines = medicationsStr.split('\n');
                for (const line of lines) {
                    if (line.trim()) {
                        const parts = line.split(',').map(p => p.trim());
                        medications.push({
                            name: parts[0] || '',
                            dosage: parts[1] || '',
                            frequency: parts[2] || ''
                        });
                    }
                }
            }
            
            return {
                patient_id: document.getElementById('aiPatientId').value || null,
                medications: medications,
                allergies: allergies,
                conditions: conditions
            };
        }
        
        // Quick AI query shortcuts
        function quickAIQuery(type) {
            const queries = {
                'medications': 'What medications is the patient taking?',
                'allergies': 'What are the patient\'s allergies?',
                'interactions': 'Check for drug interactions between current medications',
                'safety': 'Run comprehensive safety analysis on current medications',
                'timeline': 'Show medication timeline and history'
            };
            
            document.getElementById('aiQueryInput').value = queries[type] || '';
            submitAIQuery();
        }
        
        // Add message to chat
        function addAIMessage(type, content) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            
            if (type === 'user') {
                messageDiv.style.flexDirection = 'row-reverse';
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        ðŸ‘¨â€âš•ï¸
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem 1.25rem; border-radius: 16px 0 16px 16px; max-width: 80%;">
                        <p style="margin: 0;">${escapeHtml(content)}</p>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        ðŸ¤–
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; max-width: 80%;">
                        <p style="margin: 0; color: var(--gray-700);">${formatAIContent(content)}</p>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        âš ï¸
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; max-width: 80%;">
                        <p style="margin: 0; color: #991b1b;">${escapeHtml(content)}</p>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const container = document.getElementById('aiChatContainer');
            const id = 'typing-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; gap: 4px;">
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: -0.32s;"></span>
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; animation-delay: -0.16s;"></span>
                        <span style="width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></span>
                    </div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            return id;
        }
        
        // Remove typing indicator
        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }
        
        // Display AI chat response
        function displayAIChatResponse(data) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            
            // Build response HTML
            let responseContent = `<div style="margin-bottom: 0.75rem;">${formatAIContent(data.answer || 'No response available')}</div>`;
            
            // Add warnings if any
            if (data.warnings && data.warnings.length > 0) {
                responseContent += `<div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef2f2, #fee2e2); border-radius: 8px; border-left: 4px solid #dc2626;">`;
                responseContent += `<strong style="color: #991b1b;">âš ï¸ Warnings:</strong><ul style="margin: 0.5rem 0 0 1rem; color: #991b1b;">`;
                data.warnings.forEach(w => {
                    responseContent += `<li>${w.message || JSON.stringify(w)}</li>`;
                });
                responseContent += `</ul></div>`;
            }
            
            // Add recommendations if any
            if (data.recommendations && data.recommendations.length > 0) {
                responseContent += `<div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 8px; border-left: 4px solid #16a34a;">`;
                responseContent += `<strong style="color: #166534;">ðŸ’¡ Recommendations:</strong><ul style="margin: 0.5rem 0 0 1rem; color: #166534;">`;
                data.recommendations.forEach(r => {
                    responseContent += `<li>${r}</li>`;
                });
                responseContent += `</ul></div>`;
            }
            
            // Add follow-up questions
            if (data.follow_up_questions && data.follow_up_questions.length > 0) {
                responseContent += `<div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                data.follow_up_questions.slice(0, 3).forEach(q => {
                    responseContent += `<button onclick="fillQuery('${q.replace(/'/g, "\\'")}')" style="padding: 0.35rem 0.75rem; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 20px; font-size: 0.75rem; color: #667eea; cursor: pointer;">${q}</button>`;
                });
                responseContent += `</div>`;
            }
            
            // Add metadata
            const confidence = Math.round((data.confidence || 0) * 100);
            const confidenceColor = confidence >= 80 ? '#16a34a' : confidence >= 50 ? '#d97706' : '#dc2626';
            responseContent += `<div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--gray-500);">`;
            responseContent += `<span><i class="fas fa-chart-line"></i> Confidence: <strong style="color: ${confidenceColor}">${confidence}%</strong></span>`;
            if (data.processing_time_ms) {
                responseContent += `<span><i class="fas fa-clock"></i> ${Math.round(data.processing_time_ms)}ms</span>`;
            }
            responseContent += `</div>`;
            
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 85%;">
                    ${responseContent}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // Format AI content (markdown-like)
        function formatAIContent(content) {
            if (!content) return '';
            return content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/â€¢ /g, '&bull; ')
                .replace(/- /g, '&ndash; ');
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Fill query input
        function fillQuery(query) {
            document.getElementById('aiQueryInput').value = query;
            document.getElementById('aiQueryInput').focus();
        }
        
        // Handle Enter key in query input
        document.addEventListener('DOMContentLoaded', () => {
            const queryInput = document.getElementById('aiQueryInput');
            if (queryInput) {
                queryInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitAIQuery();
                    }
                });
            }
        });

        // Review Queue Functions
        async function refreshReviewQueue() {
            try {
                const response = await fetch(`${API_V2_BASE}/review/queue?confidence_threshold=0.7&limit=50`);
                const data = await response.json();
                
                document.getElementById('pendingReviewCount').textContent = data.count || 0;
                document.getElementById('reviewBadge').textContent = data.count || 0;
                renderReviewQueue(data.items);

                // Load corrections
                const corrResponse = await fetch(`${API_V2_BASE}/review/corrections?limit=10`);
                const corrData = await corrResponse.json();
                renderCorrections(corrData.corrections);

                // Load stats
                const statsResponse = await fetch(`${API_V2_BASE}/review/statistics`);
                const statsData = await statsResponse.json();
                document.getElementById('correctionsMade').textContent = statsData.total_corrections || 0;
            } catch (error) {
                console.error('Error loading review queue:', error);
            }
        }

        function renderReviewQueue(items) {
            const container = document.getElementById('reviewQueueList');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h4>All caught up!</h4><p>No items pending review</p></div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span class="badge badge-info">${item.entity_type}</span>
                        <span class="badge ${item.confidence > 0.5 ? 'badge-warning' : 'badge-danger'}">${Math.round(item.confidence * 100)}%</span>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.entity_value}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.75rem;">Source: "${item.source_text?.substring(0, 80) || 'N/A'}..."</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="confirmItem(${item.id})"><i class="fas fa-check"></i> Confirm</button>
                        <button class="btn btn-warning btn-sm" onclick="correctItem(${item.id})"><i class="fas fa-edit"></i> Correct</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCorrections(corrections) {
            const tbody = document.getElementById('recentCorrections');
            if (!corrections || corrections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No corrections yet</td></tr>';
                return;
            }

            tbody.innerHTML = corrections.map(c => `
                <tr>
                    <td><span class="badge badge-gray">${c.type || 'N/A'}</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.original || '-'}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${c.corrected || '-'}</td>
                    <td>${c.by || '-'}</td>
                    <td>${c.at ? new Date(c.at).toLocaleDateString() : '-'}</td>
                    <td><span class="badge ${c.verified ? 'badge-success' : 'badge-warning'}">${c.verified ? 'Verified' : 'Pending'}</span></td>
                </tr>
            `).join('');
        }

        async function confirmItem(id) {
            alert('Item confirmed! (API integration ready)');
            refreshReviewQueue();
        }

        async function correctItem(id) {
            const newValue = prompt('Enter the correct value:');
            if (newValue) {
                alert('Correction submitted! (API integration ready)');
                refreshReviewQueue();
            }
        }

        // Audit Functions
        async function refreshAuditTrail() {
            try {
                const action = document.getElementById('auditActionFilter').value;
                const params = action ? `?action=${action}&limit=50` : '?limit=50';
                
                const response = await fetch(`${API_V2_BASE}/audit/trail${params}`);
                const data = await response.json();
                renderAuditTrail(data.logs);

                // Load compliance report
                const compResponse = await fetch(`${API_V2_BASE}/compliance/report`);
                const compData = await compResponse.json();
                renderComplianceReport(compData);

                document.getElementById('totalAuditEvents').textContent = compData.total_events || 0;
                document.getElementById('totalUsers').textContent = Object.keys(compData.events_by_user || {}).length;
                document.getElementById('totalCorrections').textContent = compData.corrections_count || 0;
            } catch (error) {
                console.error('Error loading audit trail:', error);
            }
        }

        function filterAuditTrail() {
            refreshAuditTrail();
        }

        function renderAuditTrail(logs) {
            const container = document.getElementById('auditTrailList');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="empty-state">No audit records found</div>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Entity</th>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td style="font-size: 0.75rem;">${log.timestamp ? new Date(log.timestamp).toLocaleString() : '-'}</td>
                                <td><span class="badge badge-info">${log.action || '-'}</span></td>
                                <td>${log.entity_type || '-'} ${log.entity_id ? '#' + log.entity_id : ''}</td>
                                <td>${log.user || 'system'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderComplianceReport(report) {
            const container = document.getElementById('complianceReport');
            if (!report) {
                container.innerHTML = '<div class="empty-state">No compliance data</div>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">Events by Action</div>
                    ${Object.entries(report.events_by_action || {}).map(([action, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                            <span>${action}</span>
                            <span class="badge badge-gray">${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function exportAuditTrail() {
            try {
                const response = await fetch(`${API_V2_BASE}/compliance/export`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting audit trail: ' + error.message);
            }
        }

        function generateComplianceReport() {
            alert('Compliance report generated! (PDF export coming soon)');
        }

        // Page navigation update
        const enhancedTitles = {
            'timeline': 'Patient Timeline',
            'knowledge-graph': 'Knowledge Graph',
            'ask-ai': 'Ask AI',
            'review-queue': 'Review Queue',
            'audit': 'Audit & Compliance',
            'clinical-decision': 'Clinical Decision Support',
            'treatment-outcomes': 'Treatment Outcomes'
        };

        const originalNavigateTo = navigateTo;
        navigateTo = function(page) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update page
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`page-${page}`)?.classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'scan': 'Scan Prescription',
                'patients': 'Patient Management',
                'history': 'Prescription History',
                'interactions': 'Drug Interaction Checker',
                'allergies': 'Allergy Database',
                'analytics': 'Analytics & Reports',
                'settings': 'Settings',
                ...enhancedTitles
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';

            // Load data for enhanced pages
            if (page === 'review-queue') refreshReviewQueue();
            if (page === 'audit') refreshAuditTrail();
        };

        // ========================================
        // Doctor QR Scan & Patient Lookup Functions
        // ========================================
        
        const STAFF_API = '/api/staff';
        let currentViewedPatient = null;

        // Initialize Doctor QR drop zone
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('doctorQrDropZone');
            const fileInput = document.getElementById('doctorQrFileInput');
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255,255,255,0.25)';
                    dropZone.style.borderColor = 'white';
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.background = 'rgba(255,255,255,0.15)';
                    dropZone.style.borderColor = 'rgba(255,255,255,0.4)';
                });
                
                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dropZone.style.background = 'rgba(255,255,255,0.15)';
                    const file = e.dataTransfer.files[0];
                    if (file) await doctorScanQrImage(file);
                });
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) await doctorScanQrImage(file);
                    e.target.value = '';
                });
            }
        });

        async function doctorScanQrImage(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${STAFF_API}/doctor/scan-qr`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.patient_found) {
                    displayPatientDetails(data);
                } else if (data.decoded_uid && !data.patient_found) {
                    alert(`QR Code decoded (${data.decoded_uid}) but patient not found in database.`);
                } else {
                    alert('Could not read QR code. Please ensure the image is clear.');
                }
            } catch (error) {
                console.error('QR scan error:', error);
                alert('Error scanning QR code: ' + error.message);
            }
        }

        async function doctorLookupPatient() {
            const uid = document.getElementById('doctorPatientUidInput').value.trim();
            if (!uid) {
                alert('Please enter a patient UID');
                return;
            }
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/full-details`);
                const data = await response.json();
                
                if (data.success) {
                    displayPatientDetails(data);
                } else {
                    alert(data.detail || 'Patient not found');
                }
            } catch (error) {
                console.error('Lookup error:', error);
                alert('Patient not found: ' + error.message);
            }
        }

        function displayPatientDetails(data) {
            currentViewedPatient = data;
            
            // Hide initial state, show patient view
            document.getElementById('patientNotFoundState').style.display = 'none';
            document.getElementById('patientFoundState').style.display = 'block';
            
            // Patient header
            document.getElementById('viewPatientName').textContent = data.patient?.name || 'Unknown';
            document.getElementById('viewPatientUid').textContent = `UID: ${data.patient?.uid || data.decoded_uid}`;
            document.getElementById('viewPatientAge').textContent = data.patient?.age ? `${data.patient.age} years` : '';
            document.getElementById('viewPatientGender').textContent = data.patient?.gender || '';
            document.getElementById('viewPatientBlood').textContent = data.patient?.blood_group ? `ðŸ©¸ ${data.patient.blood_group}` : '';
            
            // Stats
            document.getElementById('viewTotalPrescriptions').textContent = data.summary?.total_prescriptions || 0;
            document.getElementById('viewActiveMeds').textContent = data.summary?.active_medications_count || 0;
            document.getElementById('viewLastVisit').textContent = data.summary?.last_visit || '-';
            
            // Allergies
            const allergiesEl = document.getElementById('viewAllergies');
            const allergies = data.patient?.allergies || [];
            if (allergies.length > 0) {
                allergiesEl.innerHTML = allergies.map(a => 
                    `<span class="badge" style="background: #fee2e2; color: #dc2626; margin-right: 0.5rem;">${a}</span>`
                ).join('');
            } else {
                allergiesEl.innerHTML = '<span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>';
            }
            
            // Conditions
            const conditionsEl = document.getElementById('viewConditions');
            const conditions = data.patient?.conditions || [];
            if (conditions.length > 0) {
                conditionsEl.innerHTML = conditions.map(c => 
                    `<span class="badge" style="background: #fef3c7; color: #d97706; margin-right: 0.5rem;">${c}</span>`
                ).join('');
            } else {
                conditionsEl.innerHTML = '<span class="badge" style="background: #f3f4f6; color: #6b7280;">None recorded</span>';
            }
            
            // Active Medications
            const activeMedsEl = document.getElementById('viewActiveMedsList');
            const activeMeds = data.active_medications || [];
            if (activeMeds.length > 0) {
                activeMedsEl.innerHTML = `
                    <div style="display: grid; gap: 0.75rem;">
                        ${activeMeds.map(med => `
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 0.75rem 1rem; border-radius: 0 8px 8px 0;">
                                <div style="font-weight: 600; color: #166534;">${med.name || med.drug_name}</div>
                                <div style="font-size: 0.85rem; color: #15803d;">
                                    ${med.dosage || ''} â€¢ ${med.frequency || ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                activeMedsEl.innerHTML = '<p style="color: var(--gray-500);">No active medications</p>';
            }
            
            // Prescription History
            const historyEl = document.getElementById('viewPrescriptionHistory');
            const prescriptions = data.prescriptions || [];
            if (prescriptions.length > 0) {
                historyEl.innerHTML = prescriptions.map((presc, idx) => `
                    <div style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; background: ${idx === 0 ? '#f0f9ff' : 'white'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; color: var(--gray-800);">
                                    ${presc.prescription_date || 'Unknown date'}
                                    ${idx === 0 ? '<span class="badge badge-success" style="margin-left: 0.5rem;">Latest</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">
                                    Dr. ${presc.doctor_name || 'Unknown'} â€¢ ${presc.hospital_name || ''}
                                </div>
                            </div>
                            <span class="badge">#${presc.prescription_number || idx + 1}</span>
                        </div>
                        ${presc.diagnosis ? `<div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 0.5rem;"><strong>Diagnosis:</strong> ${presc.diagnosis}</div>` : ''}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${(presc.medications || []).map(med => `
                                <span class="badge" style="background: #dbeafe; color: #1d4ed8;">
                                    ðŸ’Š ${med.name || med.drug_name} ${med.dosage || ''}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                historyEl.innerHTML = '<p style="color: var(--gray-500);">No prescriptions found</p>';
            }
        }

        function clearPatientView() {
            currentViewedPatient = null;
            document.getElementById('patientNotFoundState').style.display = 'block';
            document.getElementById('patientFoundState').style.display = 'none';
            document.getElementById('doctorPatientUidInput').value = '';
        }

        function loadPatientToAI() {
            if (!currentViewedPatient) return;
            
            const patient = currentViewedPatient.patient;
            const activeMeds = currentViewedPatient.active_medications || [];
            
            // Navigate to AI page
            navigateTo('ask-ai');
            
            // Fill patient context
            document.getElementById('aiPatientId').value = patient?.uid || '';
            document.getElementById('aiPatientName').value = patient?.name || '';
            document.getElementById('aiPatientAge').value = patient?.age || '';
            document.getElementById('aiPatientAllergies').value = (patient?.allergies || []).join(', ');
            document.getElementById('aiPatientConditions').value = (patient?.conditions || []).join(', ');
            
            // Fill medications
            const medsText = activeMeds.map(med => 
                `${med.name || med.drug_name}, ${med.dosage || ''}, ${med.frequency || ''}`
            ).join('\n');
            document.getElementById('aiPatientMedications').value = medsText;
            
            // Save context
            savePatientContext();
        }

        function viewPatientTimeline() {
            if (!currentViewedPatient) return;
            // Navigate to timeline page with patient context
            navigateTo('timeline');
        }

        // ========================================
        // AI Context Loading from Database
        // ========================================

        async function loadPatientContextFromDB() {
            const uid = document.getElementById('aiLoadPatientUid').value.trim();
            const statusEl = document.getElementById('aiLoadPatientStatus');
            
            if (!uid) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter a patient UID</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Loading...</span>';
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/ai-context`);
                const data = await response.json();
                
                if (data.success) {
                    const ctx = data.ai_context;
                    
                    // Fill form fields
                    document.getElementById('aiPatientId').value = ctx.patient_info?.uid || '';
                    document.getElementById('aiPatientName').value = ctx.patient_info?.name || '';
                    document.getElementById('aiPatientAge').value = ctx.patient_info?.age || '';
                    document.getElementById('aiPatientAllergies').value = (ctx.medical_profile?.allergies || []).join(', ');
                    document.getElementById('aiPatientConditions').value = (ctx.medical_profile?.chronic_conditions || []).join(', ');
                    
                    // Fill medications
                    const medsText = (ctx.current_medications || []).map(med => 
                        `${med.name}, ${med.dosage || ''}, ${med.frequency || ''}`
                    ).join('\n');
                    document.getElementById('aiPatientMedications').value = medsText;
                    
                    // Save the context
                    savePatientContext();
                    
                    statusEl.innerHTML = `<span style="color: #059669;"><i class="fas fa-check-circle"></i> Loaded ${ctx.patient_info?.name}'s context successfully!</span>`;
                    
                    // Add AI message about loaded context
                    addAIMessage(`ðŸ“‹ Loaded patient context for <strong>${ctx.patient_info?.name}</strong>:
                        <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.9rem;">
                            <li>Age: ${ctx.patient_info?.age || 'Unknown'}</li>
                            <li>Allergies: ${(ctx.medical_profile?.allergies || []).join(', ') || 'None'}</li>
                            <li>Conditions: ${(ctx.medical_profile?.chronic_conditions || []).join(', ') || 'None'}</li>
                            <li>Active Medications: ${ctx.current_medications?.length || 0}</li>
                            <li>Prescription History: ${ctx.prescription_history?.length || 0} records</li>
                        </ul>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-500);">You can now ask me questions about this patient!</p>`);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${data.detail || 'Patient not found'}</span>`;
                }
            } catch (error) {
                console.error('Error loading context:', error);
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> Error: ${error.message}</span>`;
            }
        }

        function addAIMessage(content) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1.5rem;';
            messageDiv.innerHTML = `
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    ðŸ¤–
                </div>
                <div style="background: white; padding: 1rem 1.25rem; border-radius: 0 16px 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); max-width: 80%;">
                    ${content}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ========================================
        // Clinical Decision Support Functions
        // ========================================

        async function loadClinicalDecisionSupport() {
            const uid = document.getElementById('cdsPatientUid').value.trim();
            const statusEl = document.getElementById('cdsLoadStatus');
            
            if (!uid) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter a patient UID</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Analyzing patient... This may take a moment.</span>';
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/clinical-decision-support`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.detail || 'Failed to load clinical decision support');
                }
                
                displayClinicalDecisionSupport(data);
                
                statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Analysis complete!</span>';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                
            } catch (error) {
                console.error('CDS Error:', error);
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        function displayClinicalDecisionSupport(data) {
            const cds = data.clinical_decision_support;
            const summary = data.summary;
            
            document.getElementById('cdsResultsContainer').style.display = 'block';
            
            // Guideline Compliance
            const compliance = cds.guideline_compliance;
            if (compliance) {
                const score = compliance.overall_score || 0;
                document.getElementById('cdsComplianceScore').textContent = score.toFixed(0) + '%';
                document.getElementById('cdsComplianceFill').style.width = score + '%';
                
                // Color the score based on value
                const scoreEl = document.getElementById('cdsComplianceScore');
                if (score >= 80) {
                    scoreEl.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                } else if (score >= 60) {
                    scoreEl.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                } else {
                    scoreEl.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                }
                scoreEl.style['-webkit-background-clip'] = 'text';
                scoreEl.style['-webkit-text-fill-color'] = 'transparent';
                
                // Guideline details
                let detailsHtml = `
                    <div style="margin-bottom: 1rem;">
                        <span class="badge badge-info">${compliance.guideline_source || 'Multiple Guidelines'}</span>
                        <span style="margin-left: 0.5rem; color: var(--gray-500); font-size: 0.875rem;">${compliance.guideline_version || '2024-2025'}</span>
                    </div>
                `;
                
                if (compliance.compliant_items?.length > 0) {
                    detailsHtml += `<div style="margin-bottom: 1rem;"><strong style="color: #059669;">âœ“ Compliant:</strong>`;
                    detailsHtml += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">`;
                    compliance.compliant_items.forEach(item => {
                        detailsHtml += `<span class="badge badge-success">${item.item}</span>`;
                    });
                    detailsHtml += `</div></div>`;
                }
                
                if (compliance.non_compliant_items?.length > 0) {
                    detailsHtml += `<div><strong style="color: #dc2626;">âœ— Gaps Identified:</strong>`;
                    detailsHtml += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">`;
                    compliance.non_compliant_items.forEach(item => {
                        detailsHtml += `<span class="badge badge-danger">${item.item}</span>`;
                    });
                    detailsHtml += `</div></div>`;
                }
                
                document.getElementById('cdsGuidelineDetails').innerHTML = detailsHtml;
            }
            
            // Treatment Alternatives
            const alternatives = cds.alternatives || [];
            document.getElementById('cdsAlternativesCount').textContent = alternatives.length + ' alternatives';
            
            if (alternatives.length > 0) {
                let altHtml = '';
                alternatives.forEach(alt => {
                    altHtml += `
                        <div style="border: 1px solid var(--gray-200); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--gray-500);">Current: <strong>${alt.current_drug}</strong></div>
                                    <div style="font-size: 1.125rem; font-weight: 700; color: #1d4ed8;">
                                        <i class="fas fa-arrow-right" style="font-size: 0.75rem; margin-right: 0.5rem;"></i>
                                        Consider: ${alt.alternative_drug}
                                    </div>
                                </div>
                                <div>
                                    <span class="badge badge-info">Level ${alt.evidence_level}</span>
                                </div>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="font-weight: 600; color: var(--gray-800); margin-bottom: 0.5rem;">${alt.reason}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">${alt.benefit_summary}</div>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.75rem;">
                                <span style="color: var(--gray-500);"><i class="fas fa-book"></i> ${alt.guideline_source}</span>
                            </div>
                            ${alt.patient_criteria?.length > 0 ? `
                                <div style="margin-top: 0.75rem;">
                                    <span style="font-size: 0.75rem; color: #059669;"><i class="fas fa-check-circle"></i> Patient criteria met:</span>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.25rem;">
                                        ${alt.patient_criteria.map(c => `<span class="badge badge-success" style="font-size: 0.7rem;">${c}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('cdsAlternativesList').innerHTML = altHtml;
            } else {
                document.getElementById('cdsAlternativesList').innerHTML = '<p style="color: var(--gray-500);">No specific alternatives recommended for current medications.</p>';
            }
            
            // Pharmacogenomic Alerts
            const pgxAlerts = cds.pharmacogenomic_alerts || [];
            document.getElementById('cdsPgxCount').textContent = pgxAlerts.length + ' alerts';
            
            if (pgxAlerts.length > 0) {
                let pgxHtml = '';
                pgxAlerts.forEach(alert => {
                    pgxHtml += `
                        <div style="border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 0 12px 12px 0; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: #5b21b6;">
                                    <i class="fas fa-dna" style="margin-right: 0.5rem;"></i>${alert.drug}
                                </div>
                                <span class="badge badge-purple">Gene: ${alert.gene}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b21a8; margin-bottom: 0.5rem;">
                                <strong>Phenotype:</strong> ${alert.phenotype}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">
                                <strong>Clinical Implication:</strong> ${alert.clinical_implication}
                            </div>
                            <div style="background: white; border-radius: 6px; padding: 0.75rem; font-size: 0.875rem;">
                                <strong style="color: #059669;"><i class="fas fa-lightbulb"></i> Recommendation:</strong> ${alert.recommendation}
                            </div>
                            ${alert.alternative_drugs?.length > 0 ? `
                                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                                    <strong>Alternatives:</strong> ${alert.alternative_drugs.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('cdsPgxAlertsList').innerHTML = pgxHtml;
            } else {
                document.getElementById('cdsPgxAlertsList').innerHTML = '<p style="color: var(--gray-500);">No pharmacogenomic alerts for current medications.</p>';
            }
            
            // Optimization Suggestions
            const optimizations = cds.optimization_suggestions || [];
            if (optimizations.length > 0) {
                let optHtml = '';
                optimizations.forEach(opt => {
                    const priorityColors = {
                        'high': { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
                        'medium': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                        'low': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' }
                    };
                    const colors = priorityColors[opt.priority] || priorityColors.medium;
                    
                    optHtml += `
                        <div style="border-left: 4px solid ${colors.border}; background: ${colors.bg}; border-radius: 0 12px 12px 0; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: ${colors.text};">
                                    <i class="fas fa-lightbulb" style="margin-right: 0.5rem;"></i>${opt.title}
                                </div>
                                <span class="badge" style="background: ${colors.border}; color: white;">${opt.priority.toUpperCase()}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.75rem;">${opt.description}</div>
                            <div style="background: white; border-radius: 6px; padding: 0.75rem; font-size: 0.875rem;">
                                <strong style="color: #059669;">Recommendation:</strong> ${opt.recommendation}
                            </div>
                            ${opt.evidence ? `
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-500);">
                                    <i class="fas fa-book"></i> ${opt.evidence}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('cdsOptimizationsList').innerHTML = optHtml;
            } else {
                document.getElementById('cdsOptimizationsList').innerHTML = '<p style="color: var(--gray-500); text-align: center;">âœ… No optimization opportunities identified - treatment appears well-optimized!</p>';
            }
        }

        // ========================================
        // Treatment Outcome Functions
        // ========================================

        // Update vital unit when type changes
        document.addEventListener('DOMContentLoaded', function() {
            const vitalTypeSelect = document.getElementById('vitalRecordType');
            if (vitalTypeSelect) {
                vitalTypeSelect.addEventListener('change', function() {
                    const units = {
                        'bp_systolic': 'mmHg',
                        'bp_diastolic': 'mmHg',
                        'heart_rate': 'bpm',
                        'blood_glucose': 'mg/dL',
                        'hba1c': '%',
                        'ldl_cholesterol': 'mg/dL',
                        'hdl_cholesterol': 'mg/dL',
                        'weight': 'kg',
                        'pain_score': '0-10',
                        'egfr': 'mL/min/1.73mÂ²',
                        'creatinine': 'mg/dL'
                    };
                    document.getElementById('vitalRecordUnit').value = units[this.value] || 'units';
                });
                vitalTypeSelect.dispatchEvent(new Event('change'));
            }
        });

        async function recordOutcome() {
            const patientUid = document.getElementById('outcomePatientUid').value.trim();
            const medication = document.getElementById('outcomeRecordMed').value.trim();
            const outcomeType = document.getElementById('outcomeRecordType').value;
            const description = document.getElementById('outcomeRecordDesc').value.trim();
            const sideEffects = document.getElementById('outcomeRecordSideEffects').value.trim();
            const statusEl = document.getElementById('outcomeRecordStatus');
            
            if (!patientUid || !medication || !description) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please fill in patient UID, medication, and description</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Recording outcome...</span>';
            
            try {
                const formData = new FormData();
                formData.append('medication', medication);
                formData.append('outcome_type', outcomeType);
                formData.append('description', description);
                if (sideEffects) formData.append('side_effects', sideEffects);
                
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/record-outcome`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Outcome recorded successfully!</span>';
                    // Clear fields
                    document.getElementById('outcomeRecordMed').value = '';
                    document.getElementById('outcomeRecordDesc').value = '';
                    document.getElementById('outcomeRecordSideEffects').value = '';
                    
                    setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed to record outcome');
                }
            } catch (error) {
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        async function recordVital() {
            const patientUid = document.getElementById('outcomePatientUid').value.trim();
            const vitalType = document.getElementById('vitalRecordType').value;
            const value = document.getElementById('vitalRecordValue').value;
            const unit = document.getElementById('vitalRecordUnit').value;
            const notes = document.getElementById('vitalRecordNotes').value.trim();
            const statusEl = document.getElementById('vitalRecordStatus');
            
            if (!patientUid || !value) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-exclamation-circle"></i> Please enter patient UID and vital value</span>';
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #0284c7;"><i class="fas fa-spinner fa-spin"></i> Recording vital...</span>';
            
            try {
                const formData = new FormData();
                formData.append('vital_type', vitalType);
                formData.append('value', value);
                formData.append('unit', unit);
                if (notes) formData.append('notes', notes);
                
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/record-vital`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #059669;"><i class="fas fa-check-circle"></i> Vital recorded successfully!</span>';
                    document.getElementById('vitalRecordValue').value = '';
                    document.getElementById('vitalRecordNotes').value = '';
                    
                    setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed to record vital');
                }
            } catch (error) {
                statusEl.innerHTML = `<span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</span>`;
            }
        }

        async function loadOutcomeReport() {
            const uid = document.getElementById('outcomePatientUid').value.trim();
            
            if (!uid) {
                alert('Please enter a patient UID');
                return;
            }
            
            try {
                const response = await fetch(`${STAFF_API}/patient/${uid}/comprehensive-outcome-report`);
                const data = await response.json();
                
                if (data.success) {
                    displayOutcomeReport(data.report);
                } else {
                    alert(data.detail || 'Failed to load outcome report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading outcome report: ' + error.message);
            }
        }

        function displayOutcomeReport(report) {
            document.getElementById('outcomeTimelineContainer').style.display = 'block';
            
            // Health trend badge
            const trendEl = document.getElementById('outcomeHealthTrend');
            const trend = report.overall_health_trend || 'stable';
            const trendConfig = {
                'improving': { class: 'badge-success', text: 'ðŸ“ˆ Improving' },
                'stable': { class: 'badge-info', text: 'âž¡ï¸ Stable' },
                'declining': { class: 'badge-danger', text: 'ðŸ“‰ Declining' },
                'insufficient_data': { class: 'badge-gray', text: 'â“ Insufficient Data' }
            };
            const config = trendConfig[trend] || trendConfig.stable;
            trendEl.className = 'badge ' + config.class;
            trendEl.textContent = config.text;
            
            // Timeline
            const timeline = report.outcome_timeline;
            const treatments = timeline?.treatments || [];
            
            if (treatments.length > 0) {
                let timelineHtml = '';
                treatments.forEach((t, idx) => {
                    const outcomeColors = {
                        'improved': { bg: '#dcfce7', border: '#22c55e', icon: 'âœ…' },
                        'resolved': { bg: '#dbeafe', border: '#3b82f6', icon: 'ðŸŽ‰' },
                        'stable': { bg: '#f3f4f6', border: '#6b7280', icon: 'âž¡ï¸' },
                        'worsened': { bg: '#fee2e2', border: '#ef4444', icon: 'âš ï¸' },
                        'discontinued': { bg: '#fef3c7', border: '#f59e0b', icon: 'ðŸ›‘' },
                        'adverse_event': { bg: '#fce7f3', border: '#ec4899', icon: 'âŒ' }
                    };
                    const colors = outcomeColors[t.outcome_type] || outcomeColors.stable;
                    
                    timelineHtml += `
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="width: 40px; height: 40px; background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">
                                ${colors.icon}
                            </div>
                            <div style="flex: 1; border-left: 2px solid var(--gray-200); padding-left: 1.5rem; ${idx === treatments.length - 1 ? 'border-left-color: transparent;' : ''}">
                                <div style="font-weight: 600; color: var(--gray-800);">${t.medication}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0;">${t.outcome_description}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-400);">
                                    ${t.outcome_recorded_at ? new Date(t.outcome_recorded_at).toLocaleDateString() : 'Date unknown'}
                                    ${t.effectiveness_score ? ` â€¢ Effectiveness: ${t.effectiveness_score.toFixed(0)}%` : ''}
                                </div>
                                ${t.side_effects?.length > 0 ? `
                                    <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                        ${t.side_effects.map(se => `<span class="badge badge-warning" style="font-size: 0.7rem;">âš ï¸ ${se}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('outcomeTimelineList').innerHTML = timelineHtml;
            } else {
                document.getElementById('outcomeTimelineList').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No treatment outcomes recorded yet.</p>';
            }
            
            // Vital Trends
            const vitalTrends = timeline?.vital_trends || {};
            if (Object.keys(vitalTrends).length > 0) {
                let trendsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
                
                const vitalNames = {
                    'bp_systolic': 'BP Systolic',
                    'bp_diastolic': 'BP Diastolic',
                    'heart_rate': 'Heart Rate',
                    'blood_glucose': 'Blood Glucose',
                    'hba1c': 'HbA1c',
                    'ldl_cholesterol': 'LDL Cholesterol',
                    'weight': 'Weight',
                    'pain_score': 'Pain Score'
                };
                
                for (const [type, readings] of Object.entries(vitalTrends)) {
                    if (readings.length > 0) {
                        const latest = readings[readings.length - 1];
                        const first = readings[0];
                        const change = latest.value - first.value;
                        const changePercent = ((change / first.value) * 100).toFixed(1);
                        
                        trendsHtml += `
                            <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase;">${vitalNames[type] || type}</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800);">${latest.value}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-400);">${latest.unit}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: ${change < 0 ? '#059669' : change > 0 ? '#dc2626' : '#6b7280'};">
                                    ${change > 0 ? 'â†‘' : change < 0 ? 'â†“' : 'â†’'} ${Math.abs(changePercent)}%
                                </div>
                            </div>
                        `;
                    }
                }
                
                trendsHtml += '</div>';
                document.getElementById('vitalTrendsContainer').innerHTML = trendsHtml;
            } else {
                document.getElementById('vitalTrendsContainer').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No vital readings recorded yet.</p>';
            }
            
            // Insights
            const insights = report.insights || [];
            if (insights.length > 0) {
                let insightsHtml = '';
                insights.forEach(insight => {
                    const insightColors = {
                        'positive': { bg: '#dcfce7', border: '#22c55e', icon: 'âœ…' },
                        'warning': { bg: '#fee2e2', border: '#ef4444', icon: 'âš ï¸' },
                        'info': { bg: '#dbeafe', border: '#3b82f6', icon: 'â„¹ï¸' }
                    };
                    const colors = insightColors[insight.type] || insightColors.info;
                    
                    insightsHtml += `
                        <div style="border-left: 4px solid ${colors.border}; background: ${colors.bg}; border-radius: 0 8px 8px 0; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${colors.icon} ${insight.title}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-700);">${insight.message}</div>
                        </div>
                    `;
                });
                document.getElementById('treatmentInsightsList').innerHTML = insightsHtml;
            } else {
                document.getElementById('treatmentInsightsList').innerHTML = '<p style="color: var(--gray-500); text-align: center;">No insights available yet. Record more outcomes to generate insights.</p>';
            }
        }

        async function predictTreatmentSuccess() {
            const patientUid = document.getElementById('outcomePatientUid').value.trim();
            const medication = document.getElementById('predictionMed').value.trim();
            const condition = document.getElementById('predictionCondition').value.trim();
            const resultsEl = document.getElementById('predictionResults');
            
            if (!patientUid || !medication) {
                alert('Please enter patient UID and medication');
                return;
            }
            
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);"><i class="fas fa-spinner fa-spin fa-2x"></i><div style="margin-top: 1rem;">Running ML prediction model...</div></div>';
            
            try {
                const params = new URLSearchParams({ medication });
                if (condition) params.append('condition', condition);
                
                const response = await fetch(`${STAFF_API}/patient/${patientUid}/treatment-prediction?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPrediction(data.prediction);
                } else {
                    throw new Error(data.detail || 'Failed to get prediction');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div style="background: #fee2e2; padding: 1rem; border-radius: 8px; color: #dc2626;"><i class="fas fa-times-circle"></i> ${error.message}</div>`;
            }
        }

        function displayPrediction(prediction) {
            const resultsEl = document.getElementById('predictionResults');
            const prob = prediction.predicted_success_probability;
            const ci = prediction.confidence_interval;
            
            const probColor = prob >= 70 ? '#22c55e' : prob >= 50 ? '#f59e0b' : '#ef4444';
            
            resultsEl.innerHTML = `
                <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; font-weight: 800; color: ${probColor};">${prob.toFixed(0)}%</div>
                        <div style="font-size: 0.875rem; color: var(--gray-500);">Predicted Success Probability</div>
                        <div style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem;">
                            95% CI: ${ci[0].toFixed(0)}% - ${ci[1].toFixed(0)}%
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; font-weight: 600; color: #059669; margin-bottom: 0.5rem;">
                                <i class="fas fa-thumbs-up"></i> Factors Supporting Success
                            </div>
                            ${prediction.factors_supporting?.length > 0 ? prediction.factors_supporting.map(f => `
                                <div style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.8rem; border-bottom: 1px solid rgba(5, 150, 105, 0.1);">
                                    <span>${f.factor}</span>
                                    <span style="color: #059669;">${f.impact}</span>
                                </div>
                            `).join('') : '<div style="color: var(--gray-400); font-size: 0.8rem;">No specific factors identified</div>'}
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">
                                <i class="fas fa-thumbs-down"></i> Factors Against Success
                            </div>
                            ${prediction.factors_against?.length > 0 ? prediction.factors_against.map(f => `
                                <div style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.8rem; border-bottom: 1px solid rgba(220, 38, 38, 0.1);">
                                    <span>${f.factor}</span>
                                    <span style="color: #dc2626;">${f.impact}</span>
                                </div>
                            `).join('') : '<div style="color: var(--gray-400); font-size: 0.8rem;">No specific factors identified</div>'}
                        </div>
                    </div>
                    
                    ${prediction.similar_patient_outcomes?.total_similar_patients ? `
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.5rem;">
                                <i class="fas fa-users"></i> Similar Patient Outcomes (n=${prediction.similar_patient_outcomes.total_similar_patients.toLocaleString()})
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
                                <span><strong>Improved:</strong> ${(prediction.similar_patient_outcomes.improved_rate * 100).toFixed(0)}%</span>
                                <span><strong>Avg Time:</strong> ${prediction.similar_patient_outcomes.avg_time_to_improvement} days</span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: white; border-radius: 8px; padding: 1rem;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #8b5cf6; margin-bottom: 0.5rem;">
                            <i class="fas fa-robot"></i> AI Recommendation
                        </div>
                        <div style="font-size: 0.9rem; color: var(--gray-700);">${prediction.recommendation}</div>
                    </div>
                </div>
            `;
        }
        
        // ==================== Allergy & Condition Badge Rendering ====================
        
        const CRITICAL_ALLERGY_KEYWORDS = ['penicillin', 'sulfa', 'latex', 'iodine', 'contrast', 'shellfish', 'peanut', 'bee', 'wasp', 'anaphylaxis'];
        const HIGH_ALLERGY_KEYWORDS = ['aspirin', 'nsaid', 'codeine', 'morphine', 'cephalosporin', 'tetracycline'];
        
        const CROSS_REACTIVITY_MAP = {
            'penicillin': ['Amoxicillin', 'Ampicillin', 'Cephalosporins'],
            'sulfa': ['Bactrim', 'Sulfamethoxazole'],
            'aspirin': ['Ibuprofen', 'Naproxen', 'All NSAIDs'],
            'codeine': ['Morphine', 'Tramadol'],
            'cephalosporin': ['Cefixime', 'Ceftriaxone']
        };
        
        function renderAllergyBadges(allergies) {
            const container = document.getElementById('detailAllergiesContainer');
            if (!allergies || allergies.length === 0) {
                container.innerHTML = '<span style="color: #059669; font-size: 0.875rem;"><i class="fas fa-check-circle"></i> No allergies recorded</span>';
                return;
            }
            
            container.innerHTML = allergies.map(allergy => {
                const allergyLower = allergy.toLowerCase();
                const isCritical = CRITICAL_ALLERGY_KEYWORDS.some(kw => allergyLower.includes(kw));
                const isHigh = HIGH_ALLERGY_KEYWORDS.some(kw => allergyLower.includes(kw));
                
                let badgeClass = 'standard';
                let icon = 'âš ï¸';
                let tooltip = '';
                
                if (isCritical) {
                    badgeClass = 'critical';
                    icon = 'ðŸš¨';
                    // Check cross-reactivity
                    for (const [key, drugs] of Object.entries(CROSS_REACTIVITY_MAP)) {
                        if (allergyLower.includes(key)) {
                            tooltip = `Cross-reactive with: ${drugs.join(', ')}`;
                            break;
                        }
                    }
                } else if (isHigh) {
                    badgeClass = 'high';
                    icon = 'âš ï¸';
                }
                
                return `<span class="allergy-badge ${badgeClass}" title="${tooltip}">${icon} ${allergy}</span>`;
            }).join('');
        }
        
        const HIGH_IMPACT_CONDITIONS = {
            'kidney': 'Affects drug dosing',
            'renal': 'Affects drug dosing',
            'liver': 'Affects drug metabolism',
            'hepatic': 'Affects drug metabolism',
            'heart': 'Avoid NSAIDs, certain drugs',
            'cardiac': 'Avoid NSAIDs, certain drugs',
            'pregnant': 'Many drugs contraindicated',
            'pregnancy': 'Many drugs contraindicated',
            'asthma': 'Avoid beta-blockers',
            'diabetes': 'Monitor with steroids',
            'bleeding': 'Avoid anticoagulants',
            'ulcer': 'Avoid NSAIDs'
        };
        
        function renderConditionBadges(conditions) {
            const container = document.getElementById('detailConditionsContainer');
            if (!conditions || conditions.length === 0) {
                container.innerHTML = '<span style="color: var(--gray-400); font-size: 0.875rem;">No chronic conditions recorded</span>';
                return;
            }
            
            container.innerHTML = conditions.map(condition => {
                const conditionLower = condition.toLowerCase();
                let isHighImpact = false;
                let impact = '';
                
                for (const [keyword, desc] of Object.entries(HIGH_IMPACT_CONDITIONS)) {
                    if (conditionLower.includes(keyword)) {
                        isHighImpact = true;
                        impact = desc;
                        break;
                    }
                }
                
                const badgeClass = isHighImpact ? 'high-impact' : 'standard';
                const icon = isHighImpact ? 'âš¡' : 'â€¢';
                
                return `<span class="condition-badge ${badgeClass}" title="${impact}">${icon} ${condition}</span>`;
            }).join('');
        }
        
        // ==================== Real-Time Drug Safety Check ====================
        
        let safetyAlertTimeout = null;
        
        async function checkDrugSafety(drugName, patientAllergies, patientConditions, currentMeds) {
            if (!drugName || drugName.length < 2) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/staff/check-drug-safety`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        drug_name: drugName,
                        patient_allergies: patientAllergies || [],
                        patient_conditions: patientConditions || [],
                        current_medications: currentMeds || []
                    })
                });
                
                const result = await response.json();
                
                if (result.alerts_count > 0) {
                    showDrugSafetyAlerts(result.alerts, drugName);
                }
                
                return result;
            } catch (error) {
                console.error('Drug safety check error:', error);
                return null;
            }
        }
        
        function showDrugSafetyAlerts(alerts, drugName) {
            // Remove existing popup
            const existing = document.getElementById('drugSafetyPopup');
            if (existing) existing.remove();
            
            if (!alerts || alerts.length === 0) return;
            
            const popup = document.createElement('div');
            popup.id = 'drugSafetyPopup';
            popup.className = 'drug-safety-popup';
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 700; font-size: 0.9rem;">âš ï¸ Safety Alerts for ${drugName}</span>
                    <button onclick="document.getElementById('drugSafetyPopup').remove()" style="background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--gray-500);">Ã—</button>
                </div>
                ${alerts.slice(0, 3).map(alert => `
                    <div class="safety-alert-card ${alert.severity.toLowerCase()}">
                        <div class="safety-alert-header ${alert.severity.toLowerCase()}">
                            ${alert.icon} ${alert.type}: ${alert.title}
                        </div>
                        <div class="safety-alert-body">
                            ${alert.message}
                        </div>
                        ${alert.action ? `<div class="safety-alert-action"><strong>Action:</strong> ${alert.action}</div>` : ''}
                    </div>
                `).join('')}
                ${alerts.length > 3 ? `<div style="text-align: center; font-size: 0.8rem; color: var(--gray-500);">+${alerts.length - 3} more alerts</div>` : ''}
            `;
            
            document.body.appendChild(popup);
            
            // Auto-hide after 15 seconds for non-critical alerts
            const hasCritical = alerts.some(a => a.severity === 'CRITICAL');
            if (!hasCritical) {
                safetyAlertTimeout = setTimeout(() => {
                    popup.remove();
                }, 15000);
            }
        }
        
        // Helper: Get patient context for safety checks
        function getPatientContextForSafety() {
            if (!currentPatientData) return { allergies: [], conditions: [], meds: [] };
            
            return {
                allergies: currentPatientData.patient?.allergies || [],
                conditions: currentPatientData.patient?.chronic_conditions || [],
                meds: (currentPatientData.patient?.current_medications || []).map(m => m.name || m)
            };
        }
        
    </script>
</body>
</html>
